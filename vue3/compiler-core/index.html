<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"â€” ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><meta data-react-helmet="true" name="description" content="vue3.0 source code of compiler-core module."/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=e7378b3c64c12d2baf93b45ccd2266f5"/><title data-react-helmet="true">Vue3.0 æºç ç³»åˆ— 02 -- Compiler-coreã€DOINGã€‘ | è‹¥å¶çŸ¥ç§‹</title><meta name="generator" content="Gatsby 2.23.3"/><meta data-react-helmet="true" property="og:title" content="Vue3.0 æºç ç³»åˆ— 02 -- Compiler-coreã€DOINGã€‘"/><meta data-react-helmet="true" property="og:description" content="vue3.0 source code of compiler-core module."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="gccll_love"/><meta data-react-helmet="true" name="twitter:title" content="Vue3.0 æºç ç³»åˆ— 02 -- Compiler-coreã€DOINGã€‘"/><meta data-react-helmet="true" name="twitter:description" content="vue3.0 source code of compiler-core module."/><style data-href="/styles.eb7c6a8bf4dd79098175.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}html{background-color:#ffdab9}a{color:#639}.tags .tag{margin-right:1rem}a.github{box-shadow:none}a.github img{width:1.5rem;vertical-align:middle;margin-bottom:0;transition:all .5s}a.github img:hover{transform:scale(1.5)}footer{margin-top:2rem}ol{margin-left:2rem}.css-toc{padding:15px;margin-bottom:25px}.css-toc>ul{padding-left:16px}.css-toc ul{list-style-type:square;list-style-position:outside;margin-bottom:0}.css-toc ul p{vertical-align:top;display:inline-block}.css-toc li,.css-toc li>p{margin-bottom:0}.css-toc li>ul{margin-top:0}@media screen and (min-width:1045px){.css-toc{position:fixed;bottom:0;right:1rem;width:250px;max-height:800px;overflow:scroll;font-size:14px}.css-toc li>ul{margin-left:1rem}}</style><link as="script" rel="preload" href="/component---src-templates-blog-post-js-87b9875212785ebf1c24.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-2e9a852144d8ce373a7b.js"/><link as="script" rel="preload" href="/commons-ed01901cfa003862a39a.js"/><link as="script" rel="preload" href="/app-758533d5dedfd033bfc3.js"/><link as="script" rel="preload" href="/framework-d54fcf3f0204b459cf2d.js"/><link as="script" rel="preload" href="/styles-2d4804b503525347efbe.js"/><link as="script" rel="preload" href="/webpack-runtime-f9282b41cb75aa09d440.js"/><link as="fetch" rel="preload" href="/page-data/vue3/compiler-core/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/">è‹¥å¶çŸ¥ç§‹</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0" class="title is-1">Vue3.0 æºç ç³»åˆ— 02 -- Compiler-coreã€DOINGã€‘</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">June 18, 2020</p></header><section class="css-toc"><ul>
<li>
<p><a href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%88%86%E6%9E%90">æµ‹è¯•ç”¨ä¾‹åˆ†æ</a></p>
<ul>
<li><a href="#parsespects">parse.spec.ts</a></li>
</ul>
</li>
<li>
<p><a href="#parsets">parse.ts</a></p>
<ul>
<li><a href="#baseparsecontext-options">baseParse(context, options)</a></li>
<li><a href="#createparsecontextcontext-options">createParseContext(context, options)</a></li>
<li><a href="#parsechildrencontext-mode-ancestors">parseChildren(context, mode, ancestors)</a></li>
<li><a href="#parsecommentcontext">parseComment(context)</a></li>
<li><a href="#parseelementcontext-mode">parseElement(context, mode)</a></li>
<li><a href="#parseinterpolationcontext-mode">parseInterpolation(context, mode)</a></li>
<li><a href="#parsetagcontext-type-parent">parseTag(context, type, parent)</a></li>
<li><a href="#parsetextcontext-mode">parseText(context, mode)</a></li>
<li><a href="#parsetextdatacontext-length-mode">parseTextData(context, length, mode)</a></li>
<li><a href="#parseattributescontext-type">parseAttributes(context, type)</a></li>
<li><a href="#parseattributecontext-nameset">parseAttribute(context, nameSet)</a></li>
<li><a href="#parseattributevaluecontext">parseAttributeValue(context)</a></li>
<li><a href="#pushnodenodes-node">pushNode(nodes, node)</a></li>
<li><a href="#isendcontext-mode-ancestors">isEnd(context, mode, ancestors)</a></li>
<li><a href="#getcursorcontext">getCursor(context)</a></li>
<li><a href="#getselectioncontext-start-end-postion">getSelection(context, start, end?: Postion)</a></li>
</ul>
</li>
<li>
<p><a href="#astts">ast.ts</a></p>
<ul>
<li><a href="#createrootchildren-loc--locstub">createRoot(children, loc = locStub)</a></li>
</ul>
</li>
<li>
<p><a href="#utilsts">utils.ts</a></p>
<ul>
<li><a href="#advancepositionwithmutationpossource-numberofcharacters">advancePositionWithMutation(pos,source, numberOfCharacters)</a></li>
</ul>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">å˜é‡å£°æ˜</a></p>
<ul>
<li><a href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B">æšä¸¾ç±»å‹</a></li>
<li><a href="#parser">parser</a></li>
</ul>
</li>
<li>
<p><a href="#%E7%B1%BB%E5%9E%8B%E5%A3%B0%E6%98%8E">ç±»å‹å£°æ˜</a></p>
<ul>
<li><a href="#astts-1">ast.ts</a></li>
<li><a href="#parseroptions">ParserOptions</a></li>
<li><a href="#parsercontext">ParserContext</a></li>
</ul>
</li>
<li><a href="#%E9%98%B6%E6%AE%B5%E4%BB%A3%E7%A0%81%E8%AE%B0%E5%BD%95">é˜¶æ®µä»£ç è®°å½•</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E7%96%91%E9%97%AE%E5%88%97%E8%A1%A8">é—®é¢˜/ç–‘é—®åˆ—è¡¨</a></li>
<li>
<p><a href="#%E6%B5%81%E7%A8%8B%E5%9B%BE">æµç¨‹å›¾</a></p>
<ul>
<li><a href="#%E5%B8%A6%E6%8C%87%E4%BB%A4%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90">å¸¦æŒ‡ä»¤çš„æ¨¡æ¿/æ ‡ç­¾è§£æ</a></li>
</ul>
</li>
</ul></section><section><blockquote>
<p>è¯¥ç³»åˆ—æ–‡ç« ï¼Œå‡ä»¥æµ‹è¯•ç”¨ä¾‹é€šè¿‡ä¸ºåŸºå‡†ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª vue3 æºç å‰¯æœ¬(å­¦ä¹ )ã€‚</p>
</blockquote>
<p><font color="#fc02ff"><strong>å¯èƒ½æ„Ÿå…´è¶£åˆ—è¡¨ï¼š</strong></font></p>
<ol>
<li><a href="#flowchart-list">å„ç§æµç¨‹å›¾(å‡½æ•°/åŠŸèƒ½/å®ç°/â€¦)æ— å›¾æ— çœŸç›¸ç³»åˆ—</a> ğŸ›¬ ğŸ›¬ ğŸ›¬ ğŸ›¬ ğŸ›¬</li>
<li><a href="#issues">æºç ç›¸å…³çš„ç–‘é—®/é—®é¢˜åˆ—è¡¨åŠå…¶è§£ç­”</a> ğŸ›³ ğŸ›³ ğŸ›³ ğŸ›³ ğŸ›³</li>
<li><a href="#stage-codes">é˜¶æ®µæ€§çš„ä»£ç å¤‡ä»½(æ¯”å¦‚èƒ½passæŸä¸ªç”¨ä¾‹)</a> ğŸš˜ ğŸš˜ ğŸš˜ ğŸš˜ ğŸš˜</li>
</ol>
<h1 id="æµ‹è¯•ç”¨ä¾‹åˆ†æ" style="position:relative;"><a href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%88%86%E6%9E%90" aria-label="æµ‹è¯•ç”¨ä¾‹åˆ†æ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æµ‹è¯•ç”¨ä¾‹åˆ†æ</h1>
<p>åŸæœ¬æ˜¯æƒ³ç›´æ¥æ ¹æ®æºç å»äº†è§£è¿™éƒ¨åˆ†çš„å®ç°åŸç†çš„ï¼Œä½†æ˜¯å‘ç°çº¯ç²¹çš„ä»£ç åˆ†ææœ‰ç‚¹å›°éš¾ï¼Œè¿™éƒ¨åˆ†ä¸åƒ reactivity æ¨¡å—é‚£ä¹ˆç›´è§‚ï¼Œå¹¶ä¸”æ„Ÿè§‰è¿™å—æ¯” reactivity å¤æ‚çš„å¤šï¼Œå› æ­¤å…ˆæ¢ç©¶å¦‚ä½•ä½¿ç”¨ï¼Œä»å¦‚ä½•ä½¿ç”¨åˆ°æ€ä¹ˆå®ç°å»é€æ­¥å®ç°ï¼Œåˆ†ææºä»£ç ã€‚</p>
<p>compiler-core æ¨¡å—çš„æµ‹è¯•ç”¨ä¾‹åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼Œå°†ä¾æ¬¡è¿›è¡Œåˆ†æï¼š</p>
<ol>
<li>parse.spec.ts</li>
<li>compile.spec.ts</li>
<li>codegen.spec.ts</li>
<li>scopeId.spec.ts</li>
<li>transform.spec.ts</li>
<li>
<p>transforms/</p>
<ol>
<li>hoistStatic.spec.ts</li>
<li>noopDirectiveTransform.spec.ts</li>
<li>transformElement.spec.ts</li>
<li>transformExpressions.spec.ts</li>
<li>transformSlotOutlet.spec.ts</li>
<li>transformText.spec.ts</li>
<li>vBind.spec.ts</li>
<li>vFor.spec.ts</li>
<li>vIf.spec.ts</li>
<li>vModel.spec.ts</li>
<li>vOn.spec.ts</li>
<li>vOnce.spec.ts</li>
<li>vSlot.spec.ts</li>
</ol>
</li>
<li>utils.spec.ts</li>
<li>testUtils.ts</li>
</ol>
<h2 id="parsespects" style="position:relative;"><a href="#parsespects" aria-label="parsespects permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parse.spec.ts</h2>
<p>æµ‹è¯•ç”¨ä¾‹ç»“æ„ï¼šcompiler: parse</p>
<h3 id="element-å…ƒç´ æ ‡ç­¾è§£æ" style="position:relative;"><a href="#element-%E5%85%83%E7%B4%A0%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90" aria-label="element å…ƒç´ æ ‡ç­¾è§£æ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Element å…ƒç´ æ ‡ç­¾è§£æ</h3>
<h4 id="05-template-element-with-directives" style="position:relative;"><a href="#05-template-element-with-directives" aria-label="05 template element with directives permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>05-template element with directives</h4>
<p><span id="test-element-05"></span></p>
<p>è¿™ä¸ªç”¨ä¾‹å¼€å§‹æ¨¡æ¿çš„è§£æã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'template element with directives'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;template v-if="ok">&lt;/template>'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    tagType<span class="token operator">:</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">baseParse(&#39;&lt;template v-if=&quot;ok&quot;&gt;&lt;/template&gt;&#39;)</code> è§£æä¹‹åçš„ç»“æ„ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"children"</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token comment">// &lt;template> èŠ‚ç‚¹</span>
            <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">"ns"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">"tag"</span><span class="token operator">:</span><span class="token string">"template"</span><span class="token punctuation">,</span>
            <span class="token property">"tagType"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token property">"props"</span><span class="token operator">:</span><span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// DIRECTIVE</span>
                    <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"if"</span><span class="token punctuation">,</span>
                    <span class="token property">"exp"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                        <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// SIMPLE_EXPRESSION</span>
                        <span class="token property">"content"</span><span class="token operator">:</span><span class="token string">"ok"</span><span class="token punctuation">,</span>
                        <span class="token property">"isStatic"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">"isConstant"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">"loc"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                            <span class="token comment">// ... çœç•¥</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">"modifiers"</span><span class="token operator">:</span><span class="token punctuation">[</span>
											 <span class="token comment">// ä¿®é¥°ç¬¦</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token property">"loc"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                        <span class="token comment">// çœç•¥</span>
                        <span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"v-if="</span>ok<span class="token string">""</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// ... çœç•¥</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ... çœå»</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ä¸ºäº†èƒ½è§£æå‡º <code class="language-text">v-if=&quot;ok&quot;</code> æˆ‘ä»¬éœ€è¦å»å®ç° <a href="#parse-parseattributes">parseAttributes(context, type)</a> -> <a href="#parse-parseattribute">parseAttribute</a> -> <a href="#parse-parseattributevalue">parseAttributeValue</a></p>
<p>è¯¥ç”¨ä¾‹è€ƒå¯Ÿçš„å…¶å®å¹¶ä¸æ˜¯ <code class="language-text">&lt;template&gt;</code> æ¨¡æ¿æ ‡ç­¾è§£æï¼Œè€Œæ˜¯æ ‡ç­¾ä¸Šçš„å±æ€§è§£æï¼Œå¯¹æ™®é€šçš„ <code class="language-text">&lt;div&gt;</code> æ ‡ç­¾ä¾ç„¶å¯ä»¥è§£æå‡ºå±æ€§ props[]ã€‚</p>
<h4 id="04-void-element" style="position:relative;"><a href="#04-void-element" aria-label="04 void element permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>04-void element</h4>
<p><span id="test-element-04"></span></p>
<p>ç©ºæ ‡ç­¾è§£æï¼Œå¦‚ï¼š<code class="language-text">&lt;img&gt;</code> </p>
<p>å‰ææ˜¯æä¾›äº† <code class="language-text">isVoidTag()</code> é€‰é¡¹ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'void element'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;img>after'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">isVoidTag</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span> <span class="token operator">=></span> tag <span class="token operator">===</span> <span class="token string">'img'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token operator">:</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token string">'img'</span><span class="token punctuation">,</span>
    tagType<span class="token operator">:</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'&lt;img>'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¯¥ç”¨ä¾‹å’Œ<a href="#test-element-03">è‡ªé—­æ ‡ç­¾</a>ç±»ä¼¼éƒ½æ˜¯åœ¨ <a href="#parse-parsetag">parseTag</a> è§£æå®Œä¹‹ååœ¨ <a href="#parse-parseelement">parseElement</a> ä¸­ç»“æŸè§£æï¼Œä¸åŒç‚¹åœ¨äºè°ƒç”¨ <a href="#parse-baseparse">baseParse</a> çš„æ—¶å€™éœ€è¦ä¼ é€’ä¸€ä¸ªåŒ…å« <code class="language-text">isVoidTag()</code> çš„é€‰é¡¹ <code class="language-text">{ isVoidTag: tag =&gt; tag === &#39;img&#39;}</code> ç”¨æ¥å‘Šè¯‰è§£æå™¨ä»€ä¹ˆæ ·çš„æ ‡ç­¾å±äºç©ºæ ‡ç­¾ï¼Œå³ä¸æ˜¯ <code class="language-text">&lt;img/&gt;</code> ä¹Ÿä¸æ˜¯ <code class="language-text">&lt;div&gt;&lt;/div&gt;</code> ç±»å‹ã€‚</p>
<p><a href="#parse-parseelement">parseElement</a> ä¸­è§£ææ¡ä»¶ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... parseTag ä¸­è§£æ &lt;img ...></span>
  <span class="token comment">// è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>isSelfClosing <span class="token operator">||</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>isVoidTag<span class="token operator">?.</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> element
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="03-self-closing" style="position:relative;"><a href="#03-self-closing" aria-label="03 self closing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>03-self closing</h4>
<p><span id="test-element-03"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'self closing'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;div/>after'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token operator">:</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    tagType<span class="token operator">:</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    isSelfClosing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'&lt;div/>'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="02-empty-div" style="position:relative;"><a href="#02-empty-div" aria-label="02 empty div permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>02-empty div</h4>
<p><span id="test-element-02"></span></p>
<p>å’Œ <a href="#test-element-01">01-simple div</a> ä¸€æ ·ï¼Œæ— éå°±æ˜¯æ²¡æœ‰ <code class="language-text">children[]</code> å­èŠ‚ç‚¹äº†ã€‚åœ¨ <a href="#parse-parseelement">parseElement</a> -> <a href="#parse-parsetag">parseTag</a> è§£æå°±ç»“æŸäº†ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'empty div'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;div>&lt;/div>'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token operator">:</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    tagType<span class="token operator">:</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'&lt;div>&lt;/div>'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="01-simple-div" style="position:relative;"><a href="#01-simple-div" aria-label="01 simple div permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>01-simple div</h4>
<p><span id="test-element-01"></span></p>
<p>è§£æç»“æœæµç¨‹å›¾(xmind ç”»æµç¨‹å›¾çœŸå®lowçš„ä¸è¡Œï¼ŒğŸ˜…)ï¼š</p>
<p><img src="http://qiniu.ii6g.com/parse-test-element--01.png?imageMogr2/thumbnail/!100p"></p>
<p>drawer.io æµç¨‹å›¾ï¼š</p>
<p><img src="http://qiniu.ii6g.com/test-parse-simple-tag.png?imageMogr2/thumbnail/!100p"></p>
<p>å› ä¸º <a href="#parse-parseelement">parseElement</a> å·²ç»å®ç°ï¼Œå› æ­¤è¿™ä¸ªé¡ºåˆ©é€šè¿‡ï¼Œ<code class="language-text">parseElement</code> è§£æå…ˆæ£€æµ‹ <code class="language-text">&lt;/div&gt;</code> ç»“æŸæ ‡ç­¾ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºéæ³•æ— ç»“æŸæ ‡ç­¾è§¦å‘ <code class="language-text">ErrorCodes.EOF_IN_TAG</code> å¼‚å¸¸ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'simple div'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;div>hello&lt;/div>'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token operator">:</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    tagType<span class="token operator">:</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// &lt;div åä¸º > ä¸ºéè‡ªé—­åˆæ ‡ç­¾</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
        loc<span class="token operator">:</span> <span class="token punctuation">{</span>
          start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// h ä½ç½®ç´¢å¼•</span>
          end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">11</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// o ä½ç½®ç´¢å¼•</span>
          source<span class="token operator">:</span> <span class="token string">'hello'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">17</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// é‡åˆ°&lt;div> ä¼šç›´æ¥åˆ¤æ–­æ˜¯å¦æœ‰ &lt;/div> ç„¶åæˆªå–`&lt;div>...&lt;/div></span>
      source<span class="token operator">:</span> <span class="token string">'&lt;div>hello&lt;/div>'</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>æ ‡ç­¾çš„è§£æåœ¨ <a href="#parse-parsetag">parseTag</a> ä¸­å®Œæˆï¼Œ å¦‚æœæ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œä¼šç½®æ ‡å¿—ä½ <code class="language-text">isSelfClosing = true</code>ã€‚</p>
<p>å¹¶ä¸”è§£ææ ‡ç­¾åªä¼šè§£æåˆ° <code class="language-text">&lt;div&gt;</code> ä¸­çš„ <code class="language-text">&lt;div</code> éƒ¨åˆ†å°±ç»“æŸï¼Œæ˜¯å› ä¸ºéœ€è¦æ£€æµ‹åé¢æ˜¯ <code class="language-text">&gt;</code> è¿˜æ˜¯ <code class="language-text">/&gt;</code> å¦‚æœæ˜¯ <code class="language-text">/&gt;</code> åˆ™ä¸ºè‡ªé—­åˆæ ‡ç­¾éœ€è¦åŒºåˆ†å¤„ç†ï¼Œå› æ­¤è¿™é‡Œä¼šæœ‰ä¸ªåˆ¤æ–­æ¥å†³å®š <code class="language-text">advanceBy</code> 1 æˆ– 2 ä¸ªæŒ‡é’ˆä½ç½®ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// parseTag</span>
<span class="token keyword">let</span> isSelfClosing <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_TAG</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// some &lt;div> ... &lt;/div> åˆ°è¿™é‡Œçš„ source = > ... &lt;/div></span>
  <span class="token comment">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /> å¼€å¤´çš„</span>
  isSelfClosing <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/>'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End <span class="token operator">&amp;&amp;</span> isSelfClosing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/>)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(>)</span>
  <span class="token comment">// åˆ°è¿™é‡Œ source = ... &lt;/div></span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="comment-æ³¨é‡Šè§£æ" style="position:relative;"><a href="#comment-%E6%B3%A8%E9%87%8A%E8%A7%A3%E6%9E%90" aria-label="comment æ³¨é‡Šè§£æ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Comment æ³¨é‡Šè§£æ</h3>
<p>æ³¨é‡Šé£æ ¼ï¼š<code class="language-text">&lt;!-- ... --&gt;</code>ï¼Œ<a href="#link-05">é˜¶æ®µ5</a> åŠä¹‹å‰è¿˜ä¸æ”¯æŒæ³¨é‡Šè§£æï¼Œå› ä¸ºè¿˜æ²¡å®ç° <a href="#parse-parsecomment">parseComment</a>ã€‚</p>
<p>æ³¨é‡Šæµ‹è¯•ç”¨ä¾‹ä¸å­˜åœ¨é˜¶æ®µæ€§çš„å®ç°ï¼Œåªè¦å®ç°äº† <a href="#parse-parsecomment">parseComment</a> å°±é¥¿éƒ½å¯ä»¥é€šè¿‡äº†ï¼Œå› æ­¤è¿™é‡Œæ”¾åœ¨ä¸€èµ·é€šè¿‡è®°å½•ã€‚</p>
<ol>
<li><strong>empty comment</strong> ç©ºæ³¨é‡ŠèŠ‚ç‚¹</li>
<li><strong>simple comment</strong> æ­£å¸¸æ³¨é‡ŠèŠ‚ç‚¹</li>
<li><strong>two comments</strong> å¤šä¸ªæ³¨é‡ŠèŠ‚ç‚¹</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Comment'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'empty comment'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;!---->'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> comment <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'&lt;!---->'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// empty comment</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'simple comment'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;!--abc-->'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> comment <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">11</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'&lt;!--abc-->'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// simple comment</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'two comments'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;!--abc-->&lt;!--def-->'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> comment1 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> comment2 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>comment1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">11</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'&lt;!--abc-->'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comment2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'def'</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">11</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'&lt;!--def-->'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// two comments</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ªç”¨ä¾‹ï¼Œä¸€å¼€å§‹æµ‹è¯•å¹¶ä¸èƒ½é€šè¿‡ï¼Œæ˜¯å› ä¸ºå®ç° <a href="#parse-pushnode">pushNode</a> çš„æ—¶å€™å¿˜è®°åŠ ä¸Š <code class="language-text">__DEV__</code> ç¯å¢ƒæ£€æµ‹äº†ï¼Œå› ä¸ºç”Ÿäº§ç¯å¢ƒæ˜¯ä¸éœ€è¦ä¿å­˜æ³¨é‡ŠèŠ‚ç‚¹çš„ï¼Œå¼€å‘ç¯å¢ƒä¸ºäº†æµ‹è¯•éœ€è¦æœ‰è¿™ä¸ªä¿¡æ¯ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">pushNode</span><span class="token punctuation">(</span><span class="token parameter">nodes<span class="token punctuation">,</span> node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡ŒåŠ ä¸Š __DEV__ æ£€æµ‹ï¼Œå¼€å‘çš„æ—¶å€™è¿˜æ˜¯éœ€è¦çš„</span>
  <span class="token comment">// ä¸ç„¶ç”¨ä¾‹ä¼šé€šä¸è¿‡ï¼Œå› ä¸ºè¿™é‡Œç›´æ¥è¿”å› Undefined äº†ï¼Œå¯¼è‡´</span>
  <span class="token comment">// parent.children[] é‡Œé¢å¹¶ä¸å­˜åœ¨è¿™ä¸ªæ³¨é‡ŠèŠ‚ç‚¹</span>
  <span class="token comment">// åŠ ä¸Šå°±å¥½äº†</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__DEV__ <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ³¨é‡ŠèŠ‚ç‚¹ä¸å¤„ç†</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

 <span class="token comment">// ... çœç•¥</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="interpolation-æ’å€¼è§£æ" style="position:relative;"><a href="#interpolation-%E6%8F%92%E5%80%BC%E8%A7%A3%E6%9E%90" aria-label="interpolation æ’å€¼è§£æ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interpolation æ’å€¼è§£æ</h3>
<h4 id="05-custom-delimiters" style="position:relative;"><a href="#05-custom-delimiters" aria-label="05 custom delimiters permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>05-custom delimiters</h4>
<p><span id="test-interpolation-05"></span></p>
<p>è‡ªå®šä¹‰æ’å€¼åˆ†éš”ç¬¦ï¼Œå…¶å®å¤„ç†æµç¨‹å’Œæ’å€¼å¤„ç†ä¸€æ ·ï¼Œæ‰€ä»¥æ²¡å•¥å¥½è®²çš„ï¼Œ<a href="#link-04">é˜¶æ®µä»£ç 4</a> å°±æ”¯æŒè¯¥ç”¨ä¾‹é€šè¿‡ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'custom delimiters'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;p>{msg}&lt;/p>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    delimiters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'{'</span><span class="token punctuation">,</span> <span class="token string">'}'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> interpolation <span class="token operator">=</span> element<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>interpolation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">msg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'msg'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'{msg}'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h4 id="04-it-can-have-tag-like-notation-3" style="position:relative;"><a href="#04-it-can-have-tag-like-notation-3" aria-label="04 it can have tag like notation 3 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>04-it can have tag-like notation (3)</h4>
<p><span id="test-interpolation-04"></span></p>
<p>å‰é¢çš„ä¸¤ä¸ªç”¨ä¾‹å·²ç»è§£é‡Šè¿‡äº†ï¼Œæ’å€¼é‡Œé¢çš„å†…å®¹ä¼šåœ¨ <a href="#parse-parseinterpolation">parseInterpolation</a> ä¸­ç›´æ¥å¤„ç†æˆæ’å€¼çš„æ¨¡æ¿(source)ï¼Œä¸ä¼šè¿›å…¥åˆ° while å¾ªç¯è§¦å‘å¼‚å¸¸ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'it can have tag-like notation (3)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'&lt;div>{{ "&lt;/div>" }}&lt;/div>'</span><span class="token punctuation">)</span>
  <span class="token comment">// è¿™é‡Œè§£æå‡ºæ¥çš„æ˜¯ &lt;div>&lt;/div> è¿™ä¸ªå…ƒç´ èŠ‚ç‚¹</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> ElementNode 
  <span class="token comment">// æ ‡ç­¾å†…éƒ¨çš„æ‰€æœ‰å†…å®¹åœ¨è§£æä¹‹åä¼šè¢«å½“åšå­èŠ‚ç‚¹å­˜æ”¾åˆ° children[] æ•°ç»„ä¸­</span>
  <span class="token comment">// å› æ­¤è¿™é‡Œç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹æ˜¯ä¸ªæ’å€¼æ¨¡æ¿</span>
  <span class="token keyword">const</span> interpolation <span class="token operator">=</span> element<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> InterpolationNode

  <span class="token function">expect</span><span class="token punctuation">(</span>interpolation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">// The `isConstant` is the default value and will be determined in `transformExpression`.</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'"&lt;/div>"'</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">17</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'"&lt;/div>"'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">19</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'{{ "&lt;/div>" }}'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h4 id="03-it-can-have-tag-like-notation2" style="position:relative;"><a href="#03-it-can-have-tag-like-notation2" aria-label="03 it can have tag like notation2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>03-it can have tag-like notation(2)</h4>
<p><span id="test-interpolation-03"></span></p>
<p>è¿™ä¸ªç”¨ä¾‹å…¶å®å’Œ <a href="#test-interpolation-02">ç”¨ä¾‹2</a> æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯è§£æäº†ä¸¤ä¸ªæ’å€¼è€Œå·²ï¼Œå…ˆè§£æ <code class="language-text">{{ a&lt;b }}</code> ï¼Œæœ€åå‰©ä¸‹çš„ <code class="language-text">{{ c&gt;d }}</code> ä¼šåœ¨é€€å‡º <a href="#parse-parseinterpolation">parseInterpolation</a> ä¹‹åå‰©ä½™çš„ context.source ä¸º <code class="language-text">{{ c&gt;d }}</code>åœ¨ <a href="#parse-parsechildren">parseChildren</a> é‡Œé¢ç»§ç»­è¿›è¡Œ while å¾ªç¯å¤„ç†ï¼Œéšåˆæ£€æµ‹åˆ°æ˜¯æ’å€¼å†æ¬¡è°ƒç”¨ <code class="language-text">parseInterpolation</code> è¿›è¡Œå¤„ç†å¾—åˆ°ç¬¬äºŒä¸ªæ’å€¼èŠ‚ç‚¹ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'it can have tag-like notation (2)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'{{ a&lt;b }}{{ c>d }}'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> interpolation1 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> InterpolationNode
  <span class="token keyword">const</span> interpolation2 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> InterpolationNode

  <span class="token function">expect</span><span class="token punctuation">(</span>interpolation1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">a&lt;b</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'a&lt;b'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'{{ a&lt;b }}'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>interpolation2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'c>d'</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">16</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'c>d'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">19</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'{{ c>d }}'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a href="#link-04">æ”¯æŒè¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ğŸ›¬</a></p>
<h4 id="02-it-can-have-tag-like-notation1" style="position:relative;"><a href="#02-it-can-have-tag-like-notation1" aria-label="02 it can have tag like notation1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>02-it can have tag-like notation(1)</h4>
<p><span id="test-interpolation-02"></span></p>
<p>è¯¥ç”¨ä¾‹é‡Œé¢è™½ç„¶æœ‰ <code class="language-text">&lt;</code> ç¬¦å·ï¼Œä½†æ˜¯ç”±äºæ˜¯åœ¨æ’å€¼å†…éƒ¨ï¼Œä¼šè¿›å…¥ <a href="#parse-parseinterpolation">parseInterpolation</a> ä¹‹åå°±è¢«è§£ææˆæ’å€¼çš„ sourceï¼Œå¹¶ä¸ä¼šè¿›å…¥ while é‡Œé¢çš„ä½œä¸ºæ ‡ç­¾çš„å¼€å§‹ <code class="language-text">&lt;</code> æ¥è§£æã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'it can have tag-like notation'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'{{ a&lt;b }}'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> interpolation <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>interpolation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">a&lt;b</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// content = preTrimContent.trim() å»æ‰å‰åç©ºæ ¼</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token string">'a&lt;b'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'{{ a&lt;b }}'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p><a href="#link-04">é€šè¿‡è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ğŸ›¬</a></p>
<h4 id="01--simple-interpolation" style="position:relative;"><a href="#01--simple-interpolation" aria-label="01  simple interpolation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>01- simple interpolation</h4>
<p><span id="test-interpolation-01"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'simple interpolation'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'{{message}}'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> interpolation <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>interpolation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">message</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// m ä½ç½®</span>
        end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// æœ€åä¸€ä¸ª e ä½ç½®</span>
        source<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">message</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// ç¬¬ä¸€ä¸ª { ä½ç½®</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// æœ€åä¸€ä¸ª } ä½ç½®</span>
      source<span class="token operator">:</span> <span class="token string">'{{message}}'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="text-æ–‡æœ¬è§£æ" style="position:relative;"><a href="#text-%E6%96%87%E6%9C%AC%E8%A7%A3%E6%9E%90" aria-label="text æ–‡æœ¬è§£æ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Text æ–‡æœ¬è§£æ</h3>
<h4 id="07-lonly--dont-separate-nodes" style="position:relative;"><a href="#07-lonly--dont-separate-nodes" aria-label="07 lonly  dont separate nodes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>07-lonly â€{{â€ donâ€™t separate nodes</h4>
<p><span id="test-text-06"></span></p>
<p>è¿™ä¸ªç”¨ä¾‹æ˜¯ç”¨æ¥æ£€æµ‹æ’å€¼ä¸å®Œæ•´çš„æƒ…å†µï¼Œæ­£å¸¸ä¼šçˆ†å‡º <code class="language-text">X_MISSING_INTERPOLATION_END</code> å¼‚å¸¸ï¼Œåœ¨è¯¥ç”¨ä¾‹ä¸­é‡å†™äº†è¯¥å¼‚å¸¸å¤„ç†ï¼Œå› æ­¤ä¸ä¼šæŠ¥é”™ï¼Œç”¨ä¾‹ä¼šå¾ˆé¡ºåˆ©é€šè¿‡ï¼Œå› ä¸ºæ²¡æœ‰å¼‚å¸¸ï¼Œ <a href="#parse-parseinterpolation">parseInterpolation</a> ä¼šé€€å‡ºï¼Œæœ€å <code class="language-text">{{</code> ä¼šè¢«å½“åšæ™®é€šæ–‡æœ¬å†…å®¹å¤„ç†ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'lonly "{{" don\'t separate nodes'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'a {{ b'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code <span class="token operator">!==</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_INTERPOLATION_END</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> error
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">'a {{ b'</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'a {{ b'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// lonly "{{" don\'t separate nodes</span></code></pre></div>
<p><a href="#parse-parseInterpolation">parseInterpolation</a> è¯¥ç”¨ä¾‹å¤„ç†ä»£ç ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ‰¾å‡ºæ’å€¼æ¨¡æ¿çš„å¼€å§‹å’Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯ {{ å’Œ }}</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>open<span class="token punctuation">,</span> close<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters
  <span class="token keyword">const</span> closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span> open<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œæ£€æµ‹åˆ°æ²¡æœ‰ }} é€€å‡ºï¼Œå¹¶ä¸”åˆ°è¿™é‡Œ context æŒ‡é’ˆä¿¡æ¯å¹¶æ²¡æœ‰æ”¹å˜</span>
    <span class="token comment">// å› æ­¤é€€å‡ºä¹‹åï¼Œé‡æ–° while æœ€åè¿›å…¥æ–‡æœ¬è§£æ parseText</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_INTERPOLATION_END</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ... çœç•¥</span>
<span class="token punctuation">}</span></code></pre></div>
<p>test:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">âœ  packages git:(master) âœ— jest compiler-core
 PASS  compiler-core/__tests__/parse.spec.js (19.233 s)
  compiler: parse
    Text
      âœ“ simple text (5 ms)
      âœ“ simple text with invalid end tag (2 ms)
      âœ“ text with interpolation (1 ms)
      âœ“ text with interpolation which has `&lt;` (1 ms)
      âœ“ text with mix of tags and interpolations (1 ms)
      âœ“ lonly &quot;&lt;&quot; don&#39;t separate nodes (7 ms)
      âœ“ lonly &quot;{{&quot; don&#39;t separate nodes

Test Suites: 1 passed, 1 total
Tests:       7 passed, 7 total
Snapshots:   0 total
Time:        23.277 s
Ran all test suites matching /compiler-core/i</code></pre></div>
<h4 id="06-lonly--dont-separate-nodes" style="position:relative;"><a href="#06-lonly--dont-separate-nodes" aria-label="06 lonly  dont separate nodes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>06-lonly â€&#x3C;â€ donâ€™t separate nodes</h4>
<p><span id="test-text-05"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'lonly "&lt;" don\'t separate nodes'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'a &lt; b'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">!==</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">'a &lt; b'</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'a &lt; b'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// lonly "&lt;" don\'t separate nodes</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¿™ä¸ªç”¨ä¾‹åœ¨å®ç°çš„ <a href="#test-text-05">test-05</a> ä¹‹åå°±å¯ä»¥é€šè¿‡ï¼Œå› ä¸º <code class="language-text">a &lt; b</code> å¹¶ä¸æ˜¯æ’å€¼ä¸€éƒ¨åˆ†ï¼Œä¼šè¢«å½“åšçº¯æ–‡æœ¬å¤„ç†ï¼Œè€Œä¸ºäº†é¿å…æŠ¥é”™ç”¨ä¾‹ä¸­é‡å†™äº† <code class="language-text">onError</code>ï¼Œå› ä¸º while å¾ªç¯é‡Œåœ¨æ£€æµ‹åˆ° <code class="language-text">&lt;</code> å¼€å¤´çš„ if æ¡ä»¶åˆ†æ”¯ä¸­ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸ºç©ºæ ¼çš„æƒ…å†µä¼šè¿›å…¥æœ€åçš„ else åˆ†æ”¯å¤„ç†ï¼Œå³è§¦å‘ <code class="language-text">INVALID_FIRST_CHARACTER_OF_TAG_NAME</code> å¼‚å¸¸ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... æ ‡ç­¾å¼€å¤´ &lt;...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_BEFORE_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO æ³¨é‡Šå¤„ç†ï¼Œ&lt;!-- ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¼šè¿›å…¥åˆ°è¿™é‡Œï¼Œè§¦å‘å¼‚å¸¸ï¼Œä½†æ˜¯ç”±äº options é‡Œæä¾›äº† onError é‡å†™äº†å®ƒ</span>
    <span class="token comment">// å› æ­¤è¿™é‡Œä¸ä¼šè§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯é€€å‡ºè¯¥åˆ†æ”¯è¿›å…¥ çº¯æ–‡æœ¬å¤„ç†ï¼Œåˆå¹¶æ–‡æœ¬ pushnode æ“ä½œ</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="05-text-with-mix-of-tags-and-interpolations" style="position:relative;"><a href="#05-text-with-mix-of-tags-and-interpolations" aria-label="05 text with mix of tags and interpolations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>05-text with mix of tags and interpolations</h4>
<p><span id="test-text-05"></span></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'text with mix of tags and interpolations'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'some &lt;span>{{ foo &lt; bar + foo }} text&lt;/span>'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> text1 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> TextNode
  <span class="token keyword">const</span> text2 <span class="token operator">=</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> ElementNode<span class="token punctuation">)</span><span class="token punctuation">.</span>children<span class="token operator">!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> TextNode

  <span class="token function">expect</span><span class="token punctuation">(</span>text1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">'some '</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'some '</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>text2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">' text'</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">33</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">38</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">' text'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¿™æ˜¯ä¸ªæ ‡ç­¾+æ’å€¼æ··åˆæ¨¡æ¿ï¼Œç°é˜¶æ®µçš„ä»£ç æ˜¯é€šä¸è¿‡è¯¥æµ‹è¯•çš„ï¼Œå› ä¸ºå®ƒä¼šè¿›å…¥åˆ°ä¸‹é¢è¿™ä¸ªåˆ†æ”¯ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???</span>
  <span class="token comment">// åˆ°è¿™é‡Œå°±ä¼šæŠ¥é”™</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_INVALID_END_TAG</span><span class="token punctuation">)</span>
  <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token keyword">continue</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code></pre></div>
<p>å¦‚æ§åˆ¶å°è¾“å‡ºï¼š</p>
<p><img src="http://qiniu.ii6g.com/1596638044.png?imageMogr2/thumbnail/!100p"></p>
<p>é”™è¯¯ä¸Šé¢çš„è¾“å‡ºå…¶å®æ˜¯ }} å’Œ {{ çš„è§£æä½ç½®ä¿¡æ¯ï¼Œå¹¶ä¸” <code class="language-text">&lt;div&gt;</code> å¹¶æ²¡æœ‰è§£ææ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡å®ç° <a href="#parse-parseelement">parseElement</a> åˆ†æ”¯é€»è¾‘ï¼Œæ‰€ä»¥ç›´æ¥è¿‡æ»¤æ‰å½“æˆæ–‡æœ¬å¤„ç†äº†ã€‚</p>
<ol>
<li><font color="blue">å³è¾¹ï¼š offset=14 åˆšå¥½æ˜¯ <code class="language-text">some &lt;span&gt;{{</code> å­—ç¬¦ä¸²é•¿åº¦ + 1 å³æ’å€¼å†…ç¬¬ä¸€ä¸ªç©ºæ ¼çš„ä½ç½®</font></li>
<li><font color="blue">å·¦è¾¹ï¼šoffset=29 åˆšå¥½æ˜¯ 14 + <code class="language-text">foo &lt; bar + foo</code> é•¿åº¦ä½ç½®(slice ä¸åŒ…å« endIdx)ï¼Œ å³æ’å€¼å†…æœ€åä¸€ä¸ªç©ºæ ¼çš„ä½ç½®</font></li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¾—çœ‹ä¸‹æ€ä¹ˆä¸æŠ¥é”™èƒ½è§£æ <code class="language-text">&lt;/div&gt;</code> ã€‚</p>
<p><font color="green"><em>å¤§æ¦‚çš„çŒœæƒ³æ˜¯åœ¨è§£æ <code class="language-text">&lt;div&gt;</code>çš„æ—¶å€™å‘ç°æ˜¯æ ‡ç­¾ï¼Œå¯èƒ½ä¼šé‡å†™ <code class="language-text">onError</code> ï¼Œé¿å…åœ¨è§£æ <code class="language-text">&lt;/div&gt;</code> è§¦å‘å¼‚å¸¸ï¼Œè€Œæ˜¯è¿›å…¥ <a href="#parse-parsetag">parseTag</a> è§£æç»“æŸæ ‡ç­¾ã€‚ä½†å¾ˆå¯æƒœä¸æ˜¯è¿™æ ·ï¼Œè€Œæ˜¯åœ¨ <a href="#parse-parselement">parseElement</a> ä¸­é€’å½’è°ƒç”¨ <a href="#parse-parsechildren">parseChildren</a> è§£ææ ‡ç­¾å†…éƒ¨çš„æ¨¡æ¿ï¼Œè§£æå®Œæˆä¹‹åæ£€æµ‹ç»“æŸæ ‡ç­¾ï¼Œæ— ç»“æŸæ ‡ç­¾ï¼Œéæ³•å¼‚å¸¸ï¼Œå…·ä½“å®ç°è¯·çœ‹ <a href="#parse-parseelement">parseElementæºç å®ç°</a>ã€‚</em></font></p>
<p>åœ¨å®ç°äº† <a href="#parse-parseelement">parseElement</a> å’Œéƒ¨åˆ† <a href="#parse-parsetag">parseTag</a> ä¹‹åç”¨ä¾‹é€šè¿‡ï¼š</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">âœ  packages git:(master) âœ— jest compiler-core
 PASS  compiler-core/__tests__/parse.spec.js (14.492 s)
  compiler: parse
    Text
      âœ“ simple text (5 ms)
      âœ“ simple text with invalid end tag (2 ms)
      âœ“ text with interpolation (2 ms)
      âœ“ text with interpolation which has `&lt;` (1 ms)
      âœ“ text with mix of tags and interpolations (2 ms)

Test Suites: 1 passed, 1 total
Tests:       5 passed, 5 total
Snapshots:   0 total
Time:        15.743 s
Ran all test suites matching /compiler-core/i.</code></pre></div>
<p>æœŸé—´ç¢°åˆ°ä¸ªé—®é¢˜ï¼š</p>
<blockquote>
<p>Cannot find module â€˜core-js/modules/es6.string.iteratorâ€™ from â€˜packages/compiler-core/parse.jsâ€™</p>
</blockquote>
<p>è§£å†³æ–¹æ¡ˆï¼š<a href="https://github.com/babel/babel/issues/9796">æ˜¯ core-js é™çº§åˆ° 2</a></p>
<h4 id="04-text-with-interpolation-which-has-" style="position:relative;"><a href="#04-text-with-interpolation-which-has-" aria-label="04 text with interpolation which has  permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>04-text with interpolation which has <code class="language-text">&lt;</code></h4>
<p><span id="test-text-04"></span></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'text with interpolation which has `&lt;`'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'some {{ a&lt;b &amp;&amp; c>d }} text'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> text1 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> TextNode
  <span class="token keyword">const</span> text2 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> TextNode

  <span class="token function">expect</span><span class="token punctuation">(</span>text1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">'some '</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'some '</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>text2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">' text'</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">22</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">27</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">' text'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>è¿™ä¸ªç”¨ä¾‹å…¶å®å’Œ <a href="#test-text-03">03-text with interpolation</a> ç”¨ä¾‹åŸç†ä¸€æ ·ï¼Œè™½ç„¶æ’å€¼é‡Œé¢æœ‰ç‰¹æ®Šå­—ç¬¦ <code class="language-text">&lt;</code>ï¼Œä½†æ˜¯ç”±äºåœ¨ <a href="#parse-parseInterpolation">parseInterpolation</a> å‡½æ•°è§£æè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡æˆªå– {{ åˆ° }} ç›´æ¥çš„å…¨éƒ¨å­—ç¬¦ä¸²å»è§£æçš„ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes</span>
<span class="token punctuation">)</span><span class="token operator">:</span> InterpolationNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... çœç•¥</span>
  
  <span class="token comment">// ä¹Ÿå°±æ˜¯è¿™ä¸¤è¡Œï¼Œå°† {{ ... }} å†…çš„æ‰€æœ‰å†…å®¹ä¸€æ¬¡æ€§å–å‡ºæ¥è§£æäº†ï¼Œå› æ­¤å¹¶ä¸ä¼š</span>
  <span class="token comment">// è¿›å…¥åˆ° parseChildren çš„ while å¾ªç¯ä¸­å¤„ç†ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¼‚å¸¸æƒ…å†µ</span>
  <span class="token keyword">const</span> rawContentLength <span class="token operator">=</span> closeIndex <span class="token operator">-</span> open<span class="token punctuation">.</span>length
  <span class="token keyword">const</span> rawContent <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rawContentLength<span class="token punctuation">)</span>
  
  <span class="token comment">// ... çœç•¥</span>
<span class="token punctuation">}</span></code></pre></div>
<p>æ‰€ä»¥è¿™ä¸ªç”¨ä¾‹ä¼šå¾ˆé¡ºåˆ©çš„é€šè¿‡(åœ¨ 03 ç”¨ä¾‹é€šè¿‡çš„å‰æä¸‹)ã€‚</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"> PASS  packages/compiler-core/__tests__/parse.spec.js (5.375 s)
  compiler: parse
    Text
      âœ“ simple text (5 ms)
      âœ“ simple text with invalid end tag (3 ms)
      âœ“ text with interpolation (41 ms)
      âœ“ text with interpolation which has `&lt;` (3 ms)</code></pre></div>
<h4 id="03-text-with-interpolation" style="position:relative;"><a href="#03-text-with-interpolation" aria-label="03 text with interpolation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>03-text with interpolation</h4>
<p><span id="test-text-03"></span></p>
<p><a href="#link-04">è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥ -></a></p>
<p>è¯¥ç”¨ä¾‹æ£€éªŒçš„å·®å€¼çš„å¤„ç†ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"text with interpolation"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">"some {{ foo + bar }} text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> text1 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        text2 <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>text1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">"some "</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">"some "</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>text2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">" text"</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">" text"</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">26</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å·®å€¼çš„å¤„ç†åˆ†æ”¯åœ¨ parseChildren çš„ </p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// '{{'</span>
  node <span class="token operator">=</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å®Œæˆï¼Œå› ä¸ºéœ€è¦ <a href="#parse-parseInterpolation">parseInterpolation()</a> çš„æ”¯æŒã€‚</p>
<p>ç”¨ä¾‹ç»“æœ(<font color="green">OK</font>)ï¼š</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">âœ  vue-next-code-read git:(master) âœ— jest parse.spec
 PASS  packages/compiler-core/__tests__/parse.spec.js
  compiler: parse
    Text
      âœ“ simple text (4 ms)
      âœ“ simple text with invalid end tag (2 ms)
      âœ“ text with interpolation (47 ms)

  console.log
    { column: 18, line: 1, offset: 17 } { column: 9, line: 1, offset: 8 } 1

      at parseInterpolation (packages/compiler-core/parse.js:262:11)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        8.776 s
Ran all test suites matching /parse.spec/i.
âœ  vue-next-code-read git:(master) âœ—</code></pre></div>
<h4 id="02-simple-textdiv" style="position:relative;"><a href="#02-simple-textdiv" aria-label="02 simple textdiv permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>02-simple text&#x3C;div></h4>
<p><span id="test-text-02"></span></p>
<p><a href="#link-03">è¯¥ç”¨ä¾‹ä»£ç é“¾æ¥-></a></p>
<p>åœ¨è·‘è¿™ä¸ªç”¨ä¾‹çš„æ—¶å€™å‡ºç°å†…å­˜æº¢å‡ºäº†ï¼ŒæŸ¥äº†ä¸‹åŸå› æ˜¯å› ä¸ºåªæ˜¯<a href="#link-02">å¢åŠ äº† while é‡Œé¢çš„å„ç§ if åˆ†æ”¯</a>ï¼Œä½†æ˜¯å®é™…å¹¶æ²¡æœ‰å®ç°ï¼Œè¿™ä¸ªç”¨ä¾‹ä¼šèµ°åˆ° </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"&lt;"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... æ ‡ç­¾å¼€å¤´ &lt;...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_BEFORE_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"!"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO æ³¨é‡Šå¤„ç†ï¼Œ&lt;!-- ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &lt;/...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_BEFORE_TAG_NAME</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">">"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¼šèµ°åˆ°è¿™ä¸ªåˆ†æ”¯é‡Œé¢ï¼Œä½†æ˜¯ç”±äºä¸‹é¢çš„ parseTag æœªå®ç°ï¼Œå› æ­¤ä¸€ç›´åœ¨è¿™ä¸ªåˆ†æ”¯é‡Œé¢å¾ªç¯</span>
      <span class="token comment">// åŠ ä¸Šç”¨ä¾‹é‡Œé¢é‡å†™äº† onError ä¸ä¼š throw err ç»ˆæ­¢ï¼Œå› æ­¤ä¼šå‡ºç°æ­»å¾ªç¯</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_INVALID_END_TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ä½†æ˜¯ä¸Šé¢éƒ½æŠ¥é”™äº†ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦åŠ ä¸ª parseTag??? æ­£å¸¸ç†è§£åº”è¯¥æ˜¯èµ°ä¸åˆ°è¿™é‡Œå•Š</span>
      <span class="token comment">// é™¤éæœ‰é‡å†™ onError æŠ¥é”™æœºåˆ¶???</span>
      <span class="token comment">// parseTag(context, TagType.End, parent);</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>å› æ­¤è¦é€šè¿‡è¿™ä¸ªç”¨ä¾‹ï¼Œå°±å¿…é¡»å¾—å®ç° <code class="language-text">parseTag(context, TagType.End, parent)</code> å‡½æ•°è§£ææ ‡ç­¾ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"simple text with invalid end tag"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> onError <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">"some text&lt;/div>"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    onError<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>onError<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">"some text"</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">"some text"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å› ä¸º baseparse è°ƒç”¨çš„æ—¶å€™æœ‰ä¼ é€’ onError è¦†ç›–æŠ¥é”™ä»£ç ï¼Œä¼šè¿›å…¥åˆ° parseTag è¿›è¡Œè§£ææ ‡ç­¾ï¼Œå¦‚æœä¸å®ç°ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚å› æ­¤è¿™é‡Œè¦é€šè¿‡è¿™ä¸ªç”¨ä¾‹å°±å¿…é¡»å®ç° <a href="#parse-parsetag">parseTag()</a>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> type<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åŒ¹é… &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ > ç»™å¿½ç•¥æ‰???</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^&lt;\/?([a-z][^\t\r\n\f />]*)/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ns <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div> çš„æœ€æœ‰ä¸€ä¸ª > ä¸Š</span>
  <span class="token comment">// åœ¨è¿™é‡Œ context.offset = 10, context.line = 1</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿‡æ»¤æ‰ç©ºæ ¼</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// log2: ç»è¿‡ advanceä¹‹å context.offset = 15, context.line = 1</span>
  <span class="token comment">// æ­£å¥½è¿‡æ»¤ &lt;/div 5ä¸ªå­—ç¬¦</span>
  <span class="token keyword">const</span> cursor <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> currSource <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>parseTag å®ç°åˆ°è¿™é‡Œå°±å¯ä»¥æ»¡è¶³é€šè¿‡æµ‹è¯•ç”¨ä¾‹çš„æ¡ä»¶äº†ï¼Œè¿™é‡Œé¢ä¼šå»åŒ¹é… <code class="language-text">&lt;/div</code> ç„¶åå°†å…¶è¿‡æ»¤æ‰(é€šè¿‡advanceByå’Œ advanceSpaces æ¥æ”¹å˜ context é‡Œé¢çš„ offset å’Œ line å€¼)ï¼Œè¾“å‡ºç»“æœ(log1 å’Œ log2 ä½ç½® context çš„è¾“å‡º)ï¼š</p>
<p><img src="http://qiniu.ii6g.com/1595444610.png?imageMogr2/thumbnail/!100p"></p>
<h4 id="span-idtest-text-0101-simple-text" style="position:relative;"><a href="#span-idtest-text-0101-simple-text" aria-label="span idtest text 0101 simple text permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span id="test-text-01">01-simple text</h4>
<p>è¿™é‡Œç”¨åˆ°çš„å°±ä¸€ä¸ª baseParse å‡½æ•°ï¼Œéœ€è¦æˆ‘ä»¬æ¥å®ç°å…¶åŸºæœ¬çš„åŠŸèƒ½ä»¥é€šè¿‡è¯¥ç”¨ä¾‹ã€‚</p>
<p>ç”¨ä¾‹æºç ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'simple text'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token string">'some text'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> ast<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> TextNode

  <span class="token function">expect</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token string">'some text'</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token punctuation">{</span>
      start<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      end<span class="token operator">:</span> <span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      source<span class="token operator">:</span> <span class="token string">'some text'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/test-01-some-text">ç”¨ä¾‹çš„åŸºæœ¬åŠŸèƒ½ï¼ŒéªŒè¯ baseParse è§£æå‡ºæ¥çš„æ–‡æœ¬èŠ‚ç‚¹å¯¹è±¡æ˜¯å¦æ»¡è¶³åŸºæœ¬è¦æ±‚</a>ã€‚	</p>
<p>æ”¯æŒè¯¥ç”¨ä¾‹çš„é‡è¦éƒ¨åˆ†ä»£ç ï¼š</p>
<ol>
<li>
<p>createParseContext æ„å»ºè¢«è§£æçš„å†…å®¹çš„å¯¹è±¡ç»“æ„</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token comment">/*ParserContext*/</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token punctuation">{</span>
   options<span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>defaultParserOptions<span class="token punctuation">,</span>
     <span class="token operator">...</span>options<span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token comment">// åˆå§‹åŒ–ä»¥ä¸‹å†…å®¹</span>
   column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   originalSource<span class="token operator">:</span> context<span class="token punctuation">,</span>
   source<span class="token operator">:</span> context<span class="token punctuation">,</span>
   inPref<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
   inVPref<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>parseChildren</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>
 context <span class="token comment">/* ParserContext*/</span><span class="token punctuation">,</span>
 mode <span class="token comment">/*TextModes*/</span><span class="token punctuation">,</span>
 ancesotrs <span class="token comment">/*ElementNode[]*/</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>
 <span class="token keyword">const</span> nodes <span class="token comment">/*TemplateChildNode[]*/</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancesotrs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// do sth</span>

   <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
   <span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

   <span class="token comment">// ç”±äº baseparseé‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ</span>
   <span class="token comment">// é¢å»è§£æ</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// è¿‡ç•¥æ‰éæ–‡æœ¬çš„</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// ... æ’å€¼å¤„ç†{{}}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"&lt;"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// ... æ ‡ç­¾å¼€å¤´ &lt;...</span>
     <span class="token punctuation">}</span>

     <span class="token comment">// ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°</span>
     <span class="token comment">// !node ç»™ parseText è§£æ</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// çº¯æ–‡æœ¬é‡ç‚¹åœ¨è¿™é‡Œé¢å¤„ç†ï¼Œæˆªå–å­—ç¬¦ç›´åˆ°é‡åˆ° &lt;, {{, ]]> æ ‡å¿—ç»“æŸ</span>
     <span class="token comment">// ç„¶åä¼ å…¥åˆ° parseTextData() åˆ¤æ–­æ˜¯å¦æ˜¯æ•°æ®ç»‘å®šçš„å˜é‡ï¼Œåœ¨ </span>
     <span class="token comment">// context.options.decodeEntities() ä¸­å¤„ç†</span>
     node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">let</span> removedWhitespace <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> removedWhitespace <span class="token operator">?</span> nodes<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> <span class="token operator">:</span> nodes<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>parseText</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å­—ç¬¦ä¸²è§£æç›´åˆ°é‡åˆ° &lt;, {{, ]]> ä¸ºæ­¢</span>
 <span class="token keyword">const</span> endTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"&lt;"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   endTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"]]>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">let</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endTokens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> index <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>endTokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> endIndex <span class="token operator">></span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     endIndex <span class="token operator">=</span> index<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è§£æ &amp; å¼€å¤´çš„htmlè¯­ä¹‰çš„ç¬¦å·(>,&lt;,&amp;,',")</span>
 <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token punctuation">{</span>
   type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
   content<span class="token punctuation">,</span>
   <span class="token comment">// loc:{ start, end, source}</span>
   <span class="token comment">// start,end: { line, column, offset }</span>
   loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>parseTextData</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// è§£ææ–‡æœ¬æ•°æ®ï¼Œçº¯æ–‡æœ¬å†…å®¹</span>
<span class="token keyword">function</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> length<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> rawText <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è§£ææ¢è¡Œï¼Œæ›´æ–° line, column, offsetï¼Œè¿”å›æ¢è¡Œä¹‹åçš„çš„ source</span>
 <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>
   mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span> <span class="token operator">||</span>
   mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span> <span class="token operator">||</span>
   rawText<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
 <span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> rawText<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">return</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">decodeEntities</span><span class="token punctuation">(</span>
   rawText<span class="token punctuation">,</span>
   mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>advancedBy è§£æå¤šä¸ªå­—ç¬¦ä¹‹åæ›´æ–°start,end(line,column,offset)ï¼Œå°¤å…¶æ˜¯æ¢è¡Œç¬¦çš„ç‰¹æ®Šå¤„ç†ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> numberOfCharacters</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> <span class="token punctuation">{</span> source <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
 <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> source<span class="token punctuation">,</span> numberOfCharacters<span class="token punctuation">)</span><span class="token punctuation">;</span>
 context<span class="token punctuation">.</span>source <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>numberOfCharacters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>advancePositionWithMutation</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>
 <span class="token parameter">pos<span class="token punctuation">,</span>
 source<span class="token punctuation">,</span>
 numberOfCharacters <span class="token operator">=</span> source<span class="token punctuation">.</span>length</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">let</span> linesCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">let</span> lastNewLinePos <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numberOfCharacters<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">10</span> <span class="token comment">/* newline char code */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     linesCount<span class="token operator">++</span><span class="token punctuation">;</span>
     lastNewLinePos <span class="token operator">=</span> i<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 pos<span class="token punctuation">.</span>offset <span class="token operator">+=</span> numberOfCharacters<span class="token punctuation">;</span>
 pos<span class="token punctuation">.</span>line <span class="token operator">+=</span> linesCount<span class="token punctuation">;</span>
 pos<span class="token punctuation">.</span>column <span class="token operator">=</span>
   lastNewLinePos <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
     <span class="token operator">?</span> pos<span class="token punctuation">.</span>column <span class="token operator">+</span> numberOfCharacters
     <span class="token operator">:</span> numberOfCharacters <span class="token operator">-</span> lastNewLinePos<span class="token punctuation">;</span>

 <span class="token keyword">return</span> pos<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<h1 id="parsets" style="position:relative;"><a href="#parsets" aria-label="parsets permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parse.ts</h1>
<p><span id="file-parse"></span></p>
<h2 id="baseparsecontext-options" style="position:relative;"><a href="#baseparsecontext-options" aria-label="baseparsecontext options permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>baseParse(context, options)</h2>
<p><span id="parse-baseparse"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> options <span class="token comment">/* ParserOptions */</span><span class="token punctuation">)</span> <span class="token comment">/*RootNode*/</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>
    <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>baseParse å†…éƒ¨å®ç°åŸºæœ¬å°±æ˜¯è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å¾—é’ˆå¯¹å®ƒä½¿ç”¨çš„å‡ ä¸ªæ–¹æ³•å»é€ä¸€å®ç°ï¼š</p>
<ol>
<li>createParserContextï¼Œåˆ›å»ºèŠ‚ç‚¹è§£æå¯¹è±¡ï¼ŒåŒ…å«è§£æè¿‡ç¨‹ä¸­éœ€è¦æˆ–éœ€è¦ä¿å­˜çš„æ•°æ®</li>
<li>getCursorï¼Œè·å– context ä¸­çš„ offset, line, column, start, end ç­‰ä¿¡æ¯</li>
<li><a href="#file-ast-createroot">createRoot</a>ï¼Œåˆ›å»ºæ ¹èŠ‚ç‚¹</li>
<li><a href="#parse-parsechildren">parseChildren</a>ï¼Œè§£æå­èŠ‚ç‚¹</li>
<li><a href="#parse-getselection">getSelection</a>ï¼Œè·å–é€‰ä¸­çš„æœªè§£æçš„å†…å®¹</li>
</ol>
<p><span id="pic-baseparse"></span>baseParse å‡½æ•°å¤§ä½“ç»“æ„å’Œä»£ç è°ƒç”¨å›¾ç¤ºï¼š</p>
<p><img src="http://qiniu.ii6g.com/parse-ts-baseparse-0.png?imageMogr2/thumbnail/!100p"></p>
<h2 id="createparsecontextcontext-options" style="position:relative;"><a href="#createparsecontextcontext-options" aria-label="createparsecontextcontext options permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>createParseContext(context, options)</h2>
<p><span id="parse-createparsecontext"></span></p>
<p>å‡½æ•°ä½œç”¨ï¼š<strong>åˆ›å»ºè§£æå™¨ä¸Šä¸‹æ–‡å¯¹è±¡(åŒ…å«è§£æè¿‡ç¨‹ä¸­çš„ä¸€äº›è®°å½•ä¿¡æ¯)</strong></p>
<p>å‡½æ•°å£°æ˜ï¼š</p>
<p><code class="language-text">function createParserContext(context, options) /*ParserContext*/ {}</code></p>
<p>å‚æ•°æ²¡ä»€ä¹ˆå¥½è®²çš„äº†ï¼Œä» baseParse ç»§æ‰¿è€Œæ¥ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª <a href="#td-parser-context">ParserContext</a> ç±»å‹ã€‚å…·ä½“å®ç°å…¶å®å°±æ˜¯è¿”å›ä¸€ä¸ª ParserContext ç±»å‹çš„å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†æºç å­—ç¬¦ä¸²è¢«è§£ææ˜¯çš„ä¸€äº›ä¿¡æ¯å­˜å‚¨ï¼Œæ¯”å¦‚ï¼šè§£ææ—¶æŒ‡é’ˆçš„ä½ç½® offsetï¼Œå½“å‰è¡Œåˆ—(line, column)ï¼ŒåŠå…¶ä»–ä¿¡æ¯ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>
  <span class="token parameter">content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> ParserOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ParserContext <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// è§£æå™¨çš„é»˜è®¤é€‰é¡¹ç»™äº†äº›é»˜è®¤å€¼ï¼Œæ¯”å¦‚ï¼šisVoidTag: No, isPreTag: NOï¼Œ ç­‰ç­‰</span>
      <span class="token operator">...</span>defaultParserOptions<span class="token punctuation">,</span> 
      <span class="token operator">...</span>options
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    originalSource<span class="token operator">:</span> content<span class="token punctuation">,</span>
    source<span class="token operator">:</span> content<span class="token punctuation">,</span>
    inPre<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    inVPre<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="" style="position:relative;"><a href="#" aria-label=" permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2>
<h2 id="parsechildrencontext-mode-ancestors" style="position:relative;"><a href="#parsechildrencontext-mode-ancestors" aria-label="parsechildrencontext mode ancestors permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseChildren(context, mode, ancestors)</h2>
<p><span id="parse-parsechildren"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>
  context <span class="token comment">/* ParserContext*/</span><span class="token punctuation">,</span>
  mode <span class="token comment">/*TextModes*/</span><span class="token punctuation">,</span>
  ancesotrs <span class="token comment">/*ElementNode[]*/</span>
<span class="token punctuation">)</span> <span class="token comment">/* TemplateChildNode[] */</span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></div>
<p>å‚æ•°åˆ—è¡¨ï¼š</p>
<ol>
<li>contextï¼Œå¾…è§£æçš„æ¨¡æ¿å¯¹è±¡(<a href="#td-parser-context">ParserContext</a>)</li>
<li>modeï¼Œæ–‡æœ¬æ¨¡å¼(<a href="#td-vars-textmodes">TextModes</a>)</li>
<li>ancestorsï¼Œç¥–å…ˆå…ƒç´ (<a href="#td-ast-elementnode">ElementNode[]</a>)</li>
</ol>
<p>è¿”å›ç»“æœï¼š <a href="#td-ast-tcn">TemplateChildNode[]</a></p>
<h3 id="é˜¶æ®µä¸€test01-some-text" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E4%B8%80test01-some-text" aria-label="é˜¶æ®µä¸€test01 some text permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µä¸€(<a href="test-01-sometext">test01 some text</a>)</h3>
<p>å®ç° <a href="#parse-parsetext">parseText()</a> ä¹‹åçš„ <a href="#parse-parsechildren">parseChildren()</a>ä»£ç ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>
  context <span class="token comment">/* ParserContext*/</span><span class="token punctuation">,</span>
  mode <span class="token comment">/*TextModes*/</span><span class="token punctuation">,</span>
  ancesotrs <span class="token comment">/*ElementNode[]*/</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> nodes <span class="token comment">/*TemplateChildNode[]*/</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancesotrs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth</span>

    <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
    <span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token comment">// ç”±äº baseparseé‡Œé¢ä¼ è¿‡æ¥çš„æ˜¯ä¸ª DATA ç±»å‹ï¼Œå› æ­¤ä¼šèµ°åˆ°è¿™ä¸ª if é‡Œ</span>
    <span class="token comment">// é¢å»è§£æ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿‡ç•¥æ‰éæ–‡æœ¬çš„</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... æ’å€¼å¤„ç†{{}}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"&lt;"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... æ ‡ç­¾å¼€å¤´ &lt;...</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ... åˆ°è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è¿™ä¸ª if å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åˆ°</span>
      <span class="token comment">// !node ç»™ parseText è§£æ</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"parse children"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> removedWhitespace <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> removedWhitespace <span class="token operator">?</span> nodes<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> <span class="token operator">:</span> nodes<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>æœ€åå¤„ç†å®Œä¹‹åæ–‡æœ¬èŠ‚ç‚¹å¯¹è±¡å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    delimiters<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'{{'</span><span class="token punctuation">,</span> <span class="token string">'}}'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    getNamespace<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getNamespace<span class="token punctuation">]</span><span class="token punctuation">,</span>
    getTextMode<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> getTextMode<span class="token punctuation">]</span><span class="token punctuation">,</span>
    isVoidTag<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isPreTag<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isCustomElement<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    decodeEntities<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> decodeEntities<span class="token punctuation">]</span><span class="token punctuation">,</span>
    onError<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// è¿™é‡Œå‘ç”Ÿäº†å˜æ¢</span>
  <span class="token comment">// column: å®šä½åˆ°äº†å­—ç¬¦ä¸²æœ€åå³ 'simple text' çš„é•¿åº¦ + 1ï¼Œå³ç»“æŸä½ç½®</span>
  <span class="token comment">// line: å› ä¸ºåªæœ‰ä¸€è¡Œï¼Œæ‰€ä»¥ line å¹¶æœªå‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿäº†æ”¹å˜ä¼šåœ¨ advancedBy é‡Œé¢è¿›è¡Œå¤„ç†æ›´æ–°</span>
  <span class="token comment">// offset: ç±»ä¼¼æ–‡ä»¶å¤„ç†æ—¶çš„æŒ‡é’ˆåç§»é‡ï¼Œå³å­—ç¬¦ä¸²é•¿åº¦</span>
  column<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
  line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  offset<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
  <span class="token comment">// ä¼šå‘ç°å¤„ç†å®Œæˆä¹‹åï¼ŒoriginalSource ç»´æŒåŸæ ·</span>
  originalSource<span class="token operator">:</span> <span class="token string">'simple text'</span><span class="token punctuation">,</span>
  <span class="token comment">// source å˜æˆäº†ç©ºå­—ç¬¦ä¸²ï¼Œå› ä¸ºå¤„ç†å®Œäº†</span>
  source<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  inPref<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  inVPref<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span> <span class="token comment">// parse children</span></code></pre></div>
<p>baseParse ä¹‹åçš„ ast ç»“æ„ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// è¿™ä¸ªç»“æ„çš„å½¢æˆæ˜¯ç»è¿‡ createRoot å¤„ç†ä¹‹åçš„ç»“æœ</span>
<span class="token comment">// ç»è¿‡ parseChildren ä¹‹åçš„ç»“æœä¼šè¢«å­˜æ”¾åˆ° root çš„children ä¸­ï¼Œå¦‚ä¸‹</span>
<span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token string">'\nsimple text 1\n simple text 2\n'</span><span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token string">'\nsimple text 1\n simple text 2\n'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  helpers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  hoists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  cached<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  temps<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span> <span class="token comment">//// ast</span>

<span class="token comment">// ç¬¬ä¸€ä¸ª children ç»“æ„ï¼š</span>
<span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  content<span class="token operator">:</span> <span class="token string">'\nsimple text 1\n simple text 2\n'</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token string">'\nsimple text 1\n simple text 2\n'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token comment">//// ast</span></code></pre></div>
<p>é˜¶æ®µä»£ç ï¼š<a href="#link-01">test-01-some-text æµ‹è¯•ç”¨ä¾‹é€šè¿‡</a></p>
<p>å›¾ç¤ºï¼šæ–‡æœ¬è§£æ</p>
<p><img src="http://qiniu.ii6g.com/parse-ts-parsechildren-text-part.png?imageMogr2/thumbnail/!100p" alt="parseChildren-æ”¯æŒçº¯æ–‡æœ¬è§£æ"></p>
<h2 id="parsecommentcontext" style="position:relative;"><a href="#parsecommentcontext" aria-label="parsecommentcontext permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseComment(context)</h2>
<p><span id="parse-parsecomment"></span></p>
<p>æ³¨é‡Šå¤„ç†å‡½æ•°ï¼Œè§£æåŸåˆ™æ˜¯åŒ¹é… <code class="language-text">&lt;!--</code> å¼€å¤´å’Œ <code class="language-text">--&gt;</code> ç»“å°¾ï¼Œä¸­é—´éƒ¨åˆ†ç»Ÿç»Ÿè§†ä¸ºæ³¨é‡Šï¼Œä¸­é—´éœ€è¦è€ƒè™‘åµŒå¥—æ³¨é‡Šé—®é¢˜ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseComment</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token comment">/* CommentNode */</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">let</span> content

  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/--(\!)?>/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ²¡æœ‰é—­åˆæ³¨é‡Šï¼Œåé¢çš„æ‰€æœ‰éƒ½ä¼šè¢«å½“åšæ³¨é‡Šå¤„ç†</span>
    content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// åé¢æ‰€æœ‰çš„éƒ½æˆä¸ºæ³¨é‡Š</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_COMMENT</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">.</span>index <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç©ºæ³¨é‡Šä¹ŸæŠ¥é”™</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">ABRUPT_CLOSING_OF_EMPTY_COMMENT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// éæ³•ç»“æŸï¼Œæ¯”å¦‚ï¼š &lt;!-xx--!>ï¼Œæ­£åˆ™é‡Œé¢æœ‰ä¸ª (\!)? æ•è·ç»„</span>
    <span class="token comment">// match[1] å°±æ˜¯æŒ‡è¿™ä¸ªåŒ¹é…</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INCORRECTLY_CLOSED_COMMENT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å–æ³¨é‡Šå†…å®¹ï¼Œmatch.index å³ /--(\!)?>/ æ­£åˆ™åŒ¹é…çš„å¼€å§‹ç´¢å¼•ä½ç½®</span>
    content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> match<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

    <span class="token comment">// åµŒå¥—æ³¨é‡Š??? è¿™é‡Œslice ä¹‹åçš„ s ä¸åŒ…å«ç»“æŸ --></span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> match<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
    <span class="token keyword">let</span> prevIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
      nestedIndex <span class="token operator">=</span> <span class="token number">0</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> s <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// é¦–å…ˆèƒ½è¿›å…¥ parseCommentï¼Œè¯´æ˜ source æ˜¯ä»¥ &lt;!-- å¼€å¤´çš„ï¼Œä¸”æ˜¯åŒ…å« --> çš„</span>
    <span class="token comment">// å¦åˆ™å‰é¢å°±ä¼šå‡ºç°å¼‚å¸¸ï¼Œå› æ­¤å¦‚æœåµŒå¥—é‚£å¯èƒ½æƒ…å†µåªæœ‰&lt;!--x&lt;!--y-->æ³¨é‡Šä¸­é—´</span>
    <span class="token comment">// å‡ºç°è¿‡ &lt;!--</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nestedIndex <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;!--'</span><span class="token punctuation">,</span> prevIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nestedIndex<span class="token punctuation">,</span> prevIndex<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token operator">:</span> s<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> nestedIndex <span class="token operator">-</span> prevIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">// + 4 å€¼æ˜¯ `&lt;!--`.lengthï¼Œå¦‚æœå°äº s.lengthï¼Œè¯´æ˜åµŒå¥—äº†æ³¨é‡Š</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nestedIndex <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// éæ³•åµŒå¥—, å¦‚ï¼š&lt;!--&lt;!--x--></span>
        <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">NESTED_COMMENT</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/// ç„¶åå®šä½åˆ°åµŒå¥—çš„ç¬¬ä¸€ä¸ª &lt;!-- çš„ ! ç´¢å¼•ä¸Šï¼Œè¿›å…¥ä¸‹ä¸€è½®å¤„ç†ï¼Œç›´</span>
      <span class="token comment">// åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ªåˆæ³•çš„ &lt;!--</span>
      prevIndex <span class="token operator">=</span> nestedIndex <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™é‡Œåº”è¯¥æ˜¯æ²¡åµŒå¥—çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">.</span>index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> prevIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span>
    content<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="parseelementcontext-mode" style="position:relative;"><a href="#parseelementcontext-mode" aria-label="parseelementcontext mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseElement(context, mode)</h2>
<p><span id="parse-parseelement"></span></p>
<p>è¿™ä¸ªè§£æå‡½æ•°ï¼Œç”¨æ¥è§£æ <code class="language-text">&lt;div&gt;</code> æ ‡ç­¾ã€‚</p>
<h3 id="é˜¶æ®µä¸€test-05" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E4%B8%80test-05" aria-label="é˜¶æ®µä¸€test 05 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µä¸€(<a href="#test-text-05">test-05</a>)</h3>
<p><a href="#test-text-05">some &#x3C;span>{{ foo &#x3C; bar + foo }} text&#x3C;/span></a></p>
<p>æ­¤é˜¶æ®µåªå®ç°å¯¹ <code class="language-text">&lt;div&gt;...&lt;/div&gt;</code> çš„è§£æï¼Œä¸åŒ…å«å±æ€§ç­‰ç­‰å…¶ä»–å¤æ‚æƒ…å†µï¼Œå› ä¸ºåªéœ€è¦èƒ½é€šè¿‡ç”¨ä¾‹5å°±è¡Œã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// assert context.source æ˜¯ä»¥ &lt;[a-z] å¼€å¤´çš„</span>

  <span class="token keyword">const</span> wasInPre <span class="token operator">=</span> context<span class="token punctuation">.</span>inPre
  <span class="token keyword">const</span> wasInVPre <span class="token operator">=</span> context<span class="token punctuation">.</span>inVPre
  <span class="token comment">// å– ancestors æœ€åä¸€ä¸ªèŠ‚ç‚¹ node</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>Start<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

  <span class="token comment">// pre or v-pre</span>
  <span class="token keyword">const</span> isPreBoundary <span class="token operator">=</span> context<span class="token punctuation">.</span>inPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wasInVPre
  <span class="token keyword">const</span> isVPreBoundary <span class="token operator">=</span> context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wasInVPre

  <span class="token comment">// è‡ªé—­åˆçš„åˆ°è¿™é‡Œå°±å¯ä»¥ç»“æŸäº†</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>isSelfClosing <span class="token operator">||</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>isVoidTag<span class="token operator">?.</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> element
  <span class="token punctuation">}</span>
  
  <span class="token comment">// å­å…ƒç´  childrenï¼Œè¢«æ¼æ‰çš„ä»£ç ï¼Œä¼šè¿›å…¥é€’å½’è°ƒç”¨ parseChildren å»è§£æ</span>
	<span class="token comment">// &lt;span>...&lt;/span> æ ‡ç­¾å†…çš„æ¨¡æ¿</span>
  ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
	<span class="token keyword">const</span> mode <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTextMode</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
	<span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
 
	ancestors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	element<span class="token punctuation">.</span>children <span class="token operator">=</span> children
  <span class="token comment">// P1.... è§£æä¹‹å children é‡Œé¢åº”è¯¥åŒ…å«ä¸¤ä¸ª node</span>
  <span class="token comment">// node1: æ’å€¼å†…å®¹ `foo &lt; bar + foo`</span>
  <span class="token comment">// node2: æ–‡æœ¬èŠ‚ç‚¹ ` text`</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>

  <span class="token comment">// ç»“æŸæ ‡ç­¾ï¼Ÿ &lt;span>&lt;/span> è¿™ç§ç±»å‹ï¼Ÿ</span>
  <span class="token comment">// ä¸Šé¢ä¼šè§£ææ ‡ç­¾å†…çš„æ¨¡æ¿ï¼Œè§£æå®Œä¹‹å source æ­£å¸¸åº”è¯¥ä¼šæ˜¯ `&lt;/span> ....`</span>
  <span class="token comment">// è¿›å…¥ if è§£æç»“æŸæ ‡ç­¾</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¼šè¿›å…¥åˆ°è¿™é‡Œå‡ºç°æŠ¥é”™</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_END_TAG</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> first <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">&amp;&amp;</span> first<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'&lt;!--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  element<span class="token punctuation">.</span>loc <span class="token operator">=</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> element<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPreBoundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inPre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isVPreBoundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>inVPre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> element
<span class="token punctuation">}</span></code></pre></div>
<p>å®ç°åˆ°è¿™é‡Œæ˜¯ä¸ºäº†æƒ³çœ‹ä¸‹ç»è¿‡ <a href="#parse-parsetag">parseTag</a> ä¹‹åçš„ element æ˜¯ä»€ä¹ˆï¼ŸparseTag é‡Œé¢æœ‰ä¸ªæ­£åˆ™æ˜¯ç”¨æ¥åŒ¹é…å¼€å§‹æˆ–ç»“æŸæ ‡ç­¾çš„ï¼Œå³ï¼š <code class="language-text">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i</code> è¿™ä¸ªæ—¢å¯ä»¥åŒ¹é…å¼€å§‹æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥åŒ¹é…ç»“æŸæ ‡ç­¾ï¼Œå¹¶ä¸”è€ƒè™‘äº† <code class="language-text">&lt;div   &gt;</code> æœ‰ç©ºæ ¼çš„æƒ…å†µï¼Œå¿½ç•¥å¤§å°å†™ã€‚</p>
<p>æ­£åˆ™åŒ¹é…æµ‹è¯•ç»“æœï¼š</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/i.exec(&#39;&lt;span&gt;&#39;)
(2)Â [&quot;&lt;span&quot;, &quot;span&quot;, index: 0, input: &quot;&lt;span&gt;&quot;, groups: undefined]</code></pre></div>
<p>æ‰€ä»¥è¿™é‡Œé¦–å…ˆåŒ¹é…è§£æçš„æ˜¯å¼€å§‹æ ‡ç­¾ <code class="language-text">&lt;div&gt;</code> ã€‚</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token comment">// some &lt;span>{{ foo &lt; bar + foo }} text&lt;/span></span>
<span class="token comment">// parseTag ä¹‹åçš„ element</span>
<span class="token punctuation">{</span>
    <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// èŠ‚ç‚¹ç±»å‹æ˜¯ NodeTypes.ELEMENT</span>
    <span class="token property">"ns"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// å‘½åç©ºé—´å°±æ˜¯ HTML</span>
    <span class="token property">"tag"</span><span class="token operator">:</span><span class="token string">"span"</span><span class="token punctuation">,</span> 
    <span class="token property">"tagType"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// æ ‡ç­¾ç±»å‹ ElementTypes.ELEMENT</span>
    <span class="token property">"props"</span><span class="token operator">:</span><span class="token punctuation">[</span> <span class="token comment">// æ ‡ç­¾å±æ€§ï¼Œè¿™é‡Œæ²¡æœ‰</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"isSelfClosing"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œå¦‚ï¼š&lt;img/></span>
    <span class="token property">"children"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"loc"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"start"</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// column ä¸æ¢è¡Œçš„æƒ…å†µä¸‹ä¸º offset + 1ï¼Œä» 1 å¼€å§‹è®¡æ•°</span>
            <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// æ²¡æ¢è¡Œç¬¦</span>
            <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">5</span> <span class="token comment">// &lt;span> çš„ &lt; å¼€å§‹ä½ç½®ç´¢å¼• `some `.length = 5</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"end"</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>
            <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
          	<span class="token comment">// è¿™é‡Œå€¼çš„å˜åŒ–åˆ†ä¸¤æ­¥</span>
          	<span class="token comment">// parseTag:start çš„æ—¶å€™</span>
						<span class="token comment">// 1. è§£æå‡º &lt;span ï¼Œè¿™ä¸ªæ—¶å€™ offset å…¶å®æ˜¯ 10</span>
						<span class="token comment">// 2. æ£€æµ‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œå†³å®š advancedBy </span>
            <span class="token comment">// ç§»åŠ¨æŒ‡é’ˆä½ç½®æ•°(è‡ªé—­åˆï¼š2ï¼Œéè‡ªé—­åˆï¼š1)ï¼Œåˆ°è¿™é‡Œ offset = 11</span>
            <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">11</span> 
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"&lt;span>"</span> <span class="token comment">// ä¸ºä»€ä¹ˆä¸æ˜¯ `&lt;span>` ??? æ¼äº†è‡ªé—­åˆæ ‡ç­¾æ£€æµ‹æŒ‡é’ˆç§»ä½</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è§£æä¹‹å context å†…å®¹å˜åŒ–ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"options"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token comment">// å¿½ç•¥é€‰é¡¹ï¼Œç›®å‰å¯¹æˆ‘ä»¬æ²¡å•¥ç”¨</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token comment">// &lt;span> åé¢çš„ > ç´¢å¼•</span>
    <span class="token property">"originalSource"</span><span class="token operator">:</span><span class="token string">"some &lt;span>{{ foo &lt; bar + foo }} text&lt;/span>"</span><span class="token punctuation">,</span>
  	<span class="token comment">// è§£æä¹‹åçš„æ¨¡æ¿ï¼Œä¸ºä½• > æ²¡è¢«å»æ‰???ï¼Œè§ é—®é¢˜1</span>
    <span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"{{ foo &lt; bar + foo }} text&lt;/span>"</span><span class="token punctuation">,</span>
    <span class="token property">"inPref"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"inVPref"</span><span class="token operator">:</span><span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre></div>
<p>åˆ°æ­¤æˆ‘ä»¬å·²ç»è§£æé™¤äº† <code class="language-text">&lt;span&gt;</code> å¼€å§‹æ ‡ç­¾ï¼Œè¿™ä¸ªæ—¶å€™çš„ <code class="language-text">node.childrens = []</code>ï¼Œä¸‹ä¸€æ­¥è§£ææ ‡ç­¾é‡Œé¢çš„å†…å®¹ã€‚</p>
<p>åœ¨å®ç°å®Œæ•´çš„ parseElement ä¹‹åå‘ç°æ‰§è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªç”¨ä¾‹å¹¶ä¸æ˜¯ <code class="language-text">&lt;span&gt;&lt;/span&gt;</code> æ ‡ç­¾å†…æ²¡ä¸œè¥¿ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ else è§¦å‘ <code class="language-text">emitError()</code>ï¼Œé‚£ä¸æ˜¯æ²¡æ³•å¾€ä¸‹èµ°äº†ï¼Ÿï¼Ÿï¼Ÿ</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// å­å…ƒç´  childrenï¼Œè¢«æ¼æ‰çš„ä»£ç ï¼Œä¼šè¿›å…¥é€’å½’è°ƒç”¨ parseChildren å»è§£æ</span>
<span class="token comment">// &lt;span>...&lt;/span> æ ‡ç­¾å†…çš„æ¨¡æ¿</span>
ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token keyword">const</span> mode <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTextMode</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
<span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
ancestors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
element<span class="token punctuation">.</span>children <span class="token operator">=</span> children
<span class="token comment">// ...........â˜ğŸ».â˜ğŸ».â˜ğŸ».â˜ğŸ».â˜ğŸ»ï¼ŒåŠ å›å»</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">,</span> element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_END_TAG</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> first <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">&amp;&amp;</span> first<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'&lt;!--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>é‚£æ˜¯å› ä¸ºå‰é¢æ¼äº†ä¸€æ®µä»£ç ã€‚</p>
<p>ä»£ç åŠ ä¸Šä¹‹åæœ€åä»£ç  P1 å‡ºçš„è¾“å‡º ancestors é‡Œé¢ä¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹(element)ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token comment">// ancestors[{...}]ï¼Œancestors ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ &lt;span> è¿™ä¸ªèŠ‚ç‚¹</span>
<span class="token comment">// é‡ç‚¹æˆ‘ä»¬è¦çœ‹çš„æ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„ children å› ä¸ºå…¶å†…éƒ¨æœ‰ `{{ foo &lt; bar + foo }} text`</span>
<span class="token comment">// æ‰€ä»¥å®ƒ çš„ element åº”è¯¥æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼š`foo &lt; bar + foo` å’Œ ` text`</span>
<span class="token punctuation">{</span>
    <span class="token comment">// &lt;span> èŠ‚ç‚¹æœ¬èº«çš„å±æ€§ï¼Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯ children</span>
    <span class="token property">"children"</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token comment">// ç¬¬ä¸€ä¸ª child æ˜¯ {{ ... }} æ£€æµ‹åˆ°æ’å€¼è¿›å…¥ parseInterpolation åˆ†æ”¯</span>
          <span class="token comment">// å¤„ç†ï¼Œå¾—åˆ°ä¸‹é¢çš„èŠ‚ç‚¹ç»“æ„ï¼Œæ’å€¼è§£æåœ¨ parseInterpolation ä¸€ç« æœ‰åˆ†æè¿‡äº†</span>
            <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token property">"content"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>
                <span class="token property">"isStatic"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token property">"isConstant"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token property">"content"</span><span class="token operator">:</span><span class="token string">"foo &lt; bar + foo"</span><span class="token punctuation">,</span>
                <span class="token property">"loc"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token property">"start"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                        <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span>
                        <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                        <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">14</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">"end"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                        <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">,</span>
                        <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                        <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">29</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"foo &lt; bar + foo"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"loc"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">"start"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>
                    <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">11</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"end"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">,</span>
                    <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">32</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"source"</span><span class="token operator">:</span><span class="token string">"{{ foo &lt; bar + foo }}"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token property">"content"</span><span class="token operator">:</span><span class="token string">" text"</span><span class="token punctuation">,</span>
            <span class="token property">"loc"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">"start"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">,</span>
                    <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">32</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"end"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token property">"column"</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span>
                    <span class="token property">"line"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">37</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"source"</span><span class="token operator">:</span><span class="token string">" text"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// &lt;span> æœ¬èº«èŠ‚ç‚¹çš„ loc</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¿™é‡Œä¹Ÿæ²¡ä»€ä¹ˆå¥½è§£é‡Šçš„ï¼Œæ’å€¼åœ¨ <a href="#parse-parseinterpolation">parseInterpolation</a> å¤„åˆ†æè¿‡äº†ï¼Œæ–‡æœ¬è§£æåœ¨ <a href="#parse-parsetext">parseText</a> å¤„åˆ†æäº†ã€‚</p>
<h2 id="parseinterpolationcontext-mode" style="position:relative;"><a href="#parseinterpolationcontext-mode" aria-label="parseinterpolationcontext mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseInterpolation(context, mode)</h2>
<p><span id="parse-parseinterpolation"></span></p>
<p>å‡½æ•°å£°æ˜ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes</span>
<span class="token punctuation">)</span><span class="token operator">:</span> InterpolationNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></div>
<p><strong>context</strong>: å°†è¢«è§£æçš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è¿™é‡Œçš„ source åº”è¯¥æ˜¯ä»¥å·®å€¼ (<code class="language-text">{{</code>)å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚</p>
<p><strong>mode</strong>: æ–‡æœ¬æ¨¡å¼ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ‰¾å‡ºæ’å€¼æ¨¡æ¿çš„å¼€å§‹å’Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯ {{ å’Œ }}</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>open<span class="token punctuation">,</span> close<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">;</span>
  <span class="token keyword">const</span> closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>close<span class="token punctuation">,</span> open<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_INTERPOLATION_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> open<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ä¸‹é¢æ˜¯ä» {{ ä¹‹åçš„å­—ç¬¦ä¸²å¼€å§‹è§£æ</span>
  <span class="token keyword">const</span> innerStart <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
    innerEnd <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// æ’å€¼é‡Œé¢çš„å­—ç¬¦ä¸²é•¿åº¦</span>
    rawContentLength <span class="token operator">=</span> closeIndex <span class="token operator">-</span> open<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    <span class="token comment">// æ’å€¼é‡Œé¢çš„å­—ç¬¦ä¸²å†…å®¹</span>
    rawContent <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rawContentLength<span class="token punctuation">)</span><span class="token punctuation">,</span>
    preTrimContent <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> rawContentLength<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">,</span>
    content <span class="token operator">=</span> preTrimContent<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    startOffset <span class="token operator">=</span> preTrimContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>startOffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>innerStart<span class="token punctuation">,</span> rawContent<span class="token punctuation">,</span> startOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// {{ foo + bar }} -></span>
  <span class="token comment">// res = (' foo + bar '.length - 'foo + bar'.length - ' '.length)</span>
  <span class="token comment">// æ’å€¼é‡Œé¢å­—ç¬¦ä¸²çš„é•¿åº¦ - å»æ‰ç©ºæ ¼åçš„é•¿åº¦ - èµ·å§‹ç©ºæ ¼çš„é•¿åº¦ï¼Œå¾—åˆ°çš„</span>
  <span class="token comment">// å°±æ˜¯ç»“æŸä½ç½®çš„ offset</span>
  <span class="token keyword">const</span> endOffset <span class="token operator">=</span>
    rawContentLength <span class="token operator">-</span> <span class="token punctuation">(</span>preTrimContent<span class="token punctuation">.</span>length <span class="token operator">-</span> content<span class="token punctuation">.</span>length <span class="token operator">-</span> startOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>innerEnd<span class="token punctuation">,</span> rawContent<span class="token punctuation">,</span> endOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å®šä½åˆ° }} ä½ç½®</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> close<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>innerEnd<span class="token punctuation">,</span> innerStart<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
      isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      content<span class="token punctuation">,</span>
      loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> innerStart<span class="token punctuation">,</span> innerEnd<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1595570127.png?imageMogr2/thumbnail/!100p"></p>
<p>å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°åœ¨ç»è¿‡è§£æä¹‹å innerStart å’Œ innerEnd éƒ½æ•°æ®éƒ½æ­£ç¡®å®šä½åˆ°äº†ç›¸åº”ä½ç½®ï¼ŒinnerStart æ˜¯è§£æåæ’å€¼å­—ç¬¦ä¸²çš„å¼€å§‹ä½ç½®(ç¬¬ä¸€ä¸ª <code class="language-text">{</code> offset = 8(<font color="purple">â€˜some {{ â€˜çš„é•¿åº¦</font>))ï¼ŒinnerEndæ˜¯è§£æåæ’å€¼å­—ç¬¦ä¸²çš„ç»“æŸä½ç½®(æœ€åä¸€ä¸ª <code class="language-text">}</code> offset = 17(<font color="purple">â€˜some {{ foo + bar â€˜çš„é•¿åº¦))</font>ã€‚</p>
<p><img src="http://qiniu.ii6g.com/parse-ts-parseinterpolation.png?imageMogr2/thumbnail/!100p"></p>
<p>è§£æä¹‹åå¾—åˆ°çš„ <code class="language-text">ast.children</code> å°†ä¼šæœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">(<span class="token number">3</span>) <span class="token punctuation">[</span><span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">"some "</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// å·¦ä¾§æ–‡æœ¬</span>
<span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// æ’å€¼éƒ¨åˆ†</span>
<span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">" text"</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span>â€¦<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// å³ä¾§æ–‡æœ¬</span>
length<span class="token operator">:</span> <span class="token number">3</span>
__proto__<span class="token operator">:</span> Array(<span class="token number">0</span>)</code></pre></div>
<p>è§£æå›é¡¾(åˆ†åˆ«è§£æå‡ºäº†ä¸‰ä¸ªèŠ‚ç‚¹å¯¹è±¡)ï¼š</p>
<ol>
<li>
<p><code class="language-text">0: {type: 2, content: &quot;some &quot;, loc: {â€¦}}</code>
è¯¦ç»†ç»“æ„<span id="x-1"></span>ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token number">0</span><span class="token operator">:</span>
 content<span class="token operator">:</span> <span class="token string">"some "</span> <span class="token comment">// è§£æå‡ºçš„æ–‡æœ¬å†…å®¹</span>
 loc<span class="token operator">:</span> <span class="token comment">// ä½ç½®ä¿¡æ¯</span>
 	end<span class="token operator">:</span> <span class="token punctuation">{</span>column<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span> <span class="token comment">// è¯¥èŠ‚ç‚¹åœ¨æ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯</span>
 	source<span class="token operator">:</span> <span class="token string">"some "</span> <span class="token comment">// æ–‡æœ¬æºå†…å®¹</span>
 	start<span class="token operator">:</span> <span class="token punctuation">{</span>column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span> <span class="token comment">// è¯¥èŠ‚ç‚¹åœ¨æ¨¡æ¿ä¸­çš„ç»“æŸä¿¡æ¯</span>
 __proto__<span class="token operator">:</span> Object
	type<span class="token operator">:</span> <span class="token number">2</span> <span class="token comment">// èŠ‚ç‚¹ç±»å‹</span>
	__proto__<span class="token operator">:</span> Object</code></pre></div>
<p>é‚£ä¹ˆæ˜¯å¦‚ä½•å¾—åˆ°ä¸Šé¢çš„ç»“æœçš„å‘¢ï¼Ÿï¼Ÿï¼Ÿé‚£å¾—ä» <a href="#parse-parsechildren">parseChildren</a> è¯´èµ·äº†ï¼Œæ¨¡æ¿ï¼š</p>
<p>--->> â€œsome {{ foo + bar }} textâ€</p>
<p><code class="language-text">(!context.inVPre &amp;&amp; s.startsWith(context.options.delimiters[0]))</code> <font color="red">æ£€æµ‹å¤±è´¥</font></p>
<p><code class="language-text">mode === TextModes.DATA &amp;&amp; s[0] === &quot;&lt;&quot;</code> <font color="red">æ£€æµ‹å¤±è´¥</font></p>
<p>å³ä¸€å¼€å§‹å¹¶ä¸ä¼šè¿›å…¥æ’å€¼å’Œæ ‡ç­¾è§£æä»£ç ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥ <a href="#parse-parsetext">parseText(context, mode)</a> ä¸­è§£ææ–‡æœ¬ï¼Œè§£ææ—¶å€™ç›´åˆ°é‡åˆ° <code class="language-text">{{</code> ä¹‹å‰éƒ½ä¸€ç›´ä¼šå½“åšæ–‡æœ¬è§£æï¼Œè€Œä¹‹å‰çš„æ–‡æœ¬ä¸­åˆä¸åŒ…å« <code class="language-text">decodeMap</code> ä¸­çš„å­—ç¬¦ï¼Œå› æ­¤çŸ¥é“é‡åˆ° <code class="language-text">{</code> ä¹‹å‰ä¼šä¸€ç›´æ‰§è¡Œ while é‡Œé¢çš„ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¿™æ®µä»£ç ï¼Œè€Œç”±äº â€œsome â€ éƒ½æ˜¯æ™®é€šå­—ç¬¦ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ä¼šå¯¹åº”ä¸€ä¸ª node ï¼Œç„¶ååˆéƒ½æ˜¯æ™®é€šæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¼šç»è¿‡ <a href="#parse-pushnode">pushNode(nodes, node[i])</a> å¤„ç†æ‰ï¼Œè¿›è¡Œåˆå¹¶æœ€åæˆä¸ºä¸Šé¢çš„ä¸€ä¸ªå®Œæ•´çš„ â€œsome â€ å¯¹åº”<a href="#x-1">æ–‡æœ¬èŠ‚ç‚¹ç»“æ„</a>ã€‚</p>
</li>
<li>
<p><code class="language-text">1: {type: 5, content: {â€¦}, loc: {â€¦}}</code></p>
<p>èŠ‚ç‚¹ç»“æ„<span id="x-2"></span>ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token number">1</span><span class="token operator">:</span>
 content<span class="token operator">:</span> <span class="token comment">// è¿™é‡Œçš„æ•°æ®æ˜¯ç»è¿‡æ’å€¼è§£æä¹‹åçš„æ¨¡æ¿å¯¹è±¡</span>
   content<span class="token operator">:</span> <span class="token string">"foo + bar"</span> <span class="token comment">// trim ä¹‹åçš„æ’å€¼å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰ }} ???</span>
   isConstant<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// éå¸¸é‡ç±»å‹</span>
   isStatic<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// éé™æ€èŠ‚ç‚¹</span>
   loc<span class="token operator">:</span>  <span class="token comment">// è§£æä¹‹åçš„è¯¥èŠ‚ç‚¹åœ¨æ•´ä¸ªæ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯</span>
			<span class="token comment">// 17 -> r æ‰€åœ¨çš„ä½ç½®</span>
     end<span class="token operator">:</span> <span class="token punctuation">{</span>column<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">}</span>
     source<span class="token operator">:</span> <span class="token string">"foo + bar"</span>
			<span class="token comment">// 8 -> f æ‰€åœ¨çš„ä½ç½®ï¼Œå³ start -> end => 'f &lt;-> r'</span>
     start<span class="token operator">:</span> <span class="token punctuation">{</span>column<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">}</span>
   __proto__<span class="token operator">:</span> Object
   type<span class="token operator">:</span> <span class="token number">4</span> <span class="token comment">// æ’å€¼è¡¨è¾¾å¼ç±»å‹</span>
   __proto__<span class="token operator">:</span> Object
	loc<span class="token operator">:</span> <span class="token comment">// è¿™é‡Œæ˜¯æ²¡ç»è¿‡å»å°¾éƒ¨ç©ºæ ¼çš„ä½ç½®ä¿¡æ¯</span>
		<span class="token comment">// 20 -> 'some {{ foo + bar ' æœ€åä¸€ä¸ªç©ºæ ¼ä½ç½®</span>
   end<span class="token operator">:</span> <span class="token punctuation">{</span>column<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span> 
   source<span class="token operator">:</span> <span class="token string">"{{ foo + bar }}"</span>
		<span class="token comment">// 5 -> 'some ' ç¬¬ä¸€ä¸ª { ä½ç½®</span>
   start<span class="token operator">:</span> <span class="token punctuation">{</span>column<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span> 
   __proto__<span class="token operator">:</span> Object
 type<span class="token operator">:</span> <span class="token number">5</span> <span class="token comment">// æ’å€¼ç±»å‹</span>
 __proto__<span class="token operator">:</span> Object</code></pre></div>
<p>â€‹	å¦‚ä¸Šæ‰€æ³¨é‡Šçš„ï¼Œç¬¬ä¸€çº§çš„ loc æ˜¯é€šè¿‡è§£æ â€{{ foo + bar}}â€ åœ¨æ•´ä¸ªæ¨¡æ¿ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œcontent é‡Œé¢åŒ…å«çš„æ˜¯æ’å€¼å†…éƒ¨çš„ä¿¡æ¯ï¼Œå³çœŸæ­£çš„è¡¨è¾¾å¼ç»“æ„ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><code class="language-text">{type: 2, content: &quot; text&quot;, loc: {â€¦}}</code>
å’Œç¬¬ä¸€æ­¥ä¸­ä¸€æ ·ï¼Œåªä¼šç»è¿‡ parseText(context, mode) è§£æå‡ºçº¯æ–‡æœ¬å†…å®¹ï¼šâ€ textâ€ï¼Œæœ€åçš„ç»“æ„ï¼š</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
 type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
 content<span class="token operator">:</span> <span class="token string">" text"</span><span class="token punctuation">,</span>
 loc<span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token comment">// ä» text å‰é¢çš„ç©ºæ ¼å¼€å§‹è®°å½•ï¼Œ</span><span class="token string">"some {{ foo + bar }}"</span> é•¿åº¦ä¸º <span class="token number">20</span>
   start<span class="token operator">:</span> <span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   source<span class="token operator">:</span> <span class="token string">" text"</span><span class="token punctuation">,</span>
   end<span class="token operator">:</span> <span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<p>ä¸‰æ­¥åˆ†æå®Œä¹‹åï¼Œåˆ°ç°åœ¨æˆ‘ä»¬åº”è¯¥å…·å¤‡è„±ç¦»ä»£ç å°±å¯ä»¥ç›´æ¥æ ¹æ®æ¨¡æ¿å¾—åˆ°è§£æåå¯¹åº”çš„ children ç»“æ„ã€‚åˆ†æçš„é‡ç‚¹æ˜¯è¦å¾—åˆ°ä¸€ä¸ª <code class="language-text">{ type, content, loc: { start, source, end }}</code> ç»“æ„çš„å¯¹è±¡ã€‚</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token comment">// start/end: </span>
<span class="token punctuation">{</span> 
  column<span class="token comment">/*è¯¥èŠ‚ç‚¹èµ·å§‹ç»“æŸçš„åˆ—ï¼Œä»1å¼€å§‹è®¡æ•°çš„å€¼*/</span><span class="token punctuation">,</span> 
  line<span class="token comment">/*è¯¥èŠ‚ç‚¹æ¨¡æ¿æ‰€åœ¨çš„è¡Œï¼Œä»1å¼€å§‹è®¡æ•°çš„å€¼*/</span><span class="token punctuation">,</span> 
  offset<span class="token comment">/*è¯¥èŠ‚ç‚¹èµ·å§‹ç»“æŸçš„ç´¢å¼•ï¼Œä»0å¼€å§‹è®¡æ•°çš„å€¼*/</span> 
<span class="token punctuation">}</span></code></pre></div>
<p><font color="blue">PS: å¯¹äº foo å’Œ bar å˜é‡æ•°æ®è§£ææ‰§è¡Œç»“æœè¿™å—æš‚æ—¶ä¸è®¨è®ºï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•åšåˆ°çš„ï¼Œç°é˜¶æ®µåªå…³å¿ƒæ¨¡æ¿çš„è§£æã€‚</font></p>
<h2 id="parsetagcontext-type-parent" style="position:relative;"><a href="#parsetagcontext-type-parent" aria-label="parsetagcontext type parent permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseTag(context, type, parent)</h2>
<p><span id="parse-parsetag"></span></p>
<h3 id="é˜¶æ®µä¸€simple-textdiv" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E4%B8%80simple-textdiv" aria-label="é˜¶æ®µä¸€simple textdiv permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µä¸€(<a href="#test-text-02">simple text&#x3C;/div></a>)</h3>
<p><span id="parse-parsetag-01"></span></p>
<ol>
<li>ä¸ºä»€ä¹ˆåªåŒ¹é… <code class="language-text">&lt;/div</code> è€Œå¿½ç•¥æ‰æœ€åä¸€ä¸ª <code class="language-text">&gt;</code>???</li>
</ol>
<p>å‚æ•°: </p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>
  context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span> <span class="token comment">// è¦ç»§ç»­è§£æçš„æ¨¡æ¿å¯¹è±¡ simple text&lt;/div> é‡Œé¢çš„ &lt;/div> </span>
  <span class="token keyword">type</span><span class="token operator">:</span> TagType<span class="token punctuation">,</span> <span class="token comment">// Start(&lt;div>), End(&lt;/div>)å¼€å§‹ç»“æŸæ ‡ç­¾</span>
  parent<span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token comment">// è¯¥æ ‡ç­¾çš„çˆ¶çº§</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ElementNode</code></pre></div>
<p>å…·ä½“å®ç°ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> type<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ simple text çš„é•¿åº¦</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åŒ¹é… &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ > ç»™å¿½ç•¥æ‰???</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^&lt;\/?([a-z][^\t\r\n\f />]*)/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ns <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div> çš„æœ€æœ‰ä¸€ä¸ª > ä¸Š</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿‡æ»¤æ‰ç©ºæ ¼</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> cursor <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> currSource <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="é˜¶æ®µäºŒtest-text-05" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E4%BA%8Ctest-text-05" aria-label="é˜¶æ®µäºŒtest text 05 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µäºŒ(<a href="#test-text-05">test-text-05</a>)</h3>
<p><span id="parse-parsetag-02"></span></p>
<p>æ»¡è¶³ç”¨ä¾‹ 5(<code class="language-text">some &lt;span&gt;{{ foo &lt; bar + foo }} text&lt;/span&gt;</code>) çš„ä»£ç å®ç°ï¼Œè¿™é‡Œåªéœ€è¦èƒ½è§£æ <code class="language-text">&lt;span&gt; ... &lt;/span&gt;</code> æ ‡ç­¾å°±å¯ä»¥ï¼Œæ²¡æœ‰ <code class="language-text">pre</code>,<code class="language-text">v-pre</code>,<code class="language-text">&lt;span/&gt;è‡ªé—­åˆæ ‡ç­¾</code>ï¼Œå› æ­¤ä¸‹é¢çœç•¥è¿™å‡ éƒ¨åˆ†æ£€æµ‹ä»£ç ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> type<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// åŒ¹é… &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ > ç»™å¿½ç•¥æ‰???</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^&lt;\/?([a-z][^\t\r\n\f />]*)/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> ns <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token comment">// log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div> çš„æœ€æœ‰ä¸€ä¸ª > ä¸Š</span>
  <span class="token comment">// åœ¨è¿™é‡Œ context.offset = 10, context.line = 1</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token comment">// è¿‡æ»¤æ‰ç©ºæ ¼</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// log2: ç»è¿‡ advanceä¹‹å context.offset = 15, context.line = 1</span>
  <span class="token comment">// æ­£å¥½è¿‡æ»¤ &lt;/div 5ä¸ªå­—ç¬¦</span>
  <span class="token keyword">const</span> cursor <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> currSource <span class="token operator">=</span> context<span class="token punctuation">.</span>source

  <span class="token comment">// TODO-1 è§£ææ ‡ç­¾å…ƒç´ çš„å±æ€§</span>

  <span class="token comment">// TODO-2 in pre ...</span>

  <span class="token comment">// TODO-3 v-pre æŒ‡ä»¤</span>

  <span class="token comment">// TODO-3 &lt;div/> è‡ªé—­æ ‡ç­¾</span>
  <span class="token comment">// è¿™é‡Œè¦å®ç°ï¼Œä¸ç„¶æœ€åè§£æå®Œæˆä¹‹å source ä¼šæ˜¯ï¼š>...&lt;/span></span>
  <span class="token comment">// éœ€è¦æ£€æµ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ¥ç§»åŠ¨æŒ‡é’ˆä½ç½®</span>
  <span class="token keyword">let</span> isSelfClosing <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_TAG</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// some &lt;div> ... &lt;/div> åˆ°è¿™é‡Œçš„ source = > ... &lt;/div></span>
    <span class="token comment">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /> å¼€å¤´çš„</span>
    isSelfClosing <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/>'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End <span class="token operator">&amp;&amp;</span> isSelfClosing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/>)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(>)</span>
    <span class="token comment">// åˆ°è¿™é‡Œ source = ... &lt;/div></span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> context<span class="token punctuation">.</span>options
  <span class="token comment">// ä¸æ˜¯ v-preï¼Œä¸”ä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ª if ç›®çš„æ˜¯ä¸ºäº†æ£€æµ‹å¹¶æ”¹å˜</span>
  <span class="token comment">// tagType æ ‡ç­¾ç±»å‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span><span class="token function">isCustomElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO-4 æ£€æµ‹ tagType</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    tagType<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// TODO</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¦èƒ½é€šè¿‡<a href="#test-text-05">ç”¨ä¾‹5</a> å¿…é¡»æ­é… <a href="#parse-parseelement">parseElement(context, ancestors) </a> æ‰è¡Œï¼Œå¹¶ä¸”é‡ç‚¹åœ¨ parseElement ä¸­ï¼Œå› ä¸ºæœ‰äº†å¼€å§‹æ ‡ç­¾æ‰ä¼šæœ‰ç»“æŸæ ‡ç­¾çš„è§£æï¼Œä¸ç„¶ä¼šè§¦å‘ç»“æŸæ ‡ç­¾è§£æåˆ†æ”¯é‡Œé¢çš„ error: </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/[a-z]/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œéƒ½å‡ºé”™äº†ï¼Œä¸ºå•¥åé¢è¿˜æœ‰ä¸ª parseTag ???</span>
  <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_INVALID_END_TAG</span><span class="token punctuation">)</span>
  <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token keyword">continue</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å› æ­¤å¦‚æœè¿™é‡Œä¸ä¼šè§¦å‘ X<em>INVALID</em>END_TAG é‚£å¿…å®šæ˜¯ parseElement é‡Œé¢åšäº†ä»€ä¹ˆå¤„ç†ï¼Œè¿™ä¸ªå®ç°äº† parseElement æ‰å¾—ä»¥çŸ¥æ™“(ç›®å‰åªæ˜¯çŒœæµ‹~~~)ï¼Œ<a href="#parse-parseelement">ä¼ é€é—¨ ğŸšª>>></a></p>
<h3 id="é˜¶æ®µä¸‰test-element-03" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E4%B8%89test-element-03" aria-label="é˜¶æ®µä¸‰test element 03 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µä¸‰(<a href="#test-element-03">test-element-03</a>)</h3>
<p><span id="parse-parsetag-03"></span></p>
<p>æ”¯æŒè‡ªé—­æ ‡ç­¾è§£æï¼Œå®ç°äº†é˜¶æ®µäºŒä¹‹åï¼Œè¿™é‡Œå…¶å®å¾ˆç®€å•ï¼Œåœ¨ä¸Šä¸€é˜¶æ®µä¸­çš„å®ç°åœ¨ parseTag ä¸­è¿”å›çš„æ—¶å€™ <code class="language-text">isSelfClosing</code> å†™æ­»æˆäº† <code class="language-text">false</code> ï¼Œè¦æ”¯æŒè¿™ä¸ªç”¨ä¾‹ï¼Œåªè¦å°†å®ƒçš„å€¼èµ‹å€¼ä¸ºå®é™…çš„ <code class="language-text">isSelfClosing</code> å°±å¯ä»¥äº†ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">parseTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">let</span> isSelfClosing <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_TAG</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// some &lt;div> ... &lt;/div> åˆ°è¿™é‡Œçš„ source = > ... &lt;/div></span>
    <span class="token comment">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /> å¼€å¤´çš„</span>
    isSelfClosing <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/>'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End <span class="token operator">&amp;&amp;</span> isSelfClosing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/>)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(>)</span>
    <span class="token comment">// åˆ°è¿™é‡Œ source = ... &lt;/div></span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="é˜¶æ®µå››æ”¯æŒtemplate--v-if" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E5%9B%9B%E6%94%AF%E6%8C%81template--v-if" aria-label="é˜¶æ®µå››æ”¯æŒtemplate  v if permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µå››(æ”¯æŒtemplate + v-if)</h3>
<p><span id="parse-parsetag-04"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> type<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰è§£æçš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å€¼åº”è¯¥æ˜¯ some text çš„é•¿åº¦</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// åŒ¹é… &lt;div æˆ– &lt;/div è¿‡æ»¤æ‰ç©ºæ ¼å­—ç¬¦ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦æŠŠ > ç»™å¿½ç•¥æ‰???</span>
  <span class="token comment">// å…¶å®ä¸æ˜¯å¿½ç•¥æ‰ > è€Œæ˜¯å› ä¸ºå¦‚æœæ˜¯ &lt;div å¼€å¤´ï¼Œé‚£ä¹ˆåé¢æœ‰å¯èƒ½æ˜¯ &lt; æˆ–</span>
  <span class="token comment">// /> åé¢éœ€è¦å¤„ç†é—­åˆå’Œéé—­åˆé—®é¢˜</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^&lt;\/?([a-z][^\t\r\n\f />]*)/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> ns <span class="token operator">=</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
  <span class="token comment">// log1: æ”¹å˜ä½ç§»ï¼Œå°† offset å®šä½åˆ° &lt;/div> çš„æœ€æœ‰ä¸€ä¸ª > ä¸Š</span>
  <span class="token comment">// åœ¨è¿™é‡Œ context.offset = 10, context.line = 1</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token comment">// è¿‡æ»¤æ‰ç©ºæ ¼</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// log2: ç»è¿‡ advanceä¹‹å context.offset = 15, context.line = 1</span>
  <span class="token comment">// æ­£å¥½è¿‡æ»¤ &lt;/div 5ä¸ªå­—ç¬¦</span>
  <span class="token keyword">const</span> cursor <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> currSource <span class="token operator">=</span> context<span class="token punctuation">.</span>source

  <span class="token comment">// è§£ææ ‡ç­¾å…ƒç´ çš„å±æ€§</span>
  <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> type<span class="token punctuation">)</span>

  <span class="token comment">// TODO-2 in pre ...</span>

  <span class="token comment">// TODO-3 v-pre æŒ‡ä»¤</span>

 <span class="token comment">// ....</span>

  <span class="token keyword">let</span> tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> context<span class="token punctuation">.</span>options
  <span class="token comment">// ä¸æ˜¯ v-preï¼Œä¸”ä¸æ˜¯è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¿™ä¸ª if ç›®çš„æ˜¯ä¸ºäº†æ£€æµ‹å¹¶æ”¹å˜</span>
  <span class="token comment">// tagType æ ‡ç­¾ç±»å‹</span>
  <span class="token comment">// TODO-4 æ£€æµ‹ tagType</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span><span class="token function">isCustomElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ˜¯å¦æœ‰ is æŒ‡ä»¤ï¼Ÿ</span>
    <span class="token keyword">const</span> hasVIs <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=></span> p<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'is'</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>isNativeTag <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasVIs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ²¡æœ‰ is æŒ‡ä»¤ï¼Œä¸”ä¸æ˜¯åŸç”Ÿæ ‡ç­¾ï¼Œé‚£å°±æ˜¯è‡ªå®šä¹‰çš„ç»„ä»¶äº†</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span><span class="token function">isNativeTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">COMPONENT</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      hasVIs <span class="token operator">||</span>
      <span class="token function">isCoreComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">||</span>
      options<span class="token punctuation">.</span>isBuiltInComponent<span class="token operator">?.</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token regex">/^[A-Z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">||</span>
      tag <span class="token operator">===</span> <span class="token string">'component'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æœ‰ is æŒ‡ä»¤ || vue æ ¸å¿ƒç»„ä»¶(keep-alive...) || å†…ç½®ç»„ä»¶</span>
      <span class="token comment">// || æ ‡ç­¾åå¤§å†™å¼€å¤´</span>
      tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">COMPONENT</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">SLOT</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span>
      props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          p<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSpecialTemplateDirective</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯æ¨¡æ¿çš„å‰ææ˜¯æœ‰æŒ‡ä»¤ï¼Œå¹¶ä¸”æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤</span>
      tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
    ns<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    tagType<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// TODO</span>
    isSelfClosing<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> val
<span class="token punctuation">}</span></code></pre></div>
<p>è¿™é‡Œçš„å®ç°æ¶‰åŠåˆ°å‡ ä¸ªæ–°çš„å‡½æ•°ï¼š</p>
<ol>
<li><code class="language-text">options.isCustomElement(tag)</code> é»˜è®¤åœ¨ options é‡Œé¢æ˜¯ <code class="language-text">NO</code></li>
<li><code class="language-text">options.isNativeTag(tag)</code> ä½œä¸ºå¯é€‰ <code class="language-text">OptionalOptions</code> é€‰é¡¹ç±»å‹ï¼Œå¹¶æ²¡é»˜è®¤å€¼</li>
<li>
<p><code class="language-text">isCoreComponent(tag)</code> vue å†…éƒ¨ä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„æ ‡ç­¾</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token comment">// ä¸»è¦å°±è¿™å››ä¸ª</span>
 Teleport<span class="token operator">:</span> TELEPORT<span class="token punctuation">,</span>
 Suspense<span class="token operator">:</span> SUSPENSE<span class="token punctuation">,</span>
 KeepAlive<span class="token operator">:</span> KEEP_ALIVE<span class="token punctuation">,</span>
 BaseTransition<span class="token operator">:</span> BASE_TRANSITION
<span class="token punctuation">}</span></code></pre></div>
</li>
<li><code class="language-text">options.isBuiltInComponent?.(tag)</code>  å’Œ <code class="language-text">isNativeTag</code> ä¸€æ ·ä½œä¸ºå¯é€‰é€‰é¡¹ï¼Œæ— é»˜è®¤å€¼</li>
<li>
<p><code class="language-text">isSpecialTemplateDirective(p.name)</code> ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> isSpecialTemplateDirective <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>
 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">if,else,else-if,for,slot</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span></code></pre></div>
</li>
</ol>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè¦è¢«å®šä¹‰ä¸ºæ˜¯ <code class="language-text">&lt;template&gt;</code> ç±»å‹å¿…é¡»åŒ…å« <code class="language-text">if,else,else-if,for,slot</code> è¿™å…¶ä¸­çš„ä»»ä¸€ä¸ªæŒ‡ä»¤å±æ€§ï¼Œåˆ¤æ–­æ¡ä»¶ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>
  tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span>
  props<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token comment">// isSpecialTemplateDirective æ˜¯ä½¿ç”¨ makeMap åˆ›å»ºçš„å‡½æ•°</span>
    <span class="token comment">// å³ key => true/false çš„ä¸€äº›å‡½æ•°</span>
    p<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSpecialTemplateDirective</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ˜¯æ¨¡æ¿çš„å‰ææ˜¯æœ‰æŒ‡ä»¤ï¼Œå¹¶ä¸”æ˜¯ç‰¹æ®Šçš„æ¨¡æ¿æŒ‡ä»¤(if, else, else-if, slot, for)</span>
  tagType <span class="token operator">=</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">TEMPLATE</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="parsetextcontext-mode" style="position:relative;"><a href="#parsetextcontext-mode" aria-label="parsetextcontext mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseText(context, mode)</h2>
<p><span id="parse-parsetext"></span></p>
<p>è§£ææ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°(<code class="language-text">&lt;</code>,<code class="language-text">{{</code>,<code class="language-text">]]&gt;</code>)ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span> mode<span class="token operator">:</span> TextModes</span><span class="token punctuation">)</span><span class="token operator">:</span> TextNode <span class="token punctuation">{</span>
  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> endTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">']]>'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endTokens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>endTokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> endIndex <span class="token operator">></span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      endIndex <span class="token operator">=</span> index
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  __TEST__ <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>endIndex <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// æ–‡æœ¬å†…å®¹å¯èƒ½åŒ…å« &amp;gt; &amp;lt; &amp;amp; &amp;apos; &amp;quot; ç­‰htmlç¬¦å·ï¼Œéœ€è¦</span>
  <span class="token comment">// å°†ä»–ä»¬æ›¿æ¢æˆå¯¹åº” >    &lt;    &amp;     '      "</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    content<span class="token punctuation">,</span>
    loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å¯¼å›¾ï¼š</p>
<p><img src="http://qiniu.ii6g.com/parse-ts-parsetext.png?imageMogr2/thumbnail/!100p" alt="parse-text-å¯¼å›¾"></p>
<h2 id="parsetextdatacontext-length-mode" style="position:relative;"><a href="#parsetextdatacontext-length-mode" aria-label="parsetextdatacontext length mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseTextData(context, length, mode)</h2>
<p><span id="parse-parsetextdata"></span></p>
<p>æ–‡æœ¬èŠ‚ç‚¹å¯èƒ½åŒ…å«æ•°æ®ï¼Œé€šè¿‡ <em>context.options.decodeEntities(???)</em> æ¥è§£æã€‚</p>
<p>ä¸€äº›å­—ç¬¦çš„htmlä¹¦å†™æ ¼å¼ï¼Œæœ‰ <code class="language-text">/&amp;(gt|lt|amp|apos|quot);/</code>ï¼Œæœ€ç»ˆä¼šè¢«å¯¹åº”çš„å­—ç¬¦æ›¿æ¢æ‰ã€‚</p>
<p><code class="language-text">decodeEntities: (rawText: string): string =&gt; rawText.replace(decodeRE, (_, p1) =&gt; decodeMap[p1])</code></p>
<p>å­—ç¬¦é›†ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> decodeMap<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  gt<span class="token operator">:</span> <span class="token string">'>'</span><span class="token punctuation">,</span>
  lt<span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span>
  amp<span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span>
  apos<span class="token operator">:</span> <span class="token string">"'"</span><span class="token punctuation">,</span>
  quot<span class="token operator">:</span> <span class="token string">'"'</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ä»£ç ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">/**
 * Get text data with a given length from the current location.
 * This translates HTML entities in the text data.
 */</span>
<span class="token keyword">function</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  length<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawText <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span> <span class="token operator">||</span>
    mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span> <span class="token operator">||</span>
    rawText<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rawText <span class="token comment">// å¦‚æœä¸åŒ…å« &amp;gt; &amp;lt; ç­‰htmlæ ‡è®°</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// DATA or RCDATA containing "&amp;"". Entity decoding required.</span>
    <span class="token comment">// å¦‚æœå­—ç¬¦ä¸²ä¸­åŒ…å«è¿™äº›å­—ç¬¦ï¼Œå¾—å»å°†ä»–ä»¬æ›¿æ¢æˆå¯¹åº”çš„æ˜æ–‡å­—ç¬¦ã€‚</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">decodeEntities</span><span class="token punctuation">(</span>
      rawText<span class="token punctuation">,</span>
      mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å¯¼å›¾ï¼š<img src="http://qiniu.ii6g.com/parse-ts-parsetextdata.png?imageMogr2/thumbnail/!100p" alt="parse-textd-ata"></p>
<h2 id="parseattributescontext-type" style="position:relative;"><a href="#parseattributescontext-type" aria-label="parseattributescontext type permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseAttributes(context, type)</h2>
<p><span id="parse-parseattributes"></span></p>
<p>è¿™ä¸ªæ˜¯è§£ææ•´ä¸ªæ ‡ç­¾çš„æ‰€æœ‰å±æ€§ï¼Œå› æ­¤è¯¥å±æ€§åªæ˜¯åšäº†ä¸€äº›éæ³•æƒ…å†µçš„æ£€æµ‹ï¼Œå®é™…çœŸæ­£è§£æå±æ€§çš„åœ°æ–¹åœ¨ <a href="#parse-parseattribute">parseAttribute</a> é‡Œé¢ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// è§£ææ ‡ç­¾æ‰€æœ‰å±æ€§</span>
<span class="token keyword">function</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> attributeNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/>'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éæ³•å±æ€§ï¼Œ &lt;div /v-if="ok">&lt;/div>??</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_SOLIDUS_IN_TAG</span><span class="token punctuation">)</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &lt;/div> ç»“æŸæ ‡ç­¾ï¼Œä»¥å±æ€§ç»“æŸçš„æ ‡ç­¾?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_ATTRIBUTES</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// é€ä¸ªè§£æå±æ€§</span>
    <span class="token keyword">const</span> attr <span class="token operator">=</span> <span class="token function">parseAttribute</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attributeNames<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>Start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      props<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^[^\t\r\n\f />]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">MISSING_WHITESPACE_BETWEEN_ATTRIBUTES</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> props
<span class="token punctuation">}</span></code></pre></div>
<h2 id="parseattributecontext-nameset" style="position:relative;"><a href="#parseattributecontext-nameset" aria-label="parseattributecontext nameset permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseAttribute(context, nameSet)</h2>
<p><span id="parse-parseattribute"></span></p>
<p>è§£ææ ‡ç­¾å±æ€§æˆ–æŒ‡ä»¤ï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseAttribute</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> nameSet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^[^\t\r\n\f />][^\t\r\n\f />=]*/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nameSet<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é‡å¤å±æ€§å</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">DUPLICATE_ATTRIBUTE</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  nameSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// =name=value ?</span>
    <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_EQUALS_SIGN_BEFORE_ATTRIBUTE_NAME</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token regex">/["'&lt;]/g</span>
    <span class="token keyword">let</span> m
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> pater<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¸åˆæ³•çš„å±æ€§å</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME</span><span class="token punctuation">,</span>
        m<span class="token punctuation">.</span>index
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç§»åŠ¨æŒ‡é’ˆ</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token comment">// type: { content, isQuoted, loc }</span>
  <span class="token keyword">let</span> value

  <span class="token comment">// å»ç©ºæ ¼è§£æå±æ€§å€¼</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^[\t\r\n\f ]*=/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å±æ€§åä¸ = ä¹‹é—´å­˜åœ¨ç©ºæ ¼çš„æƒ…å†µï¼Œå»æ‰ç©ºæ ¼</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token comment">// å»æ‰ç©ºæ ¼ä¹‹åè§£æå±æ€§å€¼</span>
    value <span class="token operator">=</span> <span class="token function">parseAttributeValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">MISSING_ATTRIBUTE_VALUE</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> loc <span class="token operator">=</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span>

  <span class="token comment">// v-dir æˆ– ç¼©å†™</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token regex">/^(v-|:|@|#)/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ?: éæ•è·ç»„</span>
    <span class="token comment">// 1. (?:^v-([a-z0-9]+))? -> åŒ¹é… v-dir æŒ‡ä»¤ï¼Œéè´ªå©ªåŒ¹é…ï¼Œæ•è·æŒ‡ä»¤å</span>
    <span class="token comment">//   ç§°([a-z0=9]+)</span>
    <span class="token comment">// 2. (?:(?::|^@|^#)([^\.]+))? -> åŒ¹é… :,@,#</span>
    <span class="token comment">// 3. (.+)?$ åŒ¹é…ä»»æ„å­—ç¬¦</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\.]+))?(.+)?$/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>
      name
    <span class="token punctuation">)</span>

    <span class="token keyword">let</span> arg

    <span class="token comment">// ([a-z0-9]+), ([^\.]+)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> startOffset <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> loc <span class="token operator">=</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        <span class="token function">getNewPosition</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">,</span> startOffset<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">getNewPosition</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">,</span> startOffset <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

      <span class="token keyword">let</span> content <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> isStatic <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// é™æ€å±æ€§å</span>

      <span class="token comment">// åŠ¨æ€å±æ€§åè§£æ</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'['</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isStatic <span class="token operator">=</span> <span class="token boolean">false</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¦‚æœæ˜¯åŠ¨æ€å±æ€§åï¼Œå¿…é¡»æ˜¯ [varName] å½¢å¼</span>
          <span class="token function">emitError</span><span class="token punctuation">(</span>
            context<span class="token punctuation">,</span>
            ErrorCodes<span class="token punctuation">.</span><span class="token constant">X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      arg <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
        content<span class="token punctuation">,</span>
        isStatic<span class="token punctuation">,</span>
        isConstant<span class="token operator">:</span> isStatic<span class="token punctuation">,</span>
        loc
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å±æ€§æ˜¯å¦è¢«å¼•å·åŒ…èµ·æ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>isQuoted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> valueLoc <span class="token operator">=</span> value<span class="token punctuation">.</span>loc
      valueLoc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>offset<span class="token operator">++</span>
      valueLoc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>column<span class="token operator">++</span>
      valueLoc<span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token function">advancePositionWithClone</span><span class="token punctuation">(</span>valueLoc<span class="token punctuation">.</span>start<span class="token punctuation">,</span> value<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
      <span class="token comment">// å–å¼•å·å†…çš„æ‰€æœ‰å†…å®¹</span>
      valueLoc<span class="token punctuation">.</span>source <span class="token operator">=</span> valueLoc<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span><span class="token punctuation">,</span>
      <span class="token comment">// : -> v-bind, @ -> v-on, # -> v-slot çš„ç¼©å†™</span>
      name<span class="token operator">:</span>
        match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'bind'</span> <span class="token operator">:</span> name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'on'</span> <span class="token operator">:</span> <span class="token string">'slot'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      exp<span class="token operator">:</span> value <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> value<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        isStatic<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        isConstant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        loc<span class="token operator">:</span> value<span class="token punctuation">.</span>loc
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      arg<span class="token punctuation">,</span>
      <span class="token comment">// ä¿®é¥°ç¬¦å¤„ç†, v-bind.m1.m2 -> .m1.m2 -> ['m1', 'm2']</span>
      modifiers<span class="token operator">:</span> match<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">?</span> match<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>substr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      loc
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    value<span class="token operator">:</span> value <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> value<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      loc<span class="token operator">:</span> value<span class="token punctuation">.</span>loc
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loc
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è¯¥å‡½æ•°å®ç°ä¸»è¦æœ‰å‡ éƒ¨åˆ†(ä»¥ <code class="language-text">&lt;div v-bind:keyup.enter.prevent=&quot;ok&quot;&gt;&lt;/div&gt;</code> ä¸ºä¾‹)ï¼š</p>
<ol>
<li>åŒ¹é…å±æ€§åï¼Œå…³é”®æ­£åˆ™ï¼š<code class="language-text">/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</code> ä¼šå°† <code class="language-text">v-if=&quot;varname&quot;</code> ä¸­ç­‰å·å‰é¢çš„<code class="language-text">v-bind:keyup.enter.prevent</code>éƒ½åŒ¹é…å‡ºæ¥ã€‚</li>
<li>å°†åŒ¹é…åˆ°çš„å±æ€§åæ”¶é›†åˆ° <code class="language-text">nameSet[]</code> ä¸­ï¼Œæ£€æµ‹é‡å¤æ€§ã€‚
<font color="purple">è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå±æ€§ååŒ¹é…çš„ç»“æœä¼šå°†å˜é‡åï¼Œä¿®é¥°ç¬¦éƒ½åŒ¹é…åˆ°ï¼Œå¦‚ï¼š<code class="language-text">&lt;div v-bind:keyup.enter.prevent=&quot;ok&quot;&gt;</code>ï¼Œæœ€å add åˆ° nameSet ä¸­çš„å®Œæ•´å±æ€§åä¸ºï¼š<code class="language-text">v-bind:keyup.enter.prevent</code>ã€‚</font></li>
<li>éæ³•å±æ€§åæ£€æµ‹(å¦‚ï¼š<code class="language-text">=name=value</code>ï¼Œæˆ–å±æ€§åä¸­åŒ…å« <code class="language-text">[&quot;&#39;&lt;]</code> å­—ç¬¦)ï¼Œå¼‚å¸¸</li>
<li>ç§»åŠ¨æŒ‡é’ˆ <code class="language-text">advanceBy(context, name.length)</code> å®šä½åˆ°å±æ€§ååçš„ä½ç½®ï¼Œç›®çš„æ˜¯ä¸ºäº†å–å±æ€§å€¼ï¼Œå‰©ä¸‹ï¼š<code class="language-text">=&quot;ok&quot;</code>ã€‚</li>
<li>
<p>æ­£åˆ™ï¼š<code class="language-text">/^[\t\r\n\f ]*=/</code>ï¼Œè§£æå±æ€§å€¼ï¼Œè°ƒç”¨ <a href="#pars-parseattributevalue">parseAttributeValue</a> è§£æå‡ºå±æ€§å€¼æ¥</p>
<ol>
<li>æŒ‡é’ˆå½’ä½è‡³å¼€å§‹ä½ç½®ï¼Œå¦‚ï¼š <code class="language-text">v-bind:keyup.enter.prevent=&quot;ok&quot;</code> çš„å¼€å§‹ä½ç½®ä¸º <code class="language-text">v</code> ä½ç½®ï¼Œè§£æä¿®é¥°ç¬¦ï¼Œå¾—åˆ° <code class="language-text">modifiers: []</code>ï¼Œè¿™é‡Œçš„å…³é”®åœ¨äºæ­£åˆ™ï¼š<code class="language-text">/(?:^v-([a-z0-9]+))?(?:(?::|^@|^#)([^\.]+))?(.+)?$/i</code>ï¼Œä¼šåŒ¹é… <code class="language-text">v-if, :, @, #...</code> æŒ‡ä»¤å’ŒæŒ‡ä»¤ç¼©å†™ä»¥åŠä¿®é¥°ç¬¦ã€‚</li>
<li>è§£ææŒ‡ä»¤åé¢çš„å˜é‡åç§°ï¼Œå¦‚ï¼š<code class="language-text">keyup</code>ï¼Œæœ‰å¯èƒ½æ˜¯åŠ¨æ€å€¼ <code class="language-text">v-bind:[varname]</code>ã€‚</li>
<li>æ£€æµ‹å±æ€§å€¼æœ‰æ²¡è¢«å¼•å·åŒ…èµ·æ¥ï¼Œå¦‚æœæœ‰ï¼Œè¦æ›´æ–° value.locï¼Œåªå–å¼•å·å†…çš„å†…å®¹ <code class="language-text">content.source = valueLoc.source.slice(1, -1)</code></li>
<li>è¿”å›æŒ‡ä»¤èŠ‚ç‚¹ç±»å‹å¯¹è±¡</li>
</ol>
</li>
<li>å¦åˆ™è¿”å›æ™®é€šå±æ€§ç±»å‹èŠ‚ç‚¹</li>
</ol>
<h2 id="parseattributevaluecontext" style="position:relative;"><a href="#parseattributevaluecontext" aria-label="parseattributevaluecontext permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parseAttributeValue(context)</h2>
<p><span id="parse-parseattributevalue"></span></p>
<p>è§£æå±æ€§å€¼ã€‚</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseAttributeValue</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¿å­˜æ¨¡æ¿å­—ç¬¦ä¸²æŒ‡é’ˆèµ·ç‚¹ä½ç½®</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

  <span class="token keyword">let</span> content

  <span class="token keyword">const</span> quote <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> isQuoted <span class="token operator">=</span> quote <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"</span><span class="token template-punctuation string">`</span></span> <span class="token operator">||</span> quote <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isQuoted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æœ‰å¼•å·</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span>
    <span class="token comment">// æ²¡æœ‰ç»“æŸå¼•å·??? æ•´ä¸ª source å½“åšæ–‡æœ¬æ•°æ®å¤„ç†???</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>endIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span><span class="token punctuation">)</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ²¡æœ‰å¼•å·</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex">/^[^\t\r\n\f >]+/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ— å±æ€§å€¼</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> unexpectedChars <span class="token operator">=</span> <span class="token regex">/["'&lt;=`]/g</span>
    <span class="token keyword">let</span> m
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> unexpectedChars<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ— å¼•å·å€¼ä¸­éæ³•å­—ç¬¦æ£€æµ‹</span>
      <span class="token function">emitError</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è§£ææ–‡æœ¬æ•°æ®</span>
    content <span class="token operator">=</span> <span class="token function">parseTextData</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE_VALUE</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> content<span class="token punctuation">,</span> isQuoted<span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="pushnodenodes-node" style="position:relative;"><a href="#pushnodenodes-node" aria-label="pushnodenodes node permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pushNode(nodes, node)</h2>
<p><span id="parse-pushnode"></span></p>
<ol>
<li>æ³¨é‡ŠèŠ‚ç‚¹ä¸å¤„ç†</li>
<li>åˆå¹¶æ–‡æœ¬èŠ‚ç‚¹(å‰ææ˜¯prev, node ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ç´§æŒ¨ç€çš„ï¼Œç”± loc.end.offset å’Œ loc.start.offsetåˆ¤æ–­)</li>
<li>è¿”å›æ–°å¢ node çš„ nodes èŠ‚ç‚¹æ•°ç»„</li>
</ol>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">pushNode</span><span class="token punctuation">(</span><span class="token parameter">nodes<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token operator">:</span> TemplateChildNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ignore comments in production</span>
  <span class="token comment">/* istanbul ignore next */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__DEV__ <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ä¸¤ä¸ªè¿ç€çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‹¼å‡‘åˆ°ä¸€èµ·å»</span>
    <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>
    <span class="token comment">// Merge if both this and the previous node are text and those are</span>
    <span class="token comment">// consecutive. This happens for cases like "a &lt; b".</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      prev <span class="token operator">&amp;&amp;</span>
      prev<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span>
      prev<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>end<span class="token punctuation">.</span>offset <span class="token operator">===</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">.</span>offset
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prev<span class="token punctuation">.</span>content <span class="token operator">+=</span> node<span class="token punctuation">.</span>content
      prev<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>end <span class="token operator">=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>end
      prev<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source <span class="token operator">+=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>source
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="isendcontext-mode-ancestors" style="position:relative;"><a href="#isendcontext-mode-ancestors" aria-label="isendcontext mode ancestors permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>isEnd(context, mode, ancestors)</h2>
<p><span id="parse-isend"></span></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">isEnd</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TextModes<span class="token punctuation">,</span>
  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'&lt;/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//TODO: probably bad performance</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> ancestors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> ancestors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>

    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token operator">:</span>
    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token function">startsWithEndTagOpen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> TextModes<span class="token punctuation">.</span><span class="token constant">CDATA</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">']]>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">!</span>s
<span class="token punctuation">}</span></code></pre></div>
<h2 id="getcursorcontext" style="position:relative;"><a href="#getcursorcontext" aria-label="getcursorcontext permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getCursor(context)</h2>
<p><span id="parse-getCursor"></span></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">getCursor</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">:</span> ParserContext</span><span class="token punctuation">)</span><span class="token operator">:</span> Position <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> column<span class="token punctuation">,</span> line<span class="token punctuation">,</span> offset <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token keyword">return</span> <span class="token punctuation">{</span> column<span class="token punctuation">,</span> line<span class="token punctuation">,</span> offset <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="getselectioncontext-start-end-postion" style="position:relative;"><a href="#getselectioncontext-start-end-postion" aria-label="getselectioncontext start end postion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>getSelection(context, start, end?: Postion)</h2>
<p><span id="parse-getselection"></span></p>
<p>å–å®æ—¶è§£æåçš„ sourceï¼Œstartï¼Œendçš„å€¼ã€‚</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">getSelection</span><span class="token punctuation">(</span>
  <span class="token parameter">context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span>
  start<span class="token operator">:</span> Position<span class="token punctuation">,</span>
  end<span class="token operator">?</span><span class="token operator">:</span> Position</span>
<span class="token punctuation">)</span><span class="token operator">:</span> SourceLocation <span class="token punctuation">{</span>
  end <span class="token operator">=</span> end <span class="token operator">||</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    start<span class="token punctuation">,</span>
    end<span class="token punctuation">,</span>
    source<span class="token operator">:</span> context<span class="token punctuation">.</span>originalSource<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>offset<span class="token punctuation">,</span> end<span class="token punctuation">.</span>offset<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="astts" style="position:relative;"><a href="#astts" aria-label="astts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ast.ts</h1>
<p><span id="file-ast"></span></p>
<h2 id="createrootchildren-loc--locstub" style="position:relative;"><a href="#createrootchildren-loc--locstub" aria-label="createrootchildren loc  locstub permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>createRoot(children, loc = locStub)</h2>
<p><span id="ast-createroot"></span></p>
<p>åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ª <a href="#td-ast-rootnode">RootNode</a> ç±»å‹å¯¹è±¡ã€‚</p>
<p>å‚æ•°ï¼š</p>
<ol>
<li>
<p>children èŠ‚ç‚¹å­å­™èŠ‚ç‚¹ï¼Œç±»å‹ï¼š<a href="#td-ast-tcn">TemplateChildNode[]</a></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">type</span> TemplateChildNode <span class="token operator">=</span>
 <span class="token operator">|</span> ElementNode <span class="token comment">// èŠ‚å…ƒç´ ç‚¹ç±»å‹</span>
 <span class="token operator">|</span> InterpolationNode <span class="token comment">// æ’å€¼èŠ‚ç‚¹</span>
 <span class="token operator">|</span> CompoundExpressionNode <span class="token comment">// æ··åˆè¡¨è¾¾å¼èŠ‚ç‚¹</span>
 <span class="token operator">|</span> TextNode <span class="token comment">// æ–‡æœ¬èŠ‚ç‚¹</span>
 <span class="token operator">|</span> CommentNode <span class="token comment">// æ³¨é‡ŠèŠ‚ç‚¹</span>
 <span class="token operator">|</span> IfNode <span class="token comment">// v-if èŠ‚ç‚¹</span>
 <span class="token operator">|</span> IfBranchNode <span class="token comment">// v-else, v-else-if åˆ†æ”¯èŠ‚ç‚¹</span>
 <span class="token operator">|</span> ForNode <span class="token comment">// v-ofr èŠ‚ç‚¹</span>
 <span class="token operator">|</span> TextCallNode <span class="token comment">// ???</span></code></pre></div>
</li>
<li>
<p>loc ä¸€ä¸ª SourceLoation ç±»å‹çš„ç»“æ„ï¼Œé»˜è®¤å€¼ä¸º <code class="language-text">locStub</code></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> locStub<span class="token operator">:</span> SourceLocation <span class="token operator">=</span> <span class="token punctuation">{</span>
 source<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
 start<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
 end<span class="token operator">:</span> <span class="token punctuation">{</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<p>ä»£ç ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>
  <span class="token parameter">children<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  loc <span class="token operator">=</span> locStub</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootNode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
    helpers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    directives<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    hoists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    cached<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    temps<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    codegenNode<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    loc
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="utilsts" style="position:relative;"><a href="#utilsts" aria-label="utilsts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>utils.ts</h1>
<h2 id="advancepositionwithmutationpossource-numberofcharacters" style="position:relative;"><a href="#advancepositionwithmutationpossource-numberofcharacters" aria-label="advancepositionwithmutationpossource numberofcharacters permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>advancePositionWithMutation(pos,source, numberOfCharacters)</h2>
<p><span id="util-advancepositionwithmutation"></span></p>
<p>æ›´æ–°contextçš„ lineï¼Œcolumnï¼Œoffsetçš„å€¼</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// advance by mutation without cloning (for performance reasons), since this</span>
<span class="token comment">// gets called a lot in the parser</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">advancePositionWithMutation</span><span class="token punctuation">(</span>
  <span class="token parameter">pos<span class="token operator">:</span> Position<span class="token punctuation">,</span>
  source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  numberOfCharacters<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> source<span class="token punctuation">.</span>length</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Position <span class="token punctuation">{</span>
  <span class="token keyword">let</span> linesCount <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> lastNewLinePos <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numberOfCharacters<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">10</span> <span class="token comment">/* newline char code */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      linesCount<span class="token operator">++</span>
      lastNewLinePos <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  pos<span class="token punctuation">.</span>offset <span class="token operator">+=</span> numberOfCharacters
  pos<span class="token punctuation">.</span>line <span class="token operator">+=</span> linesCount
  pos<span class="token punctuation">.</span>column <span class="token operator">=</span>
    lastNewLinePos <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token operator">?</span> pos<span class="token punctuation">.</span>column <span class="token operator">+</span> numberOfCharacters
      <span class="token operator">:</span> numberOfCharacters <span class="token operator">-</span> lastNewLinePos

  <span class="token keyword">return</span> pos
<span class="token punctuation">}</span></code></pre></div>
<h1 id="å˜é‡å£°æ˜" style="position:relative;"><a href="#%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E" aria-label="å˜é‡å£°æ˜ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å˜é‡å£°æ˜</h1>
<p>è¯¥æ¨¡å—ç›¸å…³çš„ä¸€äº›å…¨å±€å˜é‡ä¿¡æ¯ã€‚</p>
<h2 id="æšä¸¾ç±»å‹" style="position:relative;"><a href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B" aria-label="æšä¸¾ç±»å‹ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æšä¸¾ç±»å‹</h2>
<h3 id="span-idtd-vars-textmodesspantextmodes" style="position:relative;"><a href="#span-idtd-vars-textmodesspantextmodes" aria-label="span idtd vars textmodesspantextmodes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span id="td-vars-textmodes"></span>TextModes</h3>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TextModes <span class="token punctuation">{</span>
  <span class="token comment">//          | Elements | Entities | End sign              | Inside of</span>
  <span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token comment">//    | âœ”        | âœ”        | End tags of ancestors |</span>
  <span class="token constant">RCDATA</span><span class="token punctuation">,</span> <span class="token comment">//  | âœ˜        | âœ”        | End tag of the parent | &lt;textarea></span>
  <span class="token constant">RAWTEXT</span><span class="token punctuation">,</span> <span class="token comment">// | âœ˜        | âœ˜        | End tag of the parent | &lt;style>,&lt;script></span>
  <span class="token constant">CDATA</span><span class="token punctuation">,</span>
  <span class="token constant">ATTRIBUTE_VALUE</span>
<span class="token punctuation">}</span></code></pre></div>
<p>è½¬æ¢æˆ javascriptï¼š</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> TextModes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//             | Elements | Entities | End sign              | Inside of</span>
  <span class="token constant">DATA</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//    | âœ”        | âœ”        | End tags of ancestors |</span>
  <span class="token constant">RCDATA</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//  | âœ˜        | âœ”        | End tag of the parent | &lt;textarea></span>
  <span class="token constant">RAWTEXT</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// | âœ˜        | âœ˜        | End tag of the parent | &lt;style>,&lt;script></span>
  <span class="token constant">CDATA</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token constant">ATTRIBUTE_VALUE</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="parser" style="position:relative;"><a href="#parser" aria-label="parser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>parser</h2>
<h3 id="defaultparseroptions" style="position:relative;"><a href="#defaultparseroptions" aria-label="defaultparseroptions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>defaultParserOptions</h3>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// é»˜è®¤çš„è§£æå™¨é€‰é¡¹</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> defaultParserOptions<span class="token operator">:</span> MergedParserOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  delimiters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{{</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">}}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getNamespace</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">,</span> <span class="token comment">// å‘½åç©ºé—´</span>
  <span class="token function-variable function">getTextMode</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡æœ¬ç±»å‹</span>
  isVoidTag<span class="token operator">:</span> <span class="token constant">NO</span><span class="token punctuation">,</span> <span class="token comment">// è‡ªå…³é—­æ ‡ç­¾???ï¼Œå¦‚ï¼š&lt;img>, &lt;hr> ...</span>
  isPreTag<span class="token operator">:</span> <span class="token constant">NO</span><span class="token punctuation">,</span> <span class="token comment">// &lt;pre> ä»£ç æ ‡ç­¾???ï¼Œéœ€è¦ä¿ç•™ç©ºæ ¼ä¿è¯ç¼©è¿›çš„</span>
  isCustomElement<span class="token operator">:</span> <span class="token constant">NO</span><span class="token punctuation">,</span> <span class="token comment">// è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¦‚ï¼šTransition</span>
  decodeEntities<span class="token operator">:</span> <span class="token punctuation">(</span>rawText<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token builtin">string</span></span> <span class="token operator">=></span> 
  	<span class="token comment">// è§£ç å®ä¾‹ï¼Œä¸€äº›ç‰¹æ®Šç¬¦å·è¡¨ç¤ºï¼Œå¦‚ï¼š&amp;gt;, &amp;lt;, &amp;amp;, &amp;apos; &amp;quot;</span>
    rawText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>decodeRE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token operator">=></span> decodeMap<span class="token punctuation">[</span>p1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  onError<span class="token operator">:</span> defaultOnError
<span class="token punctuation">}</span></code></pre></div>
<p>ä½¿ç”¨åˆ°çš„å…¶ä»–å…¨å±€å˜é‡ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> decodeRE <span class="token operator">=</span> <span class="token regex">/&amp;(gt|lt|amp|apos|quot);/g</span>
<span class="token keyword">const</span> decodeMap<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  gt<span class="token operator">:</span> <span class="token string">'>'</span><span class="token punctuation">,</span>
  lt<span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span>
  amp<span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span>
  apos<span class="token operator">:</span> <span class="token string">"'"</span><span class="token punctuation">,</span>
  quot<span class="token operator">:</span> <span class="token string">'"'</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="ç±»å‹å£°æ˜" style="position:relative;"><a href="#%E7%B1%BB%E5%9E%8B%E5%A3%B0%E6%98%8E" aria-label="ç±»å‹å£°æ˜ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ç±»å‹å£°æ˜</h1>
<p>è¯¥æ¨¡å—æ‰€æœ‰ç±»å‹å£°æ˜ç»Ÿä¸€å½’ç±»åˆ°æ­¤ï¼Œé¡ºåºæŒ‰ç…§ç”¨ä¾‹è§£æé‡åˆ°çš„é¡ºåºä¸ºä¸»ã€‚</p>
<h2 id="astts-1" style="position:relative;"><a href="#astts-1" aria-label="astts 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ast.ts</h2>
<h3 id="elementnode" style="position:relative;"><a href="#elementnode" aria-label="elementnode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ElementNode</h3>
<p><span id="td-ast-elementnode"></span></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">type</span> ElementNode <span class="token operator">=</span>
  <span class="token operator">|</span> PlainElementNode
  <span class="token operator">|</span> ComponentNode
  <span class="token operator">|</span> SlotOutletNode
  <span class="token operator">|</span> TemplateNode</code></pre></div>
<h3 id="templatechildnode" style="position:relative;"><a href="#templatechildnode" aria-label="templatechildnode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TemplateChildNode</h3>
<p><span id="td-ast-tcn"></span></p>
<p>æ¨¡æ¿å­å­™èŠ‚ç‚¹çš„å¯èƒ½ç±»å‹ç»„åˆï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">type</span> TemplateChildNode <span class="token operator">=</span>
  <span class="token operator">|</span> ElementNode <span class="token comment">// èŠ‚å…ƒç´ ç‚¹ç±»å‹</span>
  <span class="token operator">|</span> InterpolationNode <span class="token comment">// æ’å€¼èŠ‚ç‚¹</span>
  <span class="token operator">|</span> CompoundExpressionNode <span class="token comment">// æ··åˆè¡¨è¾¾å¼èŠ‚ç‚¹</span>
  <span class="token operator">|</span> TextNode <span class="token comment">// æ–‡æœ¬èŠ‚ç‚¹</span>
  <span class="token operator">|</span> CommentNode <span class="token comment">// æ³¨é‡ŠèŠ‚ç‚¹</span>
  <span class="token operator">|</span> IfNode <span class="token comment">// v-if èŠ‚ç‚¹</span>
  <span class="token operator">|</span> IfBranchNode <span class="token comment">// v-else, v-else-if åˆ†æ”¯èŠ‚ç‚¹</span>
  <span class="token operator">|</span> ForNode <span class="token comment">// v-ofr èŠ‚ç‚¹</span>
  <span class="token operator">|</span> TextCallNode <span class="token comment">// ???</span></code></pre></div>
<h3 id="rootnode" style="position:relative;"><a href="#rootnode" aria-label="rootnode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RootNode</h3>
<p><span id="td-ast-rootnode"></span></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RootNode</span> <span class="token keyword">extends</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span>
  children<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
  helpers<span class="token operator">:</span> <span class="token builtin">symbol</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  components<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  directives<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  hoists<span class="token operator">:</span> <span class="token punctuation">(</span>JSChildNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  imports<span class="token operator">:</span> ImportItem<span class="token punctuation">[</span><span class="token punctuation">]</span>
  cached<span class="token operator">:</span> <span class="token builtin">number</span>
  temps<span class="token operator">:</span> <span class="token builtin">number</span>
  ssrHelpers<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">symbol</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  codegenNode<span class="token operator">?</span><span class="token operator">:</span> TemplateChildNode <span class="token operator">|</span> JSChildNode <span class="token operator">|</span> BlockStatement <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="parseroptions" style="position:relative;"><a href="#parseroptions" aria-label="parseroptions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ParserOptions</h2>
<p><span id="td-parser-options"></span></p>
<p>å®šä¹‰ä½ç½®ï¼š<em><font color="purple"> src/options.ts</font></em></p>
<p>æ¥å£å†…å®¹ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ParserOptions</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * e.g. platform native elements, e.g. &lt;div> for browsers
   */</span>
  isNativeTag<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span>
  <span class="token comment">/**
   * e.g. native elements that can self-close, e.g. &lt;img>, &lt;br>, &lt;hr>
   */</span>
  isVoidTag<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span>
  <span class="token comment">/**
   * e.g. elements that should preserve whitespace inside, e.g. &lt;pre>
   */</span>
  isPreTag<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span>
  <span class="token comment">/**
   * Platform-specific built-in components e.g. &lt;Transition>
   */</span>
  isBuiltInComponent<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">symbol</span> <span class="token operator">|</span> <span class="token keyword">void</span>
  <span class="token comment">/**
   * Separate option for end users to extend the native elements list
   */</span>
  isCustomElement<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">boolean</span>
  <span class="token comment">/**
   * Get tag namespace
   */</span>
  getNamespace<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> parent<span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> Namespace
  <span class="token comment">/**
   * Get text parsing mode for this element
   */</span>
  getTextMode<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    <span class="token parameter">node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span>
    parent<span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">undefined</span></span>
  <span class="token punctuation">)</span> <span class="token operator">=></span> TextModes
  <span class="token comment">/**
   * @default ['{{', '}}']
   */</span>
  delimiters<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">]</span>
  <span class="token comment">/**
   * Only needed for DOM compilers
   */</span>
  decodeEntities<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">rawText<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> asAttr<span class="token operator">:</span> <span class="token builtin">boolean</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">string</span>
  onError<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">:</span> CompilerError</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span>
<span class="token punctuation">}</span></code></pre></div>
<p>å­—æ®µè¯´æ˜ï¼š</p>
<ol>
<li><code class="language-text">isNativeTag?: (tag: string) =&gt; boolean</code> ä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯åŸç”Ÿæ ‡ç­¾(å¦‚ï¼šli, div)</li>
<li><code class="language-text">isVoidTag?: (tag: string) =&gt; boolean</code>,è‡ªå…³é—­æ ‡ç­¾ï¼Œå¦‚ï¼šimg, br, hr</li>
<li><code class="language-text">isPreTag?: (tag: string) =&gt; boolean</code>ï¼Œä»£ç æ ‡ç­¾ï¼Œéœ€è¦ç©ºæ ¼ç¼©è¿›çš„ï¼Œå¦‚ï¼špre</li>
<li><code class="language-text">isBuiltInComponent?: (tag: string) =&gt; symbol | void</code>ï¼Œå¹³å°ç›¸å…³çš„å†…ç½®ç»„ä»¶ï¼Œå¦‚ï¼šTransition</li>
<li><code class="language-text">isCoustomElement?: (tag: string) =&gt; boolean</code>ï¼Œç”¨æˆ·è‡ªå®šçš„æ ‡ç­¾</li>
<li><code class="language-text">getNamespace?: (tag: string, parent: ElementNode | undefined) =&gt; Nâ„amespace</code> ï¼Œè·å–æ ‡ç­¾å‘½åç©ºé—´</li>
<li><code class="language-text">getTextMode?: (node: ElementNode, parent: ElementNode|undefined) =&gt; TextModes</code>è·å–æ–‡æœ¬è§£ææ¨¡å¼</li>
<li><code class="language-text">delimiters?: [string, string]</code>ï¼Œæ’å€¼åˆ†éš”ç¬¦ï¼Œé»˜è®¤ï¼š<code class="language-text">[&#39;{{&#39;, &#39;}}&#39;]</code></li>
<li><code class="language-text">decodeEntities?: (rawText: string, asAttr: boolean) =&gt; string</code>ï¼Œä»…ç”¨äº DOM compilers</li>
<li><code class="language-text">onError?: (error: CompilerError) =&gt; void</code></li>
</ol>
<h2 id="parsercontext" style="position:relative;"><a href="#parsercontext" aria-label="parsercontext permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ParserContext</h2>
<p><span id="td-parser-context"></span></p>
<p>å®šä¹‰ä½ç½®ï¼š<em><font color="purple"> src/parse.ts</font></em></p>
<p>æ¥å£å†…å®¹ï¼š</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ParserContext</span> <span class="token punctuation">{</span>
  options<span class="token operator">:</span> MergedParserOptions <span class="token comment">// è§£æå™¨é€‰é¡¹ï¼Œå³åˆå¹¶ä¹‹åçš„å‚æ•°å¯¹è±¡</span>
  <span class="token keyword">readonly</span> originalSource<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">// æœ€åˆçš„æºç ï¼Œå³è§£æä¹‹å‰çš„æœ€åŸå§‹çš„å­—ç¬¦ä¸²ï¼Œåªè¯»ç‰ˆæœ¬</span>
  source<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">// è§£æä¸­çš„æºç å­—ç¬¦ä¸²ï¼Œä¼šå‘ç”Ÿå˜åŒ–çš„å­—ç¬¦ä¸²</span>
  offset<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// è§£æçš„æŒ‡é’ˆä½ç½®ï¼Œç±»ä¼¼æ–‡ä»¶è¯»å–æ˜¯çš„æŒ‡é’ˆåç§»é‡</span>
  line<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// è§£æä½ç½®åœ¨æºç ä¸­çš„å½“å‰è¡Œ</span>
  column<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// è§£æä½ç½®åœ¨æºç ä¸­çš„å½“å‰åˆ—</span>
  inPre<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// æ ‡è¯†æ˜¯ä¸æ˜¯ &lt;pre> æ ‡ç­¾ï¼Œå¦‚æœæ˜¯éœ€è¦ä¿ç•™ç©ºæ ¼ä¿è¯ç¼©è¿›</span>
  inVPre<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// v-pre æŒ‡ä»¤ï¼Œä¸å¤„ç†æŒ‡ä»¤å’Œæ’å€¼(v-xxx, {{...}})</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="é˜¶æ®µä»£ç è®°å½•" style="position:relative;"><a href="#%E9%98%B6%E6%AE%B5%E4%BB%A3%E7%A0%81%E8%AE%B0%E5%BD%95" aria-label="é˜¶æ®µä»£ç è®°å½• permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é˜¶æ®µä»£ç è®°å½•</h1>
<p><span id="stage-codes"></span></p>
<ol>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-01-some-text">text01: some text çš„ä»£ç å¤‡ä»½</a><span id="link-01"></span></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-02-some-text-div-01">text02: some text &#x3C;div> 01 ä»£ç å¤‡ä»½</a><span id="link-02"></span></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-02-some-text-div-02">text02: some text &#x3C;div> 02 ä»£ç å¤‡ä»½</a><span id="link-03"></span></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-03-interpolation">text03: some {{ foo + bar }} text ä»£ç å¤‡ä»½</a><span id="link-04"></span></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/text-test-03-interpolation">text04: some {{ a&#x3C;b &#x26;&#x26; c>d }} text ä»£ç å¤‡ä»½</a><span id="link-05"></span></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/compiler-core/comment-test">comment: <!--x-->æ³¨é‡Šè§£æä»£ç å¤‡ä»½</a><span id="link-06"></span></li>
</ol>
<h1 id="é—®é¢˜ç–‘é—®åˆ—è¡¨" style="position:relative;"><a href="#%E9%97%AE%E9%A2%98%E7%96%91%E9%97%AE%E5%88%97%E8%A1%A8" aria-label="é—®é¢˜ç–‘é—®åˆ—è¡¨ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>é—®é¢˜/ç–‘é—®åˆ—è¡¨</h1>
<p><span id="issues"></span></p>
<ol>
<li><font color="red">å¦‚ä½•åŒºåˆ†å†…ç½®æ ‡ç­¾|å†…ç½®ç»„ä»¶|æ ¸å¿ƒç»„ä»¶|è‡ªå®šä¹‰ç»„ä»¶ï¼Ÿ<a href="#parse-parsetag-04">ğŸ›«</a></font></li>
<li>
<p><font color="red">ä¸ºä»€ä¹ˆ <a href="#parse-parsetag">parseTag</a> è§£æ <code class="language-text">&lt;div&gt;</code> ä¹‹ååªä¼šå¾—åˆ° <code class="language-text">&lt;div</code> è€Œä¸ä¼šå°† <code class="language-text">&gt;</code> è§£æè¿›å»ï¼Ÿ<a href="#parse-parseelement">ğŸ›«</a></font>
ç­”ï¼šæ˜¯å› ä¸ºæˆ‘ä»¬æ¼æ‰å®ç°äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œè‡ªé—­åˆæ ‡ç­¾çš„æ£€æµ‹ï¼Œç§»åŠ¨æŒ‡é’ˆ(2/1ä½)</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// .... çœç•¥</span>
 
 
 <span class="token comment">// TODO-3 &lt;div/> è‡ªé—­æ ‡ç­¾</span>
 <span class="token comment">// è¿™é‡Œè¦å®ç°ï¼Œä¸ç„¶æœ€åè§£æå®Œæˆä¹‹å source ä¼šæ˜¯ï¼š>...&lt;/span></span>
 <span class="token comment">// éœ€è¦æ£€æµ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªé—­åˆæ ‡ç­¾æ¥ç§»åŠ¨æŒ‡é’ˆä½ç½®</span>
 <span class="token keyword">let</span> isSelfClosing <span class="token operator">=</span> <span class="token boolean">false</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_TAG</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment">// some &lt;div> ... &lt;/div> åˆ°è¿™é‡Œçš„ source = > ... &lt;/div></span>
   <span class="token comment">// æ‰€ä»¥å¯ä»¥æ£€æµ‹æ˜¯ä¸æ˜¯ä»¥ /> å¼€å¤´çš„</span>
   isSelfClosing <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/>'</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TagType<span class="token punctuation">.</span>End <span class="token operator">&amp;&amp;</span> isSelfClosing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">END_TAG_WITH_TRAILING_SOLIDUS</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// å¦‚æœæ˜¯è‡ªé—­åˆæŒ‡é’ˆç§»åŠ¨ä¸¤ä½(/>)ï¼Œå¦åˆ™åªç§»åŠ¨ä¸€ä½(>)</span>
   <span class="token comment">// åˆ°è¿™é‡Œ source = ... &lt;/div></span>
   <span class="token function">advanceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// ... çœç•¥</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><font color="red">ä¸ºä»€ä¹ˆ <a href="#parse-parseelement">parseElement</a>Â è§£æ children çš„æ—¶å€™å…ˆ ancestors.push(element) è§£æä¹‹ååˆ pop() æ‰ï¼Ÿ
</font>
ç­”ï¼šè¦å›åˆ°è¿™ä¸ªé—®é¢˜è¦ä» parseChildren å’Œ parseElement ä¸¤ä¸ªå‡½æ•°ç»“åˆæ¥çœ‹ï¼Œå¦‚ä¸‹ä»£ç åˆ†æ</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// è§£ææµç¨‹(ç”¨ä¾‹5)ï¼š</span>
<span class="token comment">// 1. å…ˆ parseChildren(context, mode, ancestors) </span>
<span class="token comment">// è§£æ `some &lt;span>{{ foo &lt; bar + foo }} text&lt;/span>`</span>
<span class="token comment">//   1) é¦–å…ˆå¾—åˆ°çš„æ˜¯ `some ` æ–‡æœ¬èŠ‚ç‚¹</span>
<span class="token comment">//   2) æ£€æµ‹åˆ° &lt;span> è¿›å…¥æ ‡ç­¾è§£æ parseElement(context, ancestors) æ³¨æ„è¿™é‡Œçš„ 		//				ancestorsï¼Œæ˜¯ç”± parseChildren ç»§æ‰¿è¿‡æ¥çš„</span>
<span class="token comment">// 2. è¿›å…¥ parseElement è§£æè¿›ç¨‹</span>
<span class="token comment">//   	1) é‡åˆ° &lt;span> è§£æå‡ºæ ‡ç­¾èŠ‚ç‚¹ span</span>
<span class="token comment">//   	2) åœ¨è‡ªèº«å‡½æ•°å†…æ£€æµ‹åˆ°æ ‡ç­¾å†…è¿˜æœ‰å†…å®¹ï¼Œé‡æ–°è°ƒç”¨ parseChildren(..., ancestors) </span>
<span class="token comment">//    3) æ‰€ä»¥é‡ç‚¹æ¥äº†</span>
<span class="token comment">// ...</span>
<span class="token comment">// ...</span>
<span class="token comment">// ancestors æ˜¯ parseChildren ä¼ é€’è¿‡æ¥çš„ï¼ŒparseElement é‡Œé¢å°†</span>
<span class="token comment">// push çš„ç›®çš„ï¼šè®©å­èŠ‚ç‚¹æœ‰æ‰€ä¾èµ–ï¼ŒçŸ¥é“è‡ªå·±çš„çˆ¶çº§æ˜¯è°ï¼Œä½†å¥½åƒ parseChildren é‡Œé¢ç”¨åˆ° </span>
<span class="token comment">// 		parent ä¹Ÿæ˜¯ä¸ºäº†è·å–å‘½åç©ºé—´å»ç”¨äº†</span>
<span class="token comment">// pop çš„ç›®çš„ï¼šéš¾é“æ˜¯ä¸ºäº†ä¸æ±¡æŸ“ ancestors ???</span></code></pre></div>
<p>å¥½åƒè¿˜ä¸æ˜¯å¾ˆæ˜ç¡®ä¸ºä½•è¦ push->popã€‚</p>
</li>
</ol>
<h1 id="æµç¨‹å›¾" style="position:relative;"><a href="#%E6%B5%81%E7%A8%8B%E5%9B%BE" aria-label="æµç¨‹å›¾ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>æµç¨‹å›¾</h1>
<p><span id="flowchart-list"></span></p>
<p>ç”±äºæœ‰äº›æµç¨‹å›¾æŒºå¤§çš„ï¼Œå†…å®¹å¤šï¼Œå› æ­¤æ”¾åˆ°æœ€åã€‚</p>
<h2 id="å¸¦æŒ‡ä»¤çš„æ¨¡æ¿æ ‡ç­¾è§£æ" style="position:relative;"><a href="#%E5%B8%A6%E6%8C%87%E4%BB%A4%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE%E8%A7%A3%E6%9E%90" aria-label="å¸¦æŒ‡ä»¤çš„æ¨¡æ¿æ ‡ç­¾è§£æ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>å¸¦æŒ‡ä»¤çš„æ¨¡æ¿/æ ‡ç­¾è§£æ</h2>
<p>å®ä¾‹ï¼š</p>
<ol>
<li>ç”¨ä¾‹ï¼š<a href="#test-element-05">05-template element with directives</a></li>
<li>moreâ€¦</li>
</ol>
<p>å›¾ç‰‡å®Œæ•´åœ°å€ï¼š<a href="http://qiniu.ii6g.com/test-element-directive.png?imageMogr2/thumbnail/!100p">http://qiniu.ii6g.com/test-element-directive.png?imageMogr2/thumbnail/!100p</a></p>
<p><img src="http://qiniu.ii6g.com/test-element-directive.png?imageMogr2/thumbnail/!100p"></p></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQCBQP/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABvg6XkPHXEs2DkVP/xAAaEAEAAwEBAQAAAAAAAAAAAAABAgMRABAx/9oACAEBAAEFApSzpFgSXZVm2odKtei6/fP/xAAYEQACAwAAAAAAAAAAAAAAAAAAARAhMf/aAAgBAwEBPwFIoex//8QAGREAAQUAAAAAAAAAAAAAAAAAAAEQESEx/9oACAECAQE/AZLExv/EAB0QAAICAQUAAAAAAAAAAAAAAAARAQIxECEiQYH/2gAIAQEABj8CtWMjcoyNz4KOjjKLG+n/xAAaEAEBAQADAQAAAAAAAAAAAAABEQAhQaEx/9oACAEBAAE/IW7iSnm9A2+tWXe7wi0Ep0zoxTkTvNVocRckd//aAAwDAQACAAMAAAAQ2zeB/8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQITH/2gAIAQMBAT8QBY65Z//EABgRAQADAQAAAAAAAAAAAAAAAAEAEBEx/9oACAECAQE/EFhBz23/xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMUHRUWGB/9oACAEBAAE/EFbOWbJntGjC1APfMsaX5TqNxAwkxrNWQph0XsR3ApUAN9vksJzcTUQaviCgGCf/2Q==" alt="ZhiCheng Lee(è‹¥å¶çŸ¥ç§‹)" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg 1x,
/static/94e5e34de11ed954bada7ca31a5613c0/aba1d/profile-pic.jpg 1.5x,
/static/94e5e34de11ed954bada7ca31a5613c0/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg 1x,
/static/94e5e34de11ed954bada7ca31a5613c0/aba1d/profile-pic.jpg 1.5x,
/static/94e5e34de11ed954bada7ca31a5613c0/b315d/profile-pic.jpg 2x" src="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg" alt="ZhiCheng Lee(è‹¥å¶çŸ¥ç§‹)" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>ZhiCheng Lee(è‹¥å¶çŸ¥ç§‹)</strong> <!-- -->ä¸­å›½äººã€‚<!-- --> <a href="https://twitter.com/gccll_love">You should not follow him on Twitter</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/algo/leetcode-easy/">â† <!-- -->Algorithm on leetcode easy levelã€DOINGã€‘</a></li><li></li></ul></nav></main><footer>Â© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a>Â <a class="github" href="https://www.github.com/gcclll" target="_blank"><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTkyNTYzMjUxOTc1IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjExMzEiIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiA4NS4zMzMzMzNDMjc2LjI2NjY2NyA4NS4zMzMzMzMgODUuMzMzMzMzIDI3Ni4yNjY2NjcgODUuMzMzMzMzIDUxMmE0MjYuNDEwNjY3IDQyNi40MTA2NjcgMCAwIDAgMjkxLjc1NDY2NyA0MDQuODIxMzMzYzIxLjMzMzMzMyAzLjcxMiAyOS4zMTItOS4wODggMjkuMzEyLTIwLjMwOTMzMyAwLTEwLjExMi0wLjU1NDY2Ny00My42OTA2NjctMC41NTQ2NjctNzkuNDQ1MzMzLTEwNy4xNzg2NjcgMTkuNzU0NjY3LTEzNC45MTItMjYuMTEyLTE0My40NDUzMzMtNTAuMTMzMzM0LTQuODIxMzMzLTEyLjI4OC0yNS42LTUwLjEzMzMzMy00My43MzMzMzMtNjAuMjg4LTE0LjkzMzMzMy03Ljk3ODY2Ny0zNi4yNjY2NjctMjcuNzMzMzMzLTAuNTU0NjY3LTI4LjI0NTMzMyAzMy42MjEzMzMtMC41NTQ2NjcgNTcuNiAzMC45MzMzMzMgNjUuNjIxMzMzIDQzLjczMzMzMyAzOC40IDY0LjUxMiA5OS43NTQ2NjcgNDYuMzc4NjY3IDEyNC4yNDUzMzQgMzUuMiAzLjc1NDY2Ny0yNy43MzMzMzMgMTQuOTMzMzMzLTQ2LjM3ODY2NyAyNy4yMjEzMzMtNTcuMDQ1MzMzLTk0LjkzMzMzMy0xMC42NjY2NjctMTk0LjEzMzMzMy00Ny40ODgtMTk0LjEzMzMzMy0yMTAuNjg4IDAtNDYuNDIxMzMzIDE2LjUxMi04NC43Nzg2NjcgNDMuNzMzMzMzLTExNC42ODgtNC4yNjY2NjctMTAuNjY2NjY3LTE5LjItNTQuNCA0LjI2NjY2Ny0xMTMuMDY2NjY3IDAgMCAzNS43MTItMTEuMTc4NjY3IDExNy4zMzMzMzMgNDMuNzc2YTM5NS45NDY2NjcgMzk1Ljk0NjY2NyAwIDAgMSAxMDYuNjY2NjY3LTE0LjQyMTMzM2MzNi4yNjY2NjcgMCA3Mi41MzMzMzMgNC43Nzg2NjcgMTA2LjY2NjY2NiAxNC4zNzg2NjcgODEuNTc4NjY3LTU1LjQ2NjY2NyAxMTcuMzMzMzMzLTQzLjY5MDY2NyAxMTcuMzMzMzM0LTQzLjY5MDY2NyAyMy40NjY2NjcgNTguNjY2NjY3IDguNTMzMzMzIDEwMi40IDQuMjY2NjY2IDExMy4wNjY2NjcgMjcuMTc4NjY3IDI5Ljg2NjY2NyA0My43MzMzMzMgNjcuNzEyIDQzLjczMzMzNCAxMTQuNjQ1MzMzIDAgMTYzLjc1NDY2Ny05OS43MTIgMjAwLjAyMTMzMy0xOTQuNjQ1MzM0IDIxMC42ODggMTUuNDQ1MzMzIDEzLjMxMiAyOC44IDM4LjkxMiAyOC44IDc4LjkzMzMzMyAwIDU3LjA0NTMzMy0wLjU1NDY2NyAxMDIuOTEyLTAuNTU0NjY2IDExNy4zMzMzMzQgMCAxMS4xNzg2NjcgOC4wMjEzMzMgMjQuNDkwNjY3IDI5LjM1NDY2NiAyMC4yMjRBNDI3LjM0OTMzMyA0MjcuMzQ5MzMzIDAgMCAwIDkzOC42NjY2NjcgNTEyYzAtMjM1LjczMzMzMy0xOTAuOTMzMzMzLTQyNi42NjY2NjctNDI2LjY2NjY2Ny00MjYuNjY2NjY3eiIgZmlsbD0iI2Q0MjM3YSIgcC1pZD0iMTEzMiI+PC9wYXRoPjwvc3ZnPg=="/></a> <a href="https://beian.miit.gov.cn">ç²¤ICPå¤‡20032623å·</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-167854855-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/vue3/compiler-core/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-758533d5dedfd033bfc3.js"],"component---src-pages-404-js":["/component---src-pages-404-js-dfa684939fdc086afe1b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-595fb2a7f5deb9405817.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-df3c457ebc2bf0738933.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-87b9875212785ebf1c24.js"]};/*]]>*/</script><script src="/webpack-runtime-f9282b41cb75aa09d440.js" async=""></script><script src="/styles-2d4804b503525347efbe.js" async=""></script><script src="/framework-d54fcf3f0204b459cf2d.js" async=""></script><script src="/app-758533d5dedfd033bfc3.js" async=""></script><script src="/commons-ed01901cfa003862a39a.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-2e9a852144d8ce373a7b.js" async=""></script><script src="/component---src-templates-blog-post-js-87b9875212785ebf1c24.js" async=""></script></body></html>