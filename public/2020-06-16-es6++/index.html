<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.491a16106869c73de5f8.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.23.3"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><title data-react-helmet="true">ES6++ | Gatsby Starter Blog</title><meta data-react-helmet="true" name="description" content="参考链接：https://leanpub.com/understandinges6/read   简介 JavaScript 核心特性在 ECMA-262 标准中被定义，也叫做  ，我们所熟知的在浏览器端和  实际上是 ECMAScript 的一个超集。   本文包含 es6+ 新增特性。 ES6 演变之路 199…"/><meta data-react-helmet="true" property="og:title" content="ES6++"/><meta data-react-helmet="true" property="og:description" content="参考链接：https://leanpub.com/understandinges6/read   简介 JavaScript 核心特性在 ECMA-262 标准中被定义，也叫做  ，我们所熟知的在浏览器端和  实际上是 ECMAScript 的一个超集。   本文包含 es6+ 新增特性。 ES6 演变之路 199…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="gccll_love"/><meta data-react-helmet="true" name="twitter:title" content="ES6++"/><meta data-react-helmet="true" name="twitter:description" content="参考链接：https://leanpub.com/understandinges6/read   简介 JavaScript 核心特性在 ECMA-262 标准中被定义，也叫做  ，我们所熟知的在浏览器端和  实际上是 ECMAScript 的一个超集。   本文包含 es6+ 新增特性。 ES6 演变之路 199…"/><link as="script" rel="preload" href="/webpack-runtime-03dfd859751270984004.js"/><link as="script" rel="preload" href="/framework-d54fcf3f0204b459cf2d.js"/><link as="script" rel="preload" href="/styles-2d4804b503525347efbe.js"/><link as="script" rel="preload" href="/app-9839487a874f55009d3e.js"/><link as="script" rel="preload" href="/commons-cf4b03b2e773ec61d45b.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-65282cc5dac79a1397dc.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-89ff2d606443a75a09e8.js"/><link as="fetch" rel="preload" href="/page-data/2020-06-16-es6++/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/">Gatsby Starter Blog</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">ES6++</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">June 16, 2020</p></header><section><blockquote>
<p>参考链接：<a href="https://leanpub.com/understandinges6/read">https://leanpub.com/understandinges6/read</a>  </p>
</blockquote>
<h1>简介</h1>
<p>JavaScript 核心特性在 <a href="https://tc39.github.io/ecma262/">ECMA-262</a> 标准中被定义，也叫做 <code class="language-text">ECMAScript</code> ，我们所熟知的在浏览器端和 <code class="language-text">Node.js</code> 实际上是 ECMAScript 的一个超集。  </p>
<p>本文包含 es6+ 新增特性。</p>
<!-- more -->
<h2>ES6 演变之路</h2>
<h3>1999 发布 v3</h3>
<p>1999.TC39 年发布了 ECMA-262 第三版。  </p>
<p>直到 2007 之前都没有任何变化。  </p>
<h3>2007 发布 v4, v3.1</h3>
<p>2007 年发布了第四版，包含以下特性：  </p>
<ul>
<li>新语法(new syntax)</li>
<li>模块(modules)</li>
<li>类概念(classes)</li>
<li>类继承概念(classical inheritance)</li>
<li>对象私有属性(private object members)</li>
<li>更多类型</li>
<li>其他</li>
</ul>
<p>由于第四版涉及的内容太多，因此造成分歧，部分成员由此创建了  </p>
<p>3.1 版本，只包含少部分的语法变化，聚焦在：  </p>
<ul>
<li>属性</li>
<li>原生 JSON 支持</li>
<li>已有对象增加方法</li>
</ul>
<p>但是两拨人在 v4 和 v3.1 版本之间并没有达成共识，导致最后不了了之。  </p>
<h3>2008 JavaScript 创始人决定</h3>
<p><a href="https://en.wikipedia.org/wiki/Brendan_Eich">Brendan Eich</a> 决定将着力于 v3.1 版本。  </p>
<p>最后 v3.1 作为 <code class="language-text">ECMA-262</code> 的第五个版本被标准化，即： <code class="language-text">ECMASCript 5</code>  </p>
<h3>2015 年发布 ECMAScript 6 也叫 ECMAScript 2015</h3>
<p>即本书要讲的内容(ES6)。  </p>
<h1>块级绑定(var, let, const)</h1>
<h2>Var 声明和提升</h2>
<p>使用 <code class="language-text">var</code> 来声明变量时，在一个作用域内，无论它在哪里声明的，都会被升到到该作<br>
用域的顶部。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token parameter">condition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 比如： var value; // undefined</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 虽然在这里声明的，其实会被提升到函数顶端</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token string">'blue'</span>

    <span class="token comment">// code</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里依旧可以访问变量 `value` 只不过它的值是 `undefined`</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 'null'</span></code></pre></div>
<p>上面的 <code class="language-text">getValue</code> 相当于下面的变量声明版本（提升之后）：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token parameter">condition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> value<span class="token punctuation">;</span> <span class="token comment">// undefined</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token string">'blue'</span>

    <span class="token comment">// code</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 'null'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">null</code></pre></div>
<h2>块级声明 let/const 声明</h2>
<p>块级作用域，如：函数，*{ … }* 大括号，等等都属于块级作用域，在该作用域下使<br>
用 <code class="language-text">let</code> 声明的变量只在  </p>
<p>该作用域下可访问。  </p>
<h3>声明提升问题</h3>
<p><code class="language-text">let</code> 声明不会被提升，但是也有另一种说法是 <strong>let</strong> 会提升，并且在如果在提升处<br>
到赋值的中间范围内使用了该变量，  </p>
<p>会使该区域成为一块临时死区(TDZ)。  </p>
<p>在声明之前使用 let 变量：  </p>
<p><strong>VM88:4 Uncaught ReferenceError: Cannot access ‘value’ before<br>
initialization</strong>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token parameter">cond</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cond<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">'blue'</span>

    <span class="token comment">// code</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// value 在该作用域不存在</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// value 在该作用域不存在</span>
<span class="token punctuation">}</span>

<span class="token function">getValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></div>
<h3>不能重复声明</h3>
<p>使用 <code class="language-text">var</code> 的时候是可以重复声明的：  </p>
<p><code class="language-text">var count = 39; var count;</code>  </p>
<p>这样是不会有问题的，只不过它的声明只会被记录一次而已，即只会记录 <code class="language-text">var count
    = 39;</code> 这里声明，但是不会出现异常。  </p>
<p>如果使用 <code class="language-text">let</code> 就不一样了，如果出现重复声明则会异常：  </p>
<p><code class="language-text">var count = 39;let count;</code>  </p>
<p>异常结果：*SyntaxError: Identifier ‘count’ has already been declared*  </p>
<h3>两者差别</h3>
<p>let 声明的值可变，const 声明的是个常量，值是不能发生改变的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span><span class="token punctuation">;</span>

name <span class="token operator">=</span> <span class="token string">'yyy'</span><span class="token punctuation">;</span> <span class="token comment">// ok</span>

<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

age <span class="token operator">=</span> <span class="token number">88</span><span class="token punctuation">;</span> <span class="token comment">// error</span></code></pre></div>
<h3>临时死区(TDZ)</h3>
<p>使用 <code class="language-text">let/const</code> 声明的变量，任何时候试图在其声明之前使用变量都会抛出异常。  </p>
<p>即使是在声明之前使用 <code class="language-text">typeof</code> 也会出现引用异常(ReferenceError)。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> value<span class="token punctuation">)</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">'blue'</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1560691097.png" alt="img">  </p>
<h3>循环中使用块级声明</h3>
<p>我们都知道使用 <code class="language-text">var</code> 声明的变量是不存在块级作用域的，即在 <em>if/for</em> 的 {} 作<br>
用域内使用 <code class="language-text">var</code>  </p>
<p>声明的变量其实是该全局作用下的全局变量。  </p>
<p>比如：我们常见的 <code class="language-text">for</code> 循环中的 <code class="language-text">i</code> 的值  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// 10</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">10</code></pre></div>
<p>结果为 <strong>10</strong> 表明在 <code class="language-text">console.log(i)</code> 处是可以访问 <code class="language-text">i</code> 变量的，因为 <code class="language-text">var i =
    0;</code> 的声明  </p>
<p>被提升成了全局变量，即循环体中使用的一直是这一份全局变量。  </p>
<p>如果是同步代码，可能没什么问题，但要是异步代码就会出现问题，如下结果：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">5
5
5
5
5</code></pre></div>
<p>很遗憾最后结果都成了 5，因为循环体是个异步代码 <code class="language-text">setTimeout</code>  </p>
<p>解决方法有：  </p>
<ul>
<li>闭包:</li>
</ul>
<p>形成一个封闭的作用域，将当前的 <code class="language-text">i</code> 值传递进去。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里的 v 值即传递进来的当前次循环的 i 的值</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">0
1
2
3
4</code></pre></div>
<ul>
<li>let</li>
</ul>
<p>每次循环相当于新创建了一个变量，因此变量的值都得以保存。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">0
1
2
3
4</code></pre></div>
<h3>全局作用域声明</h3>
<p>var, let, const 另一个区别是在全局环境下的声明作用域也是不一样，  </p>
<p>我们都知道在全局作用域下使用 <code class="language-text">var</code> 声明的话，浏览器端是可以通过 window.name<br>
来访问该变量的，但是 let, const 却不行。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>age<span class="token punctuation">)</span></code></pre></div>
<p>结果：  </p>
<p><img src="http://qiniu.ii6g.com/1560735450.png" alt="img">  </p>
<p>浏览器端作用域：  </p>
<p><img src="http://qiniu.ii6g.com/1560735987.png" alt="img">  </p>
<p><strong>结论：</strong>  </p>
<p>无论 <code class="language-text">let</code> 在那里声明的它都是个块级作用域变量，只在其声明到该作用域之后才能<br>
使用。  </p>
<p>而 <code class="language-text">var</code> 声明的始终相对于当前作用域下是全局变量。  </p>
<h2>总结(var, let, const)</h2>
<p>在 es6 之后尽量使用 let 和 const 去声明变量，严格控制变量的作用域。  </p>
<ol>
<li>var 变量声明会提升，可重复声明，且在该作用域内为全局变量</li>
<li>let/const 变量声明不会提升，不可重复声明，局部变量，且在 DTZ 范围内使用即<br>
使是 typeof 也会报错</li>
<li>let/const 区别在于 const 声明的变量值不能发生改变</li>
</ol>
<table>
<thead>
<tr>
<th>关键词</th>
<th>提升</th>
<th>作用域</th>
<th>值属性</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">var</code></td>
<td>有提升，声明提升(命名函数定义也提升)</td>
<td>范围内全局</td>
<td>可变</td>
</tr>
<tr>
<td><code class="language-text">let</code></td>
<td>无提升</td>
<td>局部变量，作用域内声明处开始往下</td>
<td>可变</td>
</tr>
<tr>
<td><code class="language-text">const</code></td>
<td>无提升</td>
<td>局部变量，作用域内声明处开始往下</td>
<td>不可变</td>
</tr>
</tbody>
</table>
<h1>字符串和正则表达式(String&#x26;Regex)</h1>
<h2>更好的 Unicode 编码支持<a id="org952d340"></a></h2>
<h3>UTF-16 编码</h3>
<h3>新增 str.codePointAt(n) 和 String.fromCodePoint(str)</h3>
<p>已有的编码查询函数： str.charCodeAt 和 String.fromCodeAt 用来应对单字符一个<br>
字节的情况。  </p>
<p>新增的两个函数可以处理单个字符串占两个字节的大小，比如一些特殊字符“𠮷”需要用<br>
到两个字节来存储。  </p>
<p>即 2bytes = 16bits 大小。  </p>
<p>charCodeAt 和 fromCodeAt 是以一个字节为单位来处理字符串的，因此如果遇到这些<br>
字就没法正常处理。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'𠮷'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">55362
134071
�
𠮷</code></pre></div>
<p>可以看到如果我们还用原来的函数 charCodeAt 和 fromCharCode 去处理这个字得到结<br>
果是不正确的。  </p>
<h3>normalize() 函数</h3>
<p>参考链接：<a href="https://www.cnblogs.com/hahazexia/p/9257409.html">https://www.cnblogs.com/hahazexia/p/9257409.html</a>  </p>
<h3>repeat(n) 函数</h3>
<p>将一个字符串重复 n 次后返回。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token string">'x'</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> b <span class="token operator">===</span> c<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xxx x false</code></pre></div>
<h2>正则表达式</h2>
<h3>y 标记</h3>
<h3>s(dotAll)flag<sup>2018</sup></h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex">/one.two/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'one\ntwo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// → false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex">/one.two/s</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'one\ntwo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// → true</span></code></pre></div>
<h3>命名捕获组(Named Caputre Groups)<sup>2018</sup></h3>
<p>格式： <code class="language-text">?&lt;name&gt;</code>  </p>
<p>引用： <code class="language-text">match.groups</code> 一个包含捕获组名称的对象  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex">/(\d{4})-(\d{2})-(\d{2})/</span>
<span class="token keyword">const</span> match <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'2019-10-10'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// -> 2019-10-10</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// -> 2019</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// -> 10</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// -> 10</span></code></pre></div>
<p>命名捕获组：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> namedRe <span class="token operator">=</span> <span class="token regex">/(?&lt;year>\d{4})-(?&lt;month>\d{2})-(?&lt;date>\d{2})/</span>
<span class="token keyword">const</span> namedMatch <span class="token operator">=</span> namedRe<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'2019-10-10'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>namedMatch<span class="token punctuation">.</span>groups<span class="token punctuation">)</span> <span class="token comment">// { year: '2019', month: '10', date: '10' }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>namedMatch<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>year<span class="token punctuation">)</span> <span class="token comment">// 2019</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>namedMatch<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>month<span class="token punctuation">)</span> <span class="token comment">// 10</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>namedMatch<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>date<span class="token punctuation">)</span> <span class="token comment">// 10</span></code></pre></div>
<h2>JSON</h2>
<h3>JSON.stringify<sup>2019</sup></h3>
<p>更好的处理不支持的字符序列。  </p>
<p><img src="https://miro.medium.com/max/605/1*1avfy0C8OcP71XsBBCmuOA.png" alt="img">  </p>
<h2>字符串方法</h2>
<h3>String.prototype.trimStart()<sup>2019</sup></h3>
<h3>String.prototype.trimEnd()<sup>2019</sup></h3>
<h3>String.prototype.toString()<sup>2019</sup></h3>
<p>更好的处理空格，换行符等特殊字符，比如：字符串化函数的时候，会将函数原样输出。  </p>
<p>如：  </p>
<p><img src="http://qiniu.ii6g.com/1571574030.png" alt="img">  </p>
<h2>模板字符串</h2>
<h3>基本语法</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello world</span><span class="token template-punctuation string">`</span></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> msg<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>length<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">hello world
string
11</code></pre></div>
<p>如果需要用到反引号，则需要使用转义字符： <code class="language-text">\`</code>  </p>
<h3>多行字符串</h3>
<p>避免一行太长，进行换行书写，但是不影响最终结果显示在一行，可以使用反斜杠  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multiline \
string</span><span class="token template-punctuation string">`</span></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">multiline string</code></pre></div>
<p>多行字符串情况：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token string">"multiline \n string"</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">multiline
 string</code></pre></div>
<p>使用模板字符串，会按照模板字符串中的格式原样输出，而不再需要显示使用 `\n` 来<br>
进行换行：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multiline
string</span><span class="token template-punctuation string">`</span></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">multiline
string</code></pre></div>
<p>在模板字符串中空格也会是字符串的一部分  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> msg1 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multiline
   string</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">var</span> msg2 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multiline
string</span><span class="token template-punctuation string">`</span></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">len1: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg1<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">len2: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg2<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">len1: 19
len2: 16</code></pre></div>
<p>所以在书写模板字符串的时候必须慎重使用缩进。  </p>
<h3>模板字符串插值</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">const</span> <span class="token function-variable function">getAge</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token number">100</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 普通字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">3 + 4  = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 可执行计算</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">call function to get age : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 可调用函数</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">my name is xxx
3 + 4  = 7
call function to get age : 100</code></pre></div>
<h3>标签模板</h3>
<p>允许使用标签模板，该标签对应的是一个函数，后面的模板字符串会被解析成参数传递<br>
给该函数去进行处理，最后返回处理的结果。  </p>
<p>比如： <code class="language-text">let msg = tag`Hello World`</code>  </p>
<p><strong>定义标签：</strong>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">tag</span><span class="token punctuation">(</span><span class="token parameter">literals<span class="token punctuation">,</span> <span class="token operator">...</span>substitutions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回一个字符串</span>
<span class="token punctuation">}</span></code></pre></div>
<p>示例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
    price <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">,</span>
    msg <span class="token operator">=</span> passthru<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> items cost $</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>count <span class="token operator">*</span> price<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">function</span> <span class="token function">passthru</span><span class="token punctuation">(</span><span class="token parameter">literals<span class="token punctuation">,</span> <span class="token operator">...</span>subs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>literals<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span>

  <span class="token comment">// 将结果拼起来</span>

  <span class="token keyword">return</span> subs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> literals<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token operator">+</span> literals<span class="token punctuation">[</span>literals<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-- items cost $--.
[ 10, &#39;2.50&#39; ]
10 items cost $2.50.</code></pre></div>
<p>从结果可以看到，标签函数参数的内容分别为:  </p>
<ol>
<li>literals 被插值(${})分割成的字符串数组，比如上例的结果为： <code class="language-text">[&quot;&quot;, &quot; items
       const $&quot;, &quot;.&quot;]</code></li>
<li>subs 为插值计算的结果值作为第2, … 第 n 个参数传递给了 <code class="language-text">passthru</code></li>
</ol>
<h3>标签模板原始值(String.raw())</h3>
<p>有时候需要在模板字符串中直接使用带有转义字符的内容，比如： `\n` 而不是使用其<br>
转义之后的含义。  </p>
<p>这个时候则可以使用新增的内置 <code class="language-text">tag</code> 函数来处理。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> msg1 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multiline\nstring</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">let</span> msg2 <span class="token operator">=</span> String<span class="token punctuation">.</span>raw<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multileline\nstring</span><span class="token template-punctuation string">`</span></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg2<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">multiline
string
multileline\nstring</code></pre></div>
<p>可看到在我们使用 <code class="language-text">String.raw</code> 之后的 <strong>\n</strong> 并没有被转义成换行符，而是按照其原<br>
始的样子输出。  </p>
<p>如果在不适用内置的 <code class="language-text">Strng.raw</code> 该怎么做？  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">raw</span><span class="token punctuation">(</span><span class="token parameter">literals<span class="token punctuation">,</span> <span class="token operator">...</span>subs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 将结果拼起来</span>

  <span class="token keyword">return</span> subs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> literals<span class="token punctuation">.</span>raw<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token operator">+</span> literals<span class="token punctuation">.</span>raw<span class="token punctuation">[</span>literals<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> msg <span class="token operator">=</span> raw<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">multiline\nstring</span><span class="token template-punctuation string">`</span></span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">multiline\nstring</code></pre></div>
<p>nodejs 环境可能看起来不直观，通过下图我们来直观的查看下标签函数是怎么处理带<br>
转义字符的字符串的：  </p>
<p><img src="http://qiniu.ii6g.com/1560743558.png" alt="img">  </p>
<p>会发现其实 <code class="language-text">literals</code> 的值依旧是转义之后的，看数组中第一个元素的字符串中是有<br>
一个回车标识的。  </p>
<p>此外该数组对象本身上面多了一个 <code class="language-text">raw</code> 属性，其值为没有转义的内容。  </p>
<p>从这里我们得出，标签模板是怎么处理带转义字符串的模板的。  </p>
<h2>小结</h2>
<ol>
<li>完整的编码支持赋予了 JavaScript 处理 UTF-16 字符的能力(通过<br>
<code class="language-text">codePointAt()</code> 和 <code class="language-text">String.fromCodePoint()</code> 来转换)</li>
<li><code class="language-text">u</code> 新增的标记使得正则表达式可以通过码点来代替 UTF-16 字符</li>
<li><code class="language-text">normalize()</code></li>
<li>模板字符串，支持原始字符串，插值支持计算表达式或函数调用</li>
<li>标签模板，第一个参数为分割后的字符串列表，后面的参数分别为插值结果</li>
<li>转义标签模板，转义标签的第一个参数数组对象上包含一个 <code class="language-text">raw</code> 数组，其中包含<br>
了原始值列表</li>
</ol>
<h1>函数(Function)</h1>
<h2>参数默认值</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>默认参数值是如何影响 <code class="language-text">arguments</code> 对象的？  </p>
<h3>严格非严格模式下的 arguments</h3>
<p>只要记住一旦使用了默认值，那么 <code class="language-text">arguments</code> 对象的行为将发生改变。  </p>
<p>在 ECMAScript5 的非严格模式下，arguments 对象的内容是会随着函数内部函数参数值得变化而发生变化的，也就是说它  </p>
<p>并不是在调用函数之初值就固定了，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">maxArgs</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> second</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>second <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  first <span class="token operator">=</span> <span class="token string">'c'</span>
  second <span class="token operator">=</span> <span class="token string">'d'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>second <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">maxArgs</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
true
true</code></pre></div>
<p>从结果我们会发现，参数值发生变化也会导致 arguments 对象跟着变化，这种情况只会在非严格模式下产生，  </p>
<p>在严格模式下， arguments 对象是不会随着参数值改变而改变的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">maxArgs</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> second</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use strict'</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>second <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  first <span class="token operator">=</span> <span class="token string">'c'</span>
  second <span class="token operator">=</span> <span class="token string">'d'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>second <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">maxArgs</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
false
false</code></pre></div>
<p>喏，后面结果为 <em>false</em> 。  </p>
<h3>带默认参数值情况下 arguments</h3>
<p>在 es6 之后，arguments 的行为和之前严格模式下是一样的，即不会映射参数值得变化。  </p>
<ol>
<li>
<p>带默认值得参数，如果在调用的时候不传递，是不会计入到 arguments 对象当中  </p>
<p>即 arguments 的实际个数是根据调用的时候所传递的参数个数来决定的。</p>
</li>
<li>arguments 对象不再响应参数值得变化</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">mixArgs</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>second <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
  first <span class="token operator">=</span> <span class="token string">'c'</span>
  second <span class="token operator">=</span> <span class="token string">'d'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>second <span class="token operator">===</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
<span class="token punctuation">}</span>

<span class="token function">mixArgs</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1
true
false
false
false</code></pre></div>
<h3>默认参数表达式</h3>
<p>参数默认值不仅可以使用静态值，还可以赋值为调用函数的结果  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get value...'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">5</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> first <span class="token operator">+</span> second
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 6</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
get value...
6</code></pre></div>
<p>从结果显示：  </p>
<ol>
<li>如果 second 没传，会在调用 <code class="language-text">add()</code> 时候执行 <code class="language-text">getValue()</code> 获取默认值</li>
<li>如果传递了 second，那么 <code class="language-text">getValue()</code> 是不会被执行的</li>
</ol>
<p>即在默认参数中调用的函数，是由在调用时该对应的函数参数是否有传递来决定是否调用。  </p>
<p><del>而不是传递了 second，先调用 getValue() 得到值，然后用传递的 second 值去覆盖。</del>  </p>
<p>也就是说 <code class="language-text">getValue()</code> 返回的值不用每次都一样，是可以在每次调用的时候发生变化的，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">5</span>

<span class="token keyword">function</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n<span class="token operator">++</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> first <span class="token operator">+</span> second
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 6</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 7</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
6
7</code></pre></div>
<p>由于上面的特性，参数默认值可以是动态的，因此我们可以将前面参数值作为后面参数的默认值来使用，  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> second <span class="token operator">=</span> first</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> first <span class="token operator">+</span> second
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
2</code></pre></div>
<p>甚至还可以将 first 作为参数传递给 <code class="language-text">getValue(first)</code> 获取新值作为默认值来用。  </p>
<h3>默认参数值的临时死区(TDZ)</h3>
<p>这里临时死区的意思是指，第二个参数在使用之前未进行声明，因为参数的声明相当于使用了 <code class="language-text">let</code> 。  </p>
<p>根据 <code class="language-text">let</code> 的特性，在为声明之前使用属于在 TDZ 范围，会抛异常。  </p>
<p>实例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">first <span class="token operator">=</span> second<span class="token punctuation">,</span> second</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> first <span class="token operator">+</span> second
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// error</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
second is not defined</code></pre></div>
<p>既然都存在 TDZ 那为什么第一次调用就没事了，下面来分析下看看：  </p>
<p>记住上一节所讲的：  </p>
<p><span class="underline">默认值的调用(如： <code class="language-text">getValue()</code> )只有在参数未传递的情况下才会发生，这里 <code class="language-text">first=second</code> 的情况依旧适用。</span>  </p>
<p>那么将这句话应用到这里：  </p>
<ol>
<li>
<p><code class="language-text">add(1, 1)</code> 这里 first 传递了 1  </p>
<p>那么 first 在 add 被调用的时候会被初始化成 1，根据上面那句话，即此时 <code class="language-text">first=second</code> 这句相当于并没有被执行  </p>
<p>因此就不会去检测 second ，也就不会出现未定义了，从而能得出正确结果：2。</p>
</li>
<li>
<p><code class="language-text">add(undefined, 1)</code> 传递了 `undefined` 相当于没传这个参数，只是占了个位  </p>
<p>那么既然没传， <code class="language-text">first=second</code> 就会被执行， <code class="language-text">second</code> 就会被检测是否定义，然而检测的结果就是“未定义”，  </p>
<p>因此抛出异常。</p>
</li>
</ol>
<p>将 add 函数参数的变化用下来转声明来表示，问题就会更明显了：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// add(1, 1)</span>

<span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// first = second 未执行，不检测</span>
<span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">// add(undefined, 1)</span>
<span class="token keyword">let</span> first <span class="token operator">=</span> second <span class="token comment">// 这句被执行，相当于这里提前使用了 second 变量，let 特性生效</span>
<span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token number">1</span></code></pre></div>
<blockquote>
<p>函数参数是有它自己的作用域和TDZ的，并且和函数体作用域是区分开的，  </p>
<p>这就意味着函数参数是无法访问函数体内的任何变量的，因为根据就是两个不同的作用域。  </p>
</blockquote>
<h2>未命名参数</h2>
<p>为什么会存在未命名参数？  </p>
<p>因为 JavaScript 是没有限制调用函数的时候传递参数个数的。  </p>
<p>比如：声明了一个函数 <code class="language-text">function add() {}</code> 没任何参数，但是调用的时候是可以这样<br>
的 <code class="language-text">add(1, 2, 3, ...)</code>  </p>
<p>那么这些调用的时候传递给 add 的参数对应的函数参数就叫做未命名参数。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=></span> n <span class="token operator">+=</span> v<span class="token punctuation">)</span>

  <span class="token keyword">return</span> n
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">15</code></pre></div>
<h3>参数展开符(…)</h3>
<p>未命名参数一般很少使用，因为这让使用者会很迷惑该函数的作用，因此参数没任何明<br>
显特征表示它是干什么用的，  </p>
<p>在 es6 中增加了一个展开符号(…)，在函数参数中的作用是将传递进的参数列表合并<br>
成一个参数数组。  </p>
<p>适用于一个函数参数个数未知的情况下使用。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">pick</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> <span class="token operator">...</span>keys</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里 keys 会成为一个包含传入的其余参数值的数组</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> object<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token punctuation">{</span>
  author<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'yyy'</span><span class="token punctuation">,</span>
  pages<span class="token operator">:</span> <span class="token number">300</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">pick</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> <span class="token string">'author'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3
{&quot;author&quot;:&quot;xxx&quot;,&quot;name&quot;:&quot;yyy&quot;}</code></pre></div>
<p>利用 …keys 将传入的 (‘author’, ‘name’) 合并成了一个数组： <code class="language-text">[&#39;author&#39;,
    &#39;name&#39;]</code> ，方便应对  </p>
<p>函数参数个数可变的情况。  </p>
<h3>参数展开符两种异常使用情况</h3>
<ol>
<li>
<p>展开符参数必须是最后一个，不能在其后面还有其他参数  </p>
<p>比如： <code class="language-text">function add(n, ...vals, more) {}</code> 这会出现异常</p>
</li>
<li>不能用在对象的 <code class="language-text">setter</code> 函数上</li>
</ol>
<p>实例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1560755195.png" alt="img">  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> <span class="token operator">...</span>vals<span class="token punctuation">,</span> more</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1560755252.png" alt="img">  </p>
<h3>参数展开符对 arguments 的影响</h3>
<p>记住一点：  </p>
<p><span class="underline">arguments 总是由函数调用时传递进来的参数决定</span>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">checkArgs</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">checkArgs</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
2
a a
b b</code></pre></div>
<h2>函数构造函数能力增强</h2>
<p>在实际编码过程，我们很少直接使用 <code class="language-text">Function()</code> 构造函数去创建一个函数。  </p>
<p>比如这么使用：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 参数：参数一名称 first, 参数二名称 second，... 最后一个是函数体</span>
<span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">,</span> <span class="token string">'second'</span><span class="token punctuation">,</span> <span class="token string">'return first + second'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3</code></pre></div>
<p>在 es6 中对构造函数的使用能力增强了，给其赋予了更多的功能，比如  </p>
<ol>
<li>默认参数值</li>
<li>展开符</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token string">"second = first"</span><span class="token punctuation">,</span>
                       <span class="token string">"return first + second"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2</span>

<span class="token keyword">var</span> pickFirst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">"...args"</span><span class="token punctuation">,</span> <span class="token string">"return args[0]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">pickFirst</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 1</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
2
1</code></pre></div>
<h2>展开符(…)</h2>
<p>在之前我们在函数参数中用到了展开符，这个时候的用途是将参数合并成数组来用。  </p>
<h3>普通参数传递</h3>
<p>我们一般调用函数的时候都是将参数逐个传递：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>
    v2 <span class="token operator">=</span> <span class="token number">30</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">30</code></pre></div>
<p>这仅仅两个参数，比较好书写，一旦参数多了起来就比较麻烦，在 es6 之前的做法可以利用 <code class="language-text">Function.prototype.apply</code> 去实现：  </p>
<h3>apply 传递多个参数</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> vs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> vs<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">5</code></pre></div>
<p>因为 <code class="language-text">apply</code> 会将数组进行展开作为函数的参数传递个调用它的函数。  </p>
<h3>es6 之后展开符传递</h3>
<p>在 es6 之后我们将使用展开符去完成这项工作，让代码更简洁和便于理解。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> vs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>vs<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">4</code></pre></div>
<h3>展开符，传统方式相结合</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> vs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">...</span>vs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 10</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>vs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">...</span>vs<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 10</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">10
4
10</code></pre></div>
<h2>函数名字属性</h2>
<p>以往，由于函数的各种使用方式使 JavaScript 在识别函数的时候成为一种挑战，并且<br>
匿名函数的频繁使用使得程序的 debugging 过程异常痛苦，经常造成追踪栈很难理解。  </p>
<p>因此在 es6 中给所有函数添加了一个 <code class="language-text">name</code> 属性。  </p>
<blockquote>
<p>name 属性只是对函数的一种描述特性，并不会有实际的引用特性，也就是说  </p>
<p>在实际编程中不可能通过函数的 name 属性去干点啥。  </p>
</blockquote>
<h3>选择合适的名称</h3>
<p>JavaScript 会根据函数的声明方式去给其选择合适的名称，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">doAnotherThing</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">doThirdThing</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">do3rdThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doSomething<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// "doSomething"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doAnotherThing<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// "doAnotherThing"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doThirdThing<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// "do3rdThing"</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">doSomething
doAnotherThing
do3rdThing</code></pre></div>
<ol>
<li>如果是命名函数式声明方式，则使用的就是它的名字作为 <code class="language-text">name</code> 属性值，如： <em>doSomething</em></li>
<li>如果是表达式匿名方式声明函数，则将使用表达式中左边的变量名称来作为 <code class="language-text">name</code> 属性值，如： <em>doAnotherThing</em></li>
<li>表达式命名方式声明函数，则将使用命名函数的名称作为 <code class="language-text">name</code> 属性，如： <em>doThridThing</em> 的名字是： <em>do3rdThing</em></li>
</ol>
<blockquote>
<p>通过第三个输出可知，命名函数的优先级高于表达式的变量名。  </p>
</blockquote>
<h3>name 属性的特殊情况</h3>
<ol>
<li>对象的函数名称，即该函数的名字</li>
<li>对象的访问器函数名称，通过 <code class="language-text">Object.getOwnPropertyDescriptor(obj, &#39;keyname&#39;)</code> 获取访问器对象</li>
<li>调用 <code class="language-text">bind()</code> 之后的函数名称，总是在原始函数名前加上 <strong>bound</strong></li>
<li>使用 <code class="language-text">new Function()</code> 创建的函数名称，总是返回 <em>anonymous</em></li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">doSth</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">firstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'Nicholas'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">sayName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>sayName<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// sayName</span>
<span class="token comment">// 访问器属性，只能通过 getOwnPropertyDescriptor 去获取</span>
<span class="token keyword">var</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token string">'firstName'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>get<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// get firstName</span>

<span class="token comment">// 调用 bind 之后的函数名称总是会在原始的函数名称之前加上 `bound fname`</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">doSth</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// bound doSth</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// anonymous</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sayName
get firstName
bound doSth
anonymous</code></pre></div>
<h2>澄清函数双重目的</h2>
<h3>函数使用方式</h3>
<ol>
<li>直接调用，当做函数来使用 <code class="language-text">Person()</code></li>
<li>使用 <code class="language-text">new</code> 的时候当做构造函数来使用创建一个实例对象</li>
</ol>
<p>在 es6 之后为了搞清楚这两种使用方式，添加了两个内置属性： <code class="language-text">[[Call]]</code> 和 <code class="language-text">[[Constructor]]</code>  </p>
<p>当当做函数直接调用时，其实内部是调用了 <code class="language-text">[[Call]]</code> 执行了函数体，  </p>
<p>当结合 <code class="language-text">new</code> 来使用是，调用的是 <code class="language-text">[[Contructor]]</code> 执行了以下步骤：  </p>
<ol>
<li>创建一个新的对象 newObj</li>
<li>将 <code class="language-text">this</code> 绑定到 newObj</li>
<li>将 newObj 对象返回作为该构造函数的一个实例对象</li>
</ol>
<p>也就是说我们可以在构造函数中去改变它的行为，如果它没有显示的 <code class="language-text">return</code> 一个合<br>
法的对象，则会默认走 #3 步，如果我们显示的去返回了一个对象，那么最后得到的实<br>
例对象即这个显示返回的对象。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person1</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">||</span> <span class="token string">'xxx'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 没有显示的 return 一个合法对象</span>
<span class="token comment">// 返回的是新创建的对象，并且 this 被绑定到这个心对象上</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person1</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>

<span class="token comment">// 因此这里访问的 name 即构造函数中的 this.name</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Person2</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">||</span> <span class="token string">'xxx'</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'李四'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 按照构造函数的使用定义，这里返回的是</span>
<span class="token comment">// 显示 return 的那个对象： { name: '李四' }</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person2</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>

<span class="token comment">// 因此这里输出的结果为：李四</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三
李四</code></pre></div>
<blockquote>
<p>并不是所有的函数都有 <code class="language-text">[[Constructor]]</code> ，比如箭头函数就没有，因此箭头函数  </p>
<p>也就不能被用来 <code class="language-text">new</code> 对象实例。  </p>
</blockquote>
<h3>判断函数被如何使用？</h3>
<p>有时候我们需要知道函数是如何被使用的，是当做构造函数？还是单纯当做函数直接调用？  </p>
<p>这个时候 <code class="language-text">instanceof</code> 就派上用场了，它的作用是用来检测一个对象是否在当前对象的  </p>
<p>原型链上出现过。  </p>
<p>比如：在 es5 中强制一个函数只能当做构造函数来使用，一般这么做  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'必须使用 new 来创建实例对象。'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>

<span class="token comment">// 这种调用，内部的 `this` 被绑定到了全局对象</span>
<span class="token comment">// 而全局对象并非 Person 原型链上的对象，因此会</span>
<span class="token comment">// 执行 else 抛出异常</span>
<span class="token keyword">var</span> notAPerson <span class="token operator">=</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">)</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1560820870.png" alt="img">  </p>
<p>但是有一种直接调用的情况，不会走 <code class="language-text">else</code> ，即通过 <code class="language-text">call</code> 调用指定 <code class="language-text">person</code> 实<br>
例为调用元。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'必须使用 new 来创建实例对象。'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>

<span class="token comment">// 这样是合法的，请 this instanceof Person 成立</span>
<span class="token comment">// 因为 Person.call(person, ...) 指定了作用域为实例对象 person</span>
<span class="token comment">// 因此函数内部的 this 会被绑定到这个实例对象 person 上，</span>
<span class="token comment">// 而 person 确实是 Person 的实例对象，因此不会报错</span>
<span class="token keyword">var</span> notAPerson <span class="token operator">=</span> <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">)</span></code></pre></div>
<p>正常运行的结果  </p>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">undefined</code></pre></div>
<p>因此，如果是 <code class="language-text">Person.call(person, ...)</code> 这种情况调用，函数内部同样无法判断它的被使用方式是如何。  </p>
<h3>new.target 元属性<a id="org52daa00"></a></h3>
<p>为了解决上一节的“函数调用方式”判断的问题， es6 中引入了 <code class="language-text">new.target</code> 元属性。  </p>
<blockquote>
<p>元属性：一个非对象的属性，用来为他的目标（比如： <code class="language-text">new</code> )提供额外的相关信息。  </p>
</blockquote>
<p><code class="language-text">new.target</code> 的取值？？  </p>
<ol>
<li>
<p>如果函数当做构造函数  </p>
<p>使用 <code class="language-text">new</code> 来调用，内部调用 <code class="language-text">[[Constructor]]</code> 的时候， <code class="language-text">new.target</code> 会被填充<br>
为 <code class="language-text">new</code> 操作符指定的目标对象，这个目标对象通常是执行内部构造函数的时候新<br>
创建的那个对象实例(在函数体重一般是 <code class="language-text">this</code> ）。</p>
</li>
<li>如果函数当做普通函数直接调用，那么 <code class="language-text">new.target</code> 的值为 <code class="language-text">undefined</code></li>
</ol>
<p>从上面两点，那么我们就可以通过在函数内部判断 <code class="language-text">new.target</code> 来判断函数的使用方<br>
式了。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'必须使用 new 创建实例。'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'new'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> notAPerson <span class="token operator">=</span> <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>notAPerson<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'call'</span><span class="token punctuation">)</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1560822025.png" alt="img">  </p>
<p>由图中的输出证明上面 #1 和 #2 的结论，也由此结论我们可以直接使用 <code class="language-text">new.target
    === Person</code> 作为判定条件。  </p>
<p>函数外部使用 <code class="language-text">new.target</code> :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">===</span> Person<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target<span class="token punctuation">)</span></code></pre></div>
<h2>块级函数</h2>
<h3>&#x3C;= es3 行为</h3>
<p>在 es3 或更早些时候，在块级作用域中声明函数会出现语法错误，虽然在之后默认允<br>
许这样使用（不会报错了），但是各个浏览器之间的处理方式依旧不同，因此在实际开<br>
发过程中，应该尽量避免这么使用，如果非要在块级作用域声明函数可以考虑使用函数<br>
表达式方式。  </p>
<h3>es5 行为</h3>
<p>另外，为了尝试去兼容这种怪异情况，在 es5 的严格模式下如果在块级作用域声明函<br>
数，会爆出异常。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在 es5 中会报语法错误， es6 中不会</span>
  <span class="token keyword">function</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>es6 行为<a id="org473d6ba"></a></h3>
<p>在 es6 之后，这种函数声明将会变的合法，且声明之后 <code class="language-text">doSth()</code> 就成了一个局部函<br>
数变量，即只能在 <code class="language-text">if (true) { ... }</code> 这个作用域内部访问，外部无法访问，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为有提升，且命名函数的提升包含声明和定义都会被提升</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> doSth<span class="token punctuation">)</span> <span class="token comment">// function</span>
  <span class="token keyword">function</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// es6 之后存在块级作用域，因此 doSth 是个局部变量，在</span>
<span class="token comment">// 它的作用域范围之外无法访问</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> doSth<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">function
undefined</code></pre></div>
<h3>决定什么时候该用块级函数</h3>
<p>在 <a href="#org473d6ba">4.7.3</a> 一节中使用的是命名式函数声明方式，这种方式声明和定义均被提升，<br>
因此在声明处至上访问能得到正常结果。  </p>
<p>如果使用表达式 + <code class="language-text">let</code> 方式，则结果会和用 <code class="language-text">let</code> 声明一样存在 <strong>TDZ</strong> 的问题。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TDZ 区域，访问会异常</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> doSth<span class="token punctuation">)</span> <span class="token comment">// error</span>

  <span class="token keyword">let</span> <span class="token function-variable function">doSth</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> doSth<span class="token punctuation">)</span> <span class="token comment">// undefined</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1560823372.png" alt="img">  </p>
<p>因此，我们可以根据需求去决定该使用哪种方式去声明块级函数，如果需要有提升则应<br>
该使用“命名式函数”，如果不需要提升，只需要在声明之后的范围使用应该使用“函数<br>
表达式”方式去声明函数。  </p>
<h3>非严格模式块级函数</h3>
<p>在 es6 中的非严格模式下，块级函数的提升不再是针对块级作用域，而是函数体或全<br>
局环境。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 相当于提升到了这里</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> doSth<span class="token punctuation">)</span>

  <span class="token comment">// 非严格模式，全局提升</span>
  <span class="token keyword">function</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> doSth<span class="token punctuation">)</span> <span class="token comment">// function</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">function
function</code></pre></div>
<p>结果显示外面的 <code class="language-text">typeof doSth</code> 也是 ‘function’ 。  </p>
<p>因此，在 es6 之后函数的声明只需要区分严格或非严格模式，而不再需要考虑浏览器<br>
的兼容问题，相当于统一了标准。  </p>
<h2>箭头函数</h2>
<h3>箭头函数特性<a id="org5e8d16a"></a></h3>
<p>在 es6 中引入了箭头函数，大大的简化了函数的书写，比如  </p>
<p>声明一个函数： <code class="language-text">function run() {}</code>  </p>
<p>现在： <code class="language-text">const run = () =&gt; {}</code> 或者 <code class="language-text">const getName = () =&gt; &#39;张三&#39;</code>  </p>
<p>虽然用起来方便了，但是箭头函数与普通函数又很大的不同，使用的时候必须要注意以<br>
下几点：  </p>
<table>
<thead>
<tr>
<th>序</th>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>无 <code class="language-text">this</code></td>
<td>减少问题，便于优化</td>
</tr>
<tr>
<td>2</td>
<td>无 <code class="language-text">super</code></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>无 <code class="language-text">arguments</code></td>
<td>箭头函数必须依赖命名参数或 <code class="language-text">rest</code> 参数去访问函数的参数列表</td>
</tr>
<tr>
<td>4</td>
<td>无 <code class="language-text">new.target</code> 元属性</td>
<td>不能被实例化，功能无歧义，不需要这个属性</td>
</tr>
<tr>
<td>5</td>
<td>不能 <code class="language-text">new</code> 实例化</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>无原型</td>
<td>因为不能用 <code class="language-text">new</code> 因此也不需要原型</td>
</tr>
<tr>
<td>7</td>
<td>不能改变 <code class="language-text">this</code> 指向</td>
<td>此时指向不再受函数本身限制</td>
</tr>
<tr>
<td>8</td>
<td>不能有重复的命名参数</td>
<td>之前非严格模式下普通函数是可以有的</td>
</tr>
</tbody>
</table>
<blockquote>
<p>箭头函数中如果引用 <code class="language-text">arguments</code> ，它指向的不再是该箭头函数的参数列表，  </p>
<p>而是包含该箭头函数的那个非箭头函数的参数列表(<a href="#orga805ee7">4.8.6</a>)。  </p>
</blockquote>
<p>没有 <code class="language-text">this</code> 绑定主要有两点理由：  </p>
<ol>
<li>
<p>不易追踪，易造成未知行为，众多错误来源  </p>
<p>函数内部 <code class="language-text">this</code> 的值非常不容易追踪，经常会造成未知的函数行为，箭头函数去<br>
掉它可以避免这些烦恼</p>
</li>
<li>
<p>便于引擎优化  </p>
<p>限制箭头函数内部使用 <code class="language-text">this</code> 去执行代码也有利于 JavaScript 引擎更容易去优<br>
化内部操作，而不像普通函数一样，函数有可能会当做构造函数使用或其他用途。</p>
</li>
</ol>
<blockquote>
<p>同样，箭头函数也有自己的 <code class="language-text">name</code> 属性，用来描述函数的名称特征。  </p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token parameter">msg</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">'arguments'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'this'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>print<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'...end'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">print
0 &#39;arguments&#39;
Object [global] {
// ... 省略
        { [Function: setImmediate] [Symbol(util.promisify.custom)]: [Function] } } &#39;this&#39;
...end
undefined</code></pre></div>
<p>因为是 <code class="language-text">nodejs</code> 环境，因此 <code class="language-text">this</code> 被绑定到了 <code class="language-text">global</code> 对象上。  </p>
<p>第二行输出结果是 <code class="language-text">0 &#39;arguments&#39;</code> 说明已经不能使用 <code class="language-text">arguments</code> 去正确获取传入<br>
的参数了。  </p>
<h3>箭头函数语法</h3>
<p>箭头函数语法非常灵活，具体如何使用根据使用场景和实际情况决定。  </p>
<p>比如：  </p>
<p><code class="language-text">var reflect = value =&gt; value;</code> 直接返回原值  </p>
<p>相当于  </p>
<p><code class="language-text">var reflect = function(value) { return value; }</code>  </p>
<p>当只有一个参数时刻省略小括号 <code class="language-text">()</code>  </p>
<p>多个参数时候：  </p>
<p><code class="language-text">var sum = (n1, n2) =&gt; n1 + n2;</code>  </p>
<p>函数体更多内容时候：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// do more...</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>空函数：  </p>
<p><code class="language-text">var empty = () =&gt; {}</code>  </p>
<p>返回一个对象：  </p>
<p><code class="language-text">var getTempItem = id =&gt; ({ id: id, name: &#39;Temp&#39; })</code>  </p>
<p>等等。。。  </p>
<h3>箭头立即函数表达式</h3>
<p>在 es6 之前我们要实现一个立即执行函数，一般这样：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">person</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> name
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 直接在函数后面加上小括号即成为立即执行函数</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三</code></pre></div>
<p><strong>PS: 但是为了代码可读性，建议给函数加上小括号。</strong>  </p>
<p>箭头函数形式的立即执行函数，不可以直接在 <code class="language-text">}</code> 后面使用小括号方式：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> name
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span>


console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三</code></pre></div>
<h3>没有 this 对象</h3>
<p>在之前我们经常遇到的一个问题写法是事件的监听回调函数中直接使用 <code class="language-text">this</code> ，这将<br>
导致引用错误问题，因为事件的回调属于被动触发的，而触发调用该回调的对象是不确<br>
定的，这就会导致各种问题。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> PageHandler <span class="token operator">=</span> <span class="token punctuation">{</span>

  id<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>

  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里用了 this ，意图是想在点击事件触发的时候去调用 PageHandler 的</span>
      <span class="token comment">// doSomething 这个函数，但实际却是事与愿违的</span>
      <span class="token comment">// 因为这里的 this 并非指向 Pagehandler 而是事件触发调用回调时候的那个目标对象</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// error</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">doSomething</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Handling "</span> <span class="token operator">+</span> type  <span class="token operator">+</span> <span class="token string">" for "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>以往解决方法：通过 <code class="language-text">bind(this)</code> 手动指定函数调用对象  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> PageHandler <span class="token operator">=</span> <span class="token punctuation">{</span>

  id<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>

  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 经过 bind 之后，回调函数的调用上下文就被绑定到了 PageHandler 这个对象</span>
    <span class="token comment">// 真正绑定到 click 事件的函数其实是执行 bind(this) 之后绑定了上下文的一个函数副本</span>
    <span class="token comment">// 从而执行能得到我们想要的结果</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// no error</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">doSomething</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Handling "</span> <span class="token operator">+</span> type  <span class="token operator">+</span> <span class="token string">" for "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>虽然问题是解决了，但是使用 <code class="language-text">bind(this)</code> 无疑多创建了一份函数副本，多少都会有<br>
些奇怪。  </p>
<p>然后，在 es6 之后这个问题就很好的被箭头函数解决掉：  </p>
<p>根据箭头函数没有 <code class="language-text">this</code> 绑定的特性，在其内部使用 <code class="language-text">this</code> 的时候这个指向将是包<br>
含该箭头函数的非箭头函数所在的上下文，即：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> PageHandler <span class="token operator">=</span> <span class="token punctuation">{</span>

  id<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>

  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token string">"click"</span><span class="token punctuation">,</span>
      <span class="token comment">// 箭头函数无 this 绑定，内部使用 this</span>
      <span class="token comment">// 这个 this 的上下文将有包含该箭头函数的上一个非箭头函数</span>
      <span class="token comment">// 这里即 init() 函数，而 init() 函数的上下文为 PageHandler 对象</span>
      <span class="token comment">// 也就是说这里箭头函数内部的 this 指向的就是 Pagehandler 这个对象</span>
      <span class="token comment">// 从而让代码按照预期运行</span>
      <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">doSomething</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Handling "</span> <span class="token operator">+</span> type  <span class="token operator">+</span> <span class="token string">" for "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h3>箭头函数和数组</h3>
<p>在使用数组的一些内置函数时，我们经常会碰到需要传递一个参考函数给他们，比如，<br>
排序函数 <code class="language-text">Array.prototype.sort</code> 就需要我们传递一个比较函数用来决定是升序还是<br>
降序等等。  </p>
<p>如果用箭头函数将大大简化代码：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// es6 之前</span>
<span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>

<span class="token keyword">var</span> res1 <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 指定为升序</span>
  <span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// es6 之后</span>
<span class="token keyword">var</span> res2 <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a <span class="token operator">-</span> b<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> res2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1,2,3,5,10 1,2,3,5,10</code></pre></div>
<p>或者 <code class="language-text">map()</code>, <code class="language-text">reduce()</code> 等等用起来会更方便更简洁许多。  </p>
<h3>无参数绑定(arguments)<a id="orga805ee7"></a></h3>
<p>看实例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createArrowFunctionReturningFirstArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> arrowFunction <span class="token operator">=</span> <span class="token function">createArrowFunctionReturningFirstArg</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">arrowFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 5</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">5</code></pre></div>
<p>从结果看出，返回的 <code class="language-text">arrowFunction()</code> 箭头函数调用的时候并没有传递任何参数，<br>
但是执行结果得到了结果这个结果正是包含它的那个非箭头函数<br>
(<code class="language-text">createArrowFunctionReturingFirstArt()</code>)所接受的参数值。  </p>
<p><em>因此箭头函数内部如果访问 <code class="language-text">arguments</code> 对象，此时该对象指向的是包含它的那个非箭头函数的参数列表对象。</em>  </p>
<h3>箭头函数的识别</h3>
<p>跟普通函数一样， <code class="language-text">typeof</code> 和 <code class="language-text">instanceof</code> 对齐依然使用。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">comparator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> comparator<span class="token punctuation">)</span> <span class="token comment">// function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>comparator <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">function
true</code></pre></div>
<p>在 <a href="#org5e8d16a">4.8.1</a> 一节提到过箭头函数是不能改变 <code class="language-text">this</code> 指向的，但是  </p>
<p>并不代表我们就完全不能使用 <code class="language-text">call, apply, bind</code>  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>n1 <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> n2

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span> n1<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
2</code></pre></div>
<p>从这个例子中可以验证，箭头函数是无法修改它的 <code class="language-text">this</code> 指向的，如果可以修改  </p>
<p>第二个结果值就应该是 <code class="language-text">12</code> 而不是和第一个一样为 <code class="language-text">2</code> ，因为在第二个中  </p>
<p>我们手动将 <code class="language-text">sum</code> 执行上下文绑定到了一个新的对象上 <code class="language-text">{n1: 10}</code> 。  </p>
<blockquote>
<p>也就是说，并非不能使用，而是用了也不会有任何变化而已。  </p>
</blockquote>
<p>使用 <code class="language-text">bind</code> 保留参数：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token operator">=></span> n1 <span class="token operator">+</span> n2

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>

<span class="token comment">// 产生新的函数，这种和普通函数使用方式一样</span>
<span class="token keyword">var</span> boundSum <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">boundSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3
3
3</code></pre></div>
<h2>尾调用优化</h2>
<p>尾调用：将一个函数的调用放在两一个函数的最后一行。  </p>
<p>或许在 es6 中对于函数相关的最感兴趣的改动就是引擎的优化了，它改变了函数的尾调<br>
用系统。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">doSthElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// tail call</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在 es6 之前，它和普通的函数调用一样被处理：创建一个新的栈帧然后将它推到调用栈<br>
的栈顶等待被执行, 也就意味着之前的每一个栈帧都在内存里面保留着，如果调用栈过<br>
大那这将可能是问题的来源。  </p>
<h3>有什么不同？</h3>
<p>在 es6 之后优化了引擎，包含尾调用系统的优化（严格模式下，非严格模式下依旧未<br>
发生改变）。  </p>
<p>优化之后，不再会为尾部调用创建一个新的栈帧，而是将当前的栈帧情况，然后将其复<br>
用到尾部调用，前提是满足下面几个条件：  </p>
<ol>
<li>尾调用函数不需要访问当前栈帧中的任何变量(即尾调用的函数不能是闭包，闭包的<br>
作用就是用来持有变量)</li>
<li>即在尾调用的函数之后不能有其他的代码，即尾调用函数必须是函数体的最后一行</li>
<li>尾调用函数的调用结果要作为当前函数的返回值返回</li>
</ol>
<p>比如：下面的函数就满足尾调用优化的条件  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span> <span class="token comment">// 1. 严格模式</span>

<span class="token keyword">function</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 2. 没有引用任何内部变量，非闭包</span>

  <span class="token comment">// 3. 最后一行</span>

  <span class="token comment">// 4. 调用结果被作为 doSth 的返回值返回</span>
  <span class="token keyword">return</span> <span class="token function">doSthElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>以下情况不会被优化：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">doSthElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 返回作为返回值，不会优化</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">doSth1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">doSthElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 在尾调用函数返回之后不能有其他操作，不会优化</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">doSth2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token function">doSthElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res <span class="token comment">// 不是最后一行，即不是将结果立即返回，不会优化</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">doSth3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> num

  <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 闭包，不会优化</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>如何利用尾调用优化？</h3>
<p>尾调用最经典的莫过于递归调用了，比如斐波那契数列问题。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

    <span class="token comment">// 不会被优化，因为函数返回之后还需要进行乘积计算才返回</span>
    <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3628800</code></pre></div>
<p>上面的并不会被优化，因为尾调用函数并不是立即返回的，修改如下：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> p <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> res <span class="token operator">=</span> n <span class="token operator">*</span> p
    <span class="token comment">// 被优化</span>
    <span class="token keyword">return</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3628800</code></pre></div>
<p>尾调用优化应该是我们在书写代码的时候时常应该考虑的问题，尤其是书写递归的时候，<br>
当使用递归涉及到大量的计算的时候，  </p>
<p>尾调用优化的优势将会很明显。  </p>
<h2>小结</h2>
<table>
<thead>
<tr>
<th>选项</th>
<th>功能</th>
<th>描述</th>
<th>其他</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>arguments</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ES6之前非严格模式</td>
<td>值会随着函数体内参数的改变而改变</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ES6之前严格模式</td>
<td>不会响应改变，调用之初就定了</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ES6之后行为统一</td>
<td>不会响应改变，内容由实际调用者传递个数决定</td>
<td></td>
</tr>
<tr>
<td><strong>函数默认参数</strong></td>
<td>可以是常量值</td>
<td><code class="language-text">function add(f, s = 3) {}</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>可以是变量</td>
<td><code class="language-text">var n = 10; function add(f, s = n) {}</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>可以是函数调用</td>
<td><code class="language-text">function getVal() {}; function add(f, s = getVal) {}</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>默认值参数的执行</td>
<td>调用时有传递则不会检测或执行，未传递则会检测和执行</td>
<td></td>
</tr>
<tr>
<td></td>
<td>相互引用</td>
<td>后面的参数可以引用前面的参数变量 <code class="language-text">function add(f, s = f) {}</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>临时死区(TDZ)</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>参数 rest 符号</strong></td>
<td>接受多个参数，合并成数组供函数内部使用</td>
<td><code class="language-text">function add(f, ...a) {}</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>异常使用一</td>
<td>不能用在访问器函数</td>
<td><code class="language-text">obj = { set name(...val) {} }</code>  非法。</td>
</tr>
<tr>
<td></td>
<td>异常使用二</td>
<td>必须作为函数最后一个参数使用</td>
<td><code class="language-text">function add(f, ...s, t) {}</code> 非法。</td>
</tr>
<tr>
<td></td>
<td>对arguments影响</td>
<td>非箭头函数没什么影响</td>
<td>arguments总是由调用者传递的参数决定个数</td>
</tr>
<tr>
<td><strong>构造函数</strong></td>
<td>new Function()</td>
<td>可以使用默认值，rest符号等功能</td>
<td></td>
</tr>
<tr>
<td><strong>展开符(…)</strong></td>
<td>普通多参数函数</td>
<td><code class="language-text">Math.max(1, 2, 3, 4, ...)</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>普通多参数函数apply</td>
<td><code class="language-text">Math.max.apply(Math, [1, 2, 3, 4])</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ES6展开符</td>
<td><code class="language-text">Math.max(...[1, 2, 3, 4, ...])</code></td>
<td></td>
</tr>
<tr>
<td><strong>name 属性</strong></td>
<td>函数名称</td>
<td>仅辅助描述功能，易于跟踪函数</td>
<td></td>
</tr>
<tr>
<td></td>
<td>特殊情况: 访问器函数</td>
<td><code class="language-text">get fnName</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>特殊情况：bind() 函数</td>
<td><code class="language-text">bound fnName</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>特殊情况：new Function()</td>
<td>匿名函数 <code class="language-text">anonymous</code></td>
<td></td>
</tr>
<tr>
<td><strong>new.target</strong></td>
<td>函数可直接调用可new构造实例</td>
<td>因此造成函数内部如何识别使用释放问题？</td>
<td></td>
</tr>
<tr>
<td></td>
<td>如果作为函数调用 <code class="language-text">[[Call]]</code></td>
<td>new.target = undefined</td>
<td></td>
</tr>
<tr>
<td></td>
<td>如果是 new 构造函数 <code class="language-text">[[Constructor]]</code></td>
<td>new.target = Person 构造函数本身</td>
<td></td>
</tr>
<tr>
<td><strong>块级函数</strong></td>
<td>在 es6之情块级函数的声明处理并没有统一</td>
<td>严格模式必出异常，非严格不好说</td>
<td></td>
</tr>
<tr>
<td></td>
<td>es6之后统一标准</td>
<td>严格模式：块级函数只是局部函数</td>
<td>只在作用域内有效</td>
</tr>
<tr>
<td></td>
<td></td>
<td>非严格模式：块级函数会提升到函数顶部或全局环境</td>
<td>全局或函数体生效</td>
</tr>
<tr>
<td><strong>箭头函数特性</strong></td>
<td>无 <code class="language-text">this</code> 不易追踪，易于引擎优化</td>
<td>内部可以使用，但是它指向的是当前箭头函数所在的非箭头函数所在的上下文</td>
<td></td>
</tr>
<tr>
<td></td>
<td>无 <code class="language-text">super</code></td>
<td>没有原型，继承等，不需要 <code class="language-text">super</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>无 <code class="language-text">arguments</code></td>
<td>内部访问的该对象，其实是当前环境函数的参数，而非箭头函数本身的参数列表</td>
<td></td>
</tr>
<tr>
<td></td>
<td>无 <code class="language-text">new.target</code></td>
<td>不支持 <code class="language-text">new</code> 就不存在使用方式问题</td>
<td></td>
</tr>
<tr>
<td></td>
<td>无原型</td>
<td>不支持 <code class="language-text">new</code></td>
<td></td>
</tr>
<tr>
<td></td>
<td>不能改变 <code class="language-text">this</code> 指向</td>
<td>其内部的 <code class="language-text">this</code> 已经不是它管辖，可以调用 <code class="language-text">call, apply, bind</code> 之流，但是不会有任何作用</td>
<td></td>
</tr>
<tr>
<td></td>
<td>不能有重复命名参数</td>
<td>非严格模式下ES6之前的普通参数可以用</td>
<td></td>
</tr>
<tr>
<td></td>
<td>箭头函数语法</td>
<td>使用方式灵活多变</td>
<td></td>
</tr>
<tr>
<td></td>
<td>立即表达式</td>
<td>必须括号包起来再执行，普通函数可直接在 <code class="language-text">}</code> 后执行</td>
<td><code class="language-text">(() =&gt; {})()</code>, <code class="language-text">function(name){}(&#39;xxx&#39;)</code></td>
</tr>
<tr>
<td></td>
<td>typeof, instanceof</td>
<td>对箭头函数依旧有效， typeof fn <code class="language-text">=</code> ‘function’, fn instanceof Function (true)</td>
<td></td>
</tr>
<tr>
<td><strong>尾调用优化</strong></td>
<td>必须满足三个条件</td>
<td>不满足条件不会优化，典型的递归调用</td>
<td></td>
</tr>
<tr>
<td></td>
<td>1. 非闭包，尾函数体内不能访问正函数体内任何变量</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>2. 结果值必须立即返回，不能参与其他计算后再返回</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>3. 必须是正函数的最后一个语句</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>优化之前</td>
<td>尾函数新建栈帧，放在调用栈顶等待调用</td>
<td></td>
</tr>
<tr>
<td></td>
<td>优化之后</td>
<td>清空调用栈，将它作为尾调用函数的栈帧复用</td>
<td></td>
</tr>
</tbody>
</table>
<h1>对象扩展(Object)</h1>
<h2>对象分类</h2>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>普通对象(Ordinary)</em></td>
<td>拥有所有对象的默认行为</td>
</tr>
<tr>
<td><em>异类对象(Exotic)</em></td>
<td>和默认行为有所差异</td>
</tr>
<tr>
<td><em>标准对象(Standard)</em></td>
<td>那些由 ECMAScript 6 定义的，如： <code class="language-text">Array</code>, <code class="language-text">Date</code> 等等</td>
</tr>
<tr>
<td><em>内置对象(Built-in)</em></td>
<td>脚本当前执行环境中的对象，所有标准对象都是内置对象</td>
</tr>
</tbody>
</table>
<h2>对象字面量(literal)语法扩展</h2>
<p>字面量语法在 JavaScript 中使用非常普遍  </p>
<ol>
<li>书写方便</li>
<li>简洁易懂</li>
<li>JSON 就是基于字面量语法演变而来</li>
</ol>
<p>es6 的来到是的对象字面量语法更加强大简洁易用。  </p>
<h3>对象属性简写</h3>
<p>&#x3C;= es5:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> name<span class="token punctuation">,</span>
    age<span class="token operator">:</span> age
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>es6:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    age
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>简洁函数写法</h3>
<p>&#x3C;= es5:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">sayName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>es6:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>计算属性</h3>
<p>在 es6 之前书写对象字面量的时候，可以直接使用多个字符串组成的字符串作为<br>
<code class="language-text">key</code> ，但是这种方式在实际使用中是非常不方便的，假如说 key 是个很长的串呢？？  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'first name'</span><span class="token operator">:</span> <span class="token string">'张三'</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span><span class="token string">'first name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三</code></pre></div>
<p>因此， es6 中支持了变量作为对象属性名去访问，根据变量的值动态决定使用什么<br>
<code class="language-text">key</code> 去访问对象的属性值，这样不管 <code class="language-text">key</code> 多长，只需要使用变量将它存储起来，<br>
直接使用变量名去使用将更加方便。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    lastName <span class="token operator">=</span> <span class="token string">"last name"</span><span class="token punctuation">;</span>

person<span class="token punctuation">[</span><span class="token string">"first name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"张三"</span><span class="token punctuation">;</span>
person<span class="token punctuation">[</span>lastName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"李四"</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span><span class="token string">"first name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "张三"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span>lastName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// "李四"</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三
李四</code></pre></div>
<p>支持表达式计算属性名：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> suffix <span class="token operator">=</span> <span class="token string">' name'</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token string">'first'</span> <span class="token operator">+</span> suffix<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'last'</span> <span class="token operator">+</span> suffix<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'李四'</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span><span class="token string">'first name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span><span class="token string">'last name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 李四</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三
李四</code></pre></div>
<h2>新方法</h2>
<h3>Object.fromEntries(iterable)<sup>2019</sup></h3>
<p>将一组 map 类型或似 map 类型的数组转成对象。  </p>
<p>如： <code class="language-text">[ [&#39;key1&#39;, &#39;value1&#39; ], [&#39;key2&#39;, &#39;value2&#39;] ]</code>  </p>
<p>转换之后： <code class="language-text">{ key1: &#39;value1&#39;, key2: &#39;value2&#39; }</code>  </p>
<h3>Object.is(value1, value2)</h3>
<p>在以往我们判断两个值是否相等，经常使用的是 <code class="language-text">==</code> 和 <code class="language-text">===</code> ，一般推荐使用后者  </p>
<p>因为前者会有隐式强转，会在比较之前将两个值进行强制转换成同一个类型再比较。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">''</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">==</span> <span class="token string">'5'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">NaN</span> <span class="token operator">==</span> <span class="token number">NaN</span><span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
true
true
true
false</code></pre></div>
<p>对于 <code class="language-text">+0</code> 和 <code class="language-text">-0</code> 使用 <code class="language-text">===</code> 的结果是 <code class="language-text">true</code> ，但实际上他们是有符号的，理论<br>
上应该是不相等的。  </p>
<p>而两个 <code class="language-text">NaN</code> 五路你是 <code class="language-text">==</code> 或 <code class="language-text">===</code> 都判定他们是不相等的。  </p>
<p>为了解决这些差异， es6 中加入了 <code class="language-text">Object.is()</code> 接口，意指将等式的判断更加合理<br>
化，它的含义是两个值是否是同一个值。  </p>
<p>我们看下各对值使用 <code class="language-text">Object.is()</code> 比较的结果:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> is <span class="token operator">=</span> Object<span class="token punctuation">.</span>is
<span class="token keyword">const</span> log <span class="token operator">=</span> console<span class="token punctuation">.</span>log

<span class="token comment">// +0, -0</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'+0 == -0'</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'+0 === -0'</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'+0 is -0: '</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// NaN</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NaN == NaN: '</span><span class="token punctuation">,</span> <span class="token number">NaN</span> <span class="token operator">==</span> <span class="token number">NaN</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NaN === NaN: '</span><span class="token punctuation">,</span> <span class="token number">NaN</span> <span class="token operator">===</span> <span class="token number">NaN</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NaN is NaN: '</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// number, string</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5 == "5": '</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token string">'5'</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5 == 5: '</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5 === "5": '</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">===</span> <span class="token string">'5'</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5 === 5: '</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5 is "5": '</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5 is 5: '</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">+0 == -0 true
+0 === -0 true
+0 is -0:  false
NaN == NaN:  false
NaN === NaN:  false
NaN is NaN:  true
5 == &quot;5&quot;:  true
5 == 5:  true
5 === &quot;5&quot;:  false
5 === 5:  true
5 is &quot;5&quot;:  false
5 is 5:  true</code></pre></div>
<p>因此， <code class="language-text">Object.is</code> 能够弥补， <code class="language-text">===</code> 无法判断出 <code class="language-text">+0, -0</code>, <code class="language-text">NaN, Nan</code> 相等的结<br>
果。  </p>
<h3>Object.assign(target, source, source1, source2, …)</h3>
<p>参数：  </p>
<ol>
<li><code class="language-text">target</code> 接受拷贝的对象，也将返回这个对象</li>
<li><code class="language-text">source</code> 拷贝内容的来源对象</li>
<li>来源对象参数可以有多个，如果存在同名属性值，最后的值由最后一个拥有同名属<br>
性对象中的值为准</li>
</ol>
<p><a href="https://tc39.es/ecma262/#sec-object.assign">TC39.ECMA262</a> 实现原理图：  </p>
<p><img src="http://qiniu.ii6g.com/Object-assign.png" alt="img">  </p>
<p>合并对象，将 source 中自身的可枚举的属性浅拷贝到 <code class="language-text">target</code> 对象中，返回<br>
<code class="language-text">target</code> 对象。  </p>
<p>混合器(<em>Mixins</em>)在 JavaScript 中被广泛使用，在一个 mixin 中，一个对象可以从<br>
另个对象中接受他们的属性和方法，即浅拷贝，许多 JavaScript 库都会有一个与下面<br>
类似的 mixin 函数:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">receiver<span class="token punctuation">,</span> supplier</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>supplier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
    <span class="token parameter">key</span> <span class="token operator">=></span> receiver<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> supplier<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> receiver
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">EventTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  constructor<span class="token operator">:</span> EventTarget<span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'EventTarget.prototype'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">emit</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">'in EventTarget.prototype'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">on</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">'on EventTarget.prototype'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> myObj1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">mixin</span><span class="token punctuation">(</span>myObj1<span class="token punctuation">,</span> <span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>

myObj1<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'something changed from myObj1'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myObj1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'obj1 name'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> myObj2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>myObj2<span class="token punctuation">,</span> <span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>

myObj2<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listen from myObj1'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myObj2<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'obj2 name'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> myObj1<span class="token punctuation">,</span> myObj2<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">something changed from myObj1 in EventTarget.prototype
EventTarget.prototype obj1 name
listen from myObj1 on EventTarget.prototype
EventTarget.prototype obj2 name</code></pre></div>
<p>由于 <code class="language-text">mixin()</code>, <code class="language-text">Object.assign</code> 的实现都是采用的 <code class="language-text">=</code> 操作符，因此是没法拷贝<br>
访问器属性的，或者说拷贝过来之后就不会再是访问器属性了，看上面代码的运行结果对比图：  </p>
<p><img src="http://qiniu.ii6g.com/1560930362.png" alt="img">  </p>
<p>多个来源对象支持：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> receiver <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">100</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  height<span class="token operator">:</span> <span class="token number">180</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  color<span class="token operator">:</span> <span class="token string">'yellow'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">80</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>receiver <span class="token operator">===</span> res<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
{ name: &#39;xxx&#39;, age: 80, height: 180, color: &#39;yellow&#39; }</code></pre></div>
<p>最后 <code class="language-text">age: 80</code> 值是最后一个来源对象中的值，返回值即第一个参数对象。  </p>
<h2>重复属性</h2>
<p>&#x3C;= es5 严格模式下，重复属性会出现语法错误：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'yyy'</span> <span class="token comment">// syntax error in es5 strict mode</span>
<span class="token punctuation">}</span></code></pre></div>
<p>es6 无论严格或非严格模式下都属合法操作，其值为最后一个指定的值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'yyy'</span> <span class="token comment">// no error</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">yyy</code></pre></div>
<h2>自有属性枚举顺序</h2>
<p>&#x3C;= es5 中是不会定义对象属性的枚举顺序的，它的枚举顺序是在实际运行时取决于所处<br>
的 JavaScript 引擎。  </p>
<p>es6 中严格定义了枚举时返回的属性顺序，这将会影响在使用<br>
<code class="language-text">Objct.getOwnPropertyNames()</code> 和 <code class="language-text">Reflect.ownKeys</code> 时属性该如何返回。  </p>
<p>枚举时基本顺序遵循：  </p>
<ol>
<li>所有数字类型的 <code class="language-text">keys</code> 为升序排序</li>
<li>所有字符串类型的 <code class="language-text">keys</code> 按照它添加的时机排序</li>
<li>所有符号类型(Symbols)的 <code class="language-text">keys</code> 按照它添加的时机排序</li>
</ol>
<p>三者的优先级为： <em>numbers > strings > symbols</em>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  c<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

obj<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token number">1</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 012acbd</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">012acbd</code></pre></div>
<blockquote>
<p>由于并非所有 JavaScript 引擎并非统一实现方式，导致 <code class="language-text">for-in</code> 循环依旧无法确定<br>
枚举的顺序。  </p>
<p>并且 <code class="language-text">Object.keys()</code> 和 <code class="language-text">JSON.stringify()</code> 采用的枚举顺序和 <code class="language-text">for-in</code> 一样。  </p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  c<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

obj<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>功能更强的原型对象</h2>
<p>原型是 JavaScript 中实现继承的基石，早起的版本中严重限制了原型能做的事情，  </p>
<p>然后随着 JavaScript 的逐渐成熟程序员们开始越来越依赖原型，我们现在能很清晰  </p>
<p>地感受到开发者们对原型控制上和易用性的渴望越来越强烈，由此 ES6 对齐进行了加强。  </p>
<h3>改变对象原型</h3>
<p>正常情况下，对象通过构造函数或 <code class="language-text">Object.create()</code> 创建的同时原型也就被创建了。  </p>
<p>ES5 中可以通过 <code class="language-text">Object.getPrototypeof()</code> 方法去获取对象原型，但是依然  </p>
<p>缺少一个标准的方式去获取失利之后的对象原型。  </p>
<p>ES6 增加了 <code class="language-text">Object.setPrototypeof(source, target)</code> 用来改变对象的原型指向，  </p>
<p>指将 <code class="language-text">source.prototype</code> 指向 <code class="language-text">target</code> 对象。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> dog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Woof"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// prototype is person</span>
<span class="token keyword">let</span> friend <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>friend<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// "Hello"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span> <span class="token operator">===</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span>

<span class="token comment">// set prototype to dog</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">,</span> dog<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>friend<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// "Woof"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span> <span class="token operator">===</span> dog<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// true</span></code></pre></div>
<p>实际上，一个对象的原型是存储在它的内部属性 <code class="language-text">[[Prototype]]</code> 上的， <code class="language-text">Object.getPrototypeOf()</code>  </p>
<p>获取的也是这个属性的值， <code class="language-text">Object.setPrototypeOf()</code> 设置也是改变这个属性的值。  </p>
<h3>旧版原型的访问</h3>
<p>比如：如果想在实例中重写原型的某个方法的时候，需要在重写的方法内调用原型方法<br>
时候，以往是这样搞  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> dog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Woof"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> friend <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", hi!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// set prototype to person</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>friend<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// "Hello, hi!"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span> <span class="token operator">===</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span>

<span class="token comment">// set prototype to dog</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">,</span> dog<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>friend<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// "Woof, hi!"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span> <span class="token operator">===</span> dog<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// true</span></code></pre></div>
<p>通过 <code class="language-text">Object.getPrototypeOf(this).getGreeting.call(this)</code> … 去获取原型中的<br>
方法  </p>
<h3>通过 super 引用简化原型的访问</h3>
<p>如之前所提，原型是 JavaScript 中一个很重要也很常用的一个对象，ES6 对他们的使<br>
用进行了简化。  </p>
<p>另外 es6 对原型的另一个改变是 <code class="language-text">super</code> 的引用，这让对象访问原型对象更加方便。  </p>
<p>而在 es6 增加 <code class="language-text">super</code> 之后就变得异常简洁了：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> friend <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// in the previous example, this is the same as:</span>
    <span class="token comment">// Object.getPrototypeOf(this).getGreeting.call(this)</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", hi!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>类似其他语言的继承， <code class="language-text">friend</code> 是实例，它的原型是它的父类，在实例中的 <code class="language-text">super</code><br>
其实是指向父类的引用，因此可以直接在子类中直接使用 <code class="language-text">super</code> 去使用父类的方法。  </p>
<h3>只能在简写函数中访问 super</h3>
<p>但是 <code class="language-text">super</code> 只能在对象的简写方法中使用，如果是使用 “function” 关键词声明的<br>
函数中使用会出现  </p>
<p><em>syntax error</em>  </p>
<p>比如：下面的方式是非法的  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> friend <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getGreeting</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// syntax error</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", hi!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>因为 <code class="language-text">super</code> 在这种函数的上下文中中不存在的。  </p>
<h3><code class="language-text">Object.getPrototypeOf()</code> 并不是所有场景都能使用的</h3>
<p>因为 <code class="language-text">this</code> 的指向是根据函数的执行上下文来决定了，因此使用 <code class="language-text">this</code> 是完全靠谱<br>
的。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// prototype is person</span>
<span class="token keyword">let</span> friend <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", hi!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// prototype is friend</span>
<span class="token keyword">let</span> relative <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// "Hello"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>friend<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// "Hello, hi!"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>relative<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// error!</span></code></pre></div>
<p>上面的 <code class="language-text">relative.getGreeting())</code> 会报错，原因是 relative 本身是个新的变量，<br>
这个变量指向由 <code class="language-text">Object.create(friend)</code> 创建的一个空对象，其原型为 <code class="language-text">friend</code> ，<br>
即 <code class="language-text">reletive.getGreeting()</code> 的调用首先在 friend 中找但没找到，最后在<br>
<code class="language-text">friend</code> 中找到了，也就是说它实际上调用的就是原型上的 <code class="language-text">getGreeting()</code> 然后原<br>
型方法里面又是通过 <code class="language-text">this</code> 去调用了原型的方法(也就自身)，由于 <code class="language-text">this</code> 始终是根<br>
据当前上下文发生变化的，此时它的指向是 <code class="language-text">friend</code> ，最终会导致循环调用。  </p>
<p>而用 <code class="language-text">super</code> 就不会有上面的问题，因为 <code class="language-text">super</code> 指向是固定的，就是指向当前对象<br>
的原型对象（父对象），即这里指向的是 <code class="language-text">person</code> 。  </p>
<h3><code class="language-text">super</code> 引用的过程</h3>
<p>一般情况下是没什么区别的，但是在我们做继承或者获取对象的原型的时候就很有用了，<br>
因为 <code class="language-text">super</code> 的指向是和 <code class="language-text">[[HomeObject]]</code> 密切相关的， <code class="language-text">super</code> 获取指向的过程：  </p>
<ol>
<li>通过在当前方法的内部属性 <code class="language-text">[[HomeObject]]</code> 上面调用 <code class="language-text">Object.getPrototypeOf()</code><br>
去获取这个方法所在对象的原型对象；</li>
<li>在原型对象上搜与这个函数同名函数；</li>
<li>最后将这个同名函数绑定当前的 <code class="language-text">this</code> 执行，然后执行这个函数。</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// prototype is person</span>
<span class="token keyword">let</span> friend <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", hi!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>friend<span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>friend<span class="token punctuation">.</span><span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// "Hello, hi!"</span></code></pre></div>
<p>比如，上面的代码  </p>
<ol>
<li>将 <code class="language-text">person</code> 设置为 <code class="language-text">friend</code> 的原型，成为它的父对象</li>
<li>调用 <code class="language-text">friend.getGreeting()</code> 执行之后在其内部使用 <code class="language-text">super.getGreeting()</code> 这<br>
个一开始会找到 <code class="language-text">friend.getGreeting</code> 这个方法的 <code class="language-text">[[HomeObject]]</code> 也就是 <code class="language-text">friend</code></li>
<li>然后根据扎到的 <code class="language-text">friend</code> ，通过 <code class="language-text">Object.getPrototypeOf()</code> ，去找到原型对象，<br>
即 <code class="language-text">person</code> ，找到之后再去这里面找同名函数 <code class="language-text">getGreeting</code></li>
<li>找到之后将该函数执行上下文绑定到 <code class="language-text">this</code> (即 friend 所在的上下文）。</li>
<li>执行同名函数，此时这个虽是原型(<code class="language-text">person</code>)上的函数，但是上下文已经被绑定到<br>
了 <code class="language-text">friend</code> 上</li>
</ol>
<p>过程简单描述就是：  </p>
<p>设置继承<br>
=> 重写方法<br>
=> super 调用父级方法<br>
=> 找当前函数的 <code class="language-text">[[HomeObject]]</code><br>
=> <code class="language-text">Object.getPrototypeOf([[HomeObject]]</code>) 找原型<br>
=> 找原型上同名函数<br>
=> 绑定找到的同名函数到当前的 <code class="language-text">this</code><br>
=> 执行同名函数  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  fnName<span class="token operator">:</span> <span class="token string">'person'</span><span class="token punctuation">,</span>
  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fnName
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token punctuation">{</span>
  fnName<span class="token operator">:</span> <span class="token string">'child'</span><span class="token punctuation">,</span>
  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fnName
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> person<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// child child</span></code></pre></div>
<h2>方法定义</h2>
<p>在 es6 之前是没有“方法”这个词的定义的，但在 es6 之后对方法的定义才正式有了规定。  </p>
<h3>函数和方法定义</h3>
<p>在对象中的函数才叫做方法，非对象中的叫做函数，且 es6 给方法增加了一个<br>
<code class="language-text">[[HomeObject]]</code> 内置属性， 它指向的是包含这个方法的那个对象。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// method</span>
  <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'xxx'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// not method</span>
<span class="token keyword">function</span> <span class="token function">shareGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'yyy'</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">getGreeting</code> 叫做方法，且其有个内部属性 <code class="language-text">[[HomeObject]]</code> 指向了 <code class="language-text">person</code> 说明这<br>
个对象拥有它。  </p>
<p><code class="language-text">shareGreeting</code> 叫做函数，不是方法  </p>
<h2>总结</h2>
<p>更新内容  </p>
<table>
<thead>
<tr>
<th>内容</th>
<th>示例/说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>属性简写</td>
<td><code class="language-text">{name, age}</code> &#x3C;=> <code class="language-text">{name: name, age: age}</code></td>
</tr>
<tr>
<td>计算属性</td>
<td><code class="language-text">{ [first + &#39;name&#39;]: &#39;张三&#39; }</code>, <code class="language-text">{ [&#39;first name&#39;]: &#39;张三&#39; }</code></td>
</tr>
<tr>
<td>简写方法</td>
<td><code class="language-text">{ getName() {} }</code></td>
</tr>
<tr>
<td>重复属性名合法化</td>
<td><code class="language-text">{ age: 10, age: 100 }</code> &#x3C;=> <code class="language-text">{ age: 100 }</code></td>
</tr>
<tr>
<td><code class="language-text">Object.assign</code> 合并对象</td>
<td>浅拷贝，内部 <code class="language-text">=</code> 实现拷贝</td>
</tr>
<tr>
<td><code class="language-text">Object.is</code></td>
<td>加强判断，弥补 <code class="language-text">===</code> 不能判断 <code class="language-text">+0, -0</code> 和 <code class="language-text">NaN, NaN</code> 问题</td>
</tr>
<tr>
<td>固定对象属性枚举顺序</td>
<td>number > string > symbol, string 和 symbol 按照增加先后顺序排列</td>
</tr>
<tr>
<td><code class="language-text">Object.setPrototypeOf</code></td>
<td>可改变对象原型</td>
</tr>
<tr>
<td><code class="language-text">super</code></td>
<td>指向原型对象，可通过它去访问原型对象中的方法</td>
</tr>
</tbody>
</table>
<h1>数据解构</h1>
<h2>解构优势</h2>
<p>在 es5 及之前如果我们想要从对象中取出属性的值，只能通过普通的赋值表达式来实现，  </p>
<p>一个还好，如果是多个的话就会出现很重复的代码，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  repeat<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  save<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> repeat <span class="token operator">=</span> options<span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
    save <span class="token operator">=</span> options<span class="token punctuation">.</span>save


<span class="token comment">// if more ???</span></code></pre></div>
<p>上面只是取两个对象的属性，如果很多呢，十几个二十几个？？  </p>
<p>不仅代码量大，还不美观。  </p>
<p>因此 es6 加入了解构系统，让这些操作变的很容易，很简洁。  </p>
<h2>对象解构</h2>
<p>对象解构的时候，等号右边不能是 <code class="language-text">null</code> 或 <code class="language-text">undefined</code> ，这样会报错，这是因为，<br>
无论什么时候去读取 <code class="language-text">null</code> 或 <code class="language-text">undefined</code> 的属性都会出发运行时错误。  </p>
<h3>声明式解构</h3>
<p>解构的同时声明解构后赋值的变量：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'foo'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> node

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token comment">// Identifier</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token comment">// foo</span></code></pre></div>
<p>在使用解构的过程中必须要有右边的初始值，而不能只是用来声明变量，这是不合法的<br>
操作, 比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// syntax error!</span>
<span class="token keyword">var</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// syntax error!</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// syntax error!</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h3>先声明后解构</h3>
<p>有时候有些变量早已经存在了，只是后面我们需要将它的值改变，也正好是需要从对象<br>
中去取值，这个时候就是先声明后解构：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里变量已经声明好了</span>
    type <span class="token operator">=</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span>
    name <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment">// assign different values using destructuring</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "Identifier"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "foo"</span></code></pre></div>
<p>这个时候必须用 <code class="language-text">()</code> 将解构语句包起来，让其成为一个执行语句，如果不，左边就相<br>
当于一个块级语句，然而块级语句是不能出现在等式的左边的。  </p>
<p>在这基础上，另一种情况是将 <code class="language-text">{type, name} = node</code> 作为参数传递给函数的时候，<br>
这个时候传递给函数的参数其实就是 <code class="language-text">node</code> 本身，例如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
    type <span class="token operator">=</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span>
    name <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">outputInfo</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value <span class="token operator">===</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">outputInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// true</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "Identifier"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "foo"</span></code></pre></div>
<h3>解构默认值</h3>
<p>在解构过程中，可能左边声明的变量在右边的对象中并不存在或者值为 <code class="language-text">undefined</code><br>
的时候，这个变量的值将会赋值为 <code class="language-text">undefined</code> ，因此这个时候就需要针对这种情况<br>
有个默认处理，即这里的解构默认值。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "Identifier"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "foo"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// undefined</span></code></pre></div>
<p>属性值为 <code class="language-text">undefined</code> 的情况：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "Identifier"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "foo"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 0</span></code></pre></div>
<h3>属性变量重命名</h3>
<p>解构出来之后，可能不想沿用右边对象中的属性名，因此需要将左边的变量名称重命名：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> localType<span class="token punctuation">,</span> name<span class="token operator">:</span> localName <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localType<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "Identifier"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "foo"</span></code></pre></div>
<p>重命名 + 默认值:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> localType<span class="token punctuation">,</span> name<span class="token operator">:</span> localName <span class="token operator">=</span> <span class="token string">'xxx'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localType<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "Identifier"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "foo"</span></code></pre></div>
<h3>多级对象解构</h3>
<p>右边对象中的属性的值不一定是普通类型，可能是对象，或对象中包含对象，数组等等<br>
类型，次数可以使用内嵌对象解构来进行解构：  </p>
<p>原则就是左边的变量的结构要和右边实际对象中的结构保持一致  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> start <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 1</span></code></pre></div>
<p>多层解构重命名：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 重命名</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> start<span class="token operator">:</span> localStart <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 1</span></code></pre></div>
<p>#+BEGIN<sub>QUOTE</sub>  </p>
<h3>语法陷阱</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// no variables declared!</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span></code></pre></div>
<p>这种形式实际上是没任何作用的，因为左边的 <code class="language-text">loc</code> 只是起到了站位的作用，实际起<br>
作用的是在 <code class="language-text">{}</code> 里面，但是里面没任何东西，也就是说这个不会解构出任何东西，也<br>
不会产生任何新的变量。  </p>
<p>#+END<sub>QUOTE</sub>  </p>
<h2>数组解构</h2>
<p>数组解构和对象解构用法基本是一样的，无非就是讲 <code class="language-text">{}</code> 改成数组的 <code class="language-text">[]</code> ，和对象<br>
一样，右边不可以是 <code class="language-text">null</code> 和 <code class="language-text">undefined</code>  </p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>结果</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">let [first, second] = [1, 2]</code></td>
<td><code class="language-text">first = 1, first = 2</code></td>
<td>普通解构</td>
</tr>
<tr>
<td><code class="language-text">let [ , , third] = [1, 2, 3]</code></td>
<td><code class="language-text">third = 3</code></td>
<td>空置解构，只指定某个位置解构</td>
</tr>
<tr>
<td><code class="language-text">let first = 1, second = 2</code> => <code class="language-text">[first, second] = [11, 22]</code></td>
<td><code class="language-text">first = 11, second = 22</code></td>
<td>先声明再解构</td>
</tr>
<tr>
<td><code class="language-text">let a = 1, b = 2</code>    => <code class="language-text">[a, b] = [b, a]</code></td>
<td><code class="language-text">a = 2, b = 1</code></td>
<td>替换值快捷方式</td>
</tr>
<tr>
<td><code class="language-text">let [a = 1, b] = [11, 22]</code></td>
<td><code class="language-text">a = 11, b = 22</code></td>
<td>默认值</td>
</tr>
<tr>
<td><code class="language-text">let [a = 1, b] = [, 22]</code></td>
<td><code class="language-text">a = 1, b = 22</code></td>
<td>默认值</td>
</tr>
<tr>
<td><code class="language-text">let [a, b = 2] = [ 1 ]</code></td>
<td><code class="language-text">a = 1, b = 2</code></td>
<td>默认值</td>
</tr>
<tr>
<td><code class="language-text">let [a, [b]] = [1, [2]]</code></td>
<td><code class="language-text">a = 1, b = 2</code></td>
<td>嵌套解构</td>
</tr>
<tr>
<td><code class="language-text">let [a, [b]] = [1, [2, 3], 4]</code></td>
<td><code class="language-text">a = 1, b = 2</code></td>
<td>嵌套解构</td>
</tr>
<tr>
<td><code class="language-text">let [a, [b], c] = [1, [2, 3], 4]</code></td>
<td><code class="language-text">a = 1, b = 2, c = 4</code></td>
<td>复杂解构</td>
</tr>
<tr>
<td><code class="language-text">let [a, ...bs] = [1, 2, 3, 4, 5]</code></td>
<td><code class="language-text">a = 1, bs = [2, 3, 4, 5]</code></td>
<td>rest 符号解构</td>
</tr>
<tr>
<td><code class="language-text">[1, 2, 3].concat()</code> => <code class="language-text">[1, 2, 3]</code> => es6: <code class="language-text">[...as] = [1, 2, 3]</code></td>
<td><code class="language-text">as = [1, 2, 3]</code></td>
<td>克隆数组</td>
</tr>
</tbody>
</table>
<h2>混合解构</h2>
<p>混合解构意味着被解构的对象中可能既包含对象由包含数组，也是按照对象和数组的解<br>
构原理进行解构就OK。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  range<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span> start <span class="token punctuation">}</span><span class="token punctuation">,</span>
  range<span class="token operator">:</span> <span class="token punctuation">[</span> startIndex <span class="token punctuation">]</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>start<span class="token punctuation">.</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 0</span></code></pre></div>
<h2>参数解构</h2>
<p>参数解构，即函数在声明的时候，参数是采用解构等式左边的形式书写，这种就需要要<br>
求在调用的时候, 这个参数位置必须有个非 null 和 Undefined 值，否则会报错，原因<br>
一样解构时候无法从 null 或 undefined 读取属性。  </p>
<h3>被解构的参数属性列表</h3>
<p>实例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">{</span> secure<span class="token punctuation">,</span> path<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> expires <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// code to set the cookie</span>
<span class="token punctuation">}</span>

<span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"js"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  secure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  expires<span class="token operator">:</span> <span class="token number">60000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>不传值得非法操作：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// Error!</span>
<span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这样第三个参数就是 <code class="language-text">undefined</code> 报错。  </p>
<p>优化参数解构写法有两种：  </p>
<ol>
<li>函数体内解构</li>
<li>解构体默认值方式(推荐)</li>
</ol>
<h3>函数体内解构：</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 函数体内解构，给个默认值 || {} ，或者在参数那里这样： (name, value, options = {})</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> secure<span class="token punctuation">,</span> path<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> expires <span class="token punctuation">}</span> <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// code to set the cookie</span>
<span class="token punctuation">}</span></code></pre></div>
<p>或者：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span> secure<span class="token punctuation">,</span> path<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> expires <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token comment">// code to set the cookie</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>直接参数解构体给默认值：</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">{</span> secure<span class="token punctuation">,</span> path<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> expires <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>默认值，如果不传第三个参数，那么它的默认值就是 <code class="language-text">{}</code> 避免解构出错。  </p>
<h3>解构的参数默认值</h3>
<p>和普通对象一样，解构出来的参数我们还可以给他们一个默认值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setCookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span>
                   <span class="token punctuation">{</span>
                     secure <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                     path <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
                     domain <span class="token operator">=</span> <span class="token string">"example.com"</span><span class="token punctuation">,</span>
                     expires <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">360000000</span><span class="token punctuation">)</span>
                   <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                  <span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<ol>
<li>第三个参数没传，四个参数都取默认值</li>
<li>第三个参数有传递，根据普通对象定义解构</li>
</ol>
<h2>总结</h2>
<ol>
<li>对象，先声明再解构，表达式必须用 <code class="language-text">()</code> 包起来，作为表达式执行</li>
<li>对象数组解构都可以给默认值，重命名，多层解构，混合解构</li>
<li>解构遵循左侧最内层的变量声明，如果左侧最内层无任何变量，则解构表达式无任何意义</li>
<li>参数解构，要么给当前参数默认值，要么保证调用时该参数都有传入非 <code class="language-text">null</code> 或<br>
<code class="language-text">undefined</code> 的值，推荐参数默认值</li>
</ol>
<h1>符号和符号属性(Symbols)</h1>
<p>符号类型值(<code class="language-text">Symbol()</code>)是 es6 新增的一种原始数据类型和 strings, numbers,<br>
booleans, <code class="language-text">null</code> 和 <code class="language-text">undefined</code> 属于原始值类型。  </p>
<p>它相当于数字的 <code class="language-text">42</code> 或字符串的 “hello” 一样，只是单穿的一些值，因此不能对其使<br>
用 <code class="language-text">new Symbol()</code> 否则会报错。  </p>
<p><img src="http://qiniu.ii6g.com/1561166674.png" alt="img">  </p>
<p>符号类型是作为一种创建私有对象成员的类型，在 es6 之前是没有什么方法可以区分普<br>
通属性和私有属性的。  </p>
<h2>新增属性或方法</h2>
<h3>Symbol.description<sup>2019</sup></h3>
<p>返回符号变量的描述。  </p>
<p>如： <code class="language-text">Symbol(&#39;my symbol&#39;)</code> 的 <code class="language-text">Symbol.description</code> 值为 ‘my symbol’。  </p>
<p>也就是返回内置属性 <code class="language-text">[[Description] ]</code> 的值。  </p>
<h2>创建符号</h2>
<p>符号类型会创建一个包含唯一值得符号变量，这些变量是没有实际字面量表示的，也就<br>
是说一旦符号变量创建之后，只能通过这个变量去访问你所创建的这个符号类型。  </p>
<h3>创建符号</h3>
<p>通过 <code class="language-text">Symbol([ description ])</code> 来创建符号，创建过程：  </p>
<ol>
<li>如果 <em>description</em> 是 <strong>undefined</strong>, 让 <code class="language-text">descString = undefined</code></li>
<li>否则 <code class="language-text">descString = ToString(description)</code></li>
<li>让内部值 <code class="language-text">[[Description]]</code> 为 <em>descString</em></li>
<li>返回一个唯一的 Symbol 值</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> firstName <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> secondName <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

person<span class="token punctuation">[</span>firstName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Nicholas"</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span>firstName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "Nicholas"</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>firstName<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>secondName<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>firstName <span class="token operator">==</span> secondName<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>firstName <span class="token operator">===</span> secondName<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> secondName<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Nicholas
Symbol()
Symbol()
false
false
false</code></pre></div>
<p><code class="language-text">firstName</code> 是存放了一个唯一值得符号类型变量，并且用来作为 <code class="language-text">person</code> 对象的一<br>
个属性使用。  </p>
<p>因此，如果要访问对象中的对应的这个属性的值，每次都必须使用 <code class="language-text">firstName</code> 这个<br>
符号变量去访问。  </p>
<blockquote>
<p>如果需要实在需要符号类型对象，可以通过 <code class="language-text">new Object(Symbol())</code> 去创建一个对象，<br>
而不能直接 <code class="language-text">new Symbol()</code> 因为 <code class="language-text">Symbol()</code> 得到的是一个原始值，就像你不能直接<br>
<code class="language-text">new 42</code> 一个道理。  </p>
<p><img src="http://qiniu.ii6g.com/1561167374.png" alt="img">  </p>
</blockquote>
<h3>带参数的 Symbol(arg)</h3>
<p>有时候可能需要对创建的符号做一些简单的区分，或者让其更加语义化，可以在创建的<br>
时候给 <code class="language-text">Symbol()</code> 函数  </p>
<p>一个参数，参数本身并没有实际的用途，但是有利于代码调试。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> firstName <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"first name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

person<span class="token punctuation">[</span>firstName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Nicholas"</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"first name"</span> <span class="token keyword">in</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span>firstName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// "Nicholas"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// "Symbol(first name)"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>firstName<span class="token punctuation">.</span>description<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>description<span class="token punctuation">)</span> <span class="token comment">// undefined</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
Nicholas
Symbol(first name)
undefined
undefined</code></pre></div>
<p>如输出，参数会一并输出，因此推荐使用的时候加上参数，这样在调试的时候你就能区<br>
分开哪个符号来自哪里，而不至于输出都是 <code class="language-text">Symbol()</code> 无法区分。  </p>
<p>参数作为符号的一种描述性质特征被储存在了内部 <code class="language-text">[[Description]]</code> 属性中，这个属性<br>
会在对符号调用 <code class="language-text">toString()</code> (隐式或显示调用)的时候去读取它的值，除了这个没有<br>
其他方法可以直接去访问 <code class="language-text">[[Description]]</code> 。  </p>
<h3>符号类型检测(typeof)</h3>
<p>由于符号属于原始值，因此可以直接通过 <code class="language-text">typeof</code> 就可以去判断变量是不是符号类型，<br>
es6 对 <code class="language-text">typeof</code> 进行了扩展，如果是符号类型检测的结果值是“symbol”  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> symbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"test symbol"</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> symbol<span class="token punctuation">)</span> <span class="token comment">// "symbol"</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">symbol</code></pre></div>
<h2>使用符号</h2>
<p>之前的例子中使用变量作为对象属性名的，都可以使用符号来替代，并且还可以对符号<br>
类型的属性进行定制，让其变成只读的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 创建符号，唯一</span>
<span class="token keyword">let</span> firstName <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'first name'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 直接当做计算属性使用</span>
  <span class="token punctuation">[</span>firstName<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'张三'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 让属性只读</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> <span class="token punctuation">{</span> writable<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> lastName <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'last name'</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>lastName<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token string">'李四'</span><span class="token punctuation">,</span>
    writable<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span>firstName<span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span>lastName<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">张三
李四</code></pre></div>
<h2>分享符号</h2>
<p>在使用过程中我们需要考虑一个问题：  </p>
<p>假设某个地方声明了一个符号类型及一个使用了这个符号作为属性 key 的对象，哪天  </p>
<p>如果我想在其他地方去使用它，该怎么办？？  </p>
<p>如今模块化得到普及，现在经常都是一个文件一个模块，用的时候导入这个文件得到相应的对象  </p>
<p>但由于符号值是唯一的，那外部模块又怎么知道另一个模块内部用了怎样的符号值作为对象？？  </p>
<p>这就是下面要讲的“符号分享”问题。  </p>
<blockquote>
<p>全局符号注册表(Global Symbol Registry) 会在所有代码执行之前就创建好，且列表为空。  </p>
<p>它和全局对象一样属于环境变量，因此不要去假设它是什么或它不存在之类的，因此它在所有代码执行之前  </p>
<p>就创建好了，所以它是确确实实存在的。  </p>
</blockquote>
<h3>Symbol.for()<a id="org281b793"></a></h3>
<p>在之前我们通过 <code class="language-text">let firstName = Symbol(&#39;first name&#39;);</code> 来创建一个符号变量，但是在使用的时候必须的用  </p>
<p><code class="language-text">firstName</code> 去使用这个变量，而现在我们想将符号分享出去需要用到 <code class="language-text">Symbol.for()</code> 。  </p>
<p><code class="language-text">Symbol.for(description)</code> 会针对 <code class="language-text">description</code> 去创建一个唯一的符号值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

object<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"12345"</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// "12345"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// "Symbol(uid)"</span></code></pre></div>
<p><code class="language-text">Symbol.for(desc)</code> 在第一次调用的时候，首先会去“全局符号注册表(global symbol registry)” 中去查找  </p>
<p>这个 <code class="language-text">desc</code> 对应的符号值，找到了就返回这个符号值，如果没找到会创建一个新的符号值并且将它注册到全局符号注册表中，  </p>
<p>供下次调用时使用。  </p>
<p>-—  </p>
<p><code class="language-text">Symbol.for(key)</code> 内部<a href="https://tc39.es/ecma262/#sec-symbol-objects">实现步骤</a>(伪代码)：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Symbol<span class="token punctuation">.</span><span class="token function-variable function">for</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 1 key 转字符串</span>
  <span class="token keyword">let</span> stringKey <span class="token operator">=</span> <span class="token function">ToString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. 遍历 GlobalSymbolRegistryList 注册表</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> e <span class="token keyword">in</span> GlobalSymbolRegistryList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 符号值已经存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SameValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Key<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stringKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. 注册表中不含 `stringKey` 的符号值，则创建新的符号值</span>
  <span class="token comment">// 3.1 新建符号值</span>
  <span class="token keyword">let</span> newSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>stringKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3.1 给 [[Description]] 赋值</span>
  newSymbol<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Description<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> stringKey<span class="token punctuation">;</span>

  <span class="token comment">// 4. 注册到符号注册表中去</span>
  GlobalSymbolRegistryList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>Key<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> stringKey<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> newSymbol
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 5. 返回新建的符号值</span>
  <span class="token keyword">return</span> newSymbol<span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre></div>
<p>总结起来为3个步骤： 查找 -> 新建 -> 注册  </p>
<p>注册表中的每个符号片段是以对象形式存在(对象中包含 <code class="language-text">Key</code> 和 <code class="language-text">Symbol</code> 两个属性分别表示创建时的描述和符号值)。  </p>
<h3>使用分享符号</h3>
<p>在上一节<a href="#org281b793">7.4.1</a> 中我们描述过了用来创建分享符号的 <code class="language-text">Symbol.for(desc)</code> 接口，这里将探讨如何具体使用它来分享符号值。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"12345"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// "12345"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// "Symbol(uid)"</span>

<span class="token keyword">let</span> uid2 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid <span class="token operator">===</span> uid2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>uid2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// "12345"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid2<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// "Symbol(uid)</span></code></pre></div>
<p>在当前代码运行的全局作用域中都可以分享到一份 <code class="language-text">Symbol.for(&quot;uid&quot;)</code> 符号，只需要调用它就可以拿到那个  </p>
<p>唯一的值。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createObj1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"12345"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> object
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createObj2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"67890"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> object
<span class="token punctuation">}</span>


<span class="token keyword">let</span> uid1 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token function">createObj1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> uid2 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">createObj2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid1 <span class="token operator">===</span> uid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">[</span>uid1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">[</span>uid2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">[</span>uid1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">[</span>uid2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
12345
12345
67890
67890</code></pre></div>
<h3>Symbol.keyFor(symbolValue)</h3>
<p>我们如果想创建或获取全局注册表中的符号是可以通过 <a href="#org281b793">7.4.1</a> 中的 <code class="language-text">Symbol.for(key)</code> ，但是  </p>
<p>如果我们只知道一个符号值变量的情况下，使用 <code class="language-text">Symbol.for(key)</code> 就没法从注册表中取值了。  </p>
<p>因此，这里将介绍如何使用 <code class="language-text">Symbol.keyFor(symbolValue)</code> 去根据符号变量查找注册表中的值。  </p>
<p>在这之前需要知道  </p>
<ol>
<li><code class="language-text">Symbol.for(key)</code> 创建的符号才会进入全局注册表</li>
<li><code class="language-text">Symbol()</code> 直接创建的是不会加入全局注册表的</li>
</ol>
<p>也就有了下面的代码及结果：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// "uid"</span>

<span class="token keyword">let</span> uid2 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>uid2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// "uid"</span>

<span class="token keyword">let</span> uid3 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>uid3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// undefined</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">uid
uid
undefined</code></pre></div>
<p>因此 <code class="language-text">Symbol(&quot;uid&quot;);</code> 结果不会加入注册表，因此结果是 <code class="language-text">undefined</code> 。  </p>
<h2>符号强制转换</h2>
<p>在 JavaScript 中类型强制转换是经常会被用到的一个特性，也让 JavaScript 使用起<br>
来会很灵活地可以将一个数据类型转成另一种数据类型。  </p>
<p>但是符号类型不支持强制转换。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token comment">// Symbol(uid)</span>

<span class="token comment">// 在输出的时候实际上是调用了 uid.toString()</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Symbol(uid)</code></pre></div>
<p>当我们将符号变量加入计算或字符串操作时会报错，因为两个不同类型的值进行操作会<br>
发生隐式转换，但是符号类型不支持强转的，因此会报异常。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    desc <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
    sum <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  desc <span class="token operator">=</span> uid <span class="token operator">+</span> <span class="token string">""</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  sum <span class="token operator">=</span> uid <span class="token operator">/</span> <span class="token number">1</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS: 异常信息  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Cannot convert a Symbol value to a string
Cannot convert a Symbol value to a number</code></pre></div>
<h2>获取对象符号属性</h2>
<p>获取对象属性的方法：  </p>
<ol>
<li><code class="language-text">Object.keys()</code> 会获取所有可枚举的属性</li>
<li><code class="language-text">Object.getOwnPropertyNames()</code> 获取所有属性，忽略可枚举性</li>
</ol>
<p>但是为了兼容 es5 及以前的版本，他们都不会去获取符号属性，因此需要使用<br>
<code class="language-text">Object.getOwnPropertySymbols()</code> 去单独获取对象所有的符号属性，返回一个包含所<br>
有符号属性的数组。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"12345"</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"uid2"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"67890"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> symbols <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>symbols<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>symbols<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// "Symbol(uid)"</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>symbols<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// "12345"</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
Symbol(uid)
12345</code></pre></div>
<h2>符号内部操作(方法)</h2>
<p>在 es6 中 JavaScript 的许多特性中其内部的实现都是使用到了符号内部方法。  </p>
<p>比如下表涉及到的内容<a id="org3f0983b"></a>：  </p>
<table>
<thead>
<tr>
<th>符号方法</th>
<th>类型</th>
<th>JavaScript 特性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">Symbol.hasInstance</code></td>
<td><code class="language-text">boolean</code></td>
<td><code class="language-text">instanceof</code></td>
<td><a href="#org7e71710">7.7.1</a> 实例(原型链)检测</td>
</tr>
<tr>
<td><code class="language-text">Symbol.isConcatSpreadable</code></td>
<td><code class="language-text">boolean</code></td>
<td><code class="language-text">Array.prototype.concat</code></td>
<td><a href="#org67eb564">7.7.2</a> 检测参数合法性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.iterator</code></td>
<td><code class="language-text">function</code></td>
<td>调用后得到迭代器</td>
<td>遍历对象或数组(等可迭代的对象)的时候会用到</td>
</tr>
<tr>
<td><code class="language-text">Symbol.asyncIterator</code></td>
<td><code class="language-text">function</code></td>
<td>调用后得到异步迭代器(返回一个 <code class="language-text">Promise</code> )</td>
<td>遍历对象或数组(等可迭代的对象)的时候会用到</td>
</tr>
<tr>
<td><code class="language-text">Symbol.match</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.match</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.matchAll</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.matchAll</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.replace</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.replace</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.search</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.search</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.split</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.split</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.species</code></td>
<td><code class="language-text">constructor</code></td>
<td>-</td>
<td>派生对象生成</td>
</tr>
<tr>
<td><code class="language-text">Symbol.toPrimitive</code></td>
<td><code class="language-text">function</code></td>
<td>-</td>
<td><a href="#orgae3ed38">7.7.4</a> 返回一个对象的原始值</td>
</tr>
<tr>
<td><code class="language-text">Symbol.toStringTag</code></td>
<td><code class="language-text">string</code></td>
<td><code class="language-text">Object.prototype.toString()</code></td>
<td><a href="#orgc7b5259">7.7.5</a> 返回一个对象的字符串描述</td>
</tr>
<tr>
<td><code class="language-text">Symbol.unscopables</code></td>
<td><code class="language-text">object</code></td>
<td><code class="language-text">with</code></td>
<td><a href="#orgf7af38d">7.7.8</a> 不能出现在 <code class="language-text">with</code> 语句中的一个对象</td>
</tr>
</tbody>
</table>
<blockquote>
<p>通过改变对象的上面的内部符号属性的实现，可以让我们去修改对象的一些  </p>
<p>默认行为，比如 <code class="language-text">instanceof</code> 一个对象的时候可以改变它的行为让它返回一个非预期值。  </p>
</blockquote>
<h3>Symbol.hasInstance<a id="org7e71710"></a></h3>
<p>每个函数都有一个内部 <code class="language-text">Symbol.hasInstance</code> 方法用来判断给定的对象是不是这个函<br>
数的一个实例。  </p>
<p>这个函数定义在 <code class="language-text">Function.prototype</code> 上，因此所有的函数都会继承 <code class="language-text">instanceof</code><br>
属性的默认行为，  </p>
<p>并且这个方法是 <em>nonwritable</em>, <em>nonconfigurable</em>, 和 <em>nonenumerable</em> 的，确保<br>
它不会被错误的重写。  </p>
<p>因此下面的中的两句 <code class="language-text">obj instanceof Array</code> 和<br>
<code class="language-text">Array[Symbol.hasInstance](obj)</code> 是等价的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> v1 <span class="token operator">=</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">;</span>

<span class="token comment">// 等价于</span>

<span class="token keyword">let</span> v2 <span class="token operator">=</span> Array<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>hasInstance<span class="token punctuation">]</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false false</code></pre></div>
<p>在 es6 中实际上已经对 <code class="language-text">instanceof</code> 操作做了重定义，其内部还让它支持了函数调<br>
用方式，即其内部的 <code class="language-text">Symbol.hasInstance</code> 不再限定只是 <code class="language-text">boolean</code> 类型，它还可<br>
以是函数类型，因此我们可以通过重写这个方法来改变 <code class="language-text">instanceof</code> 的默认行为。  </p>
<p>比如：让一个对象的 <code class="language-text">instanceof</code> 操作总是返回 <code class="language-text">false</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">MyObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>MyObj<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>hasInstance<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'override method'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">MyObj</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">override method
false</code></pre></div>
<p>由于 <code class="language-text">Symbol.hasInstance</code> 属性是 <em>nonwritable</em> 的因此需要通过<br>
<code class="language-text">Object.defineProperty</code> 去重新定义这个属性。  </p>
<p>#+BIGIN<sub>QUOTE</sub><br>
虽然 es6 赋予了这种可以重写一些 JavaScript 特性的默认行为的能力，但是依旧不<br>
推荐去这么做，很可能让你的代码变得很不可控，也不容易让人理解你的代码。<br>
#+END<sub>QUOTE</sub>  </p>
<h3>Symbol.isConcatSpreadable<a id="org67eb564"></a></h3>
<p>对应着 <code class="language-text">Array.prototype.concat</code> 的内部使用 <code class="language-text">Symbol.isConcatSpreadable</code> 。  </p>
<p>concat 使用示例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors1 <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"green"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    colors2 <span class="token operator">=</span> colors1<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> <span class="token string">"black"</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors2<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors2<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// ["red","green","blue","black"]</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">4
[ &#39;red&#39;, &#39;green&#39;, &#39;blue&#39;, &#39;black&#39; ]</code></pre></div>
<p>我们一般用 <code class="language-text">concat</code> 去扩展一个数组，把他们合并到一个新的数组中去。  </p>
<p>根据 <code class="language-text">Array.prototype.concat(value1, ...valueNs)</code> 的定义，它是可以接受 <code class="language-text">n</code><br>
多个参数的，比如：  </p>
<p><code class="language-text">[].concat(1, 2, 3, ...)</code> <code class="language-text">&gt; =[1, 2, 3, ...]</code>  </p>
<p>并且并没有限定参数的类型，即这些 <code class="language-text">value1, ...valuesNs</code> 可以是任意类型的值<br>
（数组，对象，纯值等等）。  </p>
<p>另外，如果参数是数组的话，它会将数组项一一展开合并到源数组中区(且只会做一级<br>
展开，数组中的数组不会展开)。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors1 <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"green"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    colors2 <span class="token operator">=</span> colors1<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> <span class="token string">"black"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">"white"</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"brown"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors1 <span class="token operator">===</span> colors2<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors2<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors2<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// ["red","green","blue","black","brown"]</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
7
[ &#39;red&#39;,
  &#39;green&#39;,
  &#39;blue&#39;,
  &#39;black&#39;,
  [ &#39;white&#39; ],
  &#39;brown&#39;,
  { color: &#39;red&#39; } ]</code></pre></div>
<p>但是，如果我们需要的是将 <code class="language-text">{ color: &#39;red&#39; }</code> 中的属性值 <code class="language-text">&#39;red&#39;</code> 合并到数组末<br>
尾，该如何做？？  </p>
<p>->>> <code class="language-text">Symbol.isConcatSpreadable</code> 就是它  </p>
<p>和其他内置符号不一样，这个在所有的对象中默认是不存在的，因此如果我们需要就得<br>
手动去添加，让这个对象  </p>
<p>变成 <em>concatable</em> 只需要将这个属性值置为 <code class="language-text">true</code> 即可:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> collection <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token string">'aaa'</span><span class="token punctuation">,</span>
  <span class="token string">'1'</span><span class="token operator">:</span> <span class="token string">'bbb'</span><span class="token punctuation">,</span>
  length<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>isConcatSpreadable<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> objNoLength <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'yyy'</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>isConcatSpreadable<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>


<span class="token keyword">let</span> objNoNumberAttrs <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token string">'www'</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token string">'vvv'</span><span class="token punctuation">,</span>
  length<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>isConcatSpreadable<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> words <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'somthing'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>words<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>words<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>objNoLength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>words<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>objNoNumberAttrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">somthing,aaa,bbb
somthing
somthing,,</code></pre></div>
<p>分析结果得出，对象要变的可以被 <code class="language-text">Array.prototype.concat</code> 使用，  </p>
<p>需要满足以下条件：  </p>
<ol>
<li>必须有 <code class="language-text">length</code> 属性，否则对结果没任何影响，如结果第二行输出： <em>somthing</em></li>
<li>必须有以数字为 <code class="language-text">key</code> 的属性，否则数组中将使用空值代替追加的值追加到数组中<br>
去，如第三行输出： <em>somthing,,</em></li>
<li>必须增加符号属性 <code class="language-text">Symbol.isConcatSpreadable</code> 且值为 <code class="language-text">true</code></li>
</ol>
<p>同理，我们可以将数组对象的 <code class="language-text">Symbol.isConcatSpreadable</code> 符号属性置为 <code class="language-text">false</code><br>
来阻止数组的 <em>concatable</em> 行为。  </p>
<h3>Symbol.match, Symbol.replace, Symbol.search, Symbol.split<a id="org139fb83"></a></h3>
<p>和字符串，正则表达式有关的一些符号，对应着字符串和正则表达式的方法：  </p>
<ul>
<li><code class="language-text">match(regex)</code> 字符串是否匹配正则</li>
<li><code class="language-text">replace(regex, replacement)</code> 字符串替换</li>
<li><code class="language-text">search(regex)</code> 字符串搜索</li>
<li><code class="language-text">split(regex)</code> 字符串切割</li>
</ul>
<p>这些都需要用到正则表达式 <code class="language-text">regex</code>  </p>
<p>在 es6 之前这些方法与正则表达式的交互过程对于开发者而已都是隐藏了其内部细节<br>
的，也就是说开发者无法通过自己定义的对象去表示一个正则。  </p>
<p>在 es6 中定义了四个符号便是用来实现 <code class="language-text">RegExp</code> 内部实现对象，即可以通过对象的<br>
方式去实现一个正则表达式规则。  </p>
<p>这四个符号属性是在 <code class="language-text">RegExp.prototype</code> 原型上被定义的，作为以上方法的默认实现。  </p>
<blockquote>
<p>意思就是 <code class="language-text">math</code>, <code class="language-text">replace</code>, <code class="language-text">search</code>, <code class="language-text">split</code> 这四个方法的 <code class="language-text">regex</code> 正则  </p>
<p>表达式的内部实现基于对应的四个符号属性函数 <code class="language-text">Symbol.math</code>, <code class="language-text">Symbol.replace</code>,  </p>
<p><code class="language-text">Symbol.search</code>, <code class="language-text">Symbol.split</code> 。  </p>
</blockquote>
<ul>
<li><code class="language-text">Symbol.match</code> 接受一个字符串参数，如果匹配会返回一个匹配的数组，未匹配返回 <code class="language-text">null</code> 。</li>
<li><code class="language-text">Symbol.replace</code> 接受一个字符串参数和一个用来替换的字符串，返回一个新的字符串。</li>
<li><code class="language-text">Symbol.search</code> 接受一个字符串，返回匹配到的数字所以呢，未匹配返回 -1。</li>
<li><code class="language-text">Symbol.split</code> 接受一个字符串，返回以匹配到的字符串位置分割成的一个字符串数组</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 等价于 /^.${10}$/</span>
<span class="token keyword">let</span> hasLengthOf10 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>match<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>replace<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> replacement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span> <span class="token operator">?</span> replacement <span class="token operator">:</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>search<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>split<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> msg1 <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">,</span> <span class="token comment">// 11 chars</span>
    msg2 <span class="token operator">=</span> <span class="token string">"Hello John"</span><span class="token punctuation">;</span> <span class="token comment">// 10 chars</span>


<span class="token keyword">let</span> m1 <span class="token operator">=</span> msg1<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">)</span>
<span class="token keyword">let</span> m2 <span class="token operator">=</span> msg2<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span>

<span class="token keyword">let</span> r1 <span class="token operator">=</span> msg1<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">,</span> <span class="token string">"Howdy!"</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> msg2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">,</span> <span class="token string">"Howdy!"</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span>


<span class="token keyword">let</span> s1 <span class="token operator">=</span> msg1<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">)</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> msg2<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>

<span class="token keyword">let</span> sp1 <span class="token operator">=</span> msg1<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">)</span>
<span class="token keyword">let</span> sp2 <span class="token operator">=</span> msg2<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>hasLengthOf10<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sp1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sp2<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">null
[ &#39;Hello John&#39; ]
Hello World
Howdy!
-1
0
[ &#39;Hello World&#39; ]
[ &#39;&#39;, &#39;&#39; ]</code></pre></div>
<p>通过这几个正则对象的内部符号属性，使得我们有能力根据需要去完成更复杂的正则匹配规则。  </p>
<h3>Symbol.toPrimitive<a id="orgae3ed38"></a></h3>
<p>在 es6 之前，如果我们要使用 <code class="language-text">==</code> 去比较两个对象的时候，其内部都会讲对象转成<br>
原始值之后再去比较，且此时的转换属于内部操作，我们是无法知晓更无法干涉的。  </p>
<p>但在 es6 出现之后，这种内部实现通过 <code class="language-text">Symbol.toPrimitvie</code> 被暴露出来了，从而<br>
使得我们有能力取改变他们的默认行为。  </p>
<p><code class="language-text">Symbol.toPrimitvie</code> 是定义在所有的标准类型对象的原型之上，用来描述在对象被<br>
转换成原始值之前的都做了些什么行为。  </p>
<p>当一个对象发生原始值转换的时候， <code class="language-text">Symbol.toPrimitive</code> 就会带上一个参数<br>
(<code class="language-text">hint</code>)被调用，这个参数值为 “number”, “string”, “default” 中的一个(<em>值是由<br>
JavaScript 引擎所决定的</em>)，分别表示：  </p>
<ol>
<li>“number” ：表示 <code class="language-text">Symbol.toPrimitive</code> 应该返回一个数字。</li>
<li>“string” ：表示 <code class="language-text">Symbol.toPrimitvie</code> 应该返回一个字符串。</li>
<li>“default” ： 表示原样返回。</li>
</ol>
<p>在大部分的标准对象中， <code class="language-text">number</code> 模式的行为按照以下的优先级来返回：  </p>
<ol>
<li>先调用 <code class="language-text">valueOf()</code> 如果结果是一个原始值，返回它。</li>
<li>然后调用 <code class="language-text">toString()</code> 如果结果是一个原始值，返回它。</li>
<li>否则，抛出异常。</li>
</ol>
<p>同样， <code class="language-text">string</code> 模式的行为优先级如下：  </p>
<ol>
<li>先调用 <code class="language-text">toString()</code> 如果结果是一个原始值，返回它。</li>
<li>然后调用 <code class="language-text">valueOf()</code> 如果结果是一个原始值，返回它。</li>
<li>否则，抛出异常。</li>
</ol>
<p>在此，可以通过重写 <code class="language-text">Symbol.toPrimitive</code> 方法，可以改变以上的默认行为。  </p>
<blockquote>
<p>“default” 模式仅在使用 <code class="language-text">==</code>, <code class="language-text">+</code> 操作符，以及调用 <code class="language-text">Date</code> 构造函数的时候  </p>
<p>只传递一个参数的时候才会用到。大部分的操作都是采用的 “number” 或 “string” 模式。  </p>
</blockquote>
<p>实例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Temperature</span><span class="token punctuation">(</span><span class="token parameter">degrees</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>degrees <span class="token operator">=</span> degrees
<span class="token punctuation">}</span>

<span class="token keyword">let</span> freezing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Temperature</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>freezing <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span> <span class="token comment">// [object Object]!</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>freezing <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// NaN</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>freezing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [object Object]</span></code></pre></div>
<p>输出结果：  </p>
<p><img src="http://qiniu.ii6g.com/1561273762.png" alt="img">  </p>
<p>因为默认情况下一个对象字符串化之后会变成 <code class="language-text">[object Object]</code> 这是其内部的默认<br>
行为。  </p>
<p>通过重写原型上的 <code class="language-text">Symbol.toPrimitive</code> 函数可以改写这种默认行为。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Temperature</span><span class="token punctuation">(</span><span class="token parameter">degrees</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>degrees <span class="token operator">=</span> degrees
<span class="token punctuation">}</span>

<span class="token class-name">Temperature</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toPrimitive<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">hint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'string'</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>degrees <span class="token operator">+</span> <span class="token string">'\u00b0'</span>
  <span class="token keyword">case</span> <span class="token string">'number'</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>degrees
  <span class="token keyword">case</span> <span class="token string">'default'</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>degrees <span class="token operator">+</span> <span class="token string">" degrees"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> freezing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Temperature</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>freezing <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>freezing <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>freezing<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">32 degrees!
16
32°</code></pre></div>
<p>结果就像我们之前分析的， 只有 <code class="language-text">==</code> 和 <code class="language-text">+</code> 执行的是 “default” 模式，  </p>
<p>其他情况执行的要么是 “number” 模式(如： <code class="language-text">freezing / 2</code>)  </p>
<p>要么是 “string” 模式(如： <code class="language-text">String(freezing)</code>)  </p>
<h3>Symbol.toStringTag 介绍<a id="orgc7b5259"></a></h3>
<p>在 JavaScript 的一个有趣的问题是，能同时拥有多个全局执行上下文的能力。  </p>
<p>这个发生在 web 浏览器环境下，一个页面可能包含一个 <code class="language-text">iframe</code> ，因此当前页面和<br>
这个 iframe 各自都拥有自己的执行环节。  </p>
<p>通常情况下，这并不是什么问题，因为数据可以通过一些手段让其它当前页和<br>
<code class="language-text">iframe</code> 之间进行传递，问题是如何去识别这个被传递的对象是源自哪个执行环境？？  </p>
<p>比如，一个典型的问题是在 <code class="language-text">page</code> 和 <code class="language-text">iframe</code> 之间互相传递一个数组。在 es6 的<br>
术语中， 页面和iframe 每一个都代表着一个不同的领域(<em>realm</em>, JavaScript 执行<br>
环境)。每个领域都有它自己的全局作用域包含了它自己的一份全局对象的副本。  </p>
<p>无论，数组在哪个领域被创建，它都很明确的是一个数组对象，当它被传递到另一个领<br>
域的时候，使用 <code class="language-text">instanceof Array</code> 的结果都是 <code class="language-text">false</code> ，因为数组是通过构造函<br>
数在别的领域所创建的，而  </p>
<p><code class="language-text">Array</code> 代表的仅仅是当前领域下的构造函数，即两个领域下的 <code class="language-text">Array</code> 不是一回事。  </p>
<p><em>这就造成了在当前领域下去判断另一个领域下的一个数组变量是不是数组，得到的结<br>
果将是 <code class="language-text">false</code> 。</em>  </p>
<h3>Symbol.toStringTag 延伸(不同 <em>realm</em> 下的对象识别) <a id="org1d14060"></a></h3>
<p>对象识别的应对之策(<code class="language-text">Object.prototype.toString.call(obj)</code>)  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isArray</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"[object Array]"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true</code></pre></div>
<p>这种方式虽然比较麻烦，但是却是最靠谱的方法。  </p>
<p>因为每个类型的 <code class="language-text">toString()</code> 可能有自己的实现，返回的值是无法统一的，但是<br>
<code class="language-text">Object.prototype.toString</code> 返回的内容始终是 <code class="language-text">[object Array]</code> 这种，后面是被<br>
检测数据代表的类型的构造函数，它总是能得到正确且精确的  </p>
<p>结果。  </p>
<p><code class="language-text">Object.prototype.toString</code> 内部实现的伪代码：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// toString(object)</span>

<span class="token keyword">function</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 判断 undefined 和 null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'[object Undefined]'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'[object Null]'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> <span class="token constant">O</span> <span class="token operator">=</span> <span class="token function">ToObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上下文变量对象化</span>
  <span class="token keyword">let</span> isArray <span class="token operator">=</span> <span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 先判断是不是数组类型</span>
  <span class="token keyword">let</span> builtinTag <span class="token operator">=</span> <span class="token string">''</span>

  <span class="token keyword">let</span> <span class="token function-variable function">has</span> <span class="token operator">=</span> <span class="token parameter">builtinName</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token operator">!</span><span class="token constant">O</span><span class="token punctuation">.</span>builtinName<span class="token punctuation">;</span>

  <span class="token comment">// 2. 根据内置属性，检测各对象的类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isArray <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 数组类型</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Array'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>ParameterMap<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 参数列表，函数参数对象</span>
    <span class="token comment">// 函数的参数 arguments 对象</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Arguments'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Call<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Function'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>ErrorData<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Error对象</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Error'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>BooleanData<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Boolean 布尔对象</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Boolean'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>StringData<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// String 对象</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'String'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>DateValue<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Date 对象</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Date'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>RegExpMatcher<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// RegExp 正则对象</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'RegExp'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    builtinTag <span class="token operator">=</span> <span class="token string">'Object'</span> <span class="token comment">// 其他</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. 最后检测 @@toStringTag - Symbol.toStringTag 的值</span>
  <span class="token keyword">let</span> tag <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">,</span> @@toStringTag<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Type</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tag <span class="token operator">=</span> builtinTag<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[object </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>从伪代码中我们知道，最后的实现中使用到了 <code class="language-text">@@toStringTag</code> 即对应这里的<br>
<code class="language-text">Symbol.toStringTag</code> 属性值,  </p>
<p>并且这个放在最后判断，优先级最高，即如果我们重写了 <code class="language-text">Symbol.toStringTag</code> 那么<br>
重写之后的返回值将最优先返回。  </p>
<h3>Symbol.toStringTag 的 ES6 实现</h3>
<p>正如 <a href="#org1d14060">7.7.6</a> 中的伪代码所示，在 es6 中对于<br>
<code class="language-text">Object.prototype.toString.call(obj)</code> 的实现中加入了 <code class="language-text">@@toStringTag</code> 内部属<br>
性的检测，即对应着这里的 <code class="language-text">Symbol.toStringTag</code> ，那么我们便  </p>
<p>可以通过改变这个值来修改它的默认行为，从而得到我们想要的类型值。  </p>
<p>比如：我们有一个 <code class="language-text">Person</code> 构造函数，我们希望在使用 <code class="language-text">toString()</code> 的时候得到结<br>
果是 <code class="language-text">[object Person]</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
<span class="token punctuation">}</span>

<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Person'</span>

<span class="token keyword">let</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>

<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'[object Test]'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [object Person]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>me<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [object Person]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>toString <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS: 未重写 Person.prototype.toString 结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[object Person]
[object Person]
true</code></pre></div>
<p>+RESULTS: 重写 Person.prototype.toString 的结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[object Test]
[object Person]
false</code></pre></div>
<p>我们发现就算重写了 <code class="language-text">Person.prototype.toString</code> 也不会影响<br>
<code class="language-text">Symbol.toStringTag</code> 赋值后的运行结果，如后面调用<br>
<code class="language-text">Object.prototype.toString.call(me)</code> 结果依旧是 <code class="language-text">[object Person]</code> 。  </p>
<p>因为我们重写了 <code class="language-text">Symbol.toStringTag</code> 属性值，因此<a href="#org1d14060">7.7.6</a>实现部分：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 3. 最后检测 @@toStringTag - Symbol.toStringTag 的值</span>
<span class="token keyword">let</span> tag <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">,</span> @@toStringTag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里的结果就成了 'Person'</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Type</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  tag <span class="token operator">=</span> builtinTag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[object </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span></code></pre></div>
<p>因此得到 <code class="language-text">[object Person]</code> 返回结果。  </p>
<p>我们还可以通过重写 <code class="language-text">Person</code> 自身的 <code class="language-text">toString()</code> 的实现让其拥有自己的默认行为，<br>
上面的第三行  </p>
<p>结果表明 <code class="language-text">me.toString()</code> 最终调用的是 <code class="language-text">Object.prototype.toString</code> 。  </p>
<h3>Symbol.unscopables<a id="orgf7af38d"></a></h3>
<p><code class="language-text">with</code> 语句在 JavaScript 世界中是最具争议的一项特性之一。  </p>
<p>原本设计的初衷是避免重复书写一样的代码，但是在实际使用过程中，却是让代码更难<br>
理解，很容易出错，也有性能上的影响。  </p>
<p>虽然，极力不推荐使用它，但是在 es6 中为了考虑向后兼容性问题，在非严格模式下<br>
依旧对它做了支持。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    color <span class="token operator">=</span> <span class="token string">"black"</span><span class="token punctuation">;</span>

<span class="token keyword">with</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">push</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">red,green,black,1,2,3</code></pre></div>
<p>上面代码，在 <code class="language-text">with</code> 里面调用的两次 <code class="language-text">push</code> 等价于 <code class="language-text">colors.push</code> 调用，  </p>
<p>因为 <code class="language-text">with</code> 将本地执行上下文绑定到了 <code class="language-text">colors</code> 上。  </p>
<p><code class="language-text">values, color</code> 指向的均是在 <code class="language-text">with</code> 语句外面创建的 <code class="language-text">values</code> 和 <code class="language-text">color</code> 。  </p>
<p>但是在 ES6 中给数组增加了一个 <code class="language-text">values</code> 方法，这个方法会返回当前数组的迭代器<br>
对象： <code class="language-text">Array Iterator {}</code>  </p>
<p>这就意味着在 ES6 的环境中， <code class="language-text">values</code> 指向的将是数组本身的 <code class="language-text">values()</code> 方法而<br>
不是外面声明的 <code class="language-text">values = [1, 2, 3]</code> 这个数组，将破坏整个代码的运行。  </p>
<p>这就是 <code class="language-text">Symbol.unscopables</code> 存在的原因。  </p>
<p><code class="language-text">Symbol.unscopables</code> 被用在 <code class="language-text">Array.prototype</code> 上用来指定那些属性不能在<br>
<code class="language-text">with</code> 中创建绑定：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// built into ECMAScript 6 by default</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>unscopables<span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  copyWithin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  entries<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  fill<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  find<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  findIndex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  keys<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  values<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>上面是默认情况下 ES6 内置的设定，即数组中的上列属性不允许在 <code class="language-text">with</code> 中创建绑<br>
定，从列表能发现这些被置为 <code class="language-text">true</code> 的属性都是 <code class="language-text">es6</code> 中新赠的方法，这主要是为<br>
了兼容以前的代码只针对新增的属性这么使用。  </p>
<p>#+BIGIN<sub>QUOTE</sub><br>
一般情况下，不需要重新定义 <code class="language-text">Symbol.unscopables</code> ，除非代码中存在 <code class="language-text">with</code> 语句并且  </p>
<p>需要做一些特殊处理的时候，但是建议尽量避免使用 <code class="language-text">with</code> 。<br>
#+END<sub>QUOTE</sub>  </p>
<h2>总结</h2>
<ol>
<li>Symbols 是一种新的原始值类型，用来创建一些属性，这些属性只能使用对应的符号<br>
或符号变量去访问。</li>
<li><code class="language-text">Symbol([description])</code> 用来创建一个符号，推荐传入描述，便于识别。</li>
<li><code class="language-text">Symbol.for(key)</code> 首先查找注册表(GSR)，如果 <code class="language-text">key</code> 对应的符号存在直接返回，<br>
如果不存在则创建新符号并加入到注册表，然后返回新创建的符号。</li>
<li><code class="language-text">Symbol.keyFor(symbolValue)</code> 通过符号变量从注册表中找到对应的符号值，没有<br>
返回 <code class="language-text">undefined</code> 。</li>
<li>符号共享通过 <code class="language-text">Symbol.for(key)</code> 和 <code class="language-text">Symbol.keyFor(symbolValue)</code> 可以让符号<br>
达到共享的目的，因为全局注册表在所有代码运行之前就已经创建好了。</li>
<li>符号不允许类型转换(或隐式转换)。</li>
<li><code class="language-text">Object.keys()</code> 和 <code class="language-text">Object.getOwnPropertyNames()</code> 不能获取到符号属性。</li>
<li><code class="language-text">Object.getOwnPropertySymbols(obj)</code> 能获取到对象的所有符号属性。</li>
<li><code class="language-text">Object.defineProperty()</code> 和 <code class="language-text">Object.defineProperties()</code> 对符号属性也有效。</li>
<li>知名符号<a href="#org3f0983b">7.7</a>，以往的内部实现是不对开发者开放的，如今有了这些知名<br>
符号属性，可以让开发者自信改变一些功能和接口的默认行为。</li>
</ol>
<h1>Sets 和 Maps</h1>
<ul>
<li><em>set</em> 集合是一组没有重复元素的一个序列。</li>
<li><em>map</em> key 值得集合，指向对应的值</li>
</ul>
<h2>ECMAScript 5 中的 Sets 和 Maps</h2>
<p>在 es6 之前会有各种 sets/maps 的实现方式，但是大都或多或少有所缺陷。  </p>
<h3>背景</h3>
<p>比如： 使用对象属性实现  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> st <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// sth</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在将对象作为 set 或 map 使用的时候唯一的区别在于：  </p>
<p><em>map</em> 里面的 key 有存储对应的具体内容，而不像 <em>set</em> 仅仅用来存储 true or false,  </p>
<p>用来标识 key 是否存在。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

map<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'bar'</span>

<span class="token keyword">let</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span>foo

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 'bar'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">bar</code></pre></div>
<h3>潜在问题</h3>
<p>使用对象实现 set/map 的问题：  </p>
<ol>
<li>无法避免字符串 key 的唯一性问题</li>
<li>无法避免对象作为 key 的唯一性问题</li>
</ol>
<p><strong>字符串作为 key</strong> :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

map<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'foo'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token string">"5"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'foo'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">foo</code></pre></div>
<p>因为对于对象来说，使用数字下表去访问的时候，实际上是将下标数值转成字符串去访问了，  </p>
<p>即相当于 <code class="language-text">map[5]</code> 等价于 <code class="language-text">map[&#39;5&#39;]</code> 因此，有上面的结果输出。  </p>
<p><em>但是，你偏偏想使用 5 和 ‘5’ 去标识两个 key 的时候就无法达到目的了。</em>  </p>
<p><strong>对象作为 key</strong> :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    key2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

map<span class="token punctuation">[</span>key1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'foo'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'foo'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">foo</code></pre></div>
<p>对象作为 <code class="language-text">key</code> 值得时候，内部会发生类型转换，将对象转成 <code class="language-text">&quot;[object Object]&quot;</code>  </p>
<p>因此无论用 key1 还是 key2 去访问 map ，最后的结果都是 <code class="language-text">map[&quot;[object
    Object]&quot;]</code> 去访问了  </p>
<p>因此，结果都是 ‘foo’。  </p>
<h2>Sets 集合</h2>
<ol>
<li>创建使用 <code class="language-text">new Set()</code> 创建实例。</li>
<li>添加使用 <code class="language-text">set.add()</code> 方法。</li>
<li>集合区分数值的数字类型和字符串类型，不会发生类型强转。</li>
<li><code class="language-text">-0</code> 和 <code class="language-text">+0</code> 在集合中会被当做一样处理</li>
<li>对象可以作为 set 的元素，且两个 <code class="language-text">{}</code> 会被当做两个不同的元素处理</li>
</ol>
<h3>set 初始化</h3>
<p><code class="language-text">new Set()</code> 创建了一个空的 <code class="language-text">set</code>  </p>
<p>可以在初始化的时候传入一个数组。  </p>
<blockquote>
<p>实际上， <code class="language-text">Set</code> 构造函数可以接受任意一个 <code class="language-text">iterable</code> 对象作为参数。  </p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 4</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">4</code></pre></div>
<h3>添加元素 <code class="language-text">set.add()</code></h3>
<p>添加的元素区分类型，不会做类型转换，即 <code class="language-text">5</code> 和 <code class="language-text">&#39;5&#39;</code> 是不一样的，重复添加也只<br>
会执行一次，=set= 的元素是不会重复的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token keyword">set</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2 Set { 5, &#39;5&#39; }</code></pre></div>
<p>对象元素：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    key2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key2<span class="token punctuation">)</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 2</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2</code></pre></div>
<h3>set apis</h3>
<ol>
<li><code class="language-text">set.has(v)</code> 判断 set 中是否有元素 <code class="language-text">v</code> ，返回 <code class="language-text">true/false</code></li>
<li><code class="language-text">set.add(v)</code> 添加元素</li>
<li><code class="language-text">set.size</code> 集合大小</li>
<li><code class="language-text">set.delete(v)</code> 删除元素</li>
<li><code class="language-text">set.clear()</code> 清空集合</li>
</ol>
<h3>集合迭代(forEach)</h3>
<p>对集合使用 <code class="language-text">forEach</code> 和对数组使用的方法一样，它接受一个函数，抓个函数又三个<br>
参数：  </p>
<ol>
<li>第一个参数：集合的当前值</li>
<li>第二个参数：和第一个参数一样是当前元素的值，跟数组不一样，数组使用<br>
<code class="language-text">forEach</code> 这个参数是当前索引值</li>
<li>第三个参数：被遍历的集合本身。</li>
</ol>
<p><strong>Sets 没有 Key 值。</strong>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// undefined, 没有下标值</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">idx<span class="token punctuation">,</span> v<span class="token punctuation">,</span> ownerSet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> v<span class="token punctuation">,</span> ownerSet <span class="token operator">===</span> <span class="token keyword">set</span><span class="token punctuation">,</span> ownerSet<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">undefined
a a true Set { &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39; }
b b true Set { &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39; }
c c true Set { &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39; }
d d true Set { &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39; }
e e true Set { &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39; }</code></pre></div>
<p>结果所示：  </p>
<ol>
<li>集合的 key 就是 value。</li>
<li>遍历的函数第三个参数 <code class="language-text">ownerSet</code> 就是被遍历的 <code class="language-text">set</code> 集合本身。</li>
</ol>
<p>在使用 <code class="language-text">forEach</code> 可以给它传递一个上下文参数，让绑定回调函数里面的 <code class="language-text">this</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> processor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">output</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'output from processor: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">dataSet<span class="token punctuation">,</span> scope <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function">output</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'output from obj: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    dataSet<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> scope <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> obj<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// scope: processor</span>
processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// scope: obj</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">output from processor: 1
output from processor: 2
output from obj: 1
output from obj: 2</code></pre></div>
<ol>
<li>将 <code class="language-text">this</code> 传递给回调，从而 <code class="language-text">output</code> 来自 <code class="language-text">processor</code> 。</li>
<li>将 <code class="language-text">obj</code> 传递给回调，从而 <code class="language-text">output</code> 来自 <code class="language-text">obj</code> 。</li>
</ol>
<p>结论：*我们可以通过给 forEach 传递第二个参数来改变回调函数的执行上下文。*  </p>
<p>使用箭头函数解决 <code class="language-text">this</code> 指向问题：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> processor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">output</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'output from processor: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">dataSet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this 总是绑定到 processor</span>
    dataSet<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// scope: processor</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">output from processor: 1
output from processor: 2</code></pre></div>
<p>无论第二个参数 <code class="language-text">{}</code> 传或不传结果都一样，箭头函数里的 <code class="language-text">this</code> 指向不会发生改变。  </p>
<blockquote>
<p>集合不能直接使用索引访问元素，如果需要使用到索引访问元素，那最好将集合转成数组来使用。  </p>
</blockquote>
<h3>Set 和 Array 之间的转换</h3>
<ol>
<li>集合转数组 <code class="language-text">let set = new Set([1, 2, 3, 2]);</code> ，且会将重复的元素去掉只余<br>
一个。</li>
<li>数组转集合，最简单的就是展开符了 <code class="language-text">let arr = [...set];</code></li>
</ol>
<p><em>展开符(…)可以作用域任何 iterable 的对象。即任何可 iterable 的对象都可以通<br>
过 <code class="language-text">...</code> 转成数组。</em>  </p>
<p>也因为有了 <code class="language-text">Set</code> 和 <code class="language-text">...</code> 从而是数组的去重变得异常简单:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">eleminateDuplicates</span> <span class="token operator">=</span> <span class="token parameter">items</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">eleminateDuplicates</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1,2,3,4</code></pre></div>
<h3>弱集(Weak Sets)</h3>
<p>因为它存储对象引用的方式，集合类型也可以叫做强集合类型。  </p>
<p>即集合中对于对象的存储是存储了该对象的引用而不是被添加到集合是的那个变量名而<br>
已，类似对象的属性的值为对象一样，就算改变了这个属性的值，那个对象如果有其他<br>
变量指向它，那他一样存在（类似 C 的指针概念，两个指针同时指向一块内存，一个<br>
指针的指向发生变化并不会影响另一个指针指向这块内存）。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> animal <span class="token operator">=</span> <span class="token punctuation">{</span>
  dog<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">10</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> dog1 <span class="token operator">=</span> animal<span class="token punctuation">.</span>dog

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dog1<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'xxx'</span>
<span class="token comment">// 引用发生变化</span>
animal<span class="token punctuation">.</span>dog <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token comment">// 并不影响别的变量指向 { name: 'xxx', age: 10 } 这个对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dog1<span class="token punctuation">.</span>age<span class="token punctuation">)</span> <span class="token comment">// 10</span>

<span class="token comment">// 指回去，依旧是它原来指向的那个对象</span>
animal<span class="token punctuation">.</span>dog <span class="token operator">=</span> dog1
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span>dog<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'xxx'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span>dog<span class="token punctuation">.</span>age<span class="token punctuation">)</span> <span class="token comment">// 10</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xxx
10
xxx
10</code></pre></div>
<p>根据引用的特性，对于集合元素也一样实用：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// 实际将对象的引用加到集合中</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 1</span>

key <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 改变了变量值而已，实际引用的那个对象还在</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 1</span>

key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">set</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token comment">// {}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Set { {} }
1
1
{}
undefined</code></pre></div>
<p>这种强引用在某些情况下很可能会出现内存泄漏，比如，在浏览器环境中  </p>
<p>集合中保存了一些 DOM 元素的引用，而这些元素本身可能会被其他地方的  </p>
<p>代码从 DOM 树中移除，同时你也不想再保有这些 DOM 元素的引用了，或者说以后  </p>
<p>都不会用到它了，应该被释放回收才对，但是实际上集合中仍然保有这些元素的引用<br>
(实际已经不存在的东西)，这种情况就叫做内存泄漏(<em>memory leak</em>)。  </p>
<p>为了解决这种情况， ECMAScript 6 中增加了一种集合类型： <em>weak sets</em> ,弱引用只<br>
会保存对象的弱引用 。  </p>
<h3>创建 Weak Sets(<code class="language-text">WeakSet</code>)</h3>
<p>弱引用集合构造函数： <code class="language-text">WeakSet</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key1 <span class="token operator">=</span> key

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">WeakSet { [items unknown] }
false
true
false
WeakSet { [items unknown] }
undefined</code></pre></div>
<p>浏览器环境输出结果：  </p>
<p><img src="http://qiniu.ii6g.com/1561596922.png" alt="img">  </p>
<h2>Set 和 WeakSet 对比<a id="org08033ce"></a></h2>
<p>Set 中添加对象，添加的是对该对象的引用，因此保存该对象的变量值发生变化，并不<br>
影响该对象在集合中的事实。  </p>
<p>WeakSet 中添加的是该变量的原始值？？变量值一旦改变，集合中的内容将随之改变(由<br>
JavaScript 引擎处理)。  </p>
<blockquote>
<p>TODO: Set 保存引用？WeekSet 保存原始值？？有啥区别？？  </p>
</blockquote>
<p>这里我们将对比两种集合在不同形式下的运行结果，通过对比分析来搞清楚集合中引用<br>
和原始值的概念。  </p>
<h3>Set, WeakSet 添加对象的结果</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">let</span> wset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> wkey <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

wset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wkey<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>wkey<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Set { { a: 1 } }
true
WeakSet { [items unknown] }
true
undefined</code></pre></div>
<p>这里 WeakSet 结果不直观，下面是浏览器结果：  </p>
<p><img src="http://qiniu.ii6g.com/1561597399.png" alt="img">  </p>
<p>从浏览器端的结果分析：  </p>
<ol>
<li>两者在内部属性 <code class="language-text">Entries</code> 中都有一个我们添加的 <code class="language-text">{a : 1}</code> 对象元素。</li>
<li>WeakSet 没有 size 属性， Set 有 size 属性。</li>
</ol>
<h3>改变对象 key/wkey 的值</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// 改变之前</span>
key <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// 改变之后</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">let</span> wset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> wkey <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

wset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wkey<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">)</span> <span class="token comment">// weak key 改变之前</span>
wkey <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">)</span> <span class="token comment">// weak key 改变之后</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>wkey<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: emacs nodejs  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Set { { a: 1 } }
Set { { a: 1 } }
false
WeakSet { [items unknown] }
WeakSet { [items unknown] }
false
undefined</code></pre></div>
<p>浏览器环境输出结果：  </p>
<p><img src="http://qiniu.ii6g.com/1561597936.png" alt="img">  </p>
<p>结果：  </p>
<ol>
<li>
<p>对于 Set 对象变量 key 值得改变并不会影响 Set 中 <code class="language-text">{a:1}</code> 对象  </p>
<p>Set 存放的是对象 <code class="language-text">{a:1}</code> 的引用，即在 <code class="language-text">set.add(key)</code> 之后，实际上是有两个引用指向了<br>
<code class="language-text">{a:1}</code> 对象，一个是 key 这个变量，一个是集合 set 中的某个位置上的变量(假设为: <em>fkey</em>)。<br>
根据引用的特性， key 的释放并不会影响 <code class="language-text">{a:1}</code> 这个对象本身在内存中的存在，即不会影响 fkey<br>
对这个对象的影响，从而并不影响 set 的内容。</p>
</li>
<li>
<p>WeakSet 中的 <code class="language-text">{a:1}</code> 没有了  </p>
<p>WeakSet 我们说它添加的是 wkey 的原始值，即使直接和 wkey 这个变量的原始值挂钩的，<br>
执行 <code class="language-text">wkey = null</code> 就是讲它的原始值发生改变，最终将影响 WeakSet 。</p>
</li>
</ol>
<p>针对 #2 中的 WeakSet 情况，将程序改造一下:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> key1 <span class="token operator">=</span> key

<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// 改变之前</span>
key <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token comment">// 改变之后</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------- 楚河汉界 ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> wset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> wkey <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> wkey1 <span class="token operator">=</span> wkey

wset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wkey<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">)</span> <span class="token comment">// weak key 改变之前</span>
wkey <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">)</span> <span class="token comment">// weak key 改变之后</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>wkey<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wset<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>wkey1<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Set { { a: 1 } }
Set { { a: 1 } }
false
-------- 楚河汉界 ---------
WeakSet { [items unknown] }
WeakSet { [items unknown] }
false
true
undefined</code></pre></div>
<p>再来看看输出结果：  </p>
<p><img src="http://qiniu.ii6g.com/1561598712.png" alt="img">  </p>
<p>我们得到了令人意外的结果：  </p>
<ol>
<li>并没有显示的 <code class="language-text">wset.add(wkey1)</code> 但是最后的 <code class="language-text">wset.has(wkey1)</code> 的结果却是 <code class="language-text">true</code> 。</li>
<li>wset 集合中的 <code class="language-text">{a:1}</code> 依然存在。</li>
</ol>
<p>要理解这个问题，则需要知道“强引用”和“弱引用”的区别：  </p>
<h3>强引用和弱引用</h3>
<p>我们都知道 JavaScript 的垃圾回收机制中有一个相关知识点就叫做引用计数，即一个<br>
对象如果有被其他变量  </p>
<p>引用那么这个对象的引用计数就 <code class="language-text">+1</code> 如果这个变量被释放该对象的引用计数就 <code class="language-text">-1</code><br>
一旦引用计数为 <code class="language-text">0</code> 垃圾回收机制就会将这个对象回收掉，因为没有人再使用它了。  </p>
<p><strong>强引用(<code class="language-text">Set</code>)</strong> ：相当于让该对象的引用计数 <code class="language-text">+1</code> ，如 <code class="language-text">Set</code> 集合保存了对象的引用导<br>
致引用计数 <code class="language-text">+1</code> ，在拥有该对象的变量 <code class="language-text">key</code> 的值怎么变化都不会导致引用计数为<br>
<code class="language-text">0</code> 从而阻止了垃圾回收器将其回收掉。  </p>
<p><strong>弱引用(<code class="language-text">WeakSet</code>)</strong>: 对对象的引用不会计入到引用计数中，即将 wkey 加入到<br>
WeakSet 中，并不会引起 wkey 指向的那个对象的引用计数 <code class="language-text">+1</code> ，因此只要释放了<br>
wkey 对其的引用，对象的引用计数就变成 0 了，因此此时只有 wkey 指向 <code class="language-text">{a:1}</code><br>
这个对象，改变 wkey 就会改变 WeakSet 中的内容，因为这个内容已经被回收掉了。  </p>
<p>/根据上面的结论，我们就知道为什么我们增加了一行 <code class="language-text">let key1 = key</code> 之后，<br>
<code class="language-text">{a:1}</code> 对象依然会在 <code class="language-text">wset</code> 中因为此时 <code class="language-text">{a:1}</code> 引用计数不为 <code class="language-text">0</code> 并没有被释放<br>
掉。/  </p>
<h2>Maps</h2>
<p>es6 的 <code class="language-text">Map</code> 类型是一个有序的键值对列表， key 和 value 可以是任意类型，并且 key<br>
不会发生类型强转，也就是说 <code class="language-text">5</code> 和 <code class="language-text">&quot;5&quot;</code> 属于不同的两个键，和对象不一样(对象把他<br>
们当做一个键，因为对象的 key 最终表示形式为 <code class="language-text">string</code> 内部有发生强制转换)。  </p>
<h3>Map 初始化</h3>
<p>一个 map 实例必须通过构造函数来创建 <code class="language-text">new Map()</code> ，同时可以给构造函数传递一个<br>
iterable 的对象，在创建的时候初始化，这个 iterable 对象会被转成 map。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 25</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 2</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">// 一维数组，不符合 entry object</span>
  <span class="token keyword">let</span> map1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">// 对象非 iterable</span>
  <span class="token keyword">let</span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> length<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map3<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map4<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map5<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Map { &#39;name&#39; =&gt; &#39;张三&#39;, &#39;age&#39; =&gt; 25 }
true
张三
true
25
2
Iterator value 1 is not an entry object
#&lt;Object&gt; is not iterable
Map { &#39;name&#39; =&gt; &#39;张三&#39;, &#39;age&#39; =&gt; 25 }
Iterator value name is not an entry object
Map { &#39;name&#39; =&gt; &#39;张三&#39;, &#39;age&#39; =&gt; 25 }
undefined</code></pre></div>
<p>因此能被转成 <code class="language-text">map</code> 的对象需要满足：  </p>
<ol>
<li>必须是 iterable</li>
<li>必须有键值对类型的列表对象，比如二维数组。</li>
</ol>
<p>Map 的 key 和 value 可以是任意对象。  </p>
<p><a id="orgde6b501"></a>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'EmptyObject'</span><span class="token punctuation">)</span>

<span class="token comment">// 虽然都是 {} 但是对象是引用类型，是不能等同的</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>

map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> emptyObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">,</span> <span class="token string">'EmptyObject'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 'EmptyObject'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 1</span>

emptyObj <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 'undefined'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 1, 因为 Map 是强引用，emptyObj = null 并不会改变</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">undefined
Map { {} =&gt; &#39;EmptyObject&#39; }
EmptyObject
1
Map { {} =&gt; &#39;EmptyObject&#39; }
undefined
1
undefined</code></pre></div>
<h3><code class="language-text">map.set(key, value)</code> 和 <code class="language-text">map.get(key)</code></h3>
<p><code class="language-text">Map</code> 实例可以通过 <code class="language-text">set</code> 和 <code class="language-text">get</code> 方法去设置键值对然后获取该值。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'u es6'</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'year'</span><span class="token punctuation">,</span> <span class="token number">2019</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'year'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Map { &#39;title&#39; =&gt; &#39;u es6&#39;, &#39;year&#39; =&gt; 2019 }
u es6
2019
undefined
undefined</code></pre></div>
<p>map 数据的内部存储格式(<code class="language-text">{ &#39;key&#39; =&gt; value }</code>)：  </p>
<p><img src="http://qiniu.ii6g.com/1561607782.png" alt="img">  </p>
<h3>方法</h3>
<ul>
<li><code class="language-text">map.has(key)</code> 检测 map 中是否存在 key</li>
<li><code class="language-text">map.delete(key)</code> 删除 key 对应的值</li>
<li><code class="language-text">map.clear()</code> 清空所有键值对</li>
<li><code class="language-text">map.size</code> map 的大小，键值对的个数</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------- init ---------'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 22</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------- delete ---------'</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 1</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------- clear ---------'</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// 0</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-------- init ---------
Map { &#39;name&#39; =&gt; &#39;张三&#39;, &#39;age&#39; =&gt; 22 }
2
true
张三
true
22
-------- delete ---------
Map { &#39;age&#39; =&gt; 22 }
false
undefined
1
-------- clear ---------
Map {}
false
undefined
false
undefined
0
undefined</code></pre></div>
<h3>forEach</h3>
<p><code class="language-text">forEach</code> 在 map 上的使用方式跟集合和数组类似，回调接受三个参数分别代表：  </p>
<ol>
<li>value: 代表当前循环 map 中元素键值中的值</li>
<li>key: 代表 map 元素键值中的键</li>
<li>map: 当前的 map 自身</li>
</ol>
<p>因此， map 的 <code class="language-text">forEach</code> 看起来与数组更像，有 <code class="language-text">value</code>, <code class="language-text">key</code>, <code class="language-text">map</code> ，并且 value<br>
代表值，key 表示键（数组中的索引），map 代表自身。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ownerMap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ownerMap <span class="token operator">===</span> map<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">name: 张三
true
age: 22
true
undefined</code></pre></div>
<p>和 Set 一样，也可以将 <code class="language-text">this</code> 作为第二个参数传入，绑定回调函数的上下文，或者直接<br>
使用箭头函数，就可以省略这个参数了。  </p>
<h3>WeakMap</h3>
<p><code class="language-text">WeakMap</code> 类似 <code class="language-text">WeakSet</code> 一样，是一种弱引用类型。  </p>
<p>有了<a href="#org08033ce">8.3</a>的说明，理解将让我们很容易理解 <code class="language-text">WeakMap</code> 。  </p>
<div class="org-center">
**WeakMap 弱引用，即它里面的引用类型，不计入引用计数统计，不会阻止垃圾回收器回收。**  
</div>
<p>看下 <a href="#orgde6b501">8.4.1</a> 的示例，将 <code class="language-text">Map</code> 改成 <code class="language-text">WeakMap</code> 看下结果：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> emptyObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">,</span> <span class="token string">'EmptyObject'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 'EmptyObject'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

emptyObj <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 'undefined'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>emptyObj<span class="token punctuation">)</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'NormalObject'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">map.clear is not a function
EmptyObject
undefined
undefined
undefined
NormalObject
undefined</code></pre></div>
<ol>
<li>WeakMap 中没有 <code class="language-text">map.clear()</code></li>
<li>WeakMap 没有 <code class="language-text">size</code> 属性，和 WeakSet 一样</li>
<li>弱引用， <code class="language-text">emptyObj = null</code> 会使 map 中的 emptyObj 被删除</li>
</ol>
<h1>迭代器和生成器(Iterators &#x26; Generators)<a id="orge26ee44"></a></h1>
<h2>什么是迭代器(Iterators)？</h2>
<p>迭代器：拥有特殊接口(用来遍历该对象)的一些对象。  </p>
<p>所有迭代器对象都有一个 <code class="language-text">next()</code> 方法返回一个结果对象。  </p>
<p>该结果对象包含两个属性：  </p>
<ol>
<li><code class="language-text">value</code> 迭代过程中下一个值</li>
<li><code class="language-text">done</code> , <em>boolean</em> 是否是最后一个</li>
</ol>
<p>迭代器拥有一个内部指针指向总是指向下一个值。  </p>
<p>创建一个迭代器：  </p>
<ol>
<li>返回对象中必须有 <code class="language-text">next()</code> 方法</li>
<li>必须有终结条件属性 <code class="language-text">done</code></li>
</ol>
<p><a id="org2892a08"></a>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token punctuation">(</span> i <span class="token operator">>=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token operator">!</span>done <span class="token operator">?</span> items<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        done<span class="token punctuation">,</span> value
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ done: false, value: 1 }
{ done: false, value: 2 }
{ done: false, value: 3 }
{ done: true, value: undefined }
{ done: true, value: undefined }
{ done: true, value: undefined }</code></pre></div>
<h2>什么是生成器(Generators)？</h2>
<p>生成器：一个返回迭代器的函数。  </p>
<p>生成器声明方式： <code class="language-text">function *createIterator() {}</code> ，使用 <code class="language-text">*fnName</code> 方式。  </p>
<p>它的返回值也是一个迭代器，里面使用 <code class="language-text">yield</code> 关键词暂停语句。  </p>
<p><a id="orgac453ee"></a>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: undefined, done: true }
{ value: undefined, done: true }
{ value: undefined, done: true }</code></pre></div>
<p>跟 <a href="#org2892a08">9.1</a> 结果一样。  </p>
<p>生成器函数与普通函数区别：  </p>
<ol>
<li>使用星号(<code class="language-text">*</code>) 加名字声明</li>
<li>返回值是一个迭代器 <em>iterator</em></li>
<li>只有使用迭代器调用了 <code class="language-text">next()</code> 才会返回值，该值为函数中 <code class="language-text">yield</code> 关键词语句对应</li>
</ol>
<p><code class="language-text">yield</code> 告诉引擎，我在这里要暂停下，如果要我继续下去，就请用我返回的迭代器调用下<br>
<code class="language-text">next()</code> 获取当前 <code class="language-text">yield</code> 暂停地方的返回结果。  </p>
<h3>循环中的 yield</h3>
<p><code class="language-text">yield</code> 关键词可以用于任意值或语句，比如：循环中使用 <code class="language-text">yield</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: undefined, done: true }
{ value: undefined, done: true }
{ value: undefined, done: true }</code></pre></div>
<h3>两个 yield 之间有多个语句</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
<span class="token comment">//console.log(iterator.next()) // { value: 2, done: false }</span>
<span class="token comment">//console.log(iterator.next()) // { value: 3, done: false }</span>
<span class="token comment">// console.log(iterator.next()) // { value: undefined, done: true }</span>
<span class="token comment">// console.log(iterator.next()) // { value: undefined, done: true }</span>
<span class="token comment">// console.log(iterator.next()) // { value: undefined, done: true }</span></code></pre></div>
<p><code class="language-text">yield</code> 在 <code class="language-text">console.log</code> 语句之后的结果分析：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<table>
<thead>
<tr>
<th>next() 个数</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 0</code></td>
<td>:</td>
</tr>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 1</code></td>
<td>: 0 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 1, done: false }</td>
</tr>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 2</code></td>
<td>: 0 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 1, done: false }</td>
</tr>
<tr>
<td></td>
<td>: 1 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 2, done: false }</td>
</tr>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 3</code></td>
<td>: 0 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 1, done: false }</td>
</tr>
<tr>
<td></td>
<td>: 1 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 2, done: false }</td>
</tr>
<tr>
<td></td>
<td>: 2 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 3, done: false }</td>
</tr>
</tbody>
</table>
<p><code class="language-text">yield</code> 在 <code class="language-text">console.log</code> 语句之前的结果分析：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<table>
<thead>
<tr>
<th>next() 个数</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 1</code></td>
<td>: { value: 1, done: false }</td>
</tr>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 2</code></td>
<td>: { value: 1, done: false }</td>
</tr>
<tr>
<td></td>
<td>: 0 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 2, done: false }</td>
</tr>
<tr>
<td><code class="language-text">console.log(iterator.next()) * 3</code></td>
<td>: { value: 1, done: false }</td>
</tr>
<tr>
<td></td>
<td>: 0 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 2, done: false }</td>
</tr>
<tr>
<td></td>
<td>: 1 ‘i’</td>
</tr>
<tr>
<td></td>
<td>: { value: 3, done: false }</td>
</tr>
</tbody>
</table>
<p>从上面三种结果得出： <code class="language-text">yield</code> 在调用 <code class="language-text">next()</code> 之后执行的语句范围是：当前 <code class="language-text">yield</code><br>
与上一个 <code class="language-text">yield</code> 之间的语句。  </p>
<p>得出上述结果的原因：执行生成器函数本身的时候，它只是返回了一个迭代器，本身的函数<br>
体是不会执行的，除非调用了 <code class="language-text">next()</code> 才会去执行函数体。  </p>
<p>证明：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'generator called...'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>+RESULTS: 结果什么都没有，第一个 <code class="language-text">console.log</code> 并没有被执行。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">undefined</code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'generator called...'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">generator called...
0 &#39;i&#39;
{ value: 1, done: false }
1 &#39;i&#39;
{ value: 2, done: false }
2 &#39;i&#39;
{ value: 3, done: false }
{ value: undefined, done: true }
{ value: undefined, done: true }
{ value: undefined, done: true }
undefined</code></pre></div>
<h3>生成器函数表达式(Generator Function Expressions)</h3>
<p>除了可以在声明式命名函数生成迭代器函数，还可以通过表达式的方式创建生成器函数：  </p>
<ol>
<li>右边带名字的 <code class="language-text">var createIterator = function *createIterator() {}</code></li>
<li>右边不名字的 <code class="language-text">var createIterator = function *() {}</code></li>
</ol>
<p>使用和效果和普通生成器函数 <a href="#orgac453ee">9.2</a>一样。  </p>
<blockquote>
<p>箭头函数不能用来生成生成器函数。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> createIterator <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>执行后错误结果：  </p>
<p> /private/var/folders/kt/b5x0yl<em>56h1drdb8xgfmbk</em>r0000gn/T/babel-IQ9JEI/js-script-4JzlJj:3
let createIterator = *() => {
^</p>
<p> SyntaxError: Unexpected token *
at Module.<em>compile (internal/modules/cjs/loader.js:721:23)
at Object.Module.</em>extensions..js (internal/modules/cjs/loader.js:787:10)
at Module.load (internal/modules/cjs/loader.js:653:32)
at tryModuleLoad (internal/modules/cjs/loader.js:593:12)
at Function.Module._load (internal/modules/cjs/loader.js:585:3)
at Function.Module.runMain (internal/modules/cjs/loader.js:829:12)
at startup (internal/bootstrap/node.js:283:19)
at bootstrapNodeJSCore (internal/bootstrap/node.js:622:3)</p>
</blockquote>
<h3>对象中的生成器方法成员</h3>
<p>ECMAScript 5 风格：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">createIterator</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }</code></pre></div>
<p>ECMAScript 6 方法简写风格：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }</code></pre></div>
<h2>可迭代性和 <code class="language-text">for-of</code></h2>
<p>一个可迭代的对象必须有一个 <code class="language-text">Symbol.iterator</code> 属性。  </p>
<p>像我们在迭代集合对象(arrays, sets, maps)和字符串的时候，在内部其实是使用了到了他<br>
们默认的 <code class="language-text">Symbol.iterator</code> 迭代器的。  </p>
<blockquote>
<p>所有由生成器创建的迭代器都是可以迭代的，因为生成器也有默认的 <code class="language-text">Symbol.iterator</code><br>
内部属性。  </p>
</blockquote>
<h3>for-of</h3>
<p><code class="language-text">for-of</code> 会在每次迭代的时候自动调用 <code class="language-text">next()</code> 进入下一次迭代，并且将 <code class="language-text">value</code> 的值<br>
保存到一个变量当中以供使用。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> num <span class="token keyword">of</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1
2
3</code></pre></div>
<p>如果，在迭代过程中只需要用到该被迭代对象的元素值得时候，推荐使用 <code class="language-text">for-of</code> 因为它<br>
依赖和检测的条件更少。  </p>
<blockquote>
<p><code class="language-text">for-of</code> 语句使用在 non-iterable 对象， <code class="language-text">null</code> 或 <code class="language-text">undefined</code> 上的时候会报错。  </p>
</blockquote>
<h3>访问默认迭代器</h3>
<p>之前我们讲过，任何一个可以迭代的对象，都必须有 <code class="language-text">Symbol.iterator</code> 属性，无论是内<br>
部实现还是用户实现也好。  </p>
<p>这里将探讨如果使用和访问默认迭代器：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 得到数组内部的迭代器</span>
<span class="token keyword">let</span> iterator <span class="token operator">=</span> values<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: undefined, done: true }
{ value: undefined, done: true }</code></pre></div>
<p>和我们自定义方式创建的迭代器<a href="#org2892a08">9.1</a>结果一样。  </p>
<p>检测一个对象是否是可迭代的，根据每个可迭代的对象都会有一个 <code class="language-text">Symbol.iterator</code> 属<br>
性(内部或自定义)，且是一个函数。  </p>
<p>则有：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> object<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isIterable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
true
true
false
false</code></pre></div>
<h3>创建或重写迭代器</h3>
<p>通过 <code class="language-text">Symbol.iterator</code> 属性加上生成器函数可以很容易的让一个 non-iterable 对象变成<br>
iterable :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> collection <span class="token operator">=</span> <span class="token punctuation">{</span>
  items<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> item<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

collection<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token keyword">of</span> collection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 事实上是调用了自定义实现的 `*[Symbol.iterator]() {}` 函数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1
2
3</code></pre></div>
<h2>内置迭代器</h2>
<p>迭代器是 ECMASCript 6 的很重要的一部分，因此你不再需要为许多内置类型去构建自己的<br>
的迭代器，因为从现在开始他们自己内部就已经包含了一个默认的迭代器。  </p>
<h3>集合迭代器(for-of)<a id="org001eece"></a></h3>
<p>从 ECMAScript 6 开始有三种类型的集合对象： arrays, maps 和 sets。并且他们都有内<br>
置的迭代器帮助我们遍历操作内中的元素。  </p>
<ol>
<li><code class="language-text">entries()</code> 返回一个迭代器的 key-value 键值对</li>
<li><code class="language-text">values()</code> 返回一个迭代器的所有值的集合</li>
<li><code class="language-text">keys()</code> 返回一个迭代器所有键的集合</li>
</ol>
<p><strong>entries() 迭代器</strong>:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tracking <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'yyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ array.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> entry <span class="token keyword">of</span> colors<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ set.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> entry <span class="token keyword">of</span> tracking<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ map.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> entry <span class="token keyword">of</span> data<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">------ array.entries() ---------
[ 0, &#39;red&#39; ]
[ 1, &#39;green&#39; ]
[ 2, &#39;blue&#39; ]
------ set.entries() ---------
[ 123, 123 ]
[ 456, 456 ]
[ 789, 789 ]
------ map.entries() ---------
[ &#39;title&#39;, &#39;xxx&#39; ]
[ &#39;format&#39;, &#39;yyy&#39; ]</code></pre></div>
<ol>
<li>数组 key - key， value - value</li>
<li>set key - value, value - value</li>
<li>map key - key, value - value</li>
</ol>
<p>通过 <code class="language-text">entries()</code> 获取到的 array, set, map 迭代器：  </p>
<p><img src="http://qiniu.ii6g.com/1562493375.png" alt="img">  </p>
<p><strong>values() 迭代器</strong>:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tracking <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'yyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ array.values() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> colors<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ set.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> tracking<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ map.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> data<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">------ array.values() ---------
red
green
blue
------ set.entries() ---------
123
456
789
------ map.entries() ---------
xxx
yyy</code></pre></div>
<p><strong>keys() 迭代器</strong>:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
colors<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'colors'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tracking <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'yyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ array.keys() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> colors<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ set.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> tracking<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ map.entries() ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> data<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">------ array.keys() ---------
0
1
2
------ set.entries() ---------
123
456
789
------ map.entries() ---------
title
format</code></pre></div>
<blockquote>
<p>如上，数组中的 <code class="language-text">name</code> 属性并没有输出，这是因为 <code class="language-text">for-of</code> 只会针对数组的数字索引属<br>
性，对于非数字的属性会忽略掉，因此如果需要遍历到非数字属性就需要用到 <code class="language-text">for-in</code> 去<br>
遍历。  </p>
</blockquote>
<p><code class="language-text">for-in</code> 是根据该对象的属性遍历的，它会将对象中的所有属性遍历出来：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
colors<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'colors'</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> colors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">0
1
2
name</code></pre></div>
<p><strong>集合类型默认迭代器</strong> <a id="orgaccce3d"></a>:  </p>
<p>上面所有使用到 <code class="language-text">for-of</code> 加上 <code class="language-text">entries()</code>, <code class="language-text">values()</code>, <code class="language-text">keys()</code>, 的情况都可以使用<br>
默认的迭代器来替代，其实这些迭代器方法最终取得也是集合的默认迭代器：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
colors<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'colors'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tracking <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'yyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ array ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> colors<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 相当于使用了 colors.values()</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ set ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> tracking<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 相当于使用了 tracking.values()</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------ map ---------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> entry <span class="token keyword">of</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 相当于 data.entries()</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">------ array ---------
red
green
blue
------ set ---------
123
456
789
------ map ---------
[ &#39;title&#39;, &#39;xxx&#39; ]
[ &#39;format&#39;, &#39;yyy&#39; ]</code></pre></div>
<h3>for-of 循环的解构</h3>
<p>在集合类型默认迭代器<a href="#orgaccce3d">9.4.1</a>中我们讲了，在对 arrays, sets,<br>
maps 使用 <code class="language-text">for-in</code> 的时候，其实都是分别使用了他们的默认迭代器(arrays.values(),<br>
sets.values(), maps.entries()) 。  </p>
<p>那针对 maps 其内部用到的是 <code class="language-text">entries()</code> 迭代器，得到的结果是： <code class="language-text">[key, value]</code> 类<br>
型，如果我们想要再循环体内使用，可以结合 ECMAScript 6 的解构功能，很方便的去使用<br>
他们：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'xxxx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'yyyy'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">title = xxxx
format = yyyy</code></pre></div>
<h3>字符串迭代器</h3>
<p>在我们字符串的使用当中经常会看到 <code class="language-text">str[0]</code> 和数组一样通过下标方式去访问字符串中的<br>
字符。  </p>
<p>但是需要注意的一点是：字符串中括号索引方式的访问不是基于字符的而是基于编码单元的<br>
(即单个字节的)。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">"A ð ®· B"</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> message<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>ECMAScript 6 之前的输出结果：  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">A
(blank)
(blank)
(blank)
(blank)
B</code></pre></div>
<p>ECMAScript 6 之后的输出结果：  </p>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">A

ð

®
·

B</code></pre></div>
<p>ECMASCript 6 之后能正确输出是因为，在字符串一章<a href="#org952d340">3.1</a>新增的 16 字节的编码支<br>
持，且字符串的默认迭代器是基于字符而不是编码字节去遍历的，所以通过 <code class="language-text">for</code> 可以得<br>
到正确的结果。  </p>
<p>同样，ES6 的 <code class="language-text">for-of</code> 也一样能获得正确结果：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">"A ð ®· B"</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">A

ð

®
·

B</code></pre></div>
<h3>NodeList 迭代器(DOM元素列表迭代器)<a id="org999edd7"></a></h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> divs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> div <span class="token keyword">of</span> divs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>浏览器实例：  </p>
<p><img src="http://qiniu.ii6g.com/1562550190.png" alt="img">  </p>
<h2>展开符(…)和非数组类可迭代对象</h2>
<p>展开符将集合转成数组：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">set</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span></code></pre></div>
<p>将 maps 转成数组：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'xxx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>map<span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[[&quot;name&quot; (\, &quot;xxx&quot;)] (\, [&quot;age&quot; (\, 100)])]</code></pre></div>
<p>数组的合并:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> moreNums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">...</span>nums<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moreNums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">0,1,2,3,4,5,6</code></pre></div>
<p>NodeList<a href="#org999edd7">9.4.4</a>一节中提到过在新的 HTML 标准中 <code class="language-text">NodeList</code> 也有自己的默认迭代器，<br>
因此展开符也对 <code class="language-text">NodeList</code> 有效。  </p>
<p>如图示例：(浏览器环境)  </p>
<p><img src="http://qiniu.ii6g.com/1562497834.png" alt="img">  </p>
<h2>高级迭代器功能</h2>
<p>之前的章节讲述了使用迭代器和生成器如何去实现一些基本的功能，这一章节将讲述如何去<br>
使用迭代器和生成去去实现一些高级功能。  </p>
<h3>给迭代器传递参数</h3>
<p>之前使用迭代器，使用 <code class="language-text">iterator.next()</code> 都是没有传递参数的，其实它是可以传递参数<br>
的，其实就跟普通的函数参数传递是一样的。  </p>
<p>结合生成器使用时候的特殊性： <code class="language-text">next(v)</code> 中的参数 <code class="language-text">v</code> 的值会当做当前 <code class="language-text">yield</code> 的返<br>
回值返回，不管该 <code class="language-text">yield</code> 后面表达式的结果是什么：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// 不传值理应是： first + 2 => 1 + 2 => 3</span>
  <span class="token comment">// 但 next(4) 有参数，则该参数就是 yield 表达式的值，因此结果会是： 4 + 2</span>
  <span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token keyword">yield</span> first <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">// 如上，结果是 5 + 3 = 8</span>
  <span class="token keyword">yield</span> second <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 6, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 8, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 6, done: false }
{ value: 8, done: false }
{ value: undefined, done: true }</code></pre></div>
<p>上面代码执行过程：  </p>
<p><img src="http://qiniu.ii6g.com/1562498470.png" alt="img">  </p>
<h3>迭代器中触发异常</h3>
<p>由于给 <code class="language-text">next()</code> 传递的参数不管是什么内容，它都会作为当前 <code class="language-text">yield</code> 表达式的返回值<br>
给返回。  </p>
<p>迭代器对象有一个方法： <code class="language-text">iterator.throw(Error)</code> 可以给当前的 <code class="language-text">yield</code> 处抛出一个异<br>
常。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token keyword">yield</span> first <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> second <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 6, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Boom'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 异常</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">: { value: 1, done: false }
: { value: 6, done: false }

/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-bSJrfN:4
  let second = yield first + 2;
               ^

Error: Boom
    at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-bSJrfN:12:28
    at Object.&lt;anonymous&gt; (/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI/js-script-bSJrfN:14:2)</code></pre></div>
<p>代码中，前面两个 <code class="language-text">next()</code> 会正常执行得到结果，但当 <code class="language-text">throw()</code> 调用的时候，迭代器<br>
会在执行 <code class="language-text">let second =</code> 之前抛出异常(<code class="language-text">yield first + 2;</code> 已经返回结果了)。  </p>
<p>如图：  </p>
<p><img src="http://qiniu.ii6g.com/1562499068.png" alt="img">  </p>
<p><strong>捕获异常</strong> :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> second<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    second <span class="token operator">=</span> <span class="token keyword">yield</span> first <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    second <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">yield</span> second <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 6, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Boom'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 9, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 6, done: false }
Boom
{ value: 9, done: false }</code></pre></div>
<p>从结果会惊奇的发现，调用 <code class="language-text">throw()</code> 之后，返回了下一个 <code class="language-text">yield</code> 的执行结果。  </p>
<p>原因： <code class="language-text">iterator.throw()</code> 调用之后，生成器将这个异常捕获到了，并且继续往下执行了，<br>
从触发了下一个 <code class="language-text">yield</code> 的执行。  </p>
<blockquote>
<p><code class="language-text">next()</code> 和 <code class="language-text">throw()</code> 都可以让生成器继续往下执行，只不过执行方式不一样，前者会从<br>
下一个 <code class="language-text">yield</code> 位置执行返回结果，后者是在上一个 <code class="language-text">yield</code> 执行之后的位置触发一个异<br>
常，如果这个异常被捕获就继续往下执行异常处理及后面的代码，如果没有被捕获就抛出一<br>
个异常中断整个生成器的执行。  </p>
</blockquote>
<h3>生成器函数中使用 return 语句</h3>
<p>在生成器中的 return 语句表示该迭代器结束了，后面不会再有值过来了。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 这里结束迭代器</span>
  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 不会执行</span>
  <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 不会执行</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: undefined, done: true }</code></pre></div>
<p>因此 return 语句在生成器中的效果就是终结迭代器，在它后面的 <code class="language-text">yield</code> 都无效，  </p>
<p>还可以 return 一个值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token comment">// 这里结束迭代器</span>
  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 不会执行</span>
  <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 不会执行</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 42, done: true }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 42, done: true }
{ value: undefined, done: true }</code></pre></div>
<p>这里有点特殊，之前迭代器结束了，最后一个 <code class="language-text">done: true</code> 的值是 <code class="language-text">undefined</code> 这里使<br>
用 return 返回了一个值会当做迭代器结束之返回。  </p>
<blockquote>
<p>在使用展开符和 <code class="language-text">for-of</code> 时候如果有 return 语句，该语句中的 value 会被忽略掉，因<br>
为它一旦发现了 <code class="language-text">done: true</code> 就会结束。  </p>
</blockquote>
<h3>委托生成器(Delegating Generators)<a id="orgce1f7da"></a></h3>
<p>在有些情况下，将两个迭代器的值结合成一个通常会很有用。生成器可以通过 <code class="language-text">yield</code> 和<br>
<code class="language-text">*</code> 一起使用来实现代理到其他迭代器，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createNumIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createColorIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token string">'red'</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token string">'blue'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createCombineIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">createNumIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">createColorIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> iterator <span class="token operator">=</span> <span class="token function">createCombineIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'red', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'blue', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: true, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: &#39;red&#39;, done: false }
{ value: &#39;blue&#39;, done: false }
{ value: true, done: false }
{ value: undefined, done: true }</code></pre></div>
<p>结合 <code class="language-text">return</code> 使用，比如：迭代器 B 依赖迭代器 A 的返回结果：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createNumIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// #1</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createRepeatingIterator</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token string">'repeat'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createCombinedIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// #2</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">createNumIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// #2.1</span>
  <span class="token keyword">yield</span> result<span class="token punctuation">;</span>
  <span class="token comment">// #3</span>
  <span class="token comment">// 这里得到 createNumIterator 中 return 3 返回的结果 3</span>
  <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">createRepeatingIterator</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token function">createCombinedIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'repeat', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'repeat', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'repeat', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS: 增加 <strong>#2.1</strong> 将 <strong>#2</strong> 结果输出后：  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: &#39;repeat&#39;, done: false }
{ value: &#39;repeat&#39;, done: false }
{ value: &#39;repeat&#39;, done: false }
{ value: undefined, done: true }</code></pre></div>
<p>+RESULTS: 有 <code class="language-text">return 3;</code> 的返回结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: &#39;repeat&#39;, done: false }
{ value: &#39;repeat&#39;, done: false }
{ value: &#39;repeat&#39;, done: false }
{ value: undefined, done: true }</code></pre></div>
<p>+RESULTS: 没有 <code class="language-text">return 3;</code> 的返回结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: undefined, done: true }
{ value: undefined, done: true }
{ value: undefined, done: true }
{ value: undefined, done: true }</code></pre></div>
<p>因为如果没有 <code class="language-text">return 3;</code> 那么最后 <strong>#2</strong> 处的的 <code class="language-text">yield</code> 返回结果会是<br>
<code class="language-text">createNumiterator()</code> 执行后返回的结果 <code class="language-text">undefined</code>  </p>
<p>如果有 <code class="language-text">return 3;</code> <strong>#2</strong> 处的函数又自己的返回值，作为 <strong>#2</strong> 处 <code class="language-text">yield</code> 代理完成的<br>
结果保存到了 <code class="language-text">result</code> 中，下一次 <code class="language-text">next()</code> 会执行 <strong>#3</strong> 处的 <code class="language-text">yield</code> 进入下一个代<br>
理迭代器。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'h', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'e', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'l', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'l', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'o', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS: 因为字符串本身有自己的默认迭代器，因此 <code class="language-text">yield * &#39;hello&#39;;</code> 结果会去调用<br>
默认迭代器对每个字符进行迭代。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: &#39;h&#39;, done: false }
{ value: &#39;e&#39;, done: false }
{ value: &#39;l&#39;, done: false }
{ value: &#39;l&#39;, done: false }
{ value: &#39;o&#39;, done: false }
{ value: undefined, done: true }</code></pre></div>
<h2>异步迭代器</h2>
<h3>for-await-of<sup>2019</sup></h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">promise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">timeout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> time <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> x <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>异步任务</h2>
<p>一般我们使用生成器和迭代器最常用，也用起来最爽的估计就是异步任务了吧!!!  </p>
<p>比如：异步读取一个文件  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> cnt</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 通过异步接口取文件内容  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-IQ9JEI
&lt;Buffer 7b 20 22 6e 61 6d 65 22 3a 20 22 78 78 78 22 20 7d 0a&gt;
Done</code></pre></div>
<p>接下来我们将讲述如何使用 <code class="language-text">generator</code> 来实现异步任务。  </p>
<h3>一个简单的任务执行器<a id="orgb88e39f"></a></h3>
<p>这个任务执行器的作用就是：  </p>
<ol>
<li>启动迭代器</li>
<li>循环调用 <code class="language-text">next()</code> 知道结束</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">taskDef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建迭代器，首先确保 taskDef 是一个 generator 函数</span>
  <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token function">taskDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 启动迭代器</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// #1</span>
      <span class="token comment">// result = task.next();</span>
      <span class="token comment">// #2 将上一个 yield 的结果作为下一个 yield 的返回值</span>
      result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 启动循环递归，知道迭代器结束</span>
  <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------- log --------'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">logVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'------- logVal --------'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

  val <span class="token operator">=</span> <span class="token keyword">yield</span> val <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token comment">// 3</span>
<span class="token punctuation">}</span>


<span class="token function">run</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span>
<span class="token function">run</span><span class="token punctuation">(</span>logVal<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: <strong>#2</strong> 执行结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">------- log --------
1
2
3
------- logVal --------
1
4
undefined</code></pre></div>
<p>+RESULTS: <strong>#1</strong> 的执行结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">------- log --------
1
2
3</code></pre></div>
<p>通过 <strong>#2</strong> 的改造，让每次 <code class="language-text">yield</code> 的表达式值依赖上一次 <code class="language-text">next()</code> 的结果值。  </p>
<h3>异步任务执行器</h3>
<p>我们可以将上一届<a href="#orgb88e39f">9.8.1</a>中的 <code class="language-text">run</code> 进行改造让其支持异步任务:  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">taskDef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token function">taskDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 yield 返回的是一个函数，就执行这个函数(异步任务)</span>
        <span class="token comment">// 结束之后，进行下一次 next() -> yield</span>
        result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> filename<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'/config.json'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&lt;Buffer 7b 20 22 6e 61 6d 65 22 3a 20 22 78 78 78 22 20 7d 0a&gt;
Done</code></pre></div>
<h2><a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/">Generator 内部抽象操作(伪码)</a></h2>
<h2>小结</h2>
<ul>
<li><code class="language-text">Symbol.iterator</code> 用来定义对象的默认迭代器</li>
<li>
<p><code class="language-text">for-of</code> 可以用来遍历可迭代的对象，即包含 <code class="language-text">Symbol.iterator</code> 函数的对象  </p>
<ol>
<li><code class="language-text">entries()</code> 迭代器，取 <code class="language-text">[key, value]</code> 键值对，如 <code class="language-text">for-of-map</code> 默认就是用的<br>
这个迭代器</li>
<li><code class="language-text">values()</code> 迭代器，取 <code class="language-text">value</code> 值，如果是数组 <code class="language-text">for-of-array</code> 只会去索引为数<br>
值的元素，忽略非数值索引的元素，比如： <code class="language-text">arr.name = &#39;xxx&#39;</code> 这个 <code class="language-text">name</code> 是不<br>
会被遍历到的(默认用 <code class="language-text">values()</code> 迭代器的有： arrays 和 sets)。</li>
</ol>
</li>
<li><code class="language-text">...</code> 展开符其实内部实现也是去调用了对象内部的 <code class="language-text">Symbol.iterator</code> 。</li>
<li>
<p><code class="language-text">Generator</code> 调用会生成一个迭代器，通过 <code class="language-text">it.next()</code> 触发 <code class="language-text">yield</code> 语句执行并得到<br>
结果  </p>
<ol>
<li>多个 generator 的嵌套调用可实现互相之间的代理(内部使用 <code class="language-text">yield *generatorFn()</code> 调用生成器函数)</li>
<li>generator 内部使用 <code class="language-text">return 42;</code> 终止迭代并返回 <code class="language-text">{ value: 42, done: true}</code><br>
，返回值由 <code class="language-text">return</code> 返回值决定，但该值不会被 <code class="language-text">for-of</code> 遍历到，因为 <code class="language-text">for-of</code><br>
检测到 <code class="language-text">done: true</code> 了就即刻结束。</li>
<li>可以通过 <code class="language-text">return</code> 特性灵活运用 generator 代理。</li>
<li>由于字符串本身是有迭代器的，因此可以直接： <code class="language-text">yield * &#39;hello&#39;;</code> 使用。</li>
<li>generator + iterator 实现同步任务 runner 。</li>
<li>generator + iterator + callback 实现异步任务 runner。</li>
</ol>
</li>
</ul>
<h1>类(Classes)</h1>
<h2>类声明</h2>
<h3>基本类声明</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">PersonClass</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonClass</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// xxx</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">PersonClass</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> PersonClass<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token class-name">PersonClass</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// function</span></code></pre></div>
<p>实际上 <code class="language-text">class</code> 声明只是个语法糖而已，它最终产生的 PersonClass 依旧是个函数，且这<br>
个函数行为和 <code class="language-text">constructor</code> 一致，这就是为什么上面 <code class="language-text">typeof PersonClass</code> 输出结果<br>
是 ‘function’ 。  </p>
<p>经过 babel 转换之后的代码：  </p>
<p><a id="orgccdd067"></a>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_defineProperties</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> props<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> descriptor <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>enumerable <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    descriptor<span class="token punctuation">.</span>configurable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"value"</span> <span class="token keyword">in</span> descriptor<span class="token punctuation">)</span>
      descriptor<span class="token punctuation">.</span>writable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span>key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_createClass</span><span class="token punctuation">(</span><span class="token parameter">Constructor<span class="token punctuation">,</span> protoProps<span class="token punctuation">,</span> staticProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>protoProps<span class="token punctuation">)</span>
    <span class="token function">_defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> protoProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>staticProps<span class="token punctuation">)</span>
    <span class="token function">_defineProperties</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">,</span> staticProps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> Constructor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">PersonClass</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PersonClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_createClass</span><span class="token punctuation">(</span>PersonClass<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    key<span class="token operator">:</span> <span class="token string">"sayName"</span><span class="token punctuation">,</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> PersonClass<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonClass</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// xxx</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_instanceof</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> PersonClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_instanceof</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> Object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_typeof</span><span class="token punctuation">(</span>PersonClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_typeof</span><span class="token punctuation">(</span><span class="token class-name">PersonClass</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// function</span></code></pre></div>
<p>需要关注的点：  </p>
<ol>
<li>
<p><code class="language-text">constructor</code> 中的 <code class="language-text">this.name</code> 依旧是在 PersonClass 这适用于函数的 <code class="language-text">new</code> 特性  </p>
<p>最终 <code class="language-text">name</code> 会被绑定到 <code class="language-text">new PersonClass()</code> 之后的实例上。</p>
</li>
<li>
<p><code class="language-text">sayName()</code> 类中的方法都会被绑定到 <code class="language-text">PersonClass()</code> 的原型上。  </p>
<p>如： <code class="language-text">_createClass</code> 里面的 <code class="language-text">protoProps</code> 。</p>
</li>
<li>
<p>静态属性会被绑定到函数名(即类名，构造函数上)  </p>
<p>如： <code class="language-text">_createClass</code> 里面的 <code class="language-text">staticProps</code> 。</p>
</li>
<li>最后将函数 PersonClass 返回。</li>
</ol>
<h3>类语法的好处</h3>
<p>类和其他类型之间，有很多重要的区别：  </p>
<ol>
<li>类声明不会被提升(hoisted)，和 <code class="language-text">let</code> 声明性质一样，也存在 <strong>TDZ</strong> 问题。</li>
<li>所有在类声明里面的代码默认启用 strict mode ，并且无法改变。</li>
<li>
<p>所有的方法都是不可枚举的， babel 转换之后 enumerable 默认值就是 <code class="language-text">false</code>  </p>
<p>如上一节 babel 转换之后的代码 <a href="#orgccdd067">10.1.1</a> 。</p>
</li>
<li>所有的方法都没有 <code class="language-text">[ [Constructor]]</code> 内部属性，因此不能 <code class="language-text">new</code> ，否则会抛出异常。</li>
<li>不能直接调用类的构造函数。</li>
<li>在类方法里面试图重写类名将抛出异常。</li>
</ol>
<p>根据上面 6 个重要差异，我们就可以手动去模拟一个类了：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 1. let 声明，不存在提升，TDZ</span>
<span class="token keyword">let</span> PersonType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 2. 必须是严格模式</span>
  <span class="token string">'use strict'</span><span class="token punctuation">;</span>

  <span class="token comment">// 6. 因为是用 const 声明的类名，因此在类内部不能对类名重新赋值</span>
  <span class="token keyword">const</span> <span class="token function-variable function">PersonType</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 5. 不能直接调用，必须使用 new</span>
    <span class="token comment">// 这里用到了一个新的属性， new.target ，只能在非箭头函数</span>
    <span class="token comment">// 内部使用，表示：</span>
    <span class="token comment">// 如果是通过 new 调用的 new.target 就是 PersonType 自身</span>
    <span class="token comment">// 如果不是通过 new 调用的 new.target 就是 undefined</span>
    <span class="token comment">// 这也就很好的区分了一个函数是通过什么方式调用的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'类名必须通过 new 调用。'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 类实例属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token comment">// 所有方法都挂在原型上</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">PersonType</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'sayName'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 4. 前面说过了 new.target 作用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 能进这里，表示用 new 调用了</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'类方法不能通过 new 调用'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 3. 所有方法都不能枚举</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> PersonType<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>如上例，类内部是不能对 <code class="language-text">PersonType</code> 重新复制的，因为它是用 <code class="language-text">const</code> 方式声明的，<br>
但是在外部是可以重写的，因为外部是用的 <code class="language-text">let</code> 声明的。  </p>
<p>因此：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Foo <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span> <span class="token comment">// 错误，非法</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Foo <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span> <span class="token comment">// OK</span></code></pre></div>
<h2>类表达式</h2>
<p>类也可以使用表达式的方式声明。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> PersonClass <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
  <span class="token comment">// 等价于 PersonType 的构造函数</span>
  <span class="token function">constructro</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token comment">// 等价于 PersonType.prototype.sayName</span>
  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>命名式表达式：跟命名式函数表达式是一样的， <code class="language-text">class</code> 后面可以跟一个类名：  </p>
<p><code class="language-text">let PersonClass = class PersonClass2 {...}</code>  </p>
<p>但是 class 后面的类名，只能在类的内部使用，在外部是访问不到的，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> PersonClass <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">PersonClass2</span> <span class="token punctuation">{</span>
  <span class="token comment">// 等价于 PersonType 的构造函数</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> PersonClass2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'function'</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 等价于 PersonType.prototype.sayName</span>
  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">new</span> <span class="token class-name">PersonClass</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> PersonClass2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'undefined'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">function
xxx
undefined</code></pre></div>
<p><code class="language-text">PersonClass2</code> 将作为类内部的函数名称。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> PersonClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">PersonClass2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>PersonClass2<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> PersonClass2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<h2>类作为一等公民</h2>
<p>当一个对象可以被当做值，意味着可以：  </p>
<ol>
<li>当做参数传递给函数</li>
<li>从一个函数返回</li>
<li>赋值给一个变量</li>
</ol>
<p>比如函数就是 JavaScript 中的一等公民。  </p>
<h3>作为参数</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token parameter">classDef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">classDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token punctuation">{</span>
  <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> obj2 <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token class-name">PersonClass</span> <span class="token punctuation">{</span>
  <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj1<span class="token punctuation">.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'Hi!'</span>
obj2<span class="token punctuation">.</span><span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'Hi!'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Hi!
Hi!</code></pre></div>
<p>匿名类和命名类作为参数传递。  </p>
<h3>立即执行实现单例</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">class</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>

person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'xxx'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xxx</code></pre></div>
<ol>
<li>匿名类</li>
<li>立即执行</li>
<li>person 为一个单例，声明时就已经决定了是一个类(匿名类，只会在这里使用一次)实例。</li>
</ol>
<h2>访问器属性</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">CustomHTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element <span class="token operator">=</span> element
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">.</span>innerHTML
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token class-name">CustomHTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span> <span class="token keyword">in</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span> <span class="token keyword">in</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>enumerable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ get: [Function: get html],
  set: [Function: set html],
  enumerable: false,
  configurable: true }
true
true
false</code></pre></div>
<p>注意要从 <code class="language-text">CustomHTMLElement.prototype</code> 原型上去取 <code class="language-text">html</code> ，因为类的方法都会被挂<br>
到原型上。  </p>
<h2>计算成员名称</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> methodName <span class="token operator">=</span> <span class="token string">'sayName'</span>

<span class="token keyword">class</span> <span class="token class-name">PersonClass</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonClass</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span>

me<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'xx'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xx</code></pre></div>
<p>计算成员名称，可以让类或对象的成员名动态生成，这赋予了类和对象更加灵活的使用方式。  </p>
<p>且访问器属性名称也可以使用变量。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> propertyName <span class="token operator">=</span> <span class="token string">'html'</span>

<span class="token keyword">class</span> <span class="token class-name">CustomHTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element <span class="token operator">=</span> element
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token punctuation">[</span>propertyName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">.</span>innerHTML
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token punctuation">[</span>propertyName<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>生成器方法(Generator Methods)</h2>
<p>类内部方法还可以是生成器方法。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span>
    <span class="token keyword">yield</span> <span class="token number">2</span>
    <span class="token keyword">yield</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> it <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: undefined, done: true }</code></pre></div>
<p>迭代器和生成器<a href="#orge26ee44">9</a>描述过，一个实现了 <code class="language-text">Symbol.iterator</code> 或内置它<br>
的一个对象都可以被迭代，也就可以使用 <code class="language-text">for...of</code> 去遍历它，最终调用的都会是<br>
<code class="language-text">Symbol.iterator</code> 这个内部或自定义的函数。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Collection</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

c<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token keyword">of</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1
2
3</code></pre></div>
<p>回顾<a href="#orgce1f7da"><span class="underline">代理生成器</span></a>和<a href="#org001eece"><span class="underline">集合内置迭代器</span></a>的内容，我们分析这一句：  </p>
<p><code class="language-text">yield *this.items.values()</code>  </p>
<ol>
<li>首先 <code class="language-text">values()</code> 为集合内置的值得迭代器</li>
<li><code class="language-text">yield *iterator()</code> 这种方式为生成器代理，即一个生成器中调用另一个生成器</li>
</ol>
<p>也就是说当我们 <code class="language-text">for (let x of c) {}</code> 的时候，首先是调用了 <code class="language-text">Collection</code> 类内部实<br>
现的 <code class="language-text">*[Symbol.iterator]()</code> 迭代器，然后在迭代器内部由调用了类成员的 <code class="language-text">items</code> 数<br>
组的内置迭代器，也就是说这一句最终其实就是去遍历 <code class="language-text">items</code> 数组，输出每个元素值。  </p>
<h2>静态成员</h2>
<p>静态成员，即只属于构造函数的属性，只能通过类名去访问的成员。  </p>
<p>&#x3C; ECMAScript 6 之前的做法：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
<span class="token punctuation">}</span>

Person<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>
person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'xxx'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xxx</code></pre></div>
<p>直接在函数名称上挂一个属性，因为函数也是一个对象，也可以有自己的属性，和对象一样<br>
可以通过 <code class="language-text">obj[attrName]</code> 访问或新增属性。  </p>
<blockquote>
<p>= ECMAScript 6 开始可以使用类静态成员方式：  </p>
</blockquote>
<p>通过 <code class="language-text">static</code> 关键词声明一个方法，这个方法将成为类的静态属性，只能通过类名访问。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> p <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'xx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'xx'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xx</code></pre></div>
<h2>类继承</h2>
<h3>&#x3C; ECMAScript 6 之前的类继承<a id="orga150609"></a></h3>
<p>一般都是使用原型的方式去实现继承  </p>
<p>构造函数-实例-函数三者之间的关系简图：  </p>
<p><img src="http://qiniu.ii6g.com/function-fn-constructor-prototype.png" alt="img">  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> l
  <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w
<span class="token punctuation">}</span>

<span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getArea</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Square</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用父类的构造函数，将实例属性拷贝一份到子类中</span>
  <span class="token function">Rectangle</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> l<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// #1</span>
<span class="token class-name">Square</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token comment">/* Object.create(Rectangle.prototype, {
                      constructor: {
                      value: Square,
                      enumerable: false,
                      writable: true,
                      configurable: true
                      }
                      }) */</span>

Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token comment">// Rectangle.prototype</span>

<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s <span class="token keyword">instanceof</span> <span class="token class-name">Square</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>constructor <span class="token operator">===</span> <span class="token class-name">Square</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Square <span class="token operator">===</span> <span class="token class-name">Square</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Square</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s <span class="token keyword">instanceof</span> <span class="token class-name">Rectangle</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS: #1 被注释，意味着没有重新定义构造函数的输出  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
true
true
false
[Function: Rectangle]
true</code></pre></div>
<p>这里 <code class="language-text">Square</code> 的构造函数不再是自身了，因为它的原型被重写了，而构造函数对象又是挂<br>
在原型对象上的 <code class="language-text">Square.prototype.constructor</code> 因此使用原型继承的时候尤其要记得重<br>
新定义构造函数，才能得到下面的正确继承效果：  </p>
<p>+RESULTS: #1 没有注释，有重新定义构造函数的输出结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
true
true
true
[Function: Square]
true</code></pre></div>
<p>上面代码对于初学者来说不太容易明白的一般有两点：  </p>
<ol>
<li>
<p><code class="language-text">Rectangle.call(this, l, l)</code> 这一步，这里是拷贝一份是实例属性到子类上  </p>
<p>这里相当于让 <code class="language-text">Square</code> 也有了自己的 len 和 width 实例属性。</p>
</li>
<li><code class="language-text">Square.prototype</code> 原型赋值的一步构造函数被覆盖了，需要重新定义构造函数</li>
</ol>
<p>注意点： 重写 Square 的原型，且需要重新定义构造函数，因为构造函数是在原型之上的，<br>
如果将原型覆盖了，那么 Square 将没有自己的构造函数了，将没法创建实例，因此在使用<br>
<code class="language-text">Object.create()</code> (<a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/#org2f761be">Object.create伪码实现</a>)的时候需要把构造函数属性给加上去。  </p>
<h3>>= ECMAScript 6 之后的 class 类继承</h3>
<p>在有了 <code class="language-text">class</code> 语法糖之后，让 JavaScript 中的继承变得简单易懂。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> l
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w
  <span class="token punctuation">}</span>

  <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s <span class="token keyword">instanceof</span> <span class="token class-name">Square</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s <span class="token keyword">instanceof</span> <span class="token class-name">Rectangle</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
true
true</code></pre></div>
<p>将上面的代码 babel 转换，删除一些不关心的代码之后：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token string">"use strict"</span><span class="token punctuation">;</span>

<span class="token comment">// ... 省略</span>

<span class="token keyword">function</span> <span class="token function">_inherits</span><span class="token punctuation">(</span><span class="token parameter">subClass<span class="token punctuation">,</span> superClass</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> superClass <span class="token operator">!==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> superClass <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">"Super expression must either be null or a function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  subClass<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
    superClass <span class="token operator">&amp;&amp;</span> superClass<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      constructor<span class="token operator">:</span> <span class="token punctuation">{</span>
        value<span class="token operator">:</span> subClass<span class="token punctuation">,</span>
        writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        configurable<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>superClass<span class="token punctuation">)</span>
    <span class="token function">_setPrototypeOf</span><span class="token punctuation">(</span>subClass<span class="token punctuation">,</span> superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ... 省略</span>


<span class="token keyword">var</span> Rectangle <span class="token operator">=</span>
    <span class="token comment">/*#__PURE__*/</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Rectangle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> l<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">_createClass</span><span class="token punctuation">(</span>Rectangle<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        key<span class="token operator">:</span> <span class="token string">"getArea"</span><span class="token punctuation">,</span>
        <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> Rectangle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Square <span class="token operator">=</span>
    <span class="token comment">/*#__PURE__*/</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_Rectangle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_inherits</span><span class="token punctuation">(</span>Square<span class="token punctuation">,</span> _Rectangle<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">Square</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Square<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">_possibleConstructorReturn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span>Square<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Square<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>Rectangle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_instanceof</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> Square<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_instanceof</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> Rectangle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code></pre></div>
<p>我们重点关注的应该是 <code class="language-text">_inherits</code> 这个函数，其实它里面实现的就和我们 ECMAScript6<br>
之前的版本<a href="#orga150609">10.8.1</a>一样。  </p>
<h3>类 super() 使用注意点</h3>
<p>在使用 es6 的类的 <code class="language-text">super()</code> 需要注意几点：  </p>
<ol>
<li>只能在子类的方法中使用 <code class="language-text">super()</code> ，如果试图在一个非继承的类(不是用 <code class="language-text">extends</code><br>
实现的继承的子类)中使用都会报错。</li>
<li>必须在构造函数中调用 <code class="language-text">this</code> 之前调用 <code class="language-text">super()</code> 因为 <code class="language-text">super()</code> 会对 <code class="language-text">this</code> 做<br>
一些初始化工作，比如拷贝实例属性等等。</li>
<li>唯一一个避免调用 <code class="language-text">super()</code> 的途径就是在构造函数中返回一个对象。</li>
</ol>
<p><strong>第一点</strong>: 不能非继承调用 <code class="language-text">super()</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 报错结果，表明不能在非继承的子类中直接调用 <code class="language-text">super</code> ，因为它被定义指向<br>
的是 extends 的父类那个对象。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-UZ7NKG:4
    super(name)
    ^^^^^

SyntaxError: &#39;super&#39; keyword unexpected here
    at Module._compile (internal/modules/cjs/loader.js:721:23)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:787:10)</code></pre></div>
<p><strong>第二点</strong>: 必须在使用 this 之前调用 <code class="language-text">super()</code> 初始化 this  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Man</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span></code></pre></div>
<p>+RESULTS: 直接报错，不能在使用 this 之后调用 super() ,必须在之前调用  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-c51Wqa:10
    console.log(this.name)
                ^

ReferenceError: Must call super constructor in derived class before accessing &#39;this&#39; or returning from derived constructor
    at new Man (/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-c51Wqa:10:17)
    at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-la0Zuf/js-script-c51Wqa:19:11</code></pre></div>
<h3>重写父类方法(Shadowing Class Methods)</h3>
<p>重写父类方法，通过实例调用该方法时候，会先从当前类中查找，如果没找到就会去父类中<br>
找。  </p>
<p>因此，如果想子类拥有某种自己的行为，可以通过重写方法来实现。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'human running.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'person running.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'human running.'</span></code></pre></div>
<p>+RESULTS: 重写之后  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">person running.</code></pre></div>
<p>+RESULTS: 重写之前  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">human running.</code></pre></div>
<p>Babel 编译之后的代码：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> Human <span class="token operator">=</span>
    <span class="token comment">/*#__PURE__*/</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">Human</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Human<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">_createClass</span><span class="token punctuation">(</span>Human<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        key<span class="token operator">:</span> <span class="token string">"run"</span><span class="token punctuation">,</span>
        <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'human running.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> Human<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Person <span class="token operator">=</span>
    <span class="token comment">/*#__PURE__*/</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_Human</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_inherits</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> _Human<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Person<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">_possibleConstructorReturn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">_createClass</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        key<span class="token operator">:</span> <span class="token string">"run"</span><span class="token punctuation">,</span>
        <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'person running.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> Person<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>Human<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'human running.'</span></code></pre></div>
<p><code class="language-text">_inherits</code> 让 Person.prototype 指向了 Human.prototype,  </p>
<p>两个 <code class="language-text">_createClass</code> ，前一个让 <code class="language-text">run</code> 挂到了 Human 的原型上，后一个又在 Person 的<br>
原型上重新挂了一个同名的 run 方法，但由于继承 <code class="language-text">_inherits</code> 的原型<br>
Person.prototype 实际上是指向 Human.prototype 的，因此两个 <code class="language-text">_createClass</code> 实际上<br>
是覆盖了前一个 <code class="language-text">_createClass</code> 的 run 方法。  </p>
<h3>继承静态成员</h3>
<p>静态成员在 <code class="language-text">extends</code> 继承过程中，也会被继承到子类当中，但是也只能通过构造函数访<br>
问。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> l
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w
  <span class="token punctuation">}</span>

  <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> w<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> rect <span class="token operator">=</span> Square<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rect <span class="token keyword">instanceof</span> <span class="token class-name">Rectangle</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rect <span class="token keyword">instanceof</span> <span class="token class-name">Square</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
12
false</code></pre></div>
<h3>动态父类</h3>
<p>即 <code class="language-text">extends</code> 后面的可以是任意类型，只要满足两个条件：  </p>
<ol>
<li>有 <code class="language-text">[ [Constructor]]</code> 可以构建实例(使用 <code class="language-text">new</code>)</li>
<li>有自己的原型</li>
</ol>
<p>普通构造函数：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> l
  <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w
<span class="token punctuation">}</span>

<span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getArea</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Rectangle</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
true</code></pre></div>
<p>函数调用方式：只要返回值满足有构造器和原型  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token parameter">l<span class="token punctuation">,</span> w</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> l
  <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w
<span class="token punctuation">}</span>

<span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getArea</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Rectangle
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">getBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Rectangle</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
true</code></pre></div>
<p>根据父类可以动态决定的特性，我们可以实现一些比较有用的东西，比如：混合器类型  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> SerializableMixin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> AreaMixin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mixin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>mixins</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token function-variable function">base</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token operator">...</span>mixins<span class="token punctuation">)</span>
  <span class="token keyword">return</span> base
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">mixin</span><span class="token punctuation">(</span>SerializableMixin<span class="token punctuation">,</span> AreaMixin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> l
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> l
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
{&quot;length&quot;:3,&quot;width&quot;:3}</code></pre></div>
<p>让 <code class="language-text">Square</code> 同时具备多个混合器的能力，使用多个混合器构建一个函数类。  </p>
<blockquote>
<p>记住：只要满足有原型和构造函数都可以放在 extends 右边作为被继承的父类。  </p>
<p>除下面两钟类型不能之外：  </p>
<ul>
<li><code class="language-text">null</code></li>
<li>生成器函数</li>
</ul>
<p>因为他们没有 <code class="language-text">[[Constructor] ]</code> 属性。  </p>
</blockquote>
<h3>继承内置对象</h3>
<p>可以通过原型继承的方式来基于内置对象定义一个新的对象，该对象将有用内置对象的相同<br>
的功能。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">MyArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 Array 的构造函数，初始化 this</span>
  <span class="token function">Array</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyArray</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  constructor<span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> MyArray<span class="token punctuation">,</span>
    writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> colors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'red'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

colors<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">0
red</code></pre></div>
<p>结果并非如我们所预期。 <code class="language-text">length</code> 属性和数值属性并没有像内置数组类型一样发生变化，<br>
这是因为这个功能无法通过 <code class="language-text">Array.apply()</code> 或赋值原型类实现。  </p>
<p>在 ECMAScript5 的类继承中， <code class="language-text">this</code> 的值会在调用 <code class="language-text">Array.apply</code> 之前会被新的类型<br>
(比如： <code class="language-text">MyArray</code>)创建好了，然后基础类型的构造函数才会被调用，这就意味着 <code class="language-text">this</code><br>
只是绑定到了 <code class="language-text">MyArray</code> 的本 身的实例上而已，此时并不具备数组的一些基础特性，而后<br>
的基础类型构造函数的调用只不过是对新类型做了一点扩展而已。  </p>
<p>而在 ECMAScript6 的基于类的继承当中， <code class="language-text">this</code> 会优先被 <code class="language-text">Array</code> 内置类型的构造函数<br>
调用，然后才是被新类型 <code class="language-text">MyArray</code> 的构造函数修改，修饰新类型的一些内容。结果就是<br>
<code class="language-text">this</code> 将拥有基础类型的内置功能。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyArray</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span>
  <span class="token comment">// empty</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> colors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 1</span>

colors<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// undefined</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1
undefined</code></pre></div>
<p>也就是说要继承基础类型，必须“先使用基础类型构造函数去创建 <code class="language-text">this</code> ，然后对新类型<br>
做进一步扩充”，否则，如果相反的话， <code class="language-text">this</code> 由新类型创建，那只会拥有新类型的一些<br>
基本特征，后面才调用基础类型的话只是做了一个粉饰而已。  </p>
<h2>Symbol.species 符号属性<a id="orga2051c7"></a></h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyArray</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    subItems <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>items <span class="token keyword">instanceof</span> <span class="token class-name">MyArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>subItems <span class="token keyword">instanceof</span> <span class="token class-name">MyArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true</code></pre></div>
<p>通过 class-extends 的继承，不仅能让新类型实现原生类型的能力，而且也会改变一些默<br>
认行为，比如上面的 <code class="language-text">subItems instanceof MyArray</code> 的结果会是 <code class="language-text">true</code> ，这是因为<br>
<code class="language-text">Symbol.species</code> 在继承过程中影响了它的默认行为。  </p>
<p>Symbol.species 符号属性用来定义一个静态的访问器属性，返回一个函数。该函数被当做一个<br>
构造函数使用，每当一个类的实例必须在一个实例方法中被创建的时候(而不是使用构造函<br>
数)。  </p>
<p>以下内置类型定义了 <code class="language-text">Symbol.species</code> :  </p>
<ul>
<li><code class="language-text">Array</code></li>
<li><code class="language-text">ArrayBuffer</code></li>
<li><code class="language-text">Map</code></li>
<li><code class="language-text">Promise</code></li>
<li><code class="language-text">RegExp</code></li>
<li><code class="language-text">Set</code></li>
<li>Typed Arrays</li>
</ul>
<p>上面每个类型都有一个默认的 <code class="language-text">Symbol.species</code> 属性，返回 <code class="language-text">this</code> ，也就是说它总是会<br>
返回构造函数。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">getSpecies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>species<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSpecies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
  <span class="token comment">// 上面内置类型的 Symbol.species 默认实现，类似这里的实现</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>species<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get spcies'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
  <span class="token punctuation">}</span>

  <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this.constructor[Symbol.species] 会返回 MyClass 构造函数</span>
    <span class="token comment">// 因此这里也相当于是 new MyClass(this.value)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>constructor</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>species<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>species<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>constructor</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>species<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token comment">// empty</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>species<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">A</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    a1 <span class="token operator">=</span> instance1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token string">"bar"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    a2 <span class="token operator">=</span> instance2<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b <span class="token keyword">instanceof</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// #1: true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1 <span class="token keyword">instanceof</span> <span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// #2: true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c <span class="token keyword">instanceof</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// #3: true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a2 <span class="token keyword">instanceof</span> <span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// #4: false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
true
false</code></pre></div>
<p>#1: true 因为 A 是 B 的父类，在 B 实例的原型链之上，因此这里结果为 true。  </p>
<p>#2: true 因为 B 继承 A ，且 B 的实例 <code class="language-text">b</code> 中并没有重写 <code class="language-text">Symbol.species</code> 因此他会<br>
返回默认的 <code class="language-text">Symbol.species</code> 实现也就是该类自身的构造函数。  </p>
<p>#3: true 因为 C 继承 A，同 #1 。  </p>
<p>#4: false 这里结果意味着 <code class="language-text">C</code> 并不在实例 <code class="language-text">a2</code> 的原型链上，这是因为 C 中重写了<br>
<code class="language-text">Symbol.species</code> 改变了继承的默认行为。  </p>
<h2>new.target 属性</h2>
<p>在类中 <a href="#org52daa00">new.target</a> 永远不会是 <code class="language-text">undefined</code> 因为类名不能直接被调用。  </p>
<p>利用 <code class="language-text">new.target</code> 的特性：如果是通过 <code class="language-text">new</code> 调用它的值就是当前类的构造函数  </p>
<p>我们可以将一个类变成的抽象化，让它不能被用来创建实例，只能被其他类继承：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">===</span> Shape<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'不能被实例化。'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Rect</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 报错，不能被实例化</span>

<span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></code></pre></div>
<h2>小结</h2>
<ol>
<li>类声明，支持普通方式，表达式方式，不提升，性质和 <code class="language-text">let</code> 一样，存在 TDZ。</li>
<li>类可以直接作为表达式的一部分，也可以跟函数一样立即执行，还可以直接当做参数传<br>
递，可用来实现单例。</li>
<li>类成员的名称和普通对象一样使用计算属性，动态决定其属性名称。</li>
<li>类方法可以是生成器方法，返回迭代器。</li>
<li>类的静态方法(通过 <code class="language-text">static</code> 修饰的方法)会被子类继承到构造函数上。</li>
<li><code class="language-text">super()</code> 只能在继承式的子类构造函数中调用，且必须在使用 <code class="language-text">this</code> 之前调用，否<br>
则会报错。</li>
<li>父类，即 <code class="language-text">extends</code> 右边可以是动态的，只需要满足它的返回结果必须有<br>
<code class="language-text">[[Constructor] ]</code> 和自己的原型对象。</li>
<li>
<p>内置对象的继承，ES5的继承有缺陷，因为 <code class="language-text">this</code> 绑定的先后问题  </p>
<p>es5 先绑定新类型然后是基础类型修饰，es6 是先绑定基础类型，然后是新类型的修饰，<br>
这样将是该新类型具备基础类型的功能。</p>
</li>
<li><code class="language-text">Symbol.species</code> 只能在类方法内部使用，不能通过构造函数调用，返回当前类的构造<br>
函数。</li>
<li><code class="language-text">new.target</code> 类的该属性只会是构造函数，因为类本身是不可以直接调用的，通过它<br>
的特性可以让一个类抽象化，不能被实例化，只能被其他类继承。</li>
</ol>
<h1>提升数组能力(Array)</h1>
<h2>创建数组</h2>
<h3>Array.of(…items)</h3>
<p>ECMAScript5 中构建数组：通过 <code class="language-text">Array()</code> 构造函数，但是使用这种方式很容易产生疑惑，  </p>
<p>比如：  </p>
<p>值传递一个数值： <code class="language-text">new Array(2)</code> 则会创建一个长度为 2 的数组。  </p>
<p>传递一个字符串数值： <code class="language-text">new Array(&#39;2&#39;)</code> 则会当做一个数组元素，创建了一个元素的数组。  </p>
<p>传递多个参数的时候： <code class="language-text">new Array(3, &#39;2&#39;)</code> 则参数列表中的元素都会被当做数组元素。  </p>
<p>这对我们的使用并不是什么好事，有时候你可能只是想创建一个 <code class="language-text">2</code> 元素的数组而已，但<br>
是实际上是一个长度为 2 的空数组。  </p>
<p>ECMAScript6 中则新增了 <code class="language-text">Array.of()</code> 就不会有这种混淆，它只会将参数当做数组元素来<br>
创建数组，比如：  </p>
<p><code class="language-text">Array.of(1, 2)</code> ：两个元素的数组， arr[0] = 1, arr[1] = 2。  </p>
<p><code class="language-text">Array.of(2)</code> : 一个元素数组， arr[0] = 2。  </p>
<p><code class="language-text">Array.of(&#39;2&#39;)</code> ：一个元素的数组，arr[0] = ‘2’。  </p>
<blockquote>
<p><code class="language-text">Array.of()</code> 不使用 <code class="language-text">Symbol.species</code> 决定返回值得类型，它使用的是当前构造函数(在<br>
<code class="language-text">of()</code> 函数里面的 <code class="language-text">this</code>)来决定返回的正确数据类型。  </p>
</blockquote>
<h3>Array.from(items[, mapFn[, thisArg]])</h3>
<p><a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/#orgefbba01">Array.from 内部伪码实现-></a>  </p>
<p>将类数组的对象转换成数组类型，类数组对象：  </p>
<ol>
<li>有长度属性</li>
<li>有数值索引</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  length<span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> objArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objArr<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>objArr<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2
true
undefined</code></pre></div>
<p>对于类数组对象如果想使用数组的方法，以往都是通过 <code class="language-text">call(arrayLike)</code> 方式来调用的，<br>
比如： <code class="language-text">Array.prototype.slice.call(arrayLike)</code> 相当于 <code class="language-text">arrayLike.slice()</code> 借用一<br>
下数组的 <code class="language-text">slice</code> 方法因为该方法只要对象有数值索引和长度属性就可以了。  </p>
<p><strong>参数 mapFn</strong> ：让转换过程中可以改变被转换元素的结果值，意思就是如果 <code class="language-text">mapFn</code> 传递<br>
两个合法的函数，遍历过程中元素的值会进过 <code class="language-text">mapFn</code> 先处理一遍然后在返回到新的数组<br>
列表中。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  length<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token string">'0'</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token string">'1'</span><span class="token operator">:</span> <span class="token number">200</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> arr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token parameter">v</span> <span class="token operator">=></span> v <span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10000, 40000</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">10000 40000</code></pre></div>
<p><strong>参数 thisArg</strong> ：指定 <code class="language-text">mapFn</code> 的 <code class="language-text">this</code> 指向：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> helper <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token parameter">v</span> <span class="token operator">=></span> v <span class="token operator">*</span> v
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  length<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token string">'0'</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token string">'1'</span><span class="token operator">:</span> <span class="token number">20</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> arr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> helper<span class="token punctuation">.</span>add<span class="token punctuation">,</span> helper<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100, 400</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">100 400</code></pre></div>
<p><strong>用于可迭代的对象</strong> :  </p>
<p>在<a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/#orgefbba01">伪码</a>中可以知道 <code class="language-text">Array.from</code> 可以处理有迭代器的也可以处理无迭代器的，这里也可以<br>
使用与自定义迭代器的对象，而不需要具备类数组对象的特征(必须有 <code class="language-text">length</code> 和数值索<br>
引值)  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nums2 <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token parameter">v</span> <span class="token operator">=></span> v <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2, 3, 4</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2 3 4</code></pre></div>
<p>对应伪码中的实现：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 列表类型，有自己的迭代器</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>usingIterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 取出同步迭代器</span>
  <span class="token keyword">let</span> iteratorRecord <span class="token operator">=</span> <span class="token function">GetIterator</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> sync<span class="token punctuation">,</span> usingIterator<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> error<span class="token punctuation">;</span>

  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 循环启动迭代器，相当于自动调用了 iterator.next()</span>

    <span class="token comment">// ... 省略</span>

    <span class="token comment">// #1 调用 iterator.next() 启动迭代器，取下一个 yield 值</span>
    <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token function">IteratorStep</span><span class="token punctuation">(</span>iteratorRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ... 省略</span>

    <span class="token comment">// #2 取出当前迭代 { value: xxx, done: false } 中的 value 值</span>
    <span class="token keyword">let</span> nextValue <span class="token operator">=</span> <span class="token function">IteratorValue</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ... 省略</span>

    <span class="token comment">// #3 将迭代出的值，添加到数组 Pk 位置上。</span>
    <span class="token keyword">let</span> defineStatus <span class="token operator">=</span> <span class="token function">CreateDataPropertyOrThrow</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> Pk<span class="token punctuation">,</span> mappedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ... 省略</span>

    <span class="token comment">// #4 进入下一次循环。</span>
    k<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></div>
<p>如上，我们省略了部分代码，只保留我我们需要关注的地方：  </p>
<ol>
<li><code class="language-text">GetIterator(items, sync, usingIterator)</code> 会取出 items 对象的迭代器</li>
<li><code class="language-text">while(1)</code> 一个无限循环，用来触发迭代器，相当于 <code class="language-text">iterator.next()</code></li>
<li><code class="language-text">IteratorValue(next)</code> 取出迭代器 <code class="language-text">{value: xx, done: false}</code> 中 value 的值</li>
<li>最后将值添加到新数组 A 上， <code class="language-text">k++</code> 进入下一次 <code class="language-text">iterator.next()</code></li>
</ol>
<p><strong>用于类数组且可迭代的对象</strong> :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">{</span>
  length<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token string">'0'</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token string">'1'</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token operator">*</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> nums2 <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums2<span class="token punctuation">.</span>length<span class="token punctuation">,</span> nums2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3 1 2 3</code></pre></div>
<p>从结果看出使用的是 <code class="language-text">Symbol.iterator</code> 迭代器优先，这从伪码的处理过程中也可确定优<br>
先级。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Array<span class="token punctuation">.</span><span class="token function-variable function">from</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">items<span class="token punctuation">[</span><span class="token punctuation">,</span> mapFn<span class="token punctuation">[</span><span class="token punctuation">,</span> thisArg<span class="token punctuation">]</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// ...</span>

  <span class="token comment">// 取出类数组对象的迭代器，将用来取出有效的数组元素</span>
  <span class="token keyword">let</span> usingIterator <span class="token operator">=</span> <span class="token function">GetMethod</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> @@iterator<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 列表类型，有自己的迭代器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>usingIterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 迭代器判断在前</span>

    <span class="token comment">// .... return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 非列表类型，没有自己的迭代器，可能是个类数组对象</span>
  <span class="token keyword">let</span> arrayLike <span class="token operator">=</span> <span class="token function">ToObject</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 必须具备长度属性，才能转数组，这也是类数组对象必备条件之一</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token function">ToLength</span><span class="token punctuation">(</span><span class="token function">Get</span><span class="token punctuation">(</span>arrayLike<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// ...</span>

  <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类数组对象的判断在后</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function">Set</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token constant">A</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>原型上新增的方法</h2>
<h3>flat([depth])<sup>2019</sup></h3>
<p>扁平化数组，降维。 <code class="language-text">depth</code> 表示降多少次，如果是 <code class="language-text">Infinity</code> 则把数组降维到一维数<br>
组。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [ 1, 2, 3, 4, 5 ]</span></code></pre></div>
<h3>flatMap()<sup>2019</sup></h3>
<h3>find(mapFn[, thisArg]) &#x26; findIndex(mapFn[, thisArg])</h3>
<p>查找元素，<a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/#orgefbba01">内部实现伪码</a>。  </p>
<p>以往并没有什么内置的方法用来查找数组中的元素，一般我们都是使用 <code class="language-text">indexOf</code> 和<br>
<code class="language-text">lastIndexOf</code> 或者利用他们实现自己的自定义方法。  </p>
<p>ECMAScript 6 中新增了两个专门用来查找元素的两个方法：  </p>
<ul>
<li><code class="language-text">find(mapFn[, thisArg])</code> 返回满足条件的第一个元素值</li>
<li><code class="language-text">findIndex(mapFn[, thisArg])</code> 返回满足条件的第一个元素值的索引</li>
</ul>
<p>两个方法的 <code class="language-text">mapFn</code> 接受的参数与 <code class="language-text">map()</code> 和 <code class="language-text">forEach()</code> 一样，接收三个参数：  </p>
<ol>
<li><code class="language-text">value</code> 遍历当前值</li>
<li><code class="language-text">index</code> 当前索引</li>
<li><code class="language-text">array</code> 数组本身</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> n <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> n <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3>fill(value[, start[, end]])</h3>
<p><a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/#orgefbba01">fill 内部实现伪码</a>。  </p>
<p>从指定起始结束位置将数组元素替换成 <code class="language-text">value</code> 。  </p>
<p>参数：  </p>
<ul>
<li><code class="language-text">value</code> <em>required</em> 替换的值</li>
<li><code class="language-text">start</code> <em>optional</em>, 默认(0)， 起始位置</li>
<li><code class="language-text">end</code> <em>optional</em>, 默认(length)，结束位置</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 1, 1, 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2,2,2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2,3,3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 负数，len + (-1) = 3 => fill(1, 3);</span>
nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2,3,1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 负数，len + (-2) = 2 => fill(1, 2);</span>
nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2,1,1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 负数，start: len + -2 = 2 => fill(1, 2, 1)</span>
<span class="token comment">// 2 &lt; 1 => start &lt; end => 无效</span>
nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2,1,1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// start: len + -2 = 2</span>
<span class="token comment">// end: len + -1 = 3</span>
<span class="token comment">// => fill(1, 2, 3)</span>
nums<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2,4,1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1,1,1,1
1,2,2,2
1,2,3,3
1,2,3,1
1,2,1,1
1,2,1,1
1,2,4,1</code></pre></div>
<h3>copyWithin(target, start[, end])</h3>
<p><a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/">copyWithin 内部实现伪码。</a>  </p>
<p>方法功能：拷贝 <code class="language-text">count = start:0 - end:length</code> 之间的元素，用这些元素从<br>
target(<code class="language-text">num = target:0 - len</code> ) 位置开始替换数组内的元素，实际被替换的元素个数由<br>
<code class="language-text">num</code> 决定。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> res <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'>>> 拷贝元素个数 &lt;= len - 起始位置'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'res'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'nums'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums <span class="token operator">===</span> res<span class="token punctuation">,</span> <span class="token string">'res === nums ?'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'>>> 拷贝元素个数 > len - 起始位置'</span><span class="token punctuation">)</span>
nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
res <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'res'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'nums'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums <span class="token operator">===</span> res<span class="token punctuation">,</span> <span class="token string">'res === nums ?'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&gt;&gt;&gt; 拷贝元素个数 &lt;= len - 起始位置
4,5,3,4,5,6,7,8,9 res
4,5,3,4,5,6,7,8,9 nums
true &#39;res === nums ?&#39;
&gt;&gt;&gt; 拷贝元素个数 &gt; len - 起始位置
1,2,3,4,5,6,4,5,6 res
1,2,3,4,5,6,4,5,6 nums
true &#39;res === nums ?&#39;</code></pre></div>
<ol>
<li>如果 <code class="language-text">end - start</code> > <code class="language-text">len - target</code> 则只替换 <code class="language-text">len - target</code> 个元素</li>
<li>如果 <code class="language-text">end - start</code> &#x3C; <code class="language-text">len - target</code> 则只替换 <code class="language-text">end - start</code> 个元素</li>
</ol>
<p>被替换的元素个数决定因素： <code class="language-text">Math.min(end - start, len - target)</code> 取最小值得个数。  </p>
<h2>TODO 类型化数组(Typed Arrays)</h2>
<h2>TODO 类型化数组和普通数组的相似点</h2>
<h2>TODO 类型化数组和普通数组的不同点</h2>
<h2>TODO 小结</h2>
<h1>Promises和异步编程</h1>
<p>Nodejs 异步编程：事件触发 + 回调。  </p>
<p>Promise: 指定一些代码延时执行，并且可知道代码是否执行成功或失败，支持链式调用。  </p>
<p>为了更好的理解 Promise 如何工作，有必要了解一些与异步相关的基本概念。  </p>
<h2>Promise Apis</h2>
<h3>Promise.prototype.finally(onFinally)</h3>
<p>不管异步任务执行结果如何，都会在任务都完成之后被执行的代码。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p finally'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h2>异步编程背景</h2>
<p>JavaScript 引擎基于事件循环的单线程，单线程意味着一次只能执行一个代码片段。  </p>
<p>因此 JavaScript 引擎就需要去跟踪和管理这些代码片段，而这些代码片段会被一个叫“任<br>
务队列”的东西所持有，无论什么时候如果代码准备执行，它就会被添加到“任务队列”，当<br>
代码被执行完成，，事件循环就会开始执行队列中的下一个任务。  </p>
<p>在队列中，任务的执行顺序总是从第一个任务开始执行到最后一个人任务执行结束。  </p>
<h3>事件模型</h3>
<p>比如，用户点击了一个键盘上的按键，触发点击(<code class="language-text">onclick</code>)事件，那么引擎会通过在任务<br>
队列的末尾添加一个新的任务来响应这个事件，这也是 JavaScript 中最基本的异步编程模<br>
型，被添加到队列中的事件的回调并不会立即执行直到事件被触发，且被触发执行回调时<br>
候会拥有自己合适的上下文执行环境。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"my-btn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Clicked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>上面的按钮点击事件，在按钮点击之前是不会被执行，一旦按钮被点击，那么赋值给<br>
<code class="language-text">onclick</code> 的代码片段(或叫“任务”)就会立即被添加到“任务队列”的末尾，等待它前面的其<br>
他任务执行完成之后再执行(也就是说它不一定点击之后立即执行，前面可能还有其他任务<br>
在等待执行)。  </p>
<h3>回调模式</h3>
<p>在 JavaScript 中，我们最常用的异步莫过于回调的使用了，比如在读取一个文件的时候，<br>
读取完成之后要做一些处理，这个时候就会用到回调函数，因为读取文件相对来说是一个比<br>
较耗时的操作，不太可能使用同步进行处理，因此通过回调来处理异步读取文件是个非常不<br>
错的体验。  </p>
<p>比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hi!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>在读取 <code class="language-text">example.txt</code> 文件内容之后将其立即答应出来，这里的回调函数并不会立即执行，<br>
而是在文件读取完成之后，会立即被添加到“任务队列”的列尾，在其他在它前面的任务执行<br>
完成之后会被立即执行，这和上面讲的“事件模型”是一样的原理。  </p>
<p>这相对来说读取一个文件，然后执行输出这种算是比较简单的应用场景，而现实中往往并不<br>
是这样的，现实中往往是多个事情之间有其关联性，也就是说工人在流水线上工作的时候，<br>
就必须依赖于上一个人工作的传递才能继续往下执行，这如果体现在代码使用回调完成这将<br>
会不可思议(这也就是我们常说的回调地狱问题)：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">method1</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">method2</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">method3</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">method4</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">method5</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>method4 必须等待 method3 执行完成，<br>
method3 必须等待 method2 执行完成，<br>
…<br>
一直到 method1 执行完成，这无论是在逻辑还是代码阅读性上都将会让人崩溃。  </p>
<p>一直到 <code class="language-text">Promise</code> 的出现才比较有效的解决了这回调地狱及代码可读性的问题。  </p>
<h2>Promise 基础</h2>
<p>一个 promise 实例作为一个异步操作的结果返回，而不再使用时间绑定或将回调作为参数<br>
传递给一个函数的方式，现在一个函数可以直接返回一个 promise ，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'example.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>上面的代码中读取文件操作实际上并不会立即执行，而是返回了一个 promise 可以让你决<br>
定如何去响应这个读取文件操作。  </p>
<h3>Promise 的生命周期</h3>
<ul>
<li>
<p><em>pending</em>, 表示异步操作尚未完成，也被标记为 <em>unsettled</em> 。  </p>
<p>比如 <code class="language-text">let promise = readFile(&#39;example.txt&#39;);</code> 执行之后，这个 promise 状态就<br>
成为了 <em>pending</em> 一旦文件读取操作完成，该 promise 就会被设置为 <em>settled</em> ，随<br>
后进入下面两种状态的一种，且不可逆。</p>
</li>
<li><em>Fulfilled</em> : 表示该 promise 代表的异步任务执行成功</li>
<li><em>Rejected</em> : 表示该 promise 代码的异步任务执行失败了或者执行过程中出现异常等其<br>
它非正常结果。</li>
</ul>
<p>且 promise 有个内部属性 <code class="language-text">[[PromiseState] ]</code> 用来记录了整个 promise 状态的变化，<br>
它的值由三个： <em>pending</em>, <em>fulfilled</em>, <em>rejected</em> 对应着 promise 的三种不同状态。<br>
该内部属性没有对外的接口，因此是无法直接去访问或操作它的，但是 promise 提供了一<br>
个 <code class="language-text">then()</code> 方法，可以接受处理的结果(<em>fulfilled</em> 或 <em>rejected</em>)。  </p>
<p><code class="language-text">then(fulfilled, rejected)</code> 接受两个参数，这两个参数为函数类型，第一个会在<br>
promise 状态变成 <em>fulfilled</em> 的时候调用，第二个则会在 <em>rejected</em> 状态下调用。  </p>
<p><code class="language-text">fulfilled(data)</code> :  函数会接受 promise 成功之后传递出来的数据。  </p>
<p><code class="language-text">rejected(error)</code> : 函数会接受 promise 失败之后触发的异常数据。  </p>
<blockquote>
<p>任意对象只要实现了 <code class="language-text">then()</code> 方法都可以叫做一个 <em>thenable</em> ，所有的 promises 都是<br>
<em>thenable</em> 的，但并不是所有的 <em>thenable</em> 都是 promises 。  </p>
</blockquote>
<p>使用：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 上面代码我们只是将读取文件操作包装成了一个 promise 但是并没有立即去读<br>
取文件，且此刻 promise 的状态显示为 <em>pending</em> 。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Promise { &lt;pending&gt; }</code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 将触发 promise 状态发生改变</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: promise 成功之后的输出，状态将成为 <em>fulfilled</em> (这里没输出出来，o(╯□╰)o)。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Promise { &lt;pending&gt; }
Promise {
  &lt;Buffer 49 27 6d 20 61 20 70 72 6f 6d 69 73 65 20 65 78 61 6d 70 6c 65 2e 2e 2e 2e 2e 2e 0a&gt; }
&lt;Buffer 49 27 6d 20 61 20 70 72 6f 6d 69 73 65 20 65 78 61 6d 70 6c 65 2e 2e 2e 2e 2e 2e 0a&gt;</code></pre></div>
<p>+RESULTS: 读取失败之后状态为 <em>rejected</em> 的输出。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Promise { &lt;pending&gt; }
Promise {
  &lt;rejected&gt; { Error: ENOENT: no such file or directory, open &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json&#39;
    errno: -2,
    code: &#39;ENOENT&#39;,
    syscall: &#39;open&#39;,
    path:
     &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json&#39; } }
{ [Error: ENOENT: no such file or directory, open &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json&#39;]
  errno: -2,
  code: &#39;ENOENT&#39;,
  syscall: &#39;open&#39;,
  path:
   &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json&#39; }</code></pre></div>
<p>promise 也提供了一个 <code class="language-text">catch()</code> 接口给我们用来捕获异常，比如上面的例子还可以这样：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 将触发 promise 状态发生改变</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error in then'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error in catch'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 结果是 <code class="language-text">then</code> 中和 <code class="language-text">catch</code> 中都有执行  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Promise { &lt;pending&gt; }
error in then
{ [Error: ENOENT: no such file or directory, open &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json&#39;]
  errno: -2,
  code: &#39;ENOENT&#39;,
  syscall: &#39;open&#39;,
  path:
   &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-LzyRrW/config.json&#39; }</code></pre></div>
<p>使用 promise 有个好处就是，比如上面的遇到执行异常，它会将异常捕获并处暴露出来，<br>
一旦出现异常，或执行失败 promise 的状态会立即成为 <em>rejected</em> ，且无法逆转，即该<br>
promise 已经彻底完成(无关成功或失败)。  </p>
<p>而事件模型中如果发生错误，该事件就不会被触发，而在回调中你就必须时常记住去检查异<br>
常情况的出现可能性，并作出相应的处理。  </p>
<p>而在 promise 中异常会被捕获，如果你想针对异常做处理可以使用 then-reject 或<br>
<code class="language-text">catch()</code> 都行，如果不想处理就静默结束 promise 即可，而不用关心是否会导致任务失<br>
败而中断业务。  </p>
<p>一个 fufillment 或 rejection 的任务，如果在 promise 状态已经发生改变(<em>settled</em>,<br>
成为 <em>fulfilled</em> 或 <em>rejected</em> )的情况下，依然添加了新的任务，那么它依旧会继续执<br>
行。其实这也就相当于给其赋予了一个新的任务，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// original fulfillment handler</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// #1 now add another</span>
  promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>#1 处相当于针对 promise 又在任务队列末尾新增了一个任务，等待被执行。  </p>
<h3>创建 unsettled Promises</h3>
<p>通过 <code class="language-text">Promise</code> 构造函数可以创建一个 unsettled 状态的 promise 实例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'...outer'</span><span class="token punctuation">)</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'...inner'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 得到了一个 pending - unsettled 的 promise</span>
<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 触发 promise 任务，状态将变成 settled: fulfilled 或 rejected</span>
<span class="token comment">// #1 promise.then(data => console.log(data), err => console.log(err))</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: #1 注释之后的输出结果，Promise 的参数函数会立即执行。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">...outer
Promise { &lt;pending&gt; }
...inner</code></pre></div>
<p>+RESULTS: fulfilled 结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Promise { &lt;pending&gt; }
&lt;Buffer 49 27 6d 20 61 20 70 72 6f 6d 69 73 65 20 65 78 61 6d 70 6c 65 2e 0a&gt;</code></pre></div>
<p>+RESULTS: rejected 结果  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Promise { &lt;pending&gt; }
{ [Error: ENOENT: no such file or directory, open &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/config.json&#39;]
  errno: -2,
  code: &#39;ENOENT&#39;,
  syscall: &#39;open&#39;,
  path:
   &#39;/private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/config.json&#39; }</code></pre></div>
<ol>
<li>Promise 需要一个参数作为参数</li>
<li>该函数的参数有两个：1）resolve 任务执行成功之后调用，2）reject 任务失败调用</li>
<li>创建成功之后传递给 Promise 的函数会立即执行，并且将会在任务队列末尾添加一个任<br>
务去处理这个 promise，这被称为“任务调度”。</li>
<li>参数函数立即执行，但是 resolve 和 reject 会被当做异步任务添加到任务队列末尾去<br>
等待执行。</li>
</ol>
<h3>创建 settled Promises</h3>
<ol>
<li><code class="language-text">Promise.resolve()</code> 会创建一个状态必定是 <em>fullfilled</em> 的 promise</li>
<li><code class="language-text">Promise.reject()</code> 会创建一个状态必定是 <em>rejected</em> 的 promise</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">42</code></pre></div>
<p><code class="language-text">Promise.resolve()</code> 创建的 promise 状态永远只会是 <em>fulfilled</em> 因此， <code class="language-text">reject</code> 函数<br>
是永远不会执行的，同理 =Promise.reject()=。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vlaue<span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">100 &#39;1&#39;</code></pre></div>
<blockquote>
<p>如果给 <code class="language-text">Promise.resolve()</code> 或 <code class="language-text">Promise.reject()</code> 传递了一个 promise 那么它什么都<br>
不会做，直接原样返回这个 promise 。  </p>
</blockquote>
<h3>非 Promise 的 Thenables</h3>
<p>非 Promise 的 Thenable : 对象有自己的 <code class="language-text">then(resolve,reject)</code> 方法，那么就可以使<br>
用 <code class="language-text">Promise.resolve()</code> 或 <code class="language-text">Promise.reject()</code> 将该 thenable 转变成一个<br>
<code class="language-text">fulfilled</code> 或 <code class="language-text">rejected</code> 的 promise，至于到底是哪个状态的要取决于 thenable 函数<br>
内部是执行了 <code class="language-text">resolve()</code> 还是 <code class="language-text">reject()</code> 。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 变成了一个 Fulfilled promise</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">42</code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 变成了一个 Fulfilled promise</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">42</code></pre></div>
<h3>执行异常</h3>
<p>Promise 会在其内部将代码的执行过程，使用 <code class="language-text">try...catch</code> 捕获到异常，然后通过<br>
<code class="language-text">then(null, reject)</code> 或 <code class="language-text">catch(function(error){})</code> 将异常暴露出来。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Explosion!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Error: Explosion!
    at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/js-script-7ANcUx:3:9
    at new Promise (&lt;anonymous&gt;)
    at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/js-script-7ANcUx:2:15</code></pre></div>
<p>也可以手动捕获异常调用 <code class="language-text">reject()</code> :  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Explosion!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


promise<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 结果是一样的  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Error: Explosion!
    at /private/var/folders/kt/b5x0yl_56h1drdb8xgfmbk_r0000gn/T/babel-fFqHec/js-script-oIepKJ:4:11
    at new Promise (&lt;anonymous&gt;)</code></pre></div>
<h2>全局 Promise Rejection 处理</h2>
<p>在之前的章节我们讲过，如果 promise 中的状态变成 <em>rejected</em> ，可能是任务失败，或<br>
代码执行异常了，而这些异常实际上被捕获了，可以通过 <code class="language-text">then(null, reject)</code> 的<br>
reject 来接受或使用 <code class="language-text">catch(function(err){}</code> 捕获。  </p>
<p>正式由于这种灵活性导致我们很难决定这些异常什么时候应该被处理，哪些有被处理，哪些<br>
没有被处理，哪些又是什么时候被处理了???  </p>
<p>比如 promise 状态已经 <em>rejected</em> 完成了，但是 <em>rejection</em> 相关的处理却并没有在合<br>
适的时候得到处理，因为这完全取决于编程者愿不愿意或什么时候去调用 <code class="language-text">then(null,
   reject)</code> 或 <code class="language-text">catch(function(err){}</code> 去处理。  </p>
<p>在 ECMAScript6 版本中并没有涉及到该问题的解决。  </p>
<p>在浏览器端和 Node.js 已经更新解决了该痛点问题，但这并非是 ECMAScript 6 的一部分。  </p>
<h3>Node.js Rejection 处理</h3>
<p>在 Node.js 中有两个 <code class="language-text">process</code> 对象上的事件与 promise rejection 处理相关：  </p>
<ul>
<li><code class="language-text">unhandledRejection</code>: 在一个事件循环中一个 promise 状态已经 <em>rejected</em> 了，但<br>
是没有任何 rejection 操作被调用的时候触发。</li>
<li><code class="language-text">rejectionHandled</code>: 与上面的相反，表示状态 <em>rejected</em> 了，且有相关的 rejection<br>
操作被调用。</li>
</ul>
<p><code class="language-text">unahdnledRejection</code> 事件的回调接受两个参数，一个是 reason 失败原因，一个是该<br>
promise 对象本身，如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> rejected

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rejected <span class="token operator">===</span> promise<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

rejected <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Explosion!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Explosion!
true</code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> rejected

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token string">'unhandledrejection'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rejected <span class="token operator">===</span> promise<span class="token punctuation">,</span> <span class="token string">'unhandledrejection'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'rejectionHandled'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rejected <span class="token operator">===</span> promise<span class="token punctuation">,</span> <span class="token string">'rejectionHandled'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

rejected <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Explosion!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> rejected<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token string">'catch'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Explosion! unhandledrejection
true &#39;unhandledrejection&#39;
Explosion! catch
true &#39;rejectionHandled&#39;</code></pre></div>
<p>如上结果，首先触发的是 unhandledRejection 事件，1 秒之后 rejection 被<br>
<code class="language-text">catch()</code> 处理掉了，触发 rejectionHandled 事件。  </p>
<p>有了上面的基础，我们这里就可以实现一个简易的 <strong>unhandled rejections tracker</strong> ，来<br>
跟踪哪些 promise 的 rejection 有被处理，哪些没有被处理，如果没有可以针对这些<br>
rejection 做些什么事情。  </p>
<ol>
<li>使用 <code class="language-text">Map</code> 结构保存 <code class="language-text">promise =&gt; reason</code> 当前 Promise 和它的 rejection 没有被<br>
处理的原因。</li>
<li>监听 <code class="language-text">unhandledRejection</code> 事件，在这里面将 <code class="language-text">promise=&gt;reason</code> 添加到 map。</li>
<li>监听 <code class="language-text">rejectionHandled</code> 事件，这里执行删除，因为 rejection 已经被处理，不需要<br>
再保留了。</li>
</ol>
<p>这里使用的是强引用类型的 <code class="language-text">Map</code> ，因为我们需要能够用到的 promise 引用去获取当前的<br>
promise 执行设置或删除处理。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 需要使用 Map 强引用类型，因为 unhandledRejection 和 rejectionHandled</span>
<span class="token comment">// 需要用到同一个 promise</span>
<span class="token keyword">let</span> possiblyUnhandledRejections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'rejectionHandled'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">handleRejection</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 对每个 promise 的 rejection 进行处理</span>
<span class="token punctuation">}</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 每隔 6 秒检查一次 rejections ，如果有未处理的 rejection 就立即处理掉</span>
  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>message <span class="token operator">||</span> reason<span class="token punctuation">)</span>

    <span class="token function">handleRejection</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 处理完成之后清空 rejections</span>
  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span></code></pre></div>
<p>上面的代码功能：每隔 6 秒监听一次未处理的 promise rejections 的情况，如果有未处<br>
理的，就立即将它处理掉，然后清空 <code class="language-text">map</code> ，这样就不会存在没有被处理的 rejections<br>
了。  </p>
<h3>浏览器 Rejection 处理</h3>
<p>在浏览器端也是通过监听两个同名的事件来处理这些 rejections ，使用方式基本相同，只<br>
需要注意几点：  </p>
<ul>
<li><code class="language-text">unhandledRejection</code> 和 <code class="language-text">rejectionHandled</code> 两个事件是在 <code class="language-text">window</code> 对象上</li>
<li>
<p>事件的处理句柄的参数只有一个 <code class="language-text">event</code> ，指向的是当前事件对象，该对象内包含三个<br>
我们感兴趣的内容：  </p>
<ol>
<li><code class="language-text">type</code> : 事件类型， <code class="language-text">unhandledRejection</code> 或 <code class="language-text">rejectionHandled</code></li>
<li><code class="language-text">promise</code> : 当前的 promise 对象</li>
<li><code class="language-text">reason</code> : 当前的 rejection 产生的原因</li>
</ol>
</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> rejected<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onunhandledrejection</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// "unhandledrejection"</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// "Explosion!"</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rejected <span class="token operator">===</span> event<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onrejectionhandled</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// "rejectionhandled"</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// "Explosion!"</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rejected <span class="token operator">===</span> event<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

rejected <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Explosion!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p><strong>unhandled rejections tracking</strong> 代码和 Node.js 实现一样：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> possiblyUnhandledRejections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// when a rejection is unhandled, add it to the map</span>
<span class="token comment">// 与 nodejs 版本不同点：这里只有一个事件参数，而不是 reason,promise</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onunhandledrejection</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>promise<span class="token punctuation">,</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 与 nodejs 版本不同点：这里参数不再是 promise 而是事件对象</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onrejectionhandled</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>message <span class="token operator">?</span> reason<span class="token punctuation">.</span>message <span class="token operator">:</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// do something to handle these rejections</span>
    <span class="token function">handleRejection</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  possiblyUnhandledRejections<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>链式 Promises</h2>
<p>实际上，每次调用 <code class="language-text">then()</code> 或 <code class="language-text">catch()</code> 都是创建并返回了另一个 promise ，第二个<br>
promise 只会在第一个的状态已经 settled 之后(无论是 fulfilled 或 rejected)才会<br>
resolved。  </p>
<h3>链式 Promise 语法</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finished.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">42
finished.</code></pre></div>
<p>实际上调用第二个 <code class="language-text">then()</code> 的 promise 是一个全新的 Promise 。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finished.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1 <span class="token operator">===</span> p2<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
42
finished.</code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> p3
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'p3'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p3 <span class="token operator">===</span> p2<span class="token punctuation">,</span> <span class="token string">'p3 is not p2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1 <span class="token operator">===</span> p2<span class="token punctuation">,</span> <span class="token string">'p2 is not p1'</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 我们也可以显示的在上一个 <code class="language-text">then()</code> 里面返回一个 promise，从下面的第三行<br>
输出可知，下一个 <code class="language-text">then()</code> 处理的即上一个 <code class="language-text">then()</code> 里面返回的 promise，如果没有显<br>
式返回一个 promise 默认会创建一个新的 Promise 返回。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false &#39;p2 is not p1&#39;
42
100 &#39;p3&#39;
false &#39;p3 is not p2&#39;</code></pre></div>
<p>效果是一样的，但 p1 和 p2 并非同一个 promise。  </p>
<h3>异常捕获</h3>
<p>通过链式调用可以使用 <code class="language-text">catch()</code> 捕获上一个 promise 中的异常。  </p>
<p><a id="org8dd197d"></a>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'first then.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Boom!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'third then.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'100'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'four then.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 在第一个 <code class="language-text">catch()</code> 中返回一个 <code class="language-text">Promise.resolve(&#39;100&#39;)</code> 结果，这也说明<br>
`four then` 来自 <code class="language-text">catch()</code> 里面的 promise.resolve。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">first then.
Boom!
100 four then.</code></pre></div>
<p>+RESULTS: four then 有输出，这是因为之前的异常已经被上一个 <code class="language-text">catch()</code> 捕获并处理<br>
了， promise 恢复正常状态。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">first then.
Boom!
four then.</code></pre></div>
<p>+RESULTS: 新增 first then 结果，异常之后得 thenable 不会被执行，因为该 promise<br>
已经终结。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">first then.
Boom!</code></pre></div>
<p>+RESULTS: 新增 third then 输出和之前的一样，因为前面的发生了异常后面的就无法再<br>
继续了。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Boom!</code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Boom!</code></pre></div>
<p>从以上结果，不难看出，如果链式 promise 当中有一处发生异常，会终结这个 promise 链，<br>
除非后面有一个 <code class="language-text">catch()</code> 将该异常捕获并处理掉了，才能继续在链后面追加 <code class="language-text">then()</code><br>
。  </p>
<blockquote>
<p>通常情况下，最好是在链式调用的结束有一个 rejection 处理(<code class="language-text">reject</code> 或 <code class="language-text">catch</code>)，确<br>
保链式调用中出现的异常能得到适当的处理。  </p>
</blockquote>
<h3>Promise 链式调用中返回值</h3>
<p>其实在<a href="#org8dd197d">上一节的实例</a>中，我们就已经用到了在 <code class="language-text">thenable</code> 中返回一个值，该例中是直接返<br>
回了一个 <code class="language-text">Promise.resolve()</code> 其本身就是返回了一个新的 Promise 对象，其实我们还可<br>
以直接返回一个普通的表达式或者其他类型的值，它的结果最终也会被封装成一个新的<br>
Promise 实例返回出来。  </p>
<p>返回值：  </p>
<ol>
<li>普通类型值或表达式</li>
<li><code class="language-text">Promise.resolve()</code> 或 <code class="language-text">Promise.reject()</code></li>
<li>或者直接 <code class="language-text">new Promise()</code> 返回一个全新的 promise</li>
<li>还可以返回另一个已经存在的 promise 实例</li>
<li>前面出现的异常即可以用 rejection 来接收，也可以使用 <code class="language-text">catch()</code> 来接受，实际根<br>
据需要作出选择</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 42</span>
  <span class="token keyword">return</span> value <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 43</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 44</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Boom!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Boom!</span>
  <span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> p2
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'end here.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 上一个的异常可以使用 rejection 接受</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// end here.</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'end end here.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 也可以用 catch 来接受</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">42
43
44
Boom!
100
end here.
end end here.</code></pre></div>
<p>返回值也可以在一个 rejection，比如 <code class="language-text">catch()</code> 中使用。  </p>
<h2>响应多个 Promises</h2>
<p>在之前的章节中，我们所使用的实例都是一次只能接受处理一个 promise，但是，如果你想<br>
要同时去接收多个 promise 且下一步的行为由这些多个 promise 共同决定的时候，就需要<br>
考虑使用下面这两个方法。  </p>
<ul>
<li><code class="language-text">Promise.all()</code> 所有的 promise 状态完成了，才会被视为 resolved。</li>
<li><code class="language-text">Promise.race()</code> 多个 promise 只要有一个状态完成了，那么 <code class="language-text">race()</code> 就被视为已经<br>
完成</li>
</ul>
<h3>Promise.all(iterable)</h3>
<p>参数 iterable 是一个元素为 promise 的列表，该接口的含义是只有 iterable 中所有的<br>
promise 状态都为 resolved 了，这个接口返回的 promise 才会是 resolved ，否则只要<br>
有一个 rejected 了，返回的 promise 就会是 rejected。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1 <span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span>
p4<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 结果是由 p1, p2, p3 的结果值组成的数组</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42, 43, 44</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
42,43,44</code></pre></div>
<blockquote>
<p><code class="language-text">Promise.all()</code> 是：一荣俱荣(resolved)，一损俱损(rejected)，大家都在一条船上，一根<br>
绳上的蚂蚱，谁也别想偷懒。  </p>
</blockquote>
<p>只要有一个 rejected 的了，那么立即 rejected 不会得到其他的 promise 完成：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1 <span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span>
p4<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 结果是由 p1, p2, p3 的结果值组成的数组</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42, 43, 44</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 因为只要有一个 rejected 了，就会立即 rejected 因此异常的结果值只会是所<br>
有 promises 中的一个。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
43</code></pre></div>
<h3>Promise.race(iterable)</h3>
<p>iterable 中的所有 promises 属于竞争关系，利己主义者，并且不管第一个状态完成的状<br>
态是 fulfilled 或 rejected 只要是 settled 那么 <code class="language-text">race()</code> 就会立即 settled。  </p>
<p><em>race() 中的每个 promise 都是自私鬼，宁愿自己失败也要赶在第一时间将大伙消灭(主体<br>
promise 都结束了)</em>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1 <span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span>
p4<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">42</code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> timeout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>

<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1 <span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">)</span>
p4<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 43</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">43</code></pre></div>
<h3>异步任务执行器</h3>
<p>在之前的章节<a href="#orgb88e39f">9.8.1</a>中我们有使用 iterator + generator 实现一个简易的异<br>
步任务执行函数，会在上一个任务完成之后立即启动下一个任务，如此往复直到所有任务都<br>
完成为止。  </p>
<p>在这里我们将使用 Promise 来实现它：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">taskDef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token function">taskDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里不用判断值是什么类型，promise.resolve 统统转成 promise</span>
      <span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">)</span>
  <span class="token comment">// do something with response data</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Promise 版本需要注意的点：  </p>
<ol>
<li><code class="language-text">readFile</code> 即任务函数必须返回一个 Promise 对象</li>
<li>在 <code class="language-text">step()</code> 里面讲迭代器的值无论什么类型，让它变成一个 promise ，通过<br>
<code class="language-text">then()</code> 去接受执行结果， <code class="language-text">catch()</code> 去捕获并处理异常。</li>
</ol>
<p>Promise 版本相对于 iterator + generator 版本有点：  </p>
<ol>
<li>不用关心迭代器中 value 的值是什么类型，只要转成 promise</li>
<li>能有效的处理异常，使用 <code class="language-text">catch()</code> 捕获异常，不用中断程序</li>
<li>不用使用回调传递(readFile 返回一个带有回调的函数，这个回调会被传递到迭代器的<br>
value 值，但实际最后被使用的是 readFile 中的 <code class="language-text">fs.readFile()</code>)，而使用 Promise<br>
就不需要关心回调是如何被传递和执行了。</li>
</ol>
<h3>未来异步任务执行器(async…await)</h3>
<p>在 ECMAScript 2017(es8) 中引入了一个新的语法糖： <code class="language-text">async...await</code> 这让异步任务变<br>
得异常简单，其内部实现也是基于 Promise 来实现的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/config.json'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&lt;Buffer 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 0a 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 78 ... &gt;
Done</code></pre></div>
<h2>小结</h2>
<ul>
<li>Promise 有三个状态： pending(创建之初时), fulfilled(执行成功) 和 rejected(执行<br>
失败或异常)，且状态一旦改变就无法逆转。</li>
<li><code class="language-text">promise.then(resolve, reject)</code> 用回调来接收上一个 promise 执行成功或失败的结<br>
果</li>
<li><code class="language-text">catch(rejection)</code> 失败或异常处理可以用 <code class="language-text">then(null, reject)</code> 来接受之外也可以<br>
使用 <code class="language-text">catch</code> ，并且建议在每个链式 promise 调用结尾保证总有一个 <code class="language-text">catch()</code> 来保<br>
证异常能被捕获到并得到处理</li>
<li><code class="language-text">Promise.all(iterable)</code> 所有的 promise resolved 才能 resolved</li>
<li><code class="language-text">Promise.race(iterable)</code> 所有的 promise 之间处于竞争关系，只要有一个首先<br>
settled 之后该 <code class="language-text">race()</code> 就结束，状态由第一个 settled 的 promise 决定。</li>
<li>Promise 链式调用，中每一个 <code class="language-text">then()</code> 中都会默认返回一个新的 promise 给后面的<br>
<code class="language-text">then()</code> 也可以显示返回，如果显示返回的是一个普通值或表达式则会被封装成一个<br>
promise，如果是一个 promise 则会被原样返回。</li>
<li>结合 promise 和 generator 将让异步任务执行器更加容易</li>
<li>es8 中的 async…await 语法糖将让异步任务执行更加简易</li>
</ul>
<h1>Proxies 和 Reflection Api</h1>
<p>ECMAScript 5 和 ECMAScript 6 出现的目的都是为了简化 JavaScript 的使用，在<br>
ECMAScript 5 之前在 JavaScript 环境中包含一些拥有不能枚举(nonenumerable)和不能写<br>
入(nonwritable)的对象属性，但是开发者却不能给自己声明的对象添加不能枚举和不能写<br>
入的属性，因为并没有任务接口能使用，知道 ECMAScript 5 出现之后增加了<br>
<code class="language-text">Object.defineProperty()</code> 方法，可以让开发者为自己的对象属性修改其描述符对象，从<br>
而增加不可写或不可枚举的属性等。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'100'</span><span class="token punctuation">,</span>
  enumerable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不可枚举</span>
  writable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不可赋值改变</span>
  configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token string">'count'</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token string">'prop'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">100 count</code></pre></div>
<ol>
<li>输出 100 表示 <code class="language-text">obj.count = 3</code> 并没有生效</li>
<li>for..in 中没有输出，说明 <code class="language-text">count</code> 不能被枚举</li>
</ol>
<p>ECMAScript 6 中赋予了开发者更多干涉 JavaScript 引擎工作的能力，它通过 <em>proxies</em><br>
将一些内部操作暴露出来， <em>proxies</em> 是一些包可以中断或拦截引擎的一些操作包装器。<br>
这一章节将开始于 <em>proxies</em> 相关的知识和使用。  </p>
<h2>数组问题(Array Problem)</h2>
<p>比如，长度的问题，我们可以通过控制参数组的长度来达到控制数组内容的目的。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'black'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'black'</span>

colors<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 相当于截取了数组，后面的元素将被丢弃</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'green'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3
4
black
2
undefined
undefined
green</code></pre></div>
<blockquote>
<p>这一非标准的行为也是为什么数组在 ECMAScript 6 中被视为异类了。  </p>
</blockquote>
<h2>什么是 Proxies 和 Reflection<a id="org0c2ba4d"></a></h2>
<p>我们可以通过 <code class="language-text">new Proxy()</code> 创建一个 <em>proxy</em> 用来代替另一个对象(假设叫：<br>
<em>target</em>)使用。这个 proxy 会虚拟化这个 target 以至于 proxy 和 target 能好似一个<br>
东西一样被使用。  </p>
<p>就相当于给 target 生了个孪生兄弟，用法功能都差不多，甚至可以当做是一个人。  </p>
<p>Proxies 允许你可以中断低级对象操作(偏底层的操作, low-level object operations)，<br>
这些操作可以被 <em>trap</em> 函数(一个可响应特定操作的函数)中断  </p>
<p><code class="language-text">Relect</code> 对象，是一组方法的集合，为一些低级操作提供了默认行为(这些行为可以通过<br>
proxies 重写)。对于每一个 proxy trap 都有一个 <code class="language-text">Relect</code> 方法与之对应，且这些方法<br>
和他们的 proxy traps 有一样的名字且传递了一样的参数。  </p>
<p>下表列出了一些默认行为和 proxy trap 的对应关系：  </p>
<table>
<thead>
<tr>
<th>proxy trap</th>
<th>重写的行为</th>
<th>默认行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>get <a href="#org38c7be9">13.3.3</a></td>
<td>读取一个对象属性值</td>
<td><code class="language-text">Reflect.get()</code></td>
</tr>
<tr>
<td>set <a href="#org999196c">13.3.2</a></td>
<td>设置属性值</td>
<td><code class="language-text">Reflect.set()</code></td>
</tr>
<tr>
<td>has</td>
<td>是否包含</td>
<td><code class="language-text">Reflect.has()</code></td>
</tr>
<tr>
<td>deleteProperty</td>
<td><code class="language-text">delete obj.name</code> 删除对象属性操作</td>
<td><code class="language-text">Reflect.deleteProperty()</code></td>
</tr>
<tr>
<td>getPrototypeOf</td>
<td><code class="language-text">Object.getPrototypeOf()</code></td>
<td><code class="language-text">Reflect.getPrototypeOf()</code></td>
</tr>
<tr>
<td>setPrototypeOf</td>
<td><code class="language-text">Object.setPrototypeOf()</code></td>
<td><code class="language-text">Reflect.setPrototypeOf()</code></td>
</tr>
<tr>
<td>isExtensible</td>
<td><code class="language-text">Object.isExtensible()</code></td>
<td><code class="language-text">Reflect.isExtensible()</code></td>
</tr>
<tr>
<td>preventExtensions</td>
<td><code class="language-text">Object.preventExtensions()</code></td>
<td><code class="language-text">Reflect.preventExtensions()</code></td>
</tr>
<tr>
<td>getOwnPropertyDescriptor</td>
<td><code class="language-text">Object.getOwnPropertyDescriptor()</code></td>
<td><code class="language-text">Reflect.getOwnPropertyDescriptor()</code></td>
</tr>
<tr>
<td>defineProperty</td>
<td><code class="language-text">Object.definePropery()</code></td>
<td><code class="language-text">Reflect.definePropery()</code></td>
</tr>
<tr>
<td>ownKeys</td>
<td><code class="language-text">Object.keys()</code>, <code class="language-text">Object.getOwnPropertyNames()</code>, <code class="language-text">Object.getOwnPropertySymbols()</code></td>
<td><code class="language-text">Reflect.ownKeys()</code></td>
</tr>
<tr>
<td>apply</td>
<td><code class="language-text">fn.apply(thisArg, argsArr)</code></td>
<td><code class="language-text">Reflect.apply()</code></td>
</tr>
<tr>
<td>construct</td>
<td><code class="language-text">new Ctor()</code></td>
<td><code class="language-text">Reflect.construct()</code></td>
</tr>
</tbody>
</table>
<p>每一个 trap 重写了 JavaScript 对象的内置行为，允许中断和修改这些行为。如果依然需<br>
要用到内置行为，可以使用对应的 reflection api 方法。  </p>
<blockquote>
<p>原来 ECMAScript 6 规范中有一个叫 <code class="language-text">enumerate</code> 的 trap，被设计用来改变 <code class="language-text">for...in</code><br>
和 <code class="language-text">Object.keys()</code> 枚举对象属性的行为。但是在 ECMAScript 7 中随即被移除，原因是<br>
实现起来比较困难，因此以后都不会有 <code class="language-text">enumerate</code> 了。  </p>
</blockquote>
<h2>使用 Proxies 和 Reflection</h2>
<h3>Proxy 简单应用</h3>
<p>使用 <code class="language-text">new Proxy(target, handler)</code> 创建一个 proxy 时候需要传递两个参数：  </p>
<ul>
<li><code class="language-text">target</code> 需要被代理的那个对象</li>
<li><code class="language-text">handler</code> 一个定义了一个或多个 proxy traps 的对象</li>
</ul>
<p>proxy 将使用所有操作的默认行为，除非在 <code class="language-text">handler</code> 中定义了对应的 proxy trap。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'proxy'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'proxy'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'proxy'</span>

target<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'target'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'target'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'target'</span></code></pre></div>
<p>+RESULTS: target 和 proxy 对象之间互相影响  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">proxy
proxy
target
target</code></pre></div>
<p>在这个例子上， proxy 代理了 target 对象的所有默认行为(因为传入了一个空的 <code class="language-text">{}</code> 对<br>
象给 <code class="language-text">Proxy()</code> )。也就是说对 target 和 proxy 对象的所有行为都会在两个对象上有所<br>
体现，形同操作对方本身一样。  </p>
<p><del>像这个简单的 proxy 例子，代理了 target 但是却没有提供任何 traps，这并没有任何意义</del>  </p>
<h3>用 <code class="language-text">set(trapTarget, key, value, receiver)</code> trap 验证属性<a id="org999196c"></a></h3>
<p>假设你想创建一个属性值必须是数值类型的对象，这意味着每一个新增的属性必须要有一个<br>
验证机制去确保它是一个数值类型，否则就要抛出异常。  </p>
<p>为了实现这个功能，我们可以使用 proxy 的 <code class="language-text">set</code> trap 去重写赋值的默认行为。  </p>
<p><code class="language-text">set</code> trap 接受四个参数：  </p>
<ol>
<li><code class="language-text">trapTarget</code> 那个被代理的对象 target，也是即将被新增属性的那个对象</li>
<li><code class="language-text">key</code> 新增属性的 key 值(字符串或符号类型)</li>
<li><code class="language-text">value</code> 新增属性的值，将要被检测的内容</li>
<li><code class="language-text">receiver</code> 该操作的目标对象(一般就是 target 的代理实例 proxy)</li>
</ol>
<p><code class="language-text">set</code> => 赋值操作 => <code class="language-text">Reflect.set()</code>  </p>
<p>在“<a href="#org0c2ba4d">什么是 Proxies 和 Reflection</a>”一节就将过 proxy trap 和 reflect 对应的操作函数<br>
名称和参数都是一模一样的，也就是说 <code class="language-text">Reflect.set()</code> 也将接受 <code class="language-text">set</code> trap 一样的四<br>
个参数： trapTarget, key, value, receiver 且含义一样。  </p>
<p><code class="language-text">Reflect.set()</code> 的返回值为 true/false ，成功为 true 失败为 false，且在 <code class="language-text">set</code><br>
trap 中也应该要返回一个 boolean 值表示该 trap 是否成功或失败了，一般直接返回<br>
<code class="language-text">Reflect.set()</code> 的返回值即可。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'target'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>trapTarget <span class="token operator">===</span> target<span class="token punctuation">,</span> <span class="token string">'trapTarget is target'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trapTarget<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'属性必须是 `number` 类型！'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 添加一个属性</span>
proxy<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>count<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'proxy'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true &#39;trapTarget is target&#39;
1
1
true &#39;trapTarget is target&#39;
proxy
proxy
undefined</code></pre></div>
<p>如上面的例子，操作 proxy 就像直接操作 target 一样，所有的操作都能在 target 上面<br>
有所体现，但是使用 proxy &#x26; reflect 和直接操作 target 的好处是，允许我们拦截这一<br>
底层操作，从而对其进行一些额外的处理。  </p>
<h3><code class="language-text">get(trapTarget, key, receiver)</code> trap<a id="org38c7be9"></a></h3>
<p>获取对象属性值的操作代理。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'错误：属性 '</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">' 不存在。'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// proxy.name = 'proxy'</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'proxy'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">错误：属性 name 不存在。
proxy</code></pre></div>
<h3><code class="language-text">has(trapTarget, key)</code> trap <a id="org46d3f0c"></a></h3>
<ul>
<li><code class="language-text">trapTarget</code> 被代理的那个对象(比如： <code class="language-text">target</code>)</li>
<li><code class="language-text">key</code> 被检测的属性的名称</li>
</ul>
<p><code class="language-text">in</code> 操作符可以用来检测一个属性是否存在于指定对象或者它的原型上，如果能找到返回 <em>true</em>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> target<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'toString'</span> <span class="token keyword">in</span> target<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true</code></pre></div>
<p><code class="language-text">in</code> 操作符在 Proxy 中对应的是 <code class="language-text">has</code> -> <code class="language-text">Reflect.has(trapTarget, key)</code> 接口。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'target'</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key <span class="token operator">===</span> <span class="token string">'value'</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'toString'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
true
true</code></pre></div>
<h3><code class="language-text">deleteProperty(trapTarget, key)</code> trap 删除对象属性(<em>delete</em> 关键词的使用) <a id="orgb519cd2"></a></h3>
<p><code class="language-text">delete</code> 操作符会将对象中的属性从这个对象中移除，如果成功返回 <code class="language-text">true</code> 否则返回<br>
<code class="language-text">false</code> ，在严格模式下试图删除一个 <em>non-configurable</em> 的属性会报错，非严格模式下<br>
会返回 <code class="language-text">false</code> 。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'target'</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  configurable<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">let</span> res1 <span class="token operator">=</span> <span class="token keyword">delete</span> target<span class="token punctuation">.</span>value

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token keyword">let</span> res2 <span class="token operator">=</span> <span class="token keyword">delete</span> target<span class="token punctuation">.</span>name <span class="token comment">// error 严格模式</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2<span class="token punctuation">,</span> <span class="token string">"严格模式"</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name'</span> <span class="token keyword">in</span> target<span class="token punctuation">,</span> <span class="token string">"删除失败"</span><span class="token punctuation">)</span> <span class="token comment">// true 删除失败</span></code></pre></div>
<p>通过 proxy 的 <code class="language-text">deleteProperty</code> -> <code class="language-text">deleteProperty(trapTarget, key)</code> 代理 delete<br>
行为：  </p>
<ul>
<li><code class="language-text">trapTarget</code> 被代理的对象</li>
<li><code class="language-text">key</code> 被删除的属性名称</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'target'</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key <span class="token operator">===</span> <span class="token string">'value'</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">)</span>

<span class="token keyword">let</span> res1 <span class="token operator">=</span> <span class="token keyword">delete</span> proxy<span class="token punctuation">.</span>value
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">,</span> <span class="token string">'删除失败'</span><span class="token punctuation">)</span> <span class="token comment">// true, 删除失败</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">delete</span> proxy<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'name'</span> <span class="token keyword">in</span> proxy<span class="token punctuation">)</span> <span class="token comment">// true false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
false
true &#39;删除失败&#39;
true
true false</code></pre></div>
<h2>原型代理Traps(Prototype Proxy Traps)<a id="org9c538fc"></a></h2>
<p>与原型有关的 traps :  </p>
<ol>
<li><code class="language-text">getPrototypeOf(trapTarget)</code> -> <code class="language-text">Object.getPrototypeOf(trapTarget)</code> -><br>
<code class="language-text">Reflect.getPrototypeOf(trapTarget)</code></li>
<li><code class="language-text">setPrototypeOf(trapTarget, proto)</code> -> <code class="language-text">Object.setPrototypeOf(trapTarget, proto)</code> -><br>
<code class="language-text">Reflect.setPrototypeOf(trapTarget, proto)</code></li>
</ol>
<h3>原型代理 Traps 工作原理</h3>
<p>在使用原型 trap 的时候有一些严格的规定：  </p>
<ol>
<li><code class="language-text">getPrototypeOf</code> trap 必须返回一个对象或者 <code class="language-text">null</code> ,如果是其他值就会发生运行时<br>
错误</li>
<li><code class="language-text">setPrototypeOf</code> 在失败的时候必须返回 <code class="language-text">false</code> ，如果不是那么默认会被当做成功<br>
处理</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">trapTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> targetProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">let</span> proxyProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetProto <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyProto <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyProto<span class="token punctuation">)</span> <span class="token comment">// null</span>

Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// succeed</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// error</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
false
null
&#39;setPrototypeOf&#39; on proxy: trap returned falsish</code></pre></div>
<p>使用默认行为(<code class="language-text">Reflect.get/setPrototypeOf()</code>)  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">trapTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> proto<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> targetProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">let</span> proxyProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetProto <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyProto <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxyProto<span class="token punctuation">)</span> <span class="token comment">// null</span>

Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// succeed</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// error</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
{}</code></pre></div>
<h3>为什么有两种方法?(Reflect 和 Object 上都有 get/setPrototypeOf)</h3>
<p><strong>相同点</strong> ：  </p>
<p>最终都是操作的内部属性： <code class="language-text">[[GetPrototypeOf] ]</code> 和 <code class="language-text">[[setPrototypeOf] ]</code>  </p>
<p><strong>不同点</strong> :  </p>
<table>
<thead>
<tr>
<th></th>
<th><code class="language-text">getPrototypeOf</code></th>
<th><code class="language-text">setPrototypeOf</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">Object</code></td>
<td>参数会被强转成对应的对象</td>
<td>失败抛异常，成功返回 trapTarget</td>
</tr>
<tr>
<td><code class="language-text">Reflect</code></td>
<td>参数只能是对象，否则报错</td>
<td>失败返回 <code class="language-text">false</code> , 成功返回 <code class="language-text">true</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>参数不同点：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Reflect<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
Reflect.getPrototypeOf called on non-object</code></pre></div>
<p>返回值不同点：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> res1 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>target1<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1 <span class="token operator">===</span> target1<span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">let</span> target2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> res2 <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>target2<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2 <span class="token operator">===</span> target2<span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
false
true</code></pre></div>
<h2>对象扩展性 Traps(Object Extensibility Traps)<a id="orgfd5f8b6"></a></h2>
<p>在 ECMAScript 5 中新增了两个方法： <code class="language-text">Object.preventExtensions()</code> 和<br>
<code class="language-text">Object.isExtensible()</code> 用来阻止对象被扩展和检测对象的扩展性，这两个 api 都只<br>
有一个参数 <code class="language-text">trapTarget</code> 表示作用的对象，返回值都是 <code class="language-text">boolean</code> 前者表示阻止是否<br>
成功，后者表示对象是否可扩展，在 proxy-reflect 中也有相应的 api 与之对应，且<br>
参数和返回值均一样。  </p>
<p><code class="language-text">Object.preventExtensions()</code> 阻止给对象增加属性：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

target<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'xxx'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token comment">// true</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

target<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">'100'</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token string">'166'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS: <code class="language-text">age</code> 并没有被添加, <code class="language-text">height</code> 添加报错  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true { value: 42, name: &#39;xxx&#39; }
Cannot define property height, object is not extensible
false { value: 42, name: &#39;xxx&#39; }
undefined</code></pre></div>
<p>代理：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">isExtensible</span><span class="token punctuation">(</span><span class="token parameter">trapTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'is extensible ...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token parameter">trapTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'preventing extension'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS: 因为使用了 Reflect.xxx 所以作用在 proxy 上的操作也将体现在 target 上  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true &#39;before&#39;
is extensible ...
true &#39;before&#39;
preventing extension
false &#39;after&#39;
is extensible ...
false &#39;after&#39;</code></pre></div>
<p>如果总是允许代理对象能被扩展，只需要在代理的 <code class="language-text">preventExtensions</code> trap 中直接返回<br>
<code class="language-text">false</code> 就行了，但是并不影响 <code class="language-text">target</code> 除非调用了 <code class="language-text">reflect</code> 。  </p>
<p>Reflect 和 Object 上的区别：  </p>
<table>
<thead>
<tr>
<th></th>
<th><code class="language-text">isExtensible</code></th>
<th><code class="language-text">preventExtensions</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">Reflect</code></td>
<td>参数非对象，触发异常</td>
<td>参数非对象，触发异常</td>
</tr>
<tr>
<td><code class="language-text">Object</code></td>
<td>参数非对象，总是返回 <code class="language-text">false</code></td>
<td>参数非对象，会返回该参数自身</td>
</tr>
</tbody>
</table>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res1 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Reflect<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> res2 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Reflect<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
Reflect.isExtensible called on non-object
1
Reflect.preventExtensions called on non-object</code></pre></div>
<h2>属性描述符 Traps(Property Descriptor Traps)<a id="org4910730"></a></h2>
<p>ECMAScript 5 更新中包含了可以通过 <code class="language-text">Object.defineProperty(obj, key, descObj)</code> 自<br>
定义属性的功能，这让开发者可以自己定义一些特定功能的对象属性，比如：只读、只写、<br>
或不可枚举等等特性，然后可以通过 <code class="language-text">Object.getOwnPropertyDescriptor()</code> 来获取对象<br>
属性的描述符对象。  </p>
<p><a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/">Object.defineProperty() 详细使用</a>  </p>
<h3>属性描述符代理<a id="orgb70d1c1"></a></h3>
<p>在 proxy-reflect 中对应着：  </p>
<ul>
<li><code class="language-text">defineProperty</code> -> <code class="language-text">Reflect.defineProperty(trapTarget, key, descriptor)</code></li>
<li><code class="language-text">getOwnPropertyDescriptor</code> -> <code class="language-text">Reflect.getOwnPropertyDescriptor(trapTarget, key)</code></li>
</ul>
<p>返回值：  </p>
<p><code class="language-text">defineProperty</code> 成功返回 <code class="language-text">true</code>, 失败返回 <code class="language-text">false</code>  </p>
<p><code class="language-text">getOwnPropertyDescriptor</code> 成功返回描述符  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">definePropery</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'proxy'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'proxy'</span>

<span class="token keyword">let</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 'proxy'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">proxy
proxy</code></pre></div>
<p>阻止给对象扩展符号属性：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> key <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'proxy'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'proxy'</span>
<span class="token keyword">let</span> nameSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// error</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> nameSymbol<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token string">'symbol-proxy'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">proxy
&#39;defineProperty&#39; on proxy: trap returned falsish for property &#39;Symbol(name)&#39;</code></pre></div>
<p>因为 <code class="language-text">Object.defineProperty()</code> 返回 <code class="language-text">false</code> 的话会触发异常表示扩展失败。  </p>
<p>如果想要扩展失败隐藏异常，可以在 trap 中不满足条件的时候也让它返回 <code class="language-text">true</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> key <span class="token operator">===</span> <span class="token string">'symbol'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'proxy'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'proxy'</span>
<span class="token keyword">let</span> nameSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// error</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> nameSymbol<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'symbol-proxy'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 运行结果无错误提示，因为 <code class="language-text">key === &#39;symbol&#39;</code> 条件中依旧返回了 <code class="language-text">true</code>  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">proxy</code></pre></div>
<div class="org-center">
标准中失败抛异常：  
<p><img src="http://qiniu.ii6g.com/1565166438.png" alt="img">  </p>
</div>
<h3>描述符对象约束(Descriptor Object Restrictions)</h3>
<p>在<a href="#orgb70d1c1">上一节</a>中描述了属性描述符代理的使用，在使用过程中对描述符对象的定义有一定的约束<br>
条件，比如 <code class="language-text">defineProperty(trapTarget, key, descriptor)</code> 第三个参数就并非是完整<br>
的传入的描述符对象 <code class="language-text">Object.defineProperty(obj, key, descObj)</code> 。  </p>
<p>在 trap 的 <code class="language-text">descriptor</code> 会忽略掉除下面属性以外的属性,  </p>
<ul>
<li><code class="language-text">enumerable</code></li>
<li><code class="language-text">configurable</code></li>
<li><code class="language-text">value</code></li>
<li><code class="language-text">writable</code></li>
<li><code class="language-text">get</code></li>
<li><code class="language-text">set</code></li>
</ul>
<p>除了上面 6 个属性之外，其他的属性都会被忽略掉，即使你调用<br>
<code class="language-text">Object.defineProperty</code> 的时候传入了更多的属性。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 'proxy'</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'proxy'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'custom'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: 结果显示实际传入的 <code class="language-text">{value: &#39;proxy&#39;, name: &#39;custom&#39;}</code> 在 trap 中并没有<br>
<code class="language-text">name</code> 。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">proxy
undefined</code></pre></div>
<p>这是因为 trap 中的 <code class="language-text">descriptor</code> 参数并非是 <code class="language-text">{value: &#39;proxy&#39;, name: &#39;custom&#39;}</code> 对<br>
象的引用，而是一个全新的对象，只会包含标准的 6 个属性值，其他的均不会收藏。  </p>
<p>同样， <code class="language-text">Reflect.defineProperty()</code> 也一样会忽略掉非标准的属性。  </p>
<p>在 <code class="language-text">getOwnPropertyDescriptor()</code> 方法中也有此类约束，这个方法要求它的返回值必须是<br>
<code class="language-text">null</code>, <code class="language-text">undefined</code> 或一个对象，如果是一个对象的时候，就会遵循这个约束，即返回的<br>
对象中只能包含标准的属性(<code class="language-text">enumerable</code>, <code class="language-text">configurable</code>, <code class="language-text">value</code>, <code class="language-text">writable</code>,<br>
<code class="language-text">get</code>, <code class="language-text">set</code>)  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'proxy'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">TypeError: &#39;getOwnPropertyDescriptor&#39; on proxy: trap reported non-configurability for property &#39;name&#39; which is either non-existant or configurable in the proxy target</code></pre></div>
<h3>重复的描述符方法<a id="org8c34cb8"></a></h3>
<p>与之前描述的一样在 <code class="language-text">Object</code> 和 <code class="language-text">Reflect</code> 都同时有 <code class="language-text">defineProperty()</code> 和<br>
<code class="language-text">getOwnPropertyDescriptor()</code> 方法，但双方都有一点差异。  </p>
<ol>
<li><code class="language-text">Object.defineProperty(target)</code> 返回 <code class="language-text">target</code> 对象</li>
<li><code class="language-text">Reflect.defineProperty(trapTarget, key, descriptor)</code> 返回 <code class="language-text">true</code> 或 <code class="language-text">false</code><br>
表示成功或失败</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> res1 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'target'</span><span class="token punctuation">,</span>
  configurable<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1 <span class="token operator">===</span> target<span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">let</span> res2 <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'reflect'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true</code></pre></div>
<ol>
<li><code class="language-text">Object.getOwnPropertyDescriptor(obj, key)</code> 如果 <code class="language-text">obj</code> 是原始类型会强制转换成<br>
对象后再获取描述符对象，没有就返回 <code class="language-text">undefined</code></li>
<li><code class="language-text">Reflect.getOwnPropertyDescriptor(obj, key)</code> 和上面的不一样，如果为非对象类型<br>
则会触发异常。</li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res1 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res2 <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">undefined
Reflect.getOwnPropertyDescriptor called on non-object</code></pre></div>
<h2><code class="language-text">ownKeys</code> Trap<a id="org59878e2"></a></h2>
<p>ownKeys -> <code class="language-text">Reflect.ownKeys(trapTarget)</code>  </p>
<p>这个 trap 的用途是用来中断 <code class="language-text">[[OwnPropertyKeys] ]</code> 的操作，然后允许在 trap 里面重<br>
写“返回一个值的数组”的动作。  </p>
<p>有四个内置方法用到这个数组(<code class="language-text">ownKeys</code>)  </p>
<ul>
<li><code class="language-text">Object.keys()</code>  会过滤掉 <code class="language-text">ownKeys</code> 中的符号类型 key</li>
<li><code class="language-text">Object.getOwnPropertyNames()</code> 会过滤掉 <code class="language-text">ownKeys</code> 中的符号类型 key</li>
<li><code class="language-text">Object.getOwnPropertySymbols()</code> 会过滤掉 <code class="language-text">ownKeys</code> 中的字符串类型 key</li>
<li><code class="language-text">Object.assign()</code> 用 <code class="language-text">ownKeys</code> 来决定哪些属性会被拷贝，字符串和符号 key 都会用<br>
到</li>
</ul>
<p>对应默认行为的 trap 是： <code class="language-text">Reflect.ownKeys()</code> 返回一个所有自身属性的 key，包含符<br>
号属性。  </p>
<p>接受一个对象参数，且返回数组或类数组对象否则会报错，使用 ownKeys trap 可以让我们<br>
在对该对象使用诸如 <code class="language-text">Object.keys()</code>, <code class="language-text">Object.getOwnPropertyNames()</code>, 等等这些方法<br>
的时候去过滤一些我们不想让人获取到的一些属性，比如以下划线开头的内部方法(一般使<br>
用下划线开头的放表示内部方法)。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">trapTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect
      <span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">)</span>
    <span class="token comment">// 过滤掉 _xxx() {} 的方法</span>
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> key <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> nameSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'proxy'</span>
proxy<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token string">'private'</span>
proxy<span class="token punctuation">[</span>nameSymbol<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'symbol'</span>

<span class="token keyword">let</span> names <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 会过滤符号key</span>
    keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 会过滤符号 key</span>
    symbols <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>names<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'name'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'name'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>symbols<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>symbols<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// "Symbol(name)"</span></code></pre></div>
<p>+RESULTS: 前两个为 1 是因为 <code class="language-text">Object.getOwnPropertyNames()</code> 和 <code class="language-text">Object.keys()</code> 默<br>
认会过滤掉符号属性。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1
name
1
name
1
Symbol(name)</code></pre></div>
<blockquote>
<p><code class="language-text">ownKeys</code> 对 <code class="language-text">for-in</code> 循环中也有效，它会调用 ownKeys trap 来决定哪些键可以被遍历。  </p>
</blockquote>
<h2>函数代理(apply和construct traps)<a id="org3033f8b"></a></h2>
<p>在所有的 traps 中，只有 <code class="language-text">apply</code> 和 <code class="language-text">construct</code> trap 必须要求 <code class="language-text">trapTarget</code> 是一个<br>
函数。  </p>
<p>这两个 trap 分别对应 <code class="language-text">[[Call] ]</code> 和 <code class="language-text">[[Construct] ]</code> 低级操作，而这两个内部属性<br>
对应的是函数的两种调用方式(1. 函数方式调用，2. 通过 <code class="language-text">new</code> 调用)，通过 <code class="language-text">apply</code> 和<br>
<code class="language-text">construct</code> 这两个 trap 可以拦截这两种调用操作。  </p>
<p><code class="language-text">apply</code> -> <code class="language-text">Reflect.apply(trapTarget, thisArg, argumentsList)</code><br>
<code class="language-text">construct</code> -> <code class="language-text">Reflect.construct(trapTarget, argumentsList[, newTarget])</code>  </p>
<ol>
<li><code class="language-text">trapTarget</code> 被代理的那个函数对象</li>
<li><code class="language-text">thisArg</code> 调用 apply 时指定的作用域对象</li>
<li><code class="language-text">argumentsList</code> 传递给函数的参数列表</li>
<li><code class="language-text">newTarget</code> 指向函数内部 <code class="language-text">new.target</code> 的值</li>
</ol>
<p>示例：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">target</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> <span class="token string">'applied'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> argList<span class="token punctuation">,</span> newTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newTarget<span class="token punctuation">,</span> <span class="token string">'newTarget'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> proxy<span class="token punctuation">)</span> <span class="token comment">// function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 42</span>

<span class="token keyword">var</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins <span class="token keyword">instanceof</span> <span class="token class-name">proxy</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins <span class="token keyword">instanceof</span> <span class="token class-name">target</span><span class="token punctuation">)</span>

<span class="token function">proxy</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">target</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS: apply 和 construct 分别代理了函数的两种不用使用方式(<code class="language-text">apply</code> 和 <code class="language-text">new</code>)。  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">function
undefined &#39;applied&#39;
42
[Function: target] &#39;newTarget&#39;
true
true
{ a: 1 } &#39;applied&#39;
undefined</code></pre></div>
<p>从结果可知 <code class="language-text">newTarget</code> 参数指向的是被代理的那个原始对象 <code class="language-text">trapTarget</code> 。  </p>
<p>下面将介绍如何使用这两个代理做一些事情，比如验证参数或验证函数调用方式。  </p>
<h3>验证函数参数</h3>
<p>检查函数参数的合法性，或限定函数只能以普通方式调用不能通过 <code class="language-text">new</code> 调用。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> prev <span class="token operator">+</span> next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> sumProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>sum<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    argList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">arg</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arg <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'所有参数必须是数字。'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'这个函数不能被 new 实例化。'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sumProxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sumProxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sumProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">10
所有参数必须是数字。
这个函数不能被 new 实例化。</code></pre></div>
<p>上面例子也可以反过来只允许 <code class="language-text">new</code> 实例化，不能被直接调用。  </p>
<h3>无 <code class="language-text">new</code> 直接调用构造函数检测</h3>
<p>根据 <code class="language-text">construct</code> trap 的第三个可选参数 <code class="language-text">newTarget</code> 这个值指向的是函数的<br>
<code class="language-text">new.target</code> 值(<a href="#org52daa00">new.target</a>)。  </p>
<p>这个值由两种值： 1. 函数调用时值为 <code class="language-text">undefined</code> , 2. <code class="language-text">new</code> 实例化时为当前构造函数<br>
本身。  </p>
<p>使用 apply 和 construct 两个 trap 结合使用，可以做到让一个函数无 <code class="language-text">new</code> 情况下直<br>
接调用构造函数就可以实例化：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Nums</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'该函数必须通过 `new` 调用。'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>values <span class="token operator">=</span> values
<span class="token punctuation">}</span>

<span class="token keyword">let</span> NumsProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>Nums<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">apply</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>argList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> ins <span class="token operator">=</span> <span class="token function">NumsProxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins<span class="token punctuation">.</span>values<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1,2,3,4
[ 1, 2, 3, 4 ]</code></pre></div>
<h3>重写抽象基类(Abstract Base Class)构造函数</h3>
<p>让一个类智能被继承，不能被实例化，可以通过构造函数内部的 <code class="language-text">new.target</code> 来检测。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">AbstractNums</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">===</span> AbstractNums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'该类不能被实例化，只能被继承。'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>values <span class="token operator">=</span> values
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Nums</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNums</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">let</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Nums</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins<span class="token punctuation">.</span>values<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">AbstractNums</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1,2,3,4
该类不能被实例化，只能被继承。</code></pre></div>
<p>通过代理实现屏蔽这里的异常，即让 <code class="language-text">AbstractNums</code> 构造函数中的检测失败。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">AbstractNums</span> <span class="token punctuation">{</span>
  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">===</span> AbstractNums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'该类不能被实例化，只能被继承。'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>values <span class="token operator">=</span> values

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'this.values'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> AbstractNumsProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>AbstractNums<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">construct</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>argList<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'proxy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为第三个参数即  new.target 值，这里第三个参数传递个空函数</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> argList<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/// 这里就不会报错了</span>
<span class="token keyword">let</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractNumsProxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins<span class="token punctuation">.</span>values<span class="token punctuation">,</span> <span class="token string">'eee'</span><span class="token punctuation">)</span></code></pre></div>
<h3>可调用的类的构造函数</h3>
<p>类的使用，在代理出现之前是无法直接调用的，因为其内部的 <code class="language-text">[[Call] ]</code> 属性被绑定到<br>
异常上，只要发生调用就会触发异常。  </p>
<p>但是有了代理之后，我们可以通过代理去实现一个可直接调用的类去创建一个实例，实际上<br>
还是代理里面去创建了实例。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> PersonProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">apply</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">trapTarget</span><span class="token punctuation">(</span><span class="token operator">...</span>argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> me <span class="token operator">=</span> <span class="token function">PersonProxy</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// xxx</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>me <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>me <span class="token keyword">instanceof</span> <span class="token class-name">PersonProxy</span><span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">xxx
true
true</code></pre></div>
<h2>可撤销的代理(Revocable)<a id="org0e4d674"></a></h2>
<p>通常情况下，代理一旦被创建就无法与 <code class="language-text">target</code> 解绑，但是有一些特殊情况，比如代理可<br>
能不再需要了，需要将其解绑掉。  </p>
<p>在这之前通过 <code class="language-text">new Proxy()</code> 创建的都是不可撤销的代理，如果需要创建可撤销的代理得<br>
使用 <code class="language-text">Proxy.revocable()</code> 接口。  </p>
<p>参数和 <code class="language-text">Proxy()</code> 一样，需要一个被代理对象和一个代理 traps 对象：<br>
<code class="language-text">Proxy.revocable(target, trapObj)</code>  </p>
<p>调用之后的返回值是一个包含两个属性的对象：  </p>
<ol>
<li><code class="language-text">proxy</code> 一个可被撤销的代理</li>
<li><code class="language-text">revoke</code> 用来撤销代理的函数</li>
</ol>
<p>任何时候执行了 <code class="language-text">revoke()</code> 那就表示 <code class="language-text">proxy</code> 不再可用，任意试图去通过 proxy trap<br>
去中断低级操作的行为都将触发异常，因为 <code class="language-text">proxy</code> 已经被撤销了没法用了。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'target'</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span> proxy<span class="token punctuation">,</span> revoke <span class="token punctuation">}</span> <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">revocable</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token function">revoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">target
Cannot perform &#39;get&#39; on a proxy that has been revoked</code></pre></div>
<h2>解决数组问题</h2>
<p>proxy-reflect 的出现同样赋予了开发者跟踪数组变化的能力，比如数组长度变化可以做一<br>
些特殊处理。  </p>
<p>对数组的访问和设置，可以使用之前讲过的 get-trap(<a href="#org38c7be9">13.3.3</a>) 和 set-trap(<a href="#org999196c">13.3.2</a>)，<br>
用来监听数组的访问、长度或内容的变化。  </p>
<h3>监听数组长度的变化</h3>
<p>通过数组对象的代理，可以监听数组对象长度或值的变化，从而触发一些自定义的行为。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">toUnit32</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isArrayIndex</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> numericKey <span class="token operator">=</span> <span class="token function">toUnit32</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>numericKey<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">&amp;&amp;</span> numericKey <span class="token operator">&lt;</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createArray</span><span class="token punctuation">(</span><span class="token parameter">length <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> currLen <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> numericKey <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>numericKey <span class="token operator">>=</span> currLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">,</span> numericKey <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token function">createArray</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'red'</span>
colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'green'</span>
colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'blue'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'black'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3
3
4
black
undefined</code></pre></div>
<h3>删除数组元素<a id="orgab2d3e4"></a></h3>
<p>在以往，要删除数组元素(缩减数组)，可以通过数组长度的设置来达到目的，数组多余的元素会被抛弃掉。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
nums<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
nums<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nums<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">1,2,3
1
1,,</code></pre></div>
<p>使用代理也可以达到这个目的，并且可以监听数组的变化：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">toUnit32</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isArrayIndex</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> numericKey <span class="token operator">=</span> <span class="token function">toUnit32</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>numericKey<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">&amp;&amp;</span> numericKey <span class="token operator">&lt;</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createArray</span><span class="token punctuation">(</span><span class="token parameter">length <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> currLen <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> numericKey <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numericKey <span class="token operator">>=</span> currLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">,</span> numericKey <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'length'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> currLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> currLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> value<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token function">createArray</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'red'</span>
colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'green'</span>
colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'blue'</span>
colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'black'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

colors<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">2</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'green'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'black'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3
4
2
undefined
undefined
green
red</code></pre></div>
<p>上面代码中实现了两种变化：  </p>
<ol>
<li><code class="language-text">key</code> 为数组下标，即数组元素值的变化，会将长度基于它的索引加 1</li>
<li><code class="language-text">length</code> 属性值的变化，如果新的长度值小于原有的元素长度，多余的元素会被删除掉</li>
</ol>
<h3>实现数组类<a id="orgb50f6a3"></a></h3>
<p>最简单的实现方式是按照普通类定义然后在构造函数中返回一个代理。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Thing</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> myTh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myTh <span class="token keyword">instanceof</span> <span class="token class-name">Thing</span><span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>返回的 <code class="language-text">new Proxy(this, {})</code> 有两个参数：  </p>
<ol>
<li><code class="language-text">this</code> 为 <code class="language-text">Thing</code> 类的实例</li>
<li><code class="language-text">{}</code> 为 <code class="language-text">Thing</code> 实例的代理 trap 对象</li>
</ol>
<p><code class="language-text">myTh</code> 是 <code class="language-text">Thing</code> 实例的代理对象。  </p>
<p>这里的实现和“删除数组元素<a href="#orgab2d3e4">13.10.2</a>”一节中基本一样，不同点在于 <code class="language-text">new
    Proxy()</code> 在类的构造函数中返回。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">toUnit32</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isArrayIndex</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> numericKey <span class="token operator">=</span> <span class="token function">toUnit32</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>numericKey<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">&amp;&amp;</span> numericKey <span class="token operator">&lt;</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyArray</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">length <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> currLen <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> numericKey <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>numericKey <span class="token operator">>=</span> currLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">,</span> numericKey <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'length'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> currLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> currLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> value<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyArray</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'red'</span>
colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'green'</span>
colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'blue'</span>
colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'black'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

colors<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">2</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'green'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 'black'</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">3
4
2
undefined
undefined
green
red</code></pre></div>
<h2>Proxy 作为原型使用，从而实例共享代理</h2>
<h3>原型 <code class="language-text">get</code> trap</h3>
<p>原型代理在使用上有一定的限制，它只能响应原型至上的操作，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> newTarget <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 正常的话这里返回 false 会触发异常</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>newTarget<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token string">'newTarget'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newTarget<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'newTarget'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newTarget<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">newTarget
true</code></pre></div>
<p>上面的代理并没有响应 <code class="language-text">name</code> 属性增加操作，因为 <code class="language-text">new Proxy()</code> 在<br>
<code class="language-text">Object.create(proxy)</code> 作为参数传递结果会是新创建对象的原型，也就是说<br>
<code class="language-text">newTarget</code> 的原型是 <code class="language-text">new Proxy()</code> 的代理，而原型代理是没法响应对象本身的变化。  </p>
<p>但是在有些情况下原型代理还是很有用的，比如获取对象属性操作，因为对象的获取遵循原<br>
型链查找，如果对象本身找不到该属性就会往上查找原型对象，此时如果原型对象是代理的<br>
话就可以监听到该属性值的获取操作，从而做出响应。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> thing <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> doesn't exist.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

thing<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'thing'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thing<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'thing'</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thing<span class="token punctuation">.</span>unknown<span class="token punctuation">)</span> <span class="token comment">// error</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">thing
unknown doesn&#39;t exist.</code></pre></div>
<p>给 <code class="language-text">thing</code> 新增了一个 <code class="language-text">name</code> 属性，获取的时候拿到的是该对象本身的 <code class="language-text">name</code> 属性，<br>
因此正常，但是当获取 <code class="language-text">thiing.unknown</code> 的时候对象本身没找到会到原型上去找，而原型<br>
是一个代理对象， <code class="language-text">get</code> trap 中阻止了任何原型属性的获取操作，因此报错异常。  </p>
<h3>原型 <code class="language-text">set</code> trap</h3>
<p>对象操作的 <code class="language-text">set</code> 和 <code class="language-text">get</code> 一样首先查找本身，如果没有就往原型查找，因此这里也可以<br>
通过 <code class="language-text">set</code> trap 去对原型属性的设置操作做一定的响应和拦截。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> thing <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'key: '</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> <span class="token string">'value: '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thing<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

thing<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'thing'</span> <span class="token comment">// 这里会触发 `set` 代理，因为 thing 中没有 `name` 属性</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thing<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'thing'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thing<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

thing<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'boo'</span> <span class="token comment">// 这个时候 thing 中已经有 `name` 了，因此不会触发 `set` trap</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>thing<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
key: name value: thing
thing
true
boo</code></pre></div>
<h3>原型 <code class="language-text">has</code> trap</h3>
<p><code class="language-text">key in obj</code> 对于 <code class="language-text">in</code> 操作符，它不仅会检测对象本身，还会检查原型链，与其对应的<br>
proxy-trap 为 <code class="language-text">has</code> trap，即我们可以通过这个 trap 来对 <code class="language-text">in</code> 操作做一定的处理，比<br>
如让它针对被代理的对象在原型上的查找都失效。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> thing <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">trapTarget<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// return false 让原型的查找失效</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name'</span> <span class="token keyword">in</span> thing<span class="token punctuation">)</span> <span class="token comment">// 触发代理，因为 target 没 name 属性，会去查找原型</span>

thing<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'thing'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name'</span> <span class="token keyword">in</span> thing<span class="token punctuation">)</span> <span class="token comment">// 不会触发</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
true</code></pre></div>
<h3>代理作为原型作用域类上面</h3>
<p>类是不能直接使用代理作为原型，因为累的原型属性是 <em>non-writable</em> 的，但是我们可以<br>
通过类的继承来变相实现代理原型.  </p>
<p>构造函数风格的原型代理：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">NoSuchProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token class-name">NoSuchProperty</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> doesn't exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> thing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> thing<span class="token punctuation">.</span>name
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">name doesn&#39;t exist</code></pre></div>
<p>有了上面的 <code class="language-text">NoSuchProperty</code> 构造函数之后，就可以让一个类去继承它，从而让类的原型<br>
成为代理。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">NoSuchProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token class-name">NoSuchProperty</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> doesn't exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">NoSuchProperty</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">length<span class="token punctuation">,</span> width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> shape <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> area1 <span class="token operator">=</span> shape<span class="token punctuation">.</span>length <span class="token operator">*</span> shape<span class="token punctuation">.</span>width
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>area1<span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// error, no `wdth` property, 会去原型查找</span>
  <span class="token keyword">let</span> area2 <span class="token operator">=</span> shape<span class="token punctuation">.</span>length <span class="token operator">*</span> shape<span class="token punctuation">.</span>wdth
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">12
wdth doesn&#39;t exist</code></pre></div>
<p>上面的实例中 <code class="language-text">new Proxy()</code> 代理实际上是 <code class="language-text">NoSuchProperty</code> 的原型，而非 <code class="language-text">Square</code><br>
的，但是依然有效是因为原型链特征的原因，原型链查找不单单是查找父级对象还会往上一<br>
直查找原型，直到 <code class="language-text">Object.prototype</code> 结束查找。  </p>
<p>上例中各对象原型间的关系：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">NoSuchProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>trapTarget<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> doesn't exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token class-name">NoSuchProperty</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> proxy

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">NoSuchProperty</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">length<span class="token punctuation">,</span> width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> shape <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> shapeProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy <span class="token operator">===</span> shapeProto<span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token keyword">let</span> secondLevelProto <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>shapeProto<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>secondLevelProto <span class="token operator">===</span> proxy<span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
true</code></pre></div>
<h2>小结</h2>
<p><code class="language-text">Proxy</code> : 允许拦截底层操作，给这些操作定义一些非标准的行为，比如监听数组长度变化，<br>
对象属性的删除操作。  </p>
<p><code class="language-text">Reflect</code> : 针对每个 proxy trap 执行它们的默认行为，每一个 proxy trap 都有一个相<br>
对应且同名的 <code class="language-text">Reflect</code> 方法与之对应，如<a href="#org6bf2c25">对应表</a>。  </p>
<p><code class="language-text">revocable proxy</code> : 允许解绑的 proxy 。  </p>
<p>原型代理：可以让一个代理成为一个对象的原型，从而可以对该对象的原型的操作进行拦<br>
截，比如 <code class="language-text">get</code>, <code class="language-text">set</code>, <code class="language-text">has</code> proxy traps。  </p>
<h1>代码模块化</h1>
<h2>什么是模块？</h2>
<p>模块与普通的 <em>scripts</em> 使用有很大的不同：  </p>
<ol>
<li>模块代码默认严格模式运行，并且不能改变</li>
<li>当前模块创建的全局变量只针对于该模块而言，作用域仅限于该模块内</li>
<li>一个模块的 <code class="language-text">this</code> 值为 <code class="language-text">undefined</code></li>
<li>模块内的代码不允许包含 html 格式的注释</li>
<li>模块内必须有导出，提供给模块外部使用</li>
<li>模块内通过 <code class="language-text">import</code> 可以导入其他模块代码</li>
</ol>
<p>模块赋予了指定需要的代码导入导出的能力.  </p>
<h2>基本导出(<code class="language-text">export</code>)</h2>
<p>你可以使用 <code class="language-text">export</code> 关键字去将模块内的指定内容导出给其他模块使用，比如：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 导出变量</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> color <span class="token operator">=</span> <span class="token string">'red'</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'xx'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> magicNumber <span class="token operator">=</span> <span class="token number">7</span>

<span class="token comment">// 导出函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2
<span class="token punctuation">}</span>

<span class="token comment">// 导出类</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Rect</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">len<span class="token punctuation">,</span> width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> len
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subtract</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">-</span> n2
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">*</span> n2
<span class="token punctuation">}</span>

<span class="token comment">// 先定义后导出</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> multiply <span class="token punctuation">}</span></code></pre></div>
<ol>
<li>变量、函数、类的导出都必须明确指定一个名字，因为外部使用的时候需要通过这个名<br>
字去使用</li>
<li><code class="language-text">multiply</code> 并没有在定义的时候导出，也就是说不需要总是导出定义也可以只导出引用</li>
<li><code class="language-text">subtract</code> 并没有被导出，就意味着模块外无法访问它，但是模块内部只要满足作用域<br>
就可以访问</li>
</ol>
<h2>基本导入(<code class="language-text">import</code>)</h2>
<p>一旦拥有使用 <code class="language-text">exports</code> 导出的模块了，那么就可以在其他模块通过 <code class="language-text">import</code> 关键词来<br>
导入这些内容，比如：  </p>
<p><code class="language-text">import { identifier1, identifier2 } from &#39;./example.js&#39;;</code>  </p>
<p>可以从 <em>example.js</em> (一个文件视为一个模块)，将 <code class="language-text">identifier1</code> 导入。  </p>
<p>模块导入语法导入的变量默认使用的是 <code class="language-text">const</code> 定义的，也就意味着导入之后不能改变变<br>
量的值。  </p>
<p>但是可以通过 <code class="language-text">import { a as b } from &#39;./c.js&#39;;</code> 语法来重新定义命令名称。  </p>
<p>导入有多种方式，比如：只导入一个，导入多个，导入全部等等。  </p>
<h3>导入单个</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./example.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// import 导入默认 const 不能改变</span>
sum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// error</span></code></pre></div>
<p>导入时候的路径必须与使用导入模块的文件路径想匹配，即必须要能找到模块文件的正确路<br>
径。  </p>
<h3>导入多个</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> sum<span class="token punctuation">,</span> multiply<span class="token punctuation">,</span> magicNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./example.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> magicNumber<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span></code></pre></div>
<h3>导入所有</h3>
<p>可以通过  </p>
<p><code class="language-text">import * as example from &#39;./example.js&#39;;</code>  </p>
<p>将 <em>example.js</em> 模块导出的所有绑定导出到 <code class="language-text">example</code> 对象中，然后可以通过<br>
<code class="language-text">example.sum()</code> 方式去访问模块中的内容。  </p>
<p>对同一个模块使用多个 <code class="language-text">import</code> 最终模块都会只执行一次，它会在第一次导入的时候就存<br>
在于内存中等待复用，其他后面的使用的 <code class="language-text">import</code> 语句都只是服用内存中的模块。  </p>
<p>不仅仅一个模块中多次使用 <code class="language-text">import</code> 导入一个模块多次只会执行一次，就是多个模块同时<br>
多次导入同一个模块也只会在内存中保存一份引用，且所有模块对该模块的导入都只会使用<br>
这一份引用。  </p>
<p>也就是说在一个应用实例中，单个模块只会有一份，尽管会被多个模块多次导入。  </p>
<blockquote>
<p>模块语法限制：  </p>
<p><code class="language-text">export</code> 和 <code class="language-text">import</code> 不能在函数或语句表达式中使用，比如：  </p>
<p><code class="language-text">if (flag) { export flag; }</code> 语法错误。  </p>
<p>导出只能在模块的顶级作用域才能使用，函数或块级作用域中不允许使用。  </p>
<p>同样， <code class="language-text">import</code> 只能在文件顶部执行导入。  </p>
</blockquote>
<h2>重命名导入导出</h2>
<p>导出重命名：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// example.js</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token keyword">as</span> add <span class="token punctuation">}</span>

<span class="token comment">// a.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./example.js'</span></code></pre></div>
<p>导入重命名：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// example.js</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span>

<span class="token comment">// a.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token keyword">as</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./example.js'</span></code></pre></div>
<h2>模块默认值</h2>
<p>导出默认值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// example.js</span>
<span class="token comment">// 导出默认值不需要变量名</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2
<span class="token punctuation">}</span>

<span class="token comment">// 变量名方式</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  sum <span class="token keyword">as</span> <span class="token keyword">default</span>
<span class="token punctuation">}</span></code></pre></div>
<p>导入默认值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// a.js</span>
<span class="token keyword">import</span> sum <span class="token keyword">from</span> <span class="token string">'./example.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span></code></pre></div>
<p>将 <em>example.js</em> 中 <code class="language-text">export default</code> 内容导出且赋予名称为 <code class="language-text">sum</code> 。  </p>
<p>混合使用：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// a.js</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> color <span class="token operator">=</span> <span class="token string">'red'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2
<span class="token punctuation">}</span>

<span class="token comment">// b.js</span>
<span class="token keyword">import</span> sum<span class="token punctuation">,</span> <span class="token punctuation">{</span> color <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./example.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'red'</span></code></pre></div>
<p>导出默认重命名：  </p>
<p><code class="language-text">import { default as sum, color } from &#39;./example.js&#39;</code>  </p>
<h2>导入之后导出</h2>
<p>即从一个模块导出一个内容，然后在当前模块中又将这个内容导出。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span>

<span class="token comment">// 简写</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>

<span class="token comment">// 导入-导出-重命名</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> sum <span class="token keyword">as</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>

<span class="token comment">// 导入所有导出所有</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span></code></pre></div>
<h2>无导出的模块导入</h2>
<p>即被导入的模块中并没有要导出的内容，这个时候只需要导入这个模块并且执行它即可。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// a.js</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pushAll</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// b.js</span>
<span class="token keyword">import</span> <span class="token string">'./a.js'</span>

<span class="token keyword">let</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

items<span class="token punctuation">.</span><span class="token function">pushAll</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span></code></pre></div>
<p>上面的代码会将 <em>a.js</em> 的内容直接在 <em>b.js</em> 中导入执行，这样 <code class="language-text">Array</code> 上有了<br>
<code class="language-text">pushAll</code> 方法。  </p>
<blockquote>
<p>无导出的模块通常用来创建 polyfills 和 shims，模块代码只希望导入时立即执行。  </p>
</blockquote>
<h2>加载模块</h2>
<h3>浏览器中使用模块</h3>
<p>ECMAScript 6中虽然定义了模块语法，但并没有定义如何去加载他们。  </p>
<ol>
<li>通过 <code class="language-text">&lt;script&gt;</code> 标签的 <code class="language-text">src</code> 属性加载一个脚本文件执行里面的代码</li>
<li>通过嵌入 <code class="language-text">&lt;script&gt;</code> 标签，在标签里面直接书写 js 代码</li>
<li>加载 js 代码放到一个 <code class="language-text">worker</code> 里面执行</li>
</ol>
<p>为了完全支持模块，浏览器不得不更新这些机制。  </p>
<p><code class="language-text">script</code>标签中使用模块，<code class="language-text">script</code> 标签的默认行为是当 <code class="language-text">type</code> 属性不指定或指定为一个 JavaScript 脚本类型的时<br>
候(比如： <code class="language-text">text/javascript</code>)，会加载一个 JavaScript 作为脚本去执行它而非模块。  </p>
<p>script 标签会执行 <code class="language-text">src</code> 加载的文件内的代码或者 <code class="language-text">&lt;script&gt;</code> 与 <code class="language-text">&lt;/script&gt;</code> 之间的<br>
代码。  </p>
<p>为了支持模块， <code class="language-text">type</code> 类型新增了一个 <code class="language-text">&quot;module&quot;</code> 类型值，通过设置 <code class="language-text">type=&quot;module&quot;</code><br>
告诉浏览器，该脚本包含的是一个模块代码。  </p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./example.js'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>第一个 <code class="language-text">&lt;script&gt;</code> 标签加载了一个 <code class="language-text">src</code> 指定的外部文件，唯一不同的是指定的类型为<br>
<code class="language-text">&quot;module&quot;</code> 。  </p>
<p>第二个 <code class="language-text">&lt;scrpt&gt;</code> 标签直接嵌入了一段代码通过 <code class="language-text">import</code> 导入了一个外部脚本文件，因<br>
此 <code class="language-text">result</code> 变量不会被加入到 <code class="language-text">window</code> 对象上去，因为它只在这个 <code class="language-text">&lt;script&gt;</code> 模块中<br>
生效。  </p>
<p>测试实例：  </p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>a.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./a.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> globalResult <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'module result 1'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'global result'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>globalResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'module result 2'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div>
<p>chrome 浏览器执行结果：  </p>
<p><img src="http://qiniu.ii6g.com/1565600666.png" alt="img">  </p>
<p>从结果所示：  </p>
<ol>
<li><code class="language-text">type=&#39;module&#39;</code> 的 <code class="language-text">script</code> 最后被加载执行，因为其默认应用了 <code class="language-text">defer</code> 属性</li>
<li>模块内部的变量不会添加到 <code class="language-text">window</code> 对象上</li>
</ol>
<h3>Web浏览器中的模块加载序列</h3>
<p><code class="language-text">&lt;script type=&quot;module&quot;&gt;</code> 的标签默认应用了 <code class="language-text">defer</code> 属性，意味着它会被下载但不会被<br>
立即执行，只有当 DOM 被完全解析完成之后才会被执行，多个模块的时候会按照它们在<br>
DOM 结构中的顺序来执行，不区分是 <code class="language-text">src</code> 引入模块文件还是直接嵌入代码方式。  </p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>a.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./a.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> globalResult <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'module result 1'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> testEl1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testEl1<span class="token punctuation">,</span> <span class="token string">'test el 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'global result'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>globalResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'module result 2'</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
    <span class="token keyword">const</span> testEl2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testEl2<span class="token punctuation">,</span> <span class="token string">'test el 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre></div>
<p>结果：  </p>
<p><img src="http://qiniu.ii6g.com/1565683852.png" alt="img">  </p>
<p>可以看到在普通的 <code class="language-text">script</code> 标签中 ‘test el 2’ 结果是 <code class="language-text">undefined</code> 因为这个时候<br>
<em>div#test</em> 并没有并创建，因为它在所有的 <code class="language-text">script</code> 之后。  </p>
<p>但是 ‘test el 1’ 得到了正确的结果能获取到 <em>div#test</em> 元素，这恰恰说明了类型为<br>
‘module’ 的 <code class="language-text">script</code> 标签在 DOM 解析完成之后执行。  </p>
<blockquote>
<p>多个 <code class="language-text">script#module</code> 标签，会同步下载文件以及每个 <code class="language-text">script</code> 里面的 <code class="language-text">import</code> 的文<br>
件，但是不会立即执行，只有当 document 解析完成之后才会去执行它们，执行顺序为先<br>
script 后 script 中的 import, 然后下一个 script 及其里面的 import，如此知道执行<br>
完成。  </p>
</blockquote>
<h3>浏览器中的异步模块加载</h3>
<p><code class="language-text">&lt;script type=&quot;module&quot; async src=&quot;module1.js&quot;&gt;&lt;/script&gt;</code>  </p>
<p><code class="language-text">async</code> 表示 <em>module1.js</em> 一旦下载完成就会被立即执行，且不影响其他脚本的下载和执<br>
行，哪个下载完成谁就先执行。  </p>
<h3>Worker 加载模块</h3>
<p>我们都知道 JavaScript 是单线程的，但是有时候我们又需要做一些繁琐的工作，却不希望<br>
影响到主线程的运行，这个时候就可以用到 <code class="language-text">Worker</code> 它相当于重新起了一个线程给指定的<br>
脚本去执行，并且不会阻塞主线程，还提供了与之通信的接口。  </p>
<p>脚本 Worker : <code class="language-text">new Worker(&#39;script.js&#39;);</code>  </p>
<p>模块 Worker : <code class="language-text">new Worker(&#39;module.js&#39;, { type: &#39;module&#39; });</code>  </p>
<p>模块和脚本 <code class="language-text">Worker</code> 差异：  </p>
<ol>
<li>脚本 Worker 只能加载同源脚本文件，即不支持跨域，但是模块 Worker 没有找个限制</li>
<li>脚本 Worker 可以使用 <code class="language-text">self.importScripts()</code> 方法去加载其他的脚本，而在模块<br>
Worker 中只能使用 <code class="language-text">import</code> 去加载其他脚本文件</li>
</ol>
<h3>加载文件路径限制</h3>
<p>在模块引入的时候的路径只能是 <code class="language-text">/</code>, <code class="language-text">./</code>, <code class="language-text">../</code> 这种相对路径或者直接是包含域名的绝<br>
对路径，比如： <em><a href="http://x.x.x.x/path/to/file.js">http://x.x.x.x/path/to/file.js</a></em> (需要配置 CORS 允许跨域访问)。  </p>
<p>其他情况不被允许，比如：  </p>
<p><code class="language-text">import { first } from &#39;a.js&#39;;</code> // error  </p>
<p><code class="language-text">import { second } from &#39;path/a.js&#39;;</code> // error  </p>
<p>上面两种都不会被浏览器下载，因为模块文件的路径不合法，尽管在 <code class="language-text">script</code> 的 <code class="language-text">src</code><br>
属性值中可以这么使用，这也是 <code class="language-text">script</code> 和 <code class="language-text">import</code> 的一个区别。  </p>
<h1>异常处理</h1>
<h2>try…catch 简写<sup>2019</sup></h2>
<p><code class="language-text">try {} catch {}</code> 现在可以省略 <code class="language-text">catch(e)</code> ，直接将 <code class="language-text">catch</code> 变成一个关键字。  </p>
<h1>附录 A： 更小的变更</h1>
<h2>Integers 整型数据</h2>
<p>JavaScript 使用了 IEEE 754 编码系统来表示整型和浮点数，这在以往引起不少困惑。  </p>
<p>ECMAScript 6 中与数值有关的更新让整型的表示和使用更加便利。  </p>
<h3>Number.isInteger()</h3>
<p>判断数值是否是整型数值：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">isInt</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=></span> Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isInt</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isInt</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isInt</span><span class="token punctuation">(</span><span class="token number">1.8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isInt</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isInt</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">false
true
true
false
false
false</code></pre></div>
<p><code class="language-text">1.0</code> 会被当做整型值 <code class="language-text">1</code> 存储，因此这里得到的结果是 <code class="language-text">true</code> ,<br>
<code class="language-text">Number.isInteger()</code> 如果遇到数值型数据，在判断的时候会依据这些数值型数据在内存<br>
中的存储形式来决定最终结果(浮点、整型存储方式是不一样的)。  </p>
<h3>安全整型值</h3>
<p>IEEE754 的安全整型值范围为： -2<sup>53</sup> ~ 2<sup>53</sup>，超出这个范围的值都被视为非安全数<br>
值。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9007199254740992
9007199254740992</code></pre></div>
<p>第二个 <code class="language-text">+1</code> 之后超出了范围，得的结果相当于没有执行加法操作的结果值。  </p>
<p><code class="language-text">Number.isSafeInteger()</code> 检测是否是安全整型值。  </p>
<p><code class="language-text">Number.MAX_SAFE_INTEGER</code> 得到当前机器上的最大安全整型值。  </p>
<p><code class="language-text">Number.MIN_SAFE_INTEGER</code> 得到当前机器上的最小安全整型值。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> inside <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_SAFE_INTEGER</span><span class="token punctuation">,</span>
    outside <span class="token operator">=</span> inside <span class="token operator">+</span> <span class="token number">1</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>inside<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isSafeInteger</span><span class="token punctuation">(</span>inside<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>outside<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isSafeInteger</span><span class="token punctuation">(</span>outside<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">true
true
true
false</code></pre></div>
<h2>新 Math 方法</h2>
<table>
<thead>
<tr>
<th>方法名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">Math.acosh(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.asinh(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.atanh(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.cbrt(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.clz32(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.cosh(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.expm1(x)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.fround(x)</code></td>
<td>x 最近的单精度浮点数</td>
</tr>
<tr>
<td><code class="language-text">Math.hypot(...values)</code></td>
<td>参数列表平方和的平方根</td>
</tr>
<tr>
<td><code class="language-text">Math.imul(x, y)</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">Math.log1p(x)</code></td>
<td>1 + x 的自然对数</td>
</tr>
<tr>
<td><code class="language-text">Math.log10(x)</code></td>
<td>10 为底 x 的对数</td>
</tr>
<tr>
<td><code class="language-text">Math.log2(x)</code></td>
<td>2 为底 x 的对数</td>
</tr>
<tr>
<td><code class="language-text">Math.sign(x)</code></td>
<td>检查数值符号</td>
</tr>
<tr>
<td></td>
<td>-1 : x 负数</td>
</tr>
<tr>
<td></td>
<td>0 : x 为 +0 或 -0</td>
</tr>
<tr>
<td></td>
<td>1 : x 正数</td>
</tr>
<tr>
<td><code class="language-text">Math.sigh(x)</code></td>
<td>x 的双曲正弦</td>
</tr>
<tr>
<td><code class="language-text">Math.tanh(x)</code></td>
<td>x 的双曲正切</td>
</tr>
<tr>
<td><code class="language-text">Math.trunc(x)</code></td>
<td>浮点数取整</td>
</tr>
</tbody>
</table>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">acosh</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'cos'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sinh</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'sinh'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">tanh</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'tanh'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">trunc</span><span class="token punctuation">(</span><span class="token number">30.112</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'trunc'</span><span class="token punctuation">)</span> <span class="token comment">// 30</span></code></pre></div>
<h2>Unicode 标识符</h2>
<p>用 Unicode 标识符做变量名称：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> \u0061 <span class="token operator">=</span> <span class="token string">'abc'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\u0061<span class="token punctuation">)</span>

<span class="token comment">// 等价于</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">abc
abc</code></pre></div>
<h2>正规化 <code class="language-text">__proto__</code> 属性</h2>
<h1>附录 B：理解 ECMAScript 7 (2016)</h1>
<p>为了更好的记录规范，最终将采用版本号+年份方式来记录，比如  </p>
<p>ECMAScript 6 为 ECMAScript 2015，表示 2015 年发布的标准。  </p>
<p>ECMAScript 7 为 ECMAScript 2016，表示 2016 年发布的标准  </p>
<p>ECMAScript 7 发布与 2016年3月，它值包好了三个新增内容：  </p>
<ol>
<li><code class="language-text">**</code> 幂运算操作符，等同于 <code class="language-text">Math.pow(x, y)</code> 方法</li>
<li><code class="language-text">Array.prototype.includes()</code> 方法，用来检测数组是否包含某个元素，返回<br>
<code class="language-text">true/false</code></li>
<li>支持函数域的严格模式</li>
</ol>
<h2><code class="language-text">**</code> 幂运算操作符</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">**</span> <span class="token number">2</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 25</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res <span class="token operator">===</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">25
true</code></pre></div>
<p><strong>优先级</strong> : 高于所有的二元元算法，低于一元运算符。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// ** 高于 *</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 50</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">**</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 0.04</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">50
0.04</code></pre></div>
<p>但是不允许一元运算符出现在 <code class="language-text">**</code> 的左侧，因为这样就没法判定哪个优先级更高，容易造<br>
成混淆，如果非要使用就必须使用 <code class="language-text">()</code> 括起来。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// -25</span>
<span class="token keyword">let</span> res2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token comment">// 25</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">,</span> res2<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-25 25</code></pre></div>
<p><code class="language-text">++</code> 和 <code class="language-text">--</code> 在 <code class="language-text">**</code> 中表达式中的使用：  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> n1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    n2 <span class="token operator">=</span> <span class="token number">2</span>


console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">++</span>n1 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 9</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span> <span class="token comment">// 3</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n2<span class="token operator">--</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n2<span class="token punctuation">)</span> <span class="token comment">// 1</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">9
3
4
1</code></pre></div>
<p>但是不允许直接在数字上使用 <code class="language-text">++</code> 和 <code class="language-text">--</code>  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token operator">++</span><span class="token number">5</span> <span class="token operator">**</span> <span class="token number">2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">ReferenceError: Invalid left-hand side expression in prefix operation</code></pre></div>
<h2><code class="language-text">Array.prototype.includes(val[, startIdx])</code></h2>
<p><a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/">includes 内部实现伪码。</a>  </p>
<p>查找 <code class="language-text">val</code> 是否在数组中， <code class="language-text">startIdx</code> 指定查找的其实索引，找到返回 <code class="language-text">true</code> 否则返<br>
回 <code class="language-text">false</code> 。  </p>
<p><code class="language-text">includes()</code> 会将 <code class="language-text">NaN</code> 视为同一个值，也就是说在比较的时候 <code class="language-text">NaN</code> 和 <code class="language-text">NaN</code> 比较的<br>
结果是真值，而 <code class="language-text">indexOf()</code> 中使用的是 <code class="language-text">===</code> 判断， <code class="language-text">NaN === NaN</code> 结果是 <code class="language-text">false</code>  </p>
<p>所以使用 <code class="language-text">includes()</code> 更合理更安全，如果不需要被查找元素的索引值的话。  </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vals<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vals<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>+RESULTS:  </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-1
true</code></pre></div>
<p>实现内部对于零值的比较实用的是抽象操作 <a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/">SameValueZero</a>内中对 <code class="language-text">NaN</code> 的判断并非是等<br>
式判断而是通过 <code class="language-text">isNaN()</code> 方式的判断，对于零值有正负零值的判断(<code class="language-text">1/0 ===
   Infinity</code>, <code class="language-text">1/-0 === Infinity</code>)，更多详情请查看<a href="https://blog.ii6g.com/2019/07/08/ecma_pseudo_code/">实现伪码</a>。  </p>
<h2>函数域的严格模式</h2>
<p>即可以在函数顶部使用 <code class="language-text">&quot;use strict&quot;;</code> 来指定当前函数执行模式为严格模式，不影响函<br>
数外的代码。  </p>
<h1>相关链接</h1>
<ul>
<li><a href="https://css-tricks.com/new-es2018-features-every-javascript-developer-should-know/">new-es2018-features-every-javascript-developer-should-know</a></li>
</ul>
<h1>新增内容列表</h1>
<h2>Object 和 Reflect 重复函数比较</h2>
<table>
<thead>
<tr>
<th></th>
<th><code class="language-text">Object</code></th>
<th><code class="language-text">Reflect</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">getOwnPropertyDescriptor(obj, key)</code></td>
<td>obj 原始类型强转</td>
<td>obj 原始类型会抛异常</td>
</tr>
</tbody>
</table>
<h2>代理和映射<a id="org6bf2c25"></a></h2>
<table>
<thead>
<tr>
<th>Proxy Traps</th>
<th>Reflect Apis</th>
<th>原生功能</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">get</code> <a href="#org38c7be9">13.3.3</a></td>
<td><code class="language-text">Reflect.get(trapTarget, key, receiver)</code></td>
<td>对象属性读取</td>
<td>访问对象属性的时候触发</td>
</tr>
<tr>
<td><code class="language-text">set</code> <a href="#org999196c">13.3.2</a></td>
<td><code class="language-text">Reflect.set(trapTarget, key, value, receiver)</code></td>
<td>对象属性赋值操作</td>
<td>改变对象属性的值时触发</td>
</tr>
<tr>
<td><code class="language-text">has</code> <a href="#org46d3f0c">13.3.4</a></td>
<td><code class="language-text">Reflect.has(trapTarget, key)</code></td>
<td><code class="language-text">key in obj</code></td>
<td>检测存在性</td>
</tr>
<tr>
<td><code class="language-text">deleteProperty</code> <a href="#orgb519cd2">13.3.5</a></td>
<td><code class="language-text">Reflect.deleteProperty(trapTarget, key)</code></td>
<td><code class="language-text">delete obj.name</code></td>
<td>删除属性</td>
</tr>
<tr>
<td><code class="language-text">getPrototypeOf</code> <a href="#org9c538fc">13.4</a></td>
<td><code class="language-text">Reflect.getPrototypeOf(trapTarget)</code></td>
<td>获取对象原型</td>
<td><code class="language-text">Object.getPrototypeOf()</code></td>
</tr>
<tr>
<td><code class="language-text">setPrototypeOf</code> <a href="#org9c538fc">13.4</a></td>
<td><code class="language-text">Reflect.setPrototypeOf(trapTarget, proto)</code></td>
<td>设置对象原型</td>
<td><code class="language-text">Object.setPrototypeOf()</code></td>
</tr>
<tr>
<td><code class="language-text">isExtensible</code> <a href="#orgfd5f8b6">13.5</a></td>
<td><code class="language-text">Reflect.isExtensible(trapTarget)</code></td>
<td>扩展性</td>
<td><code class="language-text">Object.isExtensible()</code></td>
</tr>
<tr>
<td><code class="language-text">preventExtensions</code> <a href="#orgfd5f8b6">13.5</a></td>
<td><code class="language-text">Reflect.preventExtensions(trapTarget)</code></td>
<td>扩展对象</td>
<td><code class="language-text">Object.preventExtensions()</code></td>
</tr>
<tr>
<td><code class="language-text">definePropery</code> <a href="#org8c34cb8">13.6.3</a></td>
<td><code class="language-text">Reflect.definePropery(trapTarget, key, descriptor)</code></td>
<td>属性描述符代理</td>
<td><code class="language-text">Object.defineProperty(obj, key, desc)</code></td>
</tr>
<tr>
<td><code class="language-text">getOwnPropertyDescriptor</code>  <a href="#org8c34cb8">13.6.3</a></td>
<td><code class="language-text">Reflect.getOwnPropertyDescriptor(trapTarget, key)</code></td>
<td>获取属性描述符对象</td>
<td><code class="language-text">Object.getOwnPropertyDescriptor(trapTarget, key</code></td>
</tr>
<tr>
<td><code class="language-text">ownKeys</code> <a href="#org59878e2">13.7</a></td>
<td><code class="language-text">Reflect.ownKeys(trapTarget)</code></td>
<td>返回自身属性</td>
<td><code class="language-text">Object.keys()</code>, <code class="language-text">Object.getOwnPropertyNames()</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td><code class="language-text">Object.keys()</code></td>
<td>不包含符号属性</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code class="language-text">=Object.getOwnPropertyNames()=</code></td>
<td>不包含符号属性</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code class="language-text">Object.getOwnPropertySymbols()</code></td>
<td>不包含符号属性</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code class="language-text">Object.assign()</code></td>
<td>包含符号属性</td>
</tr>
<tr>
<td><code class="language-text">apply</code>  <a href="#org3033f8b">13.8</a></td>
<td><code class="language-text">Reflect.apply(trapTarget, thisArg, argumentsList)</code></td>
<td>函数的调用</td>
<td>-</td>
</tr>
<tr>
<td><code class="language-text">construct</code> <a href="#org3033f8b">13.8</a></td>
<td><code class="language-text">Reflect.construct(trapTarget, argList[, newTarget]</code></td>
<td>函数实例化(<code class="language-text">new</code>)</td>
<td>-</td>
</tr>
<tr>
<td><code class="language-text">Proxy.revocable(target, trapObj)</code> <a href="#org0e4d674">13.9</a></td>
<td>-</td>
<td>可撤销的代理</td>
<td>返回代理实例和 <code class="language-text">revoke()</code> 撤销函数</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>表中参数说明：  </p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">trapTarget</code></td>
<td><code class="language-text">Object</code></td>
<td>被代理的对象</td>
</tr>
<tr>
<td><code class="language-text">key</code></td>
<td>-</td>
<td>要操作的对象属性名</td>
</tr>
<tr>
<td><code class="language-text">value</code></td>
<td>-</td>
<td>对象属性值</td>
</tr>
<tr>
<td><code class="language-text">receiver</code></td>
<td><code class="language-text">Proxy</code></td>
<td>代理对象</td>
</tr>
</tbody>
</table>
<h2>符号</h2>
<table>
<thead>
<tr>
<th>符号方法</th>
<th>类型</th>
<th>JavaScript 特性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">Symbol.hasInstance</code></td>
<td><code class="language-text">boolean</code></td>
<td><code class="language-text">instanceof</code></td>
<td><a href="#org7e71710">7.7.1</a> 实例(原型链)检测</td>
</tr>
<tr>
<td><code class="language-text">Symbol.isConcatSpreadable</code></td>
<td><code class="language-text">boolean</code></td>
<td><code class="language-text">Array.prototype.concat</code></td>
<td><a href="#org67eb564">7.7.2</a> 检测参数合法性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.iterator</code></td>
<td><code class="language-text">function</code></td>
<td>调用后得到迭代器</td>
<td>遍历对象或数组(等可迭代的对象)的时候会用到</td>
</tr>
<tr>
<td><code class="language-text">Symbol.asyncIterator</code></td>
<td><code class="language-text">function</code></td>
<td>调用后得到异步迭代器(返回一个 <code class="language-text">Promise</code> )</td>
<td>遍历对象或数组(等可迭代的对象)的时候会用到</td>
</tr>
<tr>
<td><code class="language-text">Symbol.match</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.match</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.matchAll</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.matchAll</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.replace</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.replace</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.search</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.search</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.split</code></td>
<td><code class="language-text">function</code></td>
<td><code class="language-text">String.prototype.split</code></td>
<td><a href="#org139fb83">7.7.3</a> 正则表达式对象内部属性</td>
</tr>
<tr>
<td><code class="language-text">Symbol.species</code></td>
<td><code class="language-text">constructor</code></td>
<td><code class="language-text">new this.constructor[Symbol.species](value)</code></td>
<td><a href="#orga2051c7">symbol-species</a> 返回构造函数，类内部使用，不能构造函数调用</td>
</tr>
<tr>
<td><code class="language-text">Symbol.toPrimitive</code></td>
<td><code class="language-text">function</code></td>
<td>-</td>
<td><a href="#orgae3ed38">7.7.4</a> 返回一个对象的原始值</td>
</tr>
<tr>
<td><code class="language-text">Symbol.toStringTag</code></td>
<td><code class="language-text">string</code></td>
<td><code class="language-text">Object.prototype.toString()</code></td>
<td><a href="#orgc7b5259">7.7.5</a> 返回一个对象的字符串描述</td>
</tr>
<tr>
<td><code class="language-text">Symbol.unscopables</code></td>
<td><code class="language-text">object</code></td>
<td><code class="language-text">with</code></td>
<td><a href="#orgf7af38d">7.7.8</a> 不能出现在 <code class="language-text">with</code> 语句中的一个对象</td>
</tr>
</tbody>
</table>
<h2>函数</h2>
<table>
<thead>
<tr>
<th>分类</th>
<th>函数名</th>
<th>描述</th>
<th>其他</th>
</tr>
</thead>
<tbody>
<tr>
<td>Promise</td>
<td><code class="language-text">Promise.all(iterable)</code></td>
<td>所有的 promise resolved</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Promise.race(iterable)</code></td>
<td>只要有一个 promise settled 那么 race 立即 settled(无论是 rejected 还是 fulfilled)</td>
<td></td>
</tr>
<tr>
<td>Array</td>
<td><code class="language-text">Array.of(...items)</code></td>
<td>将参数了列表中的值组合成数组</td>
<td>和构造函数不一样，该方法会将参数只当做元素处理，而不会像 <code class="language-text">Array()</code> 传一个参数当做长度处理。</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Array.from(items[, mapFn[, thisArg]])</code></td>
<td>将满足条件的对象转成数组</td>
<td>条件：1. 必须有长度属性，2. 要有数值索引元素。可迭代的对象会直接访问迭代器。</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Array.prototype.find(mapFn[, thisArg])</code></td>
<td>查找 mapFn 返回 true 条件的元素，返回该元素值</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Array.prototype.findIndex(mapFn[, thisArg])</code></td>
<td>查找 mapFn 返回 true 条件的元素，返回该元素索引</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Array.prototype.fill(value[, start[, end]])</code></td>
<td>用 value 替换区间 [start, end) 之间的元素值</td>
<td>返回值是原数组(元素被替换之后的)</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Array.prototype.copyWithin(target, start[, end])</code></td>
<td>拷贝区间 [start, end) 的元素替换 [target, len) 区间的元素</td>
<td>实际替换的区间长度由 min(end - start, len - target) 决定。</td>
</tr>
<tr>
<td>Function</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Object</td>
<td><code class="language-text">Object.is(v1, v2)</code></td>
<td>v1 是否是 v2</td>
<td>弥补 <code class="language-text">===</code> 不能判断 +0，-0 和 NaN，NaN</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.assign(target, ...sources)</code></td>
<td>合并对象，浅拷贝，赋值运算</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.getPrototypeOf(obj)</code></td>
<td>取原型对象</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.setPrototypeOf(obj, protoObj)</code></td>
<td>设置原型对象</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.getOwnPropertySymbols(obj)</code></td>
<td>获取对象所有符号属性</td>
<td><code class="language-text">Object.keys</code>, <code class="language-text">Object.getOwnPropertyNames</code> 不能取符号属性</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.getOwnPropertyDescriptor(obj, key)</code></td>
<td>获取对象的描述符对象</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.preventExtensions()</code></td>
<td>阻止对象呗扩展</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">Object.isExtensible()</code></td>
<td>对象是否可被扩展</td>
<td>-</td>
</tr>
<tr>
<td>String</td>
<td><code class="language-text">str.codePointAt(n)</code></td>
<td>Unicode编码值</td>
<td>str.charCodeAt(n)</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">str.fromCodePoint(s)</code></td>
<td>根据编码转字符</td>
<td>str.fromCharCode(s)</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">str.normalize()</code></td>
<td>将字符的不同表示方式统一成一种表示形式</td>
<td>undefined, “NFC”, “NFD”, “NFKC”, or “NFKD”</td>
</tr>
<tr>
<td></td>
<td><code class="language-text">str.repeat(n)</code></td>
<td>将字符串重复 n 遍，作为新字符串返回</td>
<td>‘x’.repeat(3) => ‘xxx’</td>
</tr>
</tbody>
</table></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQCBQP/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABvg6XkPHXEs2DkVP/xAAaEAEAAwEBAQAAAAAAAAAAAAABAgMRABAx/9oACAEBAAEFApSzpFgSXZVm2odKtei6/fP/xAAYEQACAwAAAAAAAAAAAAAAAAAAARAhMf/aAAgBAwEBPwFIoex//8QAGREAAQUAAAAAAAAAAAAAAAAAAAEQESEx/9oACAECAQE/AZLExv/EAB0QAAICAQUAAAAAAAAAAAAAAAARAQIxECEiQYH/2gAIAQEABj8CtWMjcoyNz4KOjjKLG+n/xAAaEAEBAQADAQAAAAAAAAAAAAABEQAhQaEx/9oACAEBAAE/IW7iSnm9A2+tWXe7wi0Ep0zoxTkTvNVocRckd//aAAwDAQACAAMAAAAQ2zeB/8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQITH/2gAIAQMBAT8QBY65Z//EABgRAQADAQAAAAAAAAAAAAAAAAEAEBEx/9oACAECAQE/EFhBz23/xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMUHRUWGB/9oACAEBAAE/EFbOWbJntGjC1APfMsaX5TqNxAwkxrNWQph0XsR3ApUAN9vksJzcTUQaviCgGCf/2Q==" alt="ZhiCheng Lee(若叶知秋)" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg 1x,
/static/94e5e34de11ed954bada7ca31a5613c0/aba1d/profile-pic.jpg 1.5x,
/static/94e5e34de11ed954bada7ca31a5613c0/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg 1x,
/static/94e5e34de11ed954bada7ca31a5613c0/aba1d/profile-pic.jpg 1.5x,
/static/94e5e34de11ed954bada7ca31a5613c0/b315d/profile-pic.jpg 2x" src="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg" alt="ZhiCheng Lee(若叶知秋)" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>ZhiCheng Lee(若叶知秋)</strong> <!-- -->中国人。<!-- --> <a href="https://twitter.com/gccll_love">You should follow him on Twitter</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/new-beginnings/">← <!-- -->New Beginnings</a></li><li><a rel="next" href="/2020-06-16-vue-3.0-reactivity/">Vue3.0 源码之 Reactivity<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020-06-16-es6++/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-9839487a874f55009d3e.js"],"component---src-pages-404-js":["/component---src-pages-404-js-dfa684939fdc086afe1b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-e9a9ff0bc6d35a12e2fb.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-df3c457ebc2bf0738933.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-89ff2d606443a75a09e8.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-89ff2d606443a75a09e8.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-65282cc5dac79a1397dc.js" async=""></script><script src="/commons-cf4b03b2e773ec61d45b.js" async=""></script><script src="/app-9839487a874f55009d3e.js" async=""></script><script src="/styles-2d4804b503525347efbe.js" async=""></script><script src="/framework-d54fcf3f0204b459cf2d.js" async=""></script><script src="/webpack-runtime-03dfd859751270984004.js" async=""></script></body></html>