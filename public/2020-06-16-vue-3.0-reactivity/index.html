<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.491a16106869c73de5f8.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.23.3"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><title data-react-helmet="true">Vue3.0 源码之 Reactivity | Gatsby Starter Blog</title><meta data-react-helmet="true" name="description" content="简介  是 vue next 里面通过  +  实现的响应式模块。 源码路径：  入口文件： 疑问点解答：  相当于浅复制，只针对对象的一级 reactive，嵌套的对象不会 reactive 参考：测试代码 reactive.spec.ts 完整的 reactivity…"/><meta data-react-helmet="true" property="og:title" content="Vue3.0 源码之 Reactivity"/><meta data-react-helmet="true" property="og:description" content="简介  是 vue next 里面通过  +  实现的响应式模块。 源码路径：  入口文件： 疑问点解答：  相当于浅复制，只针对对象的一级 reactive，嵌套的对象不会 reactive 参考：测试代码 reactive.spec.ts 完整的 reactivity…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="kylemathews"/><meta data-react-helmet="true" name="twitter:title" content="Vue3.0 源码之 Reactivity"/><meta data-react-helmet="true" name="twitter:description" content="简介  是 vue next 里面通过  +  实现的响应式模块。 源码路径：  入口文件： 疑问点解答：  相当于浅复制，只针对对象的一级 reactive，嵌套的对象不会 reactive 参考：测试代码 reactive.spec.ts 完整的 reactivity…"/><link as="script" rel="preload" href="/webpack-runtime-69d8816745da999b9479.js"/><link as="script" rel="preload" href="/framework-d54fcf3f0204b459cf2d.js"/><link as="script" rel="preload" href="/styles-2d4804b503525347efbe.js"/><link as="script" rel="preload" href="/app-da2011b4223c5d7c3864.js"/><link as="script" rel="preload" href="/commons-db8b23eb39139ace1919.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-6260575670be770f4a25.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-89ff2d606443a75a09e8.js"/><link as="fetch" rel="preload" href="/page-data/2020-06-16-vue-3.0-reactivity/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/">Gatsby Starter Blog</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Vue3.0 源码之 Reactivity</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">June 16, 2020</p></header><section><h1>简介</h1>
<p><code class="language-text">reactivity</code> 是 vue next 里面通过 <code class="language-text">proxy</code> + <code class="language-text">reflect</code> 实现的响应式模块。</p>
<p>源码路径： <code class="language-text">packages/reactivity</code></p>
<p>入口文件：<code class="language-text">packages/reactivity/src/index.ts</code></p>
<p>疑问点解答：</p>
<ol>
<li>
<p><code class="language-text">shallowReactive</code> 相当于浅复制，只针对对象的一级 reactive，嵌套的对象不会 reactive</p>
<p>参考：测试代码 reactive.spec.ts</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should keep reactive properties reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> props<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> n<span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
     props<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
</ol>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_over">完整的 reactivity 模块代码链接。</a></p>
<h2>阶段代码链接</h2>
<ol>
<li><a href="#code1">测试用例 <code class="language-text">reactive.spec.ts</code> 通过后的代码链接</a></li>
<li><a href="#code2">测试用例 <code class="language-text">effect.spec.ts</code>通过后的代码链接</a></li>
<li><a href="#file-0521">05-21号 git pull 后的更新合 并之后的 reactive.js</a></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_files_v">将 reactive.js 拆分成 effect.js + baseHandlers.js</a></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_collection_get_set">完成 collection handlers(set + get)</a></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_collection_map_set">完成 collection Map, Set 支持</a></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_ref">支持 Ref 类型</a></li>
<li><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_computed">支持 computed 属性</a></li>
</ol>
<h2>文中重点链接</h2>
<ol>
<li><a href="#test-case-rloops">vue 中是如何防止在 effect(fn) 的 fn 中防止 ob.prop++ 导致栈溢出的？</a></li>
<li><a href="#test-case-json">vue 中为何能对 JSON.parse(JSON.stringify({})) 起作用的？</a></li>
<li><a href="#question-this">集合 handlers 的 get 函数实现 this 问题</a></li>
<li><a href="#question-raw-key">Key 和 rawKey 的问题(get 中)，为什么要两次 track:get？</a></li>
<li><a href="#question-key1-key11">为什么 key1 和 toReactive(key1) 后的 key11 前后 set 会改变 key1 对应的值？？？</a></li>
<li><a href="#reactive-nest-ref">如果 Ref 类型放在一个对象中 reactive 化会有什么结果？？？</a></li>
<li><a href="#test-case-computed-chained">计算属性的链式嵌套使用输出结果详细分析过程(想要透彻computed请看这里！！！)</a></li>
</ol>
<h2>遗留问题</h2>
<ol>
<li><strong><font color="green">DONE</font></strong> <code class="language-text">ownKeys</code> 代理收集的依赖不能被触发。</li>
<li><font color="red">TODO</font> <a href="#question-ref-++">Ref:a 类型在对象中执行 obj.a++ 之后依旧是 Ref 类型的 a ???</a></li>
</ol>
<h2>更新</h2>
<h3>2020-05-21 21:19:07 git pull</h3>
<h1>模块结构</h1>
<ol>
<li><code class="language-text">__tests__/</code> 测试代码目录</li>
<li><code class="language-text">src/</code> 主要代码目录</li>
</ol>
<p><code class="language-text">src</code> 目录下的文件：</p>
<ol>
<li><code class="language-text">baseHandler.ts</code> 传入给代理的对象，代理 <code class="language-text">Object/Array</code> 时使用的 Handlers。</li>
<li><code class="language-text">collectionHandlers.ts</code> 传入给代理的对象，代理 <code class="language-text">[Week]Set/Map</code>类型时使用的 Handlers。</li>
<li><code class="language-text">computed.ts</code> 计算属性代码</li>
<li><code class="language-text">effect.ts</code></li>
<li><code class="language-text">operations.ts</code> 操作类型枚举</li>
<li><code class="language-text">reactive.ts</code> 主要代码</li>
<li><code class="language-text">ref.ts</code> </li>
</ol>
<!-- more -->
<h1>Proxy 和 Reflect 回顾</h1>
<p>将 reactive -> createReactiveObject 简化合并：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">,</span> collectionHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 必须是对象 return</span>

  <span class="token comment">// ... 已经设置过代理了</span>
  <span class="token keyword">let</span> observed <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token comment">// ... 本身就是代理</span>

  <span class="token comment">// ... 白名单检测</span>

  <span class="token comment">// ... handlers</span>

  <span class="token comment">// new 代理</span>
  <span class="token keyword">let</span> handlers <span class="token operator">=</span> baseHandlers <span class="token operator">||</span> collectionHandlers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// ...</span>
  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>

  <span class="token comment">// 缓存代理设置结果到 toProxy, toRaw</span>

  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span></code></pre></div>
<p>增加一个 reactive 对象：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'vuejs'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver <span class="token operator">===</span> observed<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
	</code></pre></div>
<p>输出结果：</p>
<blockquote>
<p>{name: “vuejs”} Proxy {name: “vuejs”}</p>
<p>=> original.name
“vuejs”
=> observed.name
index.js:28 true “name” true “get”
undefined
=> observed === original
false</p>
</blockquote>
<p>访问 target, observed 的属性 name 结果如上，<code class="language-text">observed</code> 是被代理之后的对象。</p>
<ol>
<li>Observed.name 输出结果是 handler.get 执行之后的结果，因为没任何返回所以是 <code class="language-text">undefined</code></li>
<li>
<p><code class="language-text">get(target, prop, receiver)</code> 有三个参数，分别代表</p>
<ul>
<li>target: 被代理的对象，即原始的那个 target 对象</li>
<li>prop: 要获取对象的属性值的 key</li>
<li>receiver: 代理之后的对象，即 <code class="language-text">observed</code></li>
</ul>
</li>
</ol>
<p><strong>其他主要几个代理方法</strong>：</p>
<ol>
<li><code class="language-text">set</code> 赋值的时候触发，对应 <code class="language-text">Reflect.set(target, prop, value)</code></li>
<li><code class="language-text">get</code> 取值的时候触发，对应 <code class="language-text">Reflect.get(target, prop, reciver)</code></li>
<li><code class="language-text">ownKeys</code> 使用 <code class="language-text">for...in</code> 时触发，对应 <code class="language-text">Reflect.ownKeys(target)</code></li>
<li><code class="language-text">has</code> 使用 <code class="language-text">prop in obj</code> 时触发，对应语法 ： <code class="language-text">... in ...</code></li>
<li><code class="language-text">deleteProperty</code> 使用 <code class="language-text">delete obj.name</code> 触发，对应 <code class="language-text">delete obj.name</code></li>
<li><code class="language-text">apply</code> 被代理对象是函数的时候，通过 <code class="language-text">fn.apply()</code> 时触发，handler 里对应 <code class="language-text">fn()</code></li>
<li><code class="language-text">construct</code> 构造器，<code class="language-text">new target()</code> 时触发</li>
<li><code class="language-text">getPrototypeOf</code> 调用 <code class="language-text">Object.getPrototypeOf(target)</code> 触发，返回对象 或 null</li>
<li><code class="language-text">setPrototypeOf</code> 设置对象原型时触发，如： <code class="language-text">obj.prototype = xxx</code></li>
</ol>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> original <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'vuejs'</span><span class="token punctuation">,</span>
  foo<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

original <span class="token operator">=</span> test

<span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target <span class="token operator">===</span> original<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver <span class="token operator">===</span> observed<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">)</span>
    Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">ownKeys</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get own keys...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">has</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'has proxy handler...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> key <span class="token keyword">in</span> target
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">deleteProperty</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">'deleted from '</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    <span class="token keyword">delete</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 适用于被代理对象是函数类型的</span>
  <span class="token function-variable function">apply</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'apply...'</span><span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
    <span class="token function">target</span><span class="token punctuation">(</span><span class="token operator">...</span>argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'proxy construct ... '</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">target</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 必须返回一个对象或者 null，代理 Object.getPrototypeOf 取对象原型</span>
  <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'proxy getPrototypeOf...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'proxy setPrototypeOf...'</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// -> true "name" true "get"</span>
observed<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'xxx'</span> <span class="token comment">// -> name xxx set</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> observed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span> <span class="token comment">// -> get own keys...</span>
<span class="token string">'name'</span> <span class="token keyword">in</span> observed <span class="token comment">// -> has proxy handler</span>
<span class="token keyword">delete</span> observed<span class="token punctuation">.</span>foo <span class="token comment">// foo deleted from { name: 'xxx', foo: 1 }</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'test apply'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">observed</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// apply... (3) [1, 2, 3]</span>
<span class="token comment">// 注意点：proxy-construct 的第二个参数是传入构造函数时的参数列表</span>
<span class="token comment">// 就算是以下面方式一个个传递的</span>
<span class="token keyword">new</span> <span class="token class-name">observed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// proxy construct ...  (3) [1, 2, 3]</span>
Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span> <span class="token comment">// proxy getPrototypeOf...</span>
observed<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  bar<span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token comment">// prototype {bar: 2} set</span>
<span class="token comment">// index.js:31 true "prototype" true "get"</span>
<span class="token comment">// index.js:90 {bar: 2}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span></code></pre></div>
<p>需要注意的点：</p>
<ol>
<li><code class="language-text">construct</code> 的代理 <code class="language-text">handler</code> 中的第二个参数是一个参数列表数组。</li>
<li><code class="language-text">getPrototypeOf</code> 代理里面返回一个正常的对象 或 <code class="language-text">null</code>表示失败。 </li>
</ol>
<h1>reactive 函数</h1>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// if trying to observe a readonly proxy, return the readonly version.</span>
  <span class="token comment">// 这里对只读的对象进行判断，因为只读的对象不允许修改值</span>
  <span class="token comment">// 只要曾经被代理过的就会被存到 readonlyToRaw 这个 WeakMap 里面</span>
  <span class="token comment">// 直接返回只读版本</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonlyToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    rawToReactive<span class="token punctuation">,</span>
    reactiveToRaw<span class="token punctuation">,</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>传入一个 <code class="language-text">target</code> 返回代理对象。</p>
<h1>createReactiveObject</h1>
<p>真正执行代理的是这个函数里面。</p>
<h2>参数列表</h2>
<ol>
<li><code class="language-text">target</code> 被代理的对象</li>
<li><code class="language-text">toProxy</code> 一个 <code class="language-text">WeakMap</code> 里面存储了 <code class="language-text">target -&gt; observed</code> </li>
<li><code class="language-text">toRaw</code> 和 <code class="language-text">toProxy</code> 刚好相反的一个 <code class="language-text">WeakMap</code> 存储了 <code class="language-text">observed -&gt; target</code></li>
<li><code class="language-text">baseHandlers</code> 代理时传递给 <code class="language-text">Proxy</code> 的第二个参数</li>
<li><code class="language-text">collectionHandlers</code> 代理时传递给 <code class="language-text">Proxy</code> 的第二个参数(一个包含四种集合类型的 <code class="language-text">Set</code>)</li>
</ol>
<h2>函数体</h2>
<p>下面是将 <code class="language-text">reactive</code> 和 <code class="language-text">createReactiveObject</code> 进行合并的代码。</p>
<p>事先声明的变量列表：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 集合类型的构造函数，用来检测 target 是使用 baseHandlers</span>
<span class="token comment">// 还是 collectionHandlers</span>
<span class="token keyword">const</span> collectionTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Set<span class="token punctuation">,</span> Map<span class="token punctuation">,</span> WeakMap<span class="token punctuation">,</span> WeakSet<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 只读对象的 map，只读对象代理时候直接返回原始对象</span>
<span class="token keyword">const</span> readonlyToRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 存储一些只读或无法代理的值</span>
<span class="token keyword">const</span> rawValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>合并后的 <code class="language-text">reactive(target, toProxy, toRaw, basehandlers, collectionHandlers)</code> 函数</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">,</span> collectionHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只读的对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonlyToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// ... 必须是对象 return</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'不是对象，不能被代理。。。'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>

  <span class="token comment">// toProxy 是一个 WeakMap ，存储了 observed -> target</span>
  <span class="token comment">// 因此这里检测是不是已经代理过了避免重复代理情况</span>
  <span class="token keyword">let</span> observed <span class="token operator">=</span> toProxy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>observed <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'target 已经设置过代理了'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> observed
  <span class="token punctuation">}</span>

  <span class="token comment">// ... 本身就是代理</span>
  <span class="token comment">// toRaw 也是一个 WeakMap 存储了 target -> observed</span>
  <span class="token comment">// 这里判断这个，可能是为了防止，将曾经被代理之后的 observed 传进来再代理的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>toRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'target 本身已经是代理'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>

  <span class="token comment">// ...... 这里省略非法对象的判断，放在后面展示 ......</span>

  <span class="token comment">// 根据 target 类型决定使用哪个 handlers</span>
  <span class="token comment">// `Set, Map, WeakSet, SeakMap` 四种类型使用 collectionHandlers 集合类型的 handlers</span>
  <span class="token comment">// `Object, Array` 使用 basehandlers</span>
  <span class="token keyword">const</span> handlers <span class="token operator">=</span> collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span>
    <span class="token operator">?</span> collectionHandlers
    <span class="token operator">:</span> baseHandlers

  <span class="token comment">// new 代理</span>
  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>

  <span class="token comment">// 缓存代理设置结果到 toProxy, toRaw</span>
  toProxy<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
  toRaw<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span></code></pre></div>
<ol>
<li><code class="language-text">readonlyToRaw.has(target)</code> 检测是否是只读对象，直接返回该对象</li>
<li>检测 <code class="language-text">target</code>是引用类型还是普通类型，只有引用类型才能被代理</li>
<li><code class="language-text">toProxy</code> 中存储了 <code class="language-text">target-&gt;observed</code> 内容，检测 <code class="language-text">target</code> 是不是已经有代理了</li>
<li><code class="language-text">toRaw</code> 中存储了 <code class="language-text">observed-&gt;target</code> 检测是否已经是代理了</li>
<li>
<p>五种不合法的对象类型，不能作为代理源</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// ... 白名单检测，源码中调用的是 `canObserve` 这里一个个拆分来检测</span>
 <span class="token comment">// 1. Vue 实例本身不能被代理</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'target 是 vue 实例，不能被代理'</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> target
 <span class="token punctuation">}</span>

 <span class="token comment">// 2. Vue 的虚拟节点，其实就是一堆包含模板字符串的对象解构</span>
 <span class="token comment">// 这个是用来生成 render 构建 DOM 的，不能用来被代理</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'target 是虚拟节点，不能被代理'</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> targtet
 <span class="token punctuation">}</span>

 <span class="token comment">// 限定了只能被代理的一些对象： 'Object, Array, Map, Set, WeakMap, WeakSet`</span>
 <span class="token comment">// Object.prototype.toString.call(target) => [object Object] 取 (-1, 8)</span>
 <span class="token comment">// 其实 `Object` 构造函数字符串</span>
 <span class="token keyword">const</span> <span class="token function-variable function">toRawType</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span>
   <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>
   <span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">'Object'</span><span class="token punctuation">,</span> <span class="token string">'Array'</span><span class="token punctuation">,</span> <span class="token string">'Map'</span><span class="token punctuation">,</span> <span class="token string">'Set'</span><span class="token punctuation">,</span> <span class="token string">'WeakMap'</span><span class="token punctuation">,</span> <span class="token string">'WeakSet'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>
     <span class="token function">toRawType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
   <span class="token punctuation">)</span>
 <span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
     <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">target 不是可代理范围对象('Object', 'Array', 'Map', 'Set', 'WeakMap', 'WeakSet')</span><span class="token template-punctuation string">`</span></span>
   <span class="token punctuation">)</span>
   <span class="token keyword">return</span> target
 <span class="token punctuation">}</span>

 <span class="token comment">// 那些被标记为只读或者非响应式的WeakSets的值</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>rawValues<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> target
 <span class="token punctuation">}</span>

 <span class="token comment">// 被冻结的对象，是不允许任何修改操作的，不可用作响应式对象</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">isFrozen</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> target
 <span class="token punctuation">}</span></code></pre></div>
</li>
<li>根据 target 的类型检测采用哪种类型的 <code class="language-text">handlers</code>，集合类型使用 <code class="language-text">collectionhandlers</code>，对象类型采用 <code class="language-text">baseHandlers</code></li>
<li>创建代理 <code class="language-text">new Proxy(target, handlers)</code></li>
<li>缓存代理源及代理结果到 <code class="language-text">toProxy, toRaw</code> 避免出现重复代理的情况</li>
<li>返回代理对象 <code class="language-text">observed</code>。</li>
</ol>
<h2>使用 <code class="language-text">reactive</code></h2>
<p>为了区分两种代理类型(集合类型，普通对象(对象和数组))，这里使用两个对象(<code class="language-text">setTarget</code>, <code class="language-text">objTarget</code>)，创建两个代理(<code class="language-text">setObserved</code>, <code class="language-text">objObserved</code>)，分别传入不同的代理 <code class="language-text">handlers</code>，代码如下：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> toProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> toRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> setTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> objTarget <span class="token operator">=</span> <span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  bar<span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> setObserved <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>setTarget<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token string">'set get...'</span><span class="token punctuation">)</span>
    <span class="token comment">// return Reflect.get(target, prop, receiver)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// set/map 集合类型</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ret <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> <span class="token string">'set has...'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> objObserved <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>
  objTarget<span class="token punctuation">,</span>
  toProxy<span class="token punctuation">,</span>
  toRaw<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// object/arary, 普通类型</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token string">'object/array get...'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span></code></pre></div>
<p>输出代理的结果对象如下：<code class="language-text">console.log(setObserved, objObserved)</code></p>
<p>结果：<code class="language-text">Proxy {1, 2, 3} Proxy {foo: 1, bar: 2}</code></p>
<p>然后出现了错误，当我试图调用 <code class="language-text">setObserved.has(1)</code> 的时候<span id="error-map">报错了</span>：</p>
<p><img src="http://qiniu.ii6g.com/1589614203.png?imageMogr2/thumbnail/!100p"></p>
<p>获取 <code class="language-text">setObserved.size</code> 属性报错，不同的是 <code class="language-text">set proxy handler</code> 有被调用，这里应该是调用 <code class="language-text">Reflect.get()</code> 时候报错了：</p>
<p><img src="http://qiniu.ii6g.com/1589614685.png?imageMogr2/thumbnail/!100p"></p>
<p><a href="https://medium.com/the-non-traditional-developer/safely-extending-the-javascript-set-object-using-proxies-3ce25702b8c3">google 之后这里有篇文章里给出了问题原因和解决方案</a></p>
<p>解决方法，在 <code class="language-text">get proxy handler</code> 里面加上判断，如果是函数就使用 <code class="language-text">target</code>去调用：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> setObserved <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>setTarget<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>prop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是函数，经过代理之后会丢失作用域问题，所以要</span>
        <span class="token comment">// 重新给他绑定下作用域</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token string">'get...'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span> target<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span>
          <span class="token operator">?</span> target<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
          <span class="token operator">:</span> target<span class="token punctuation">[</span>prop<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
 </code></pre></div>
<p>结果：</p>
<blockquote>
<p>Proxy {1, 2, 3} Proxy {foo: 1, bar: 2}
-> setObserved.has(1)
has get…
true</p>
</blockquote>
<h1>baseHandlers.ts</h1>
<p>这个文件模块出现了几个 handlers 是需要弄清楚的，比如：</p>
<p><code class="language-text">baseHandlers.ts</code> 里面和 <strong>Array</strong>, <strong>Object</strong> 有关的四个：</p>
<ol>
<li><code class="language-text">mutableHandlers</code></li>
<li><code class="language-text">readonlyHandlers</code></li>
<li><code class="language-text">shallowReactiveHandlers</code>, </li>
<li><code class="language-text">shallowReadonlyHandlers</code></li>
</ol>
<p><code class="language-text">collectionHandlers.ts</code> 里和集合相关的两个：</p>
<ol>
<li><code class="language-text">mutableCollectionHandlers</code></li>
<li><code class="language-text">readonlyCollectionHandlers</code></li>
</ol>
<p>在上一节讲过 <code class="language-text">createReactiveObject</code> 需要给出两个 handlers 作为参数，一个是针对数组和普通对象的，另一个是针对集合类型的。</p>
<p>下面分别来看看两个文件中分别都干了什么？？？</p>
<h2>列出文件中相关的函数和属性：</h2>
<p>属性:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 符号集合</span>
<span class="token keyword">const</span> builtInSymbols <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 四个通过 createGetter 生成的 get 函数</span>
<span class="token keyword">const</span> <span class="token keyword">get</span> <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> shallowGet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readonlyGet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> shallowReadonlyGet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// 三个数组函数 'includes', 'indexOf', 'lastIndexOf'</span>
<span class="token keyword">const</span> arrayInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// setter</span>
<span class="token keyword">const</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> shallowSet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></div>
<p>函数：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 创建 getter 函数的函数</span>
<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>

<span class="token comment">// 创建 setter 函数的函数</span>
<span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>

<span class="token comment">// delete obj.name 原子操作</span>
<span class="token keyword">function</span> <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> 	<span class="token comment">/*...*/</span> 
<span class="token punctuation">}</span>

<span class="token comment">// 原子操作 key in obj</span>
<span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>

<span class="token comment">// Object.keys(target) 操作，取对象 key</span>
<span class="token keyword">function</span> <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span></code></pre></div>
<p>四个要被导出的 <code class="language-text">handlers</code>：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReactiveHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span></code></pre></div>
<p>接下来一个个来分析分析，看看每个都有什么作用？？？</p>
<p>先从 <code class="language-text">createGetter</code> 说起吧 -> </p>
<p>为了下面方便调试，对上面的 <code class="language-text">reactive()</code> 进行了简化，只保留了与 handlers 有关的部分：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> collectionTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Set<span class="token punctuation">,</span> Map<span class="token punctuation">,</span> WeakMap<span class="token punctuation">,</span> WeakSet<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">,</span> collectionHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 简化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target

  <span class="token comment">//... isVue, VNode...</span>

  <span class="token keyword">let</span> observed <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">const</span> handlers <span class="token operator">=</span> collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span>
    <span class="token operator">?</span> collectionHandlers
    <span class="token operator">:</span> baseHandlers

  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
  toProxy<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
  toRaw<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span>

<span class="token keyword">const</span> toProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  toRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h2>createGetter(isReadonly = false, shallow = false)</h2>
<p>参数： </p>
<ol>
<li><code class="language-text">isReadonly = false</code></li>
<li><code class="language-text">shallow = false</code></li>
</ol>
<p>简化之后的 <code class="language-text">createGetter</code>，先用它来创建一个 <code class="language-text">get</code> 然后创建一个 <code class="language-text">baseHandler: mutableHandlers</code> 可变的 <code class="language-text">handlers</code>。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token comment">// 很明显这个 proxy handler get, 简化之后...</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
    <span class="token comment">// ... 省略1，如果是数组，且是 includes, indexOf, lastIndexOf 操作</span>
    <span class="token comment">// 直接返回它对应的 res</span>
    <span class="token comment">// ... 省略2，如果是符号属性，直接返回 res</span>

    <span class="token comment">// ... 省略3, 浅 reactive，不支持嵌套</span>

    <span class="token comment">// ... 省略4，isRef 类型，判断是数组还是对象，数组执行 track(...), 对象返回 res.value</span>

    <span class="token comment">// 非只读属性，执行 track()，收集依赖</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">'get...'</span><span class="token punctuation">)</span>
    <span class="token comment">// return res</span>
    <span class="token comment">// 非对象直接返回原结果，如果是对象区分只读与否</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> res <span class="token operator">!==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> isReadonly
        <span class="token operator">?</span> <span class="token comment">// need to lazy access readonly and reactive here to avoid</span>
          <span class="token comment">// circular dependency</span>
          res <span class="token comment">// ... readonly(res)</span>
        <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">)</span>
      <span class="token operator">:</span> res
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>上面我们省略了暂时不关心的是哪个部分：</p>
<ol>
<li>数组类型且 key 是 <code class="language-text">[&#39;includes&#39;, &#39;indexOf&#39;, &#39;lastIndexOf&#39;]</code> 其中任一一个</li>
<li>符号属性处理</li>
<li><code class="language-text">ref</code> 类型处理</li>
</ol>
<p>目前我们只关心如何创建 <code class="language-text">get</code> 和一个最简单的 <code class="language-text">basehandler: mutableHandler</code></p>
<p>使用 <code class="language-text">createGetter: get</code></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 示例 1</span>
<span class="token keyword">const</span> objTarget <span class="token operator">=</span> <span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  bar<span class="token operator">:</span> <span class="token punctuation">{</span> 
    name<span class="token operator">:</span> <span class="token string">'bar'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将 createGetter 生成的 get -> mutableHandlers 传入 reactive</span>
<span class="token keyword">const</span> objObserved <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>objTarget<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">)</span></code></pre></div>
<p>这里 <code class="language-text">get</code> 我认为只有两个目的：</p>
<h2>递归 <code class="language-text">reactive</code>，就在最后返回的时候检测 <code class="language-text">res</code> 结果时候</h2>
<p>这里我们首先来验证下递归 <code class="language-text">reactive</code> 问题，即当我们访问对象中嵌套对象里面的属性时候，实际上是不会触发 <code class="language-text">get</code> 的，我们在 <code class="language-text">createGetter</code> 的 <code class="language-text">return</code> 前面加上一句 <code class="language-text">return res</code> 。</p>
<p>也就是说不检测结果是不是对象，而直接返回当前取值的结果：</p>
<blockquote>
<p>=> objObserved.foo
“foo” “get…”
1
=> objObserved.bar
{name: “bar”} “bar” “get…”
{name: “bar”}
{name: “bar”} “bar” “get…”
=> objObserved.bar.name
{name: “bar”} “bar” “get…”
“bar”
=> const bar = objObserved.bar
{name: “bar”} “bar” “get…”
undefined
=> bar.name
“bar”</p>
</blockquote>
<p>分析上面的测试结果：</p>
<ul>
<li><code class="language-text">objObserved.foo</code> 直接取对象的成员值，触发了 <code class="language-text">proxy get</code></li>
<li><code class="language-text">objObserved.bar</code> 取对象的对象成员，触发了 <code class="language-text">proxy get</code></li>
<li><code class="language-text">objObserved.bar.name</code> 取嵌套对象的成员，触发了 <code class="language-text">proxy get</code>但请注意实际上触发 <code class="language-text">get</code> 的是 <code class="language-text">objObserved.bar</code> 得取值过程，因为输出的 <code class="language-text">res</code> 是 <code class="language-text">{name: &quot;bar&quot;}</code>，也就是说取 <code class="language-text">bar.name</code> 的<code class="language-text">name</code>时候实际并没有触发 <code class="language-text">proxy get</code>，这说明 <code class="language-text">proxy get</code> 只能代理一级。</li>
<li>为了证明代理只能代理一级，下面通过 <code class="language-text">bar = objObserved.bar</code> 再去取 <code class="language-text">bar.name</code> 就很明显并没有触发 <code class="language-text">proxy get</code></li>
</ul>
<p>通过上面的分析，这也就是为什么要在 <code class="language-text">return</code> 的时候去检测是不是对象，如果是对象需要进行递归 <code class="language-text">reactive</code>的动作。</p>
<p>那么，我们将 <code class="language-text">return res</code> 注释掉再来看看结果如何：</p>
<blockquote>
<p>=> objObserved.foo
1 “foo” “get…”
1
=> objObserved.bar
{name: “bar”} “bar” “get…”
Proxy {name: “bar”}
=> objObserved.bar.name
{name: “bar”} “bar” “get…”
bar name get…
“bar”
=> const bar = objObserved.bar
{name: “bar”} “bar” “get…”
bar.name
=> bar name get…
“bar”</p>
</blockquote>
<p>看到差异没，首先从 <code class="language-text">objObserved.bar.name</code> 就可看出差异了，这里首先触发的实际是 <code class="language-text">objObserved.bar</code> 的 <code class="language-text">proxy get</code>，此时 <code class="language-text">return</code> 的时候发现结果是个对象，因此将 <code class="language-text">bar</code> 传入 <code class="language-text">reactive(bar)</code> 进一步代理，完成之后取 <code class="language-text">bar.name</code> 的时候 <code class="language-text">bar</code> 已经是 reactive 对象了，因此就在 <strong>{name: “bar”} “bar” “get…”</strong> 后面紧跟着出现了<strong>bar name get…</strong> 输出。</p>
<p>此时，无论后面是赋值到变量 <code class="language-text">bar</code> 再取 <code class="language-text">bar.name</code> 结果一样会触发对应的 <code class="language-text">proxy get</code>，毕竟对象是引用类型，类似指针一样，新增了一个变量指向它，它依旧在哪里。</p>
<p>到此，最基本的 <code class="language-text">proxy get</code> 响应式也完成了，并且能做到嵌套对象的 reactive 化，感觉相比 vue3 之前的通过 <code class="language-text">defineProperty</code> 实现更加清晰容易理解。</p>
<h2>收集依赖(<code class="language-text">track</code>)</h2>
<p>既然有了响应式数据，那么接下来的重点就是如果利用其特性为我们做点事情，但是它又如何知道为我们做什么的，这个时候就有了所谓的“收集依赖”。</p>
<p>“收集依赖”就是在 <code class="language-text">get</code> 取值期间发生的，也就是 <code class="language-text">createGetter</code> 中的 <code class="language-text">track()</code> 调用时触发了依赖收集动作。</p>
<p><code class="language-text">track()</code> 相关的代码在 <code class="language-text">effect.ts</code> 中：</p>
<p>函数定义： </p>
<p><code class="language-text">export function track(target: object, type: TrackOpTypes, key: unknown){}</code></p>
<p>有三个参数：</p>
<ol>
<li>target：proxy get 时候传递给 proxy 的那个对象</li>
<li>type: 要 track 的类型，有三种： <code class="language-text">get</code>, <code class="language-text">has</code>,<code class="language-text">iterate</code>，分别是取值，检测属性存在性，以及迭代时。</li>
<li>Key: 针对 target 对象里面的属性，收集依赖到 <code class="language-text">targetMap -&gt; depsMap -&gt; dep:Set</code> 中</li>
</ol>
<p>简化 <code class="language-text">track(target, type)</code>代码：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// trackType -> get, has, iterate</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...省略1 检测 shouldTrack 和 activeEffect 标记</span>

  <span class="token comment">// 取 target 自己的依赖 map ，如果没有说明是首次，需要给它创建一个</span>
  <span class="token comment">// 空的集合，这里使用 Map 而不是 WeakMap，为的是强引用，它涉及到</span>
  <span class="token comment">// 数据的更新触发 UI 渲染，因此不该使用 WeakMap，否则可能会导致依赖丢失问题</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 接下来对 key 取其依赖</span>
  <span class="token comment">// 如果属性的依赖不存在，说明该对象是首次使用，需要创建其依赖库</span>
  <span class="token comment">// 且这里使用了 `Set` 是为了避免重复注册依赖情况，避免数据的更新导致重复触发</span>
  <span class="token comment">// 同一个 update 情况</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 注册实际的 update: activeEffect 操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
    activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>代码实现主要有三个过程：</p>
<ol>
<li>检测全局的 <code class="language-text">targetMap</code> 中是不是有 <code class="language-text">target</code> 自己的依赖仓库(<code class="language-text">Map</code>)</li>
<li>检测 <code class="language-text">depsMap = targetMap.get(target)</code> 中是不是有取值 <code class="language-text">key</code> 对应的依赖集合 <code class="language-text">dep</code></li>
<li>注册 <code class="language-text">activeEffect</code>对象，然后将当前 target-key-dep 注册到 activeEffect，然后发现每个 <code class="language-text">activeEffect</code>会有自己的 <code class="language-text">deps</code> 保存了所有对象 <code class="language-text">key</code> 的依赖。 </li>
</ol>
<p>收集依赖的过程如图：，执行取值 <code class="language-text">activeEffect.deps</code> 中就会新增一个 <code class="language-text">Set</code></p>
<p><img src="http://qiniu.ii6g.com/1589694976.png?imageMogr2/thumbnail/!100p"></p>
<p>到这里，依赖收集算是完成，但并不是很明白 <code class="language-text">activeEffect</code> 具体是做什么的???</p>
<p>既然依赖收集，要搞明白 <code class="language-text">activeEffect</code> 是做什么的，估计的从 <code class="language-text">set</code> 入手了，下面来实现 <code class="language-text">set</code> 从而完成一个完整的 <code class="language-text">get -&gt; dep -&gt; set -&gt; update</code> 的过程。</p>
<p>go on…</p>
<h2>createSetter(shallow = false)</h2>
<p>源码简化版：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 标准的 proxy set</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取旧值</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

    <span class="token comment">// 先不管 shallow mode</span>

    <span class="token comment">// 还记得 reactive 里面的 toRaw啊，对象这里就是取出</span>
    <span class="token comment">// value 的原始对象 target，前提是它有 reactive() 过</span>
    <span class="token comment">// 才会被存入到 toRaw: observed -> target 中</span>
    <span class="token comment">// 暂时简化成： toRaw.get(value)</span>
    value <span class="token operator">=</span> toRaw<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token comment">// ... 省略，ref 检测</span>

    <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">// 先执行设置原子操作</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token comment">// 只有对象是它自身的时候，才触发 dep-update(排除原型链)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新增属性操作</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 值改变操作,排除 NaN !== NaN 情况</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这里主要有几个操作：</p>
<ol>
<li>shallow mode 检测，已省略。</li>
<li><code class="language-text">value = toRaw(value)</code> 如果 value 是 observed，那么可以通过 toRaw 取出被代理之前的对象 target，还记得 <code class="language-text">reactive()</code> 里面的那个 toRaw, toProxy 缓存操作吧。</li>
<li>调用 <code class="language-text">Reflect.set()</code> 先将值设置下去，然后再考虑是否触发依赖</li>
<li>检测对象原型链，只有当对象是自身的时候才触发依赖</li>
<li>触发的行为只有两种要么是新增属性(<code class="language-text">add</code>)，要么是更改值(<code class="language-text">set</code>, 值不变的情况不触发)</li>
</ol>
<p>这里有个与 <code class="language-text">createGetter</code> 里面收集依赖 (<code class="language-text">track()</code>)对应的触发依赖函数： <code class="language-text">trigger</code>。</p>
<p>接下来就是要看看 <code class="language-text">trigger()</code> 里面都做了啥。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// step1: 检测是否被 track 过，没有根本就没有依赖</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// step2: 将 dep 加入到 effects</span>
  <span class="token comment">// 创建两个 effects, 一个普通的，一个计算属性</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> computedRunners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 根据 effect 的选项 computed 决定是添加到那个 Set 中</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effectsToAdd</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> <span class="token operator">!</span>shouldTrack<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed
          <span class="token operator">?</span> computedRunners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
          <span class="token operator">:</span> effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

  <span class="token comment">// if ... clear</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO 清空动作，触发所有依赖</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 数组长度变化</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO 触发更长度变化有关的所有依赖</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 例如： SET | ADD | DELETE 操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> isAddOrDelete <span class="token operator">=</span>
      type <span class="token operator">===</span> <span class="token string">'add'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'delete'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAddOrDelete <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'set'</span> <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除或添加操作，或者 map 的设置操作</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'length'</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Map 的添加或删除操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAddOrDelete <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// step3: 执行 effects 中所有的 dep</span>

  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 选项提供了自己的调度器，执行自己的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发应该触发的依赖</span>
  computedRunners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>主要有三个步骤：</p>
<ul>
<li>step1: 检测是否收集过依赖，如果没有说明可能没有被用过，没什么可触发的</li>
<li>step2: 主要是过滤收集到依赖，针对当前更改操作的所有依赖触发(add)</li>
<li>step2: 经过第二步的依赖过滤之后，触发所有的依赖(run)</li>
</ul>
<p>这里面有两个重要的属性(<code class="language-text">effects</code>,<code class="language-text">computedRunners</code>)和两个函数(<code class="language-text">add</code>,<code class="language-text">run</code>)</p>
<p><em>add: 过滤，run: 执行。</em></p>
<p>很明显，到这里，我们还是没有解决，依赖对应的 <code class="language-text">update</code> 是如何收集的问题，因为 <code class="language-text">set</code> 也只是将已经收集好 <code class="language-text">dep</code> 执行而已。</p>
<h1>effect.ts</h1>
<p>该文件中主要包含三个重要函数:</p>
<ol>
<li><code class="language-text">trigger(target, type, key?, newValue?, oldValue?, oldTarget?)</code> 触发依赖函数</li>
<li><code class="language-text">effect-&gt;createReactiveEffect(fn, options)</code> 转换依赖函数成ReactiveEffect类型，并且立即执行它。</li>
<li><code class="language-text">track(target, type, key)</code></li>
</ol>
<p>以及一些辅助函数：</p>
<ol>
<li><code class="language-text">isEffect()</code> 检测是不是 <code class="language-text">ReactiveEffect</code> 类型
<code class="language-text">isEffect = fn =&gt; fn?._isEffect === true</code></li>
<li>
<p><code class="language-text">stop(effect: ReactiveEffect)</code>
停止 effect ，如果选项中提供了 onStop 监听该动作，执行它，重置 effect.active。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">cleanup</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><code class="language-text">cleanup(effect: ReactiveEffect)</code></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 在 track 的时候，加入 effect 时，对其做一次清理工作</span>
<span class="token comment">// 保证 effect.deps 干净</span>
<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> <span class="token punctuation">{</span> deps <span class="token punctuation">}</span> <span class="token operator">=</span> effect
 <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><code class="language-text">pauseTracking()</code></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 暂停 track 动作</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 trackStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span>
 shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><code class="language-text">enableTracking()</code></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 恢复 track 动作</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enableTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 trackStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span>
 shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><code class="language-text">resetTracking()</code></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 重置 track，可能 fn 执行失败了，try ... finally ... 丢弃 fn:effect 时候调用</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> last <span class="token operator">=</span> trackStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 shouldTrack <span class="token operator">=</span> last <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> last
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<p>包含的属性变量：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 保存着 target 对象的所有依赖的 Map &lt;target, dep&lt;Set>></span>
<span class="token comment">// target -> Map&lt;key, dep[]></span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// effect 栈，保存所有的 fn->effect</span>
<span class="token keyword">const</span> effectStack<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 当前激活状态的 effect</span>
<span class="token keyword">let</span> activeEffect<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token string">'iterate'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">MAP_KEY_ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token string">'Map key iterate'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>

<span class="token comment">// 执行 effect 时，uid++，即每个 effect 都会有自己的唯一的 uid</span>
<span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">// 记录当前 effect 的状态，</span>
<span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// 当前 effect -> shouldTack</span>
<span class="token comment">// 每增加一个 effect 记录 shouldTrack = true, push 到 trackStack</span>
<span class="token comment">// 如果 effect.raw&lt;fn> 执行异常会 pop 掉，还原 shouldTrack -> last, </span>
<span class="token comment">// pop trackStack</span>
<span class="token keyword">const</span> trackStack<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre></div>
<p>一直到这里我们基本完成了 <code class="language-text">reactive-&gt;get-&gt;set-&gt;track-&gt;trigger-&gt;effect</code> 一系列动作，</p>
<p>也该我们测试的时候了，按正常应该会有我们想要的结果，响应式->注册fn:update->取值收集依赖-> 设置触发 fn:udpate 调用 </p>
<p>=>>>>>>>>></p>
<p>比如：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">r</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effect fn'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'after effect'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>上面的例子运行之后，并没有得到我们想要的结果！！！</p>
<blockquote>
<p>effect fn
[“id”, “_isEffect”, “active”, “raw”, “deps”, “options”] “after effect”
0 “num” “get…”
0 “before”
0 “after”</p>
</blockquote>
<p>按照我们的实现，理论上 after 的结果应该是 7 才对，但结果显示依然是 0，这说明了我们调用 <code class="language-text">effect(fn)</code> 并没有与上面的 <code class="language-text">r({ num: 0 })</code> 发生任何联系，即 fn 并没有被收集到 <code class="language-text">counter.num</code> 的依赖 deps 中去，那这是为什么呢？？？</p>
<hr>
<p>我们来回顾分析下之前所作工作的整个过程(<code class="language-text">reactive-&gt;get-&gt;set-&gt;track-&gt;trigger-&gt;effect</code>):</p>
<ul>
<li><code class="language-text">reactive</code> 将数据通过 <code class="language-text">proxy</code> 转成响应式</li>
<li><code class="language-text">get-&gt;track</code> 收集依赖，相关属性：targetMap, depsMap, dep, activeEffect, activeEffect.deps。</li>
<li><code class="language-text">set-&gt;trigger</code> 触发依赖 update 函数，涉及到的 targetMap, depsMap,  add, run</li>
<li><code class="language-text">effect</code> 将 update 函数，转换成 ReactiveEffect 类型</li>
</ul>
<p>纵观这整个过程，尤其是 <code class="language-text">get-&gt;track</code> ， <code class="language-text">set-&gt;trigger -&gt; effect</code> 收集，触发和 effect 三个过程，唯一有可能让他们发生联系的应该就是这个 <code class="language-text">activeEffect</code> 模块域里的变量，标识着当前处于激活状态的 effect，它的使用几乎贯穿了整个过程(track->trigger->effect，这三个函数也都在 <em>effect.ts</em> 中实现)。</p>
<p>那么接下来…</p>
<p>前面都是简化之后的，现在看看完整的这三个函数实现：</p>
<h2>track(target, type, key)</h2>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> activeEffect <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
    activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      activeEffect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        effect<span class="token operator">:</span> activeEffect<span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token punctuation">,</span>
        key
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>trigger(…)</h2>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span>
  <span class="token keyword">type</span><span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>
  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  newValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldTarget<span class="token operator">?</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">></span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// never been tracked</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> computedRunners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effectsToAdd<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> <span class="token operator">!</span>shouldTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            computedRunners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// the effect mutated its own dependency during its execution.</span>
          <span class="token comment">// this can be caused by operations like foo.value++</span>
          <span class="token comment">// do not trigger or we end in an infinite loop</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// collection being cleared</span>
    <span class="token comment">// trigger all effects for target</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">||</span> key <span class="token operator">>=</span> <span class="token punctuation">(</span>newValue <span class="token keyword">as</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// schedule runs for SET | ADD | DELETE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// also run for iteration key on ADD | DELETE | Map.SET</span>
    <span class="token keyword">const</span> isAddOrDelete <span class="token operator">=</span>
      <span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      isAddOrDelete <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span> <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'length'</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAddOrDelete <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        effect<span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        key<span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token punctuation">,</span>
        newValue<span class="token punctuation">,</span>
        oldValue<span class="token punctuation">,</span>
        oldTarget
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Important: computed effects must be run first so that computed getters</span>
  <span class="token comment">// can be invalidated before any normal effects that depend on them are run.</span>
  computedRunners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>effect(fn, options)</h2>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> effect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> ReactiveEffectOptions <span class="token operator">=</span> <span class="token constant">EMPTY_OBJ</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> fn<span class="token punctuation">.</span>raw
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span>


<span class="token keyword">function</span> createReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> ReactiveEffectOptions
<span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">reactiveEffect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> options<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effectStack<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cleanup</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">enableTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
        activeEffect <span class="token operator">=</span> effect
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> ReactiveEffect
  effect<span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>
  effect<span class="token punctuation">.</span>_isEffect <span class="token operator">=</span> <span class="token boolean">true</span>
  effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
  effect<span class="token punctuation">.</span>raw <span class="token operator">=</span> fn
  effect<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  effect<span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span></code></pre></div>
<h2>对比三个函数</h2>
<table>
<thead>
<tr>
<th>过程</th>
<th>shouldTrack/activeEffect</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">track</code></td>
<td><font color="blue">if (!shouldTrack || activeEffect === undefined) return</font></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">trigger</code></td>
<td>add 里面有个判断：<font color="blue">if (!shouldTrack || effect !== activeEffect)`</font>才会继续往下执行添加操作</td>
<td></td>
</tr>
<tr>
<td><code class="language-text">effect</code></td>
<td><code class="language-text">effectStack.push(effect)</code><br /><code class="language-text">activeEffect = effect</code><br />// enable tracking<br /><code class="language-text">trackStack.push(shouldTrack)</code><br /><code class="language-text">shouldTrack = true</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>对下面测试代码逐行分析：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> dummy
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> counter<span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<ol>
<li><code class="language-text">const counter = r({sum: 0})</code>
这里将 { sum: 0 } reactive 代理之后赋值给了  <code class="language-text">counter</code> 也就是说这个 <code class="language-text">counter</code> 是个 <code class="language-text">Proxy</code>：<img src="http://qiniu.ii6g.com/1589705626.png?imageMogr2/thumbnail/!100p"></li>
<li>
<p><code class="language-text">effect(() =&gt; (dummy = counter.num))</code>
在这里调用 <code class="language-text">effect(fn)</code> 注册了一个 updater，里面用到了 <code class="language-text">counter.num</code> 那么就会触发 <code class="language-text">counter.num</code> 的 <code class="language-text">proxy get</code>，然后会触发 <code class="language-text">track()</code> 收集依赖:
<img src="http://qiniu.ii6g.com/1589705890.png?imageMogr2/thumbnail/!100p">
并且我们从图中结果可知， fn 实际被立即执行了一次，这是 <code class="language-text">effect</code> 函数里面的操作。
按预期，这里的 fn 应该会被收集到 counter.num 的 deps 中。
我们在 <code class="language-text">track()</code> 最后加上打印</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
   activeEffect<span class="token operator">?.</span>deps<span class="token operator">?.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">)</span>
 <span class="token punctuation">}</span></code></pre></div>
<p>结果：<img src="http://qiniu.ii6g.com/1589706174.png?imageMogr2/thumbnail/!100p"></p>
<p>即，activeEffect.deps 以及收集到了 <code class="language-text">counter.num</code> 的依赖: <code class="language-text">Map(1) {&quot;num&quot; =&gt; Set(1)}</code>。
<img src="http://qiniu.ii6g.com/1589706408.png?imageMogr2/thumbnail/!100p"></p>
</li>
<li><code class="language-text">console.log(dummy, counter, &#39;before&#39;)</code>
经过上面的结果分析，在第2步的时候，确实已经收集到了 counter.num 的 fn:updater，且存放到了 <code class="language-text">targetMap -&gt; despMap -&gt; num:Set(1)</code> 中。
因此这里的输出内容是： <strong>0 “num” “get…”</strong> 没什么毛病，那继续往下，问题或许处在设置的时候???</li>
<li><code class="language-text">counter.num = 7</code>
最后发现问题所在，原始是个超级低级的问题(捂脸<del>，没脸见人</del>~)。
没有创建 <code class="language-text">set handler</code> 并添加到 mutableHandlers 里面。
只要添加两句：
<code class="language-text">const set = createSetter()</code>
然后：
<code class="language-text">const mutableHandlers = { get, set }</code>
就能得到我们想要的结果。</li>
<li>
<p><code class="language-text">console.log(dummy, &#39;after&#39;)</code>
最后看下最终输出：<img src="http://qiniu.ii6g.com/1589707939.png?imageMogr2/thumbnail/!100p"></p>
<p>1 <code class="language-text">effect(() =&gt; (dummy = counter.num))</code>取值时 proxy get 里面的输出</p>
<p>2： 设置值为 7 之前的输出</p>
<p>3： 设置值当中的输出
4： 最后一个log取值 proxy get 的输出
5： 最后 log 的输出内容</p>
</li>
</ol>
<p>虽然犯了个非常低级的错误，但也正因为这个低级错误，促使自己一步步的去跟踪 <code class="language-text">get-&gt;track</code>, <code class="language-text">set-&gt;trigger</code>, <code class="language-text">effect</code> 整个过程，从而了解了依赖收集，updater 触发原理。</p>
<h1>小结 1</h1>
<p>到此一个比较完整的响应式代码也算告一段落，这里贴一下简化后可运行的完整代码(<a href="https://github.com/gcclll/vue-next-code-read/blob/master/packages/reactive.js">reactive.js</a>)如下：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">hasChanged</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> oldValue</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  value <span class="token operator">!==</span> oldValue <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> value <span class="token operator">||</span> oldValue <span class="token operator">===</span> oldValue<span class="token punctuation">)</span>
<span class="token keyword">const</span> __DEV__ <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token string">'iterate'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">MAP_KEY_ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token string">'Map key iterate'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> trackStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> reactiveToRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> rawToReactive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// baseHandlers.ts start</span>
<span class="token keyword">const</span> <span class="token keyword">get</span> <span class="token operator">=</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 存放目标依赖的 map： target -> depsMap</span>
<span class="token comment">// 一个目标，有自己的一个 map 存放依赖</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token punctuation">{</span>
  _isEffect<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  active<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  raw<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token parameter">observed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> reactiveToRaw<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span> <span class="token operator">||</span> observed
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是个 activeEffect 类型，那么其执行函数应该是 fn.raw</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token operator">?.</span>_isEffect <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> fn<span class="token punctuation">.</span>raw
  <span class="token punctuation">}</span>

  <span class="token comment">// 接下来要创建一个 effect</span>
  <span class="token keyword">const</span> <span class="token function-variable function">_effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">reactiveEffect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 非激活状态</span>
      <span class="token keyword">return</span> options<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effectStack<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果栈中不包含当前的 effect，即没有注册过该 effect</span>
      <span class="token comment">// 注册过就不需要重复注册了</span>
      <span class="token comment">// 添加前先执行清理工作 cleanup -> effect.deps[i].delete(effect)</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
        effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span>
        activeEffect <span class="token operator">=</span> _effect
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// fn 执行异常了，移除对应的 effect</span>
        effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> last <span class="token operator">=</span> trackStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 还原状态值</span>
        shouldTrack <span class="token operator">=</span> last <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> last
        <span class="token comment">// 还原当前激活的 effect</span>
        activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  _effect<span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>
  _effect<span class="token punctuation">.</span>_isEffect <span class="token operator">=</span> <span class="token boolean">true</span>
  _effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
  _effect<span class="token punctuation">.</span>raw <span class="token operator">=</span> fn
  _effect<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  _effect<span class="token punctuation">.</span>options <span class="token operator">=</span> options

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> _effect
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// step1: 检测是否被 track 过，没有根本就没有依赖</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// step2: 将 dep 加入到 effects</span>
  <span class="token comment">// 创建两个 effects, 一个普通的，一个计算属性</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> computedRunners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 根据 effect 的选项 computed 决定是添加到那个 Set 中</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effectsToAdd</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    effectsToAdd<span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> <span class="token operator">!</span>shouldTrack<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed
          <span class="token operator">?</span> computedRunners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
          <span class="token operator">:</span> effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// if ... clear</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO 清空动作，触发所有依赖</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 数组长度变化</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO 触发更长度变化有关的所有依赖</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 例如： SET | ADD | DELETE 操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> isAddOrDelete <span class="token operator">=</span>
      type <span class="token operator">===</span> <span class="token string">'add'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'delete'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAddOrDelete <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'set'</span> <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除或添加操作，或者 map 的设置操作</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'length'</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Map 的添加或删除操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAddOrDelete <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// step3: 执行 effects 中所有的 dep</span>

  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 选项提供了自己的调度器，执行自己的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 触发应该触发的依赖</span>
  computedRunners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// trackType -> get, has, iterate</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> activeEffect <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// ...省略1 检测 shouldTrack 和 activeEffect 标记</span>

  <span class="token comment">// 取 target 自己的依赖 map ，如果没有说明是首次，需要给它创建一个</span>
  <span class="token comment">// 空的集合，这里使用 Map 而不是 WeakMap，为的是强引用，它涉及到</span>
  <span class="token comment">// 数据的更新触发 UI 渲染，因此不该使用 WeakMap，否则可能会导致依赖丢失问题</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 接下来对 key 取其依赖</span>
  <span class="token comment">// 如果属性的依赖不存在，说明该对象是首次使用，需要创建其依赖库</span>
  <span class="token comment">// 且这里使用了 `Set` 是为了避免重复注册依赖情况，避免数据的更新导致重复触发</span>
  <span class="token comment">// 同一个 update 情况</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 注册实际的 update: activeEffect 操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
    activeEffect<span class="token operator">?.</span>deps<span class="token operator">?.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 很明显这个 proxy handler get, 简化之后...</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
    <span class="token comment">// ... 省略1，如果是数组，且是 includes, indexOf, lastIndexOf 操作</span>
    <span class="token comment">// 直接返回它对应的 res</span>
    <span class="token comment">// ... 省略2，如果是符号属性，直接返回 res</span>

    <span class="token comment">// ... 省略3, 浅 reactive，不支持嵌套</span>

    <span class="token comment">// ... 省略4，isRef 类型，判断是数组还是对象，数组执行 track(...), 对象返回 res.value</span>

    <span class="token comment">// 非只读属性，执行 track()，收集依赖</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">'get...'</span><span class="token punctuation">)</span>
    <span class="token comment">// return res</span>
    <span class="token comment">// 非对象直接返回原结果，如果是对象区分只读与否</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> res <span class="token operator">!==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> isReadonly
        <span class="token operator">?</span> <span class="token comment">// need to lazy access readonly and reactive here to avoid</span>
          <span class="token comment">// circular dependency</span>
          res <span class="token comment">// ... readonly(res)</span>
        <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">)</span>
      <span class="token operator">:</span> res
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 标准的 proxy set</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取旧值</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

    <span class="token comment">// 先不管 shallow mode</span>

    <span class="token comment">// 还记得 reactive 里面的 toRaw啊，对象这里就是取出</span>
    <span class="token comment">// value 的原始对象 target，前提是它有 reactive() 过</span>
    <span class="token comment">// 才会被存入到 toRaw: observed -> target 中</span>
    <span class="token comment">// 暂时简化成： toRaw.get(value)</span>
    value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token comment">// ... 省略，ref 检测</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> reactiveToRaw<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> hadKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">// 先执行设置原子操作</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token comment">// 只有对象是它自身的时候，才触发 dep-update(排除原型链)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新增属性操作</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 值改变操作,排除 NaN !== NaN 情况</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span>
<span class="token punctuation">}</span>
<span class="token comment">// baseHandlers.ts end</span>

<span class="token keyword">const</span> collectionTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Set<span class="token punctuation">,</span> Map<span class="token punctuation">,</span> WeakMap<span class="token punctuation">,</span> WeakSet<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> toProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">,</span> collectionHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 简化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target

  <span class="token comment">//... isVue, VNode...</span>

  <span class="token keyword">let</span> observed <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">const</span> handlers <span class="token operator">=</span> collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span>
    <span class="token operator">?</span> collectionHandlers
    <span class="token operator">:</span> baseHandlers

  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
  toProxy<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
  toRaw<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">r</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> rawToReactive<span class="token punctuation">,</span> reactiveToRaw<span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'effect fn'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'after effect'</span><span class="token punctuation">)</span>

<span class="token comment">// 使用示例</span>
<span class="token keyword">let</span> dummy
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> counter<span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> counter<span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>核心函数：</p>
<table>
<thead>
<tr>
<th>函数名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">createGetter-&gt;get</code></td>
<td>创建 proxy 的 get handler，里面会调用 track 收集依赖</td>
</tr>
<tr>
<td><code class="language-text">createSetter-&gt;set</code></td>
<td>创建 proxy 的 set handler，里面会调用 trigger 触发 targetMap>depsMap>dep:Set依赖执行</td>
</tr>
<tr>
<td><code class="language-text">track(target, type, key)</code></td>
<td>收集 target 对象或 target[key] 属性的依赖</td>
</tr>
<tr>
<td><code class="language-text">trigger(target, type, key?, newValue?, oldValue?, oldTarget?)</code></td>
<td>触发 target 对象的依赖调用</td>
</tr>
<tr>
<td><code class="language-text">effect(fn, options)</code></td>
<td>注册reactive属性的updater</td>
</tr>
</tbody>
</table>
<p>涉及到的核心属性：</p>
<p>ReactiveEffect 类型定义：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReactiveEffect</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span>
  _isEffect<span class="token operator">:</span> <span class="token boolean">true</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span>
  active<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token function-variable function">raw</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span>
  deps<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Dep<span class="token operator">></span>
  options<span class="token operator">:</span> ReactiveEffectOptions
<span class="token punctuation">}</span></code></pre></div>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">activeEffect</code></td>
<td><code class="language-text">ReactiveEffect</code></td>
<td>记录当前的 effect，在 <code class="language-text">effect()</code>注册updater的时候置为当前的 RE，在 <code class="language-text">get-&gt;track</code> 里面添加到 targetMap->depsMap->dep 中，且同时更新自己的 <code class="language-text">activeEffect.deps.push(dep)</code></td>
</tr>
<tr>
<td><code class="language-text">effectStack</code></td>
<td><code class="language-text">Array&lt;ReactiveEffect&gt;</code></td>
<td>存放所有的 <code class="language-text">ReactiveEffect</code> 的数组，也就是说页面中所有的 <code class="language-text">updater&lt;ReactiveEffect&gt;</code> 都是存在这里面。但是每个 updater 执行完之后就会被移出 <code class="language-text">effectStack</code>，因为 <code class="language-text">efffect()</code>调用里面有个 <code class="language-text">try...finally</code> 无论结果如何都会被 pop 掉。</td>
</tr>
<tr>
<td><code class="language-text">shouldTrack</code></td>
<td><code class="language-text">Boolean</code></td>
<td>用来追踪当前 effect->activeEffect 的状态</td>
</tr>
<tr>
<td><code class="language-text">trackStack</code></td>
<td><code class="language-text">Array&lt;Boolean&gt;</code></td>
<td>用来存放当前 effect 的 shouldTrack 状态值</td>
</tr>
<tr>
<td><code class="language-text">targetMap</code></td>
<td><code class="language-text">WeakMap</code></td>
<td>存放被 reactive 对象依赖的 Map，即：每个 target 在 targetMap 里面有自己的一个 depsMap，里面以 target => &#x3C;key, Set> 形式存在，key 表示 target 上的一个属性键，Set 存放了该 key 的所有依赖 dep。<img src="http://qiniu.ii6g.com/1589709260.png?imageMogr2/thumbnail/!100p">层级关系：targetMap:WeakMap -> depsMap:Map -> dep:Set</td>
</tr>
<tr>
<td><code class="language-text">depsMap</code></td>
<td><code class="language-text">Map</code></td>
<td>target 对象里所有属性和其依赖对应的关系集合，如：counter.num 的依赖： <code class="language-text">{ &quot;num&quot; =&gt; Set(1) }</code></td>
</tr>
<tr>
<td><code class="language-text">reactiveToRaw</code></td>
<td><code class="language-text">WeakMap</code></td>
<td>作为 reactive 的第三个参数 toRaw，保存了 observed->target 关系的 WeakMap。</td>
</tr>
<tr>
<td><code class="language-text">rawToReactive</code></td>
<td><code class="language-text">WeakMap</code></td>
<td>作为 reactive 的第二个参数 toProxy，保存了 target->observed 关系的 WeakMap，和 <code class="language-text">reactiveToRaw</code> 刚好相反。</td>
</tr>
<tr>
<td><code class="language-text">uid</code></td>
<td><code class="language-text">Number</code></td>
<td>每个 effect 都有一个唯一的 id，一直递增。</td>
</tr>
</tbody>
</table>
<h1>支持数组 reactive</h1>
<p>在这之前都是在对象基础上做的测试，并没有增加数组的支持，比如：jest(所有测试用例都来自官方仓库) -></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'嵌套的 reactives'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">{</span>
      nested<span class="token operator">:</span> <span class="token punctuation">{</span>
        foo<span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      array<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>nested<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>测试结果：</p>
<p><img src="http://qiniu.ii6g.com/1589852337.png?imageMogr2/thumbnail/!100p"></p>
<p>也就是说做到现在，并不支持数组的 reactive，这也是这节将要完善的点。</p>
<ol>
<li>
<p>数组三个方法(<code class="language-text">includes, indexOf, lastIndexOf</code>)的依赖收集：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 数组三个方法的处理</span>
<span class="token keyword">const</span> arrayInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// 兼容数组三个索引方法，收集他们相关的依赖</span>
<span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token string">'includes'</span><span class="token punctuation">,</span> <span class="token string">'indexOf'</span><span class="token punctuation">,</span> <span class="token string">'lastIndexOf'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 arrayInstrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> arra <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">track</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 使用原始方法执行一次(有可能是 reactive 的)</span>
   <span class="token keyword">const</span> res <span class="token operator">=</span> arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> res <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 如果结果失败，使用原始方法再执行一次</span>
     <span class="token keyword">return</span> arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>toRaw<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> res
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><code class="language-text">createGetter -&gt; get</code> 的时候增加数组支持：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>targetIsArray <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// ...省略</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>到这里，我们已经可以正常收集到数组的依赖了，测试代码：</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> targetMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./packages/reactive.js'</span>
   <span class="token keyword">let</span> n
   <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token string">'reactive'</span><span class="token punctuation">]</span>
   <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
   <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>n <span class="token operator">=</span> observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 	<span class="token comment">// 这里还可以添加多个依赖，比如：effect(() => (m = observed[0]))</span>
 	<span class="token comment">// 这样，targetMap>depsMap:arr>dep 里面就会有两个了 [f, f]</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>n<span class="token punctuation">,</span> targetMap<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>输出结果：</p>
<p><img src="/Users/simon/Library/Application%20Support/typora-user-images/image-20200519095740412.png" alt="image-20200519095740412"></p>
<ul>
<li><code class="language-text">effect(() =&gt; (n = observed[0]))</code>会执行一次 <code class="language-text">fn</code> ，即取了一次数组的 <code class="language-text">0</code> 下标值，触发了 <code class="language-text">get</code></li>
<li>检测到是数组进入数组依赖收集程序<code class="language-text">arrayInstrumentations</code> ，触发 <code class="language-text">track</code> 收集依赖</li>
</ul>
<p>🙆‍♂️，依赖咱收集到了，第三步就是如何去触发它们了 >>>></p>
</li>
<li>
<p>数组的 set->trigger 实际上已经支持了</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 触发 updater</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'clear'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'length'</span> <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果是数组，传入 key 是索引值，会进入这个 if 进行依赖收集</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 对象属性 deps</span>
     <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

	<span class="token comment">// ...</span>

<span class="token punctuation">}</span></code></pre></div>
<p>所以下面的示例：</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> targetMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./packages/reactive.js'</span>
   <span class="token keyword">let</span> n<span class="token punctuation">,</span> m
   <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token string">'reactive'</span><span class="token punctuation">]</span>
   <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
   <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>n <span class="token operator">=</span> observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>m <span class="token operator">=</span> observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'setter n'</span>
   observed<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'setter m'</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>n<span class="token punctuation">,</span> m<span class="token punctuation">,</span> targetMap<span class="token punctuation">}</span><span class="token punctuation">)</span>
 </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>输出结果(set 数组元素值的时候出发了 dep 更新 n, m 的值)：</p>
</li>
</ol>
<p><img src="http://qiniu.ii6g.com/1589858380.png?imageMogr2/thumbnail/!100p"></p>
<ol start="4">
<li>
<p>最后 jest 测试结果(失败…):
原因是之前的 <code class="language-text">createGetter</code>代码又有个问题，返回的时候检测结果的时候，递归 reactive 传递了 target，应该是 res 才对：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">return</span> res <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">'object'</span>
     <span class="token operator">?</span> isReadonly
       <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token comment">// 修正：target -> res</span>
       <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token comment">// 修正：target -> res</span>
     <span class="token operator">:</span> res</code></pre></div>
<p>修正之后 jest 结果(:perfect)：</p>
<blockquote>
<p>☁  vue-next-code-read [master] ⚡  jest
PASS  packages/<strong>tests</strong>/reactive/reactive.spec.js
reactivity/reactive
✓ Object (4 ms)
✓ 嵌套的 reactives (1 ms)</p>
<p>Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        7.547 s
Ran all test suites.
☁  vue-next-code-read [master] ⚡</p>
</blockquote>
</li>
</ol>
<p>OK，数组的 reactive 完成。</p>
<hr>
<h2>jest 测试：</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">☁  vue-next-code-read [master] ⚡  jest
FAIL  packages/__tests__/reactive/reactive.spec.js
reactivity/reactive
✓ Object (5 ms)
✓ 嵌套的 reactives (1 ms)
✓ observed value should proxy mutations to original (Object) (1 ms)
✓ setting a property with an unobserved value should wrap with reactive (1 ms)
✕ observing already observed value should return same Proxy (4 ms)
✕ should not pollute original object with Proxies (2 ms)
✕ unwrap
✓ should not unwrap Ref&lt;T&gt;
✓ should unwrap computed refs
✕ non-observable values (36 ms)
✕ markRaw
✕ should not observe frozen objects (1 ms)
shallowReactive
✕ should not make non-reactive properties reactive
✕ should keep reactive properties reactive</code></pre></div>
<ol>
<li>
<p><font color="red">✕ observing already observed value should return same Proxy (4 ms)</font>
这个是因为 <code class="language-text">createReactiveObject()</code>里面判断的时候判断错误：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>toRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 修正成：target</span>
 <span class="token keyword">return</span> target
<span class="token punctuation">}</span></code></pre></div>
<p>修改后测试通过。</p>
</li>
<li>
<p><font color="red">✕ should not pollute original object with Proxies (5 ms)</font>
修改：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 新增判断，如果是递归 reactive 设置的时候取原始值去传递给 reflect</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 比如：value 如果是 Observed，那么从 reactiveToRaw 中取 proxy </span>
     <span class="token comment">// 之前的那个 target 出来，给 reflect</span>
     value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
     <span class="token comment">// TODO !shallow is ref</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// const res = Reflect.set(...arguments)</span>
   <span class="token comment">// 这里就不能直接 ...arguments 了，都将最新的 value 传递下去</span>
   <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>修改后测试通过。</p>
</li>
<li><font color="red">✕ unwrap</font>
是因为没有导出 <code class="language-text">toRaw</code> 函数导致的，导入下就好了。</li>
<li>
<p><font color="red">✕ non-observable values (8 ms)</font>
需要改些下测试用例：源码里面加了 expect -> toHaveBeenWarnedLast 为了更友好的提示。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">/// 修改后：</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></code></pre></div>
</li>
<li><font color="red"> ✕ markRaw</font>
在 <code class="language-text">createReactiveObject()</code> 中增加 <code class="language-text">canObserve(target)</code> 检测解决，因为检测中就有一项 <code class="language-text">rawValues.has(value)</code></li>
<li><font color="red">✕ should not observe frozen objects (1 ms)</font>
在 <code class="language-text">createReactiveObject()</code> 中增加 <code class="language-text">canObserve(target)</code> 检测解决。</li>
<li><font color="red">✕ should not make non-reactive properties reactive</font>
没导出 <code class="language-text">shallowReactive</code>。</li>
<li>
<p><font color="red">✕ should keep reactive properties reactive</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 粗心的锅，这个写反了</span>
<span class="token keyword">const</span> shallowSet <span class="token operator">=</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> shallowGet <span class="token operator">=</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// 修正：</span>
<span class="token keyword">const</span> shallowSet <span class="token operator">=</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> shallowGet <span class="token operator">=</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></div>
</li>
</ol>
<p>修正上述问题之后 jest 结果：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">vue-next-code-read [master] ⚡  jest
PASS  packages/__tests__/reactive/reactive.spec.js
reactivity/reactive
✓ Object (6 ms)
✓ 嵌套的 reactives
✓ observed value should proxy mutations to original (Object) (1 ms)
✓ setting a property with an unobserved value should wrap with reactive (1 ms)
✓ observing already observed value should return same Proxy
✓ should not pollute original object with Proxies (1 ms)
✓ unwrap
✓ should not unwrap Ref&lt;T&gt; (1 ms)
✓ should unwrap computed refs
✓ non-observable values (2 ms)
✓ markRaw (1 ms)
✓ should not observe frozen objects (1 ms)
shallowReactive
✓ should not make non-reactive properties reactive
✓ should keep reactive properties reactive

Test Suites: 1 passed, 1 total
Tests:       14 passed, 14 total
Snapshots:   0 total
Time:        6.436 s
Ran all test suites.</code></pre></div>
<p><span id="code1">阶段代码链接 <a href="https://github.com/gcclll/vue-next-code-read/blob/master/bakups/reactive_with_array.js">reactive<em>with</em>array.js</a>  代码</span></p>
<h1>handlers续(baseHandlers 的 delete, has, ownKeys)</h1>
<p>前面完成了 <code class="language-text">proxy-set</code> 和 <code class="language-text">proxy-get</code>，这节继续完成其他的 <code class="language-text">proxy</code>，包含：</p>
<ol>
<li><code class="language-text">deleteProperty(target, key)</code></li>
<li><code class="language-text">ownKeys(target)</code></li>
<li><code class="language-text">has(target, key)</code></li>
</ol>
<h2>delete</h2>
<p>在之前实现的基础上 <a href="https://github.com/gcclll/vue-next-code-read/blob/master/bakups/reactive_with_array.js">reactive.js</a> 增加 delete proxy，这之前先来看下现有的功能是否支持 delete 操作。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">let</span> dum
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updating...'</span><span class="token punctuation">)</span>
dum <span class="token operator">=</span> n<span class="token punctuation">.</span>bar
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* console.log(targetMap.get(target), dum, 'map') */</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dum <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
<span class="token keyword">delete</span> n<span class="token punctuation">.</span>bar  <span class="token comment">// code 1</span>
<span class="token comment">// n.bar = 3 // code2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dum <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>这里先注册一个 updater，后面通过更新 <code class="language-text">n.bar</code> 值，来触发 updater，结果：</p>
<blockquote>
<p>updating…
{dum: 2} “before”
updating…
{dum: 3} “after”</p>
</blockquote>
<p>结果如我们所料，然后把 code1 放开，注释掉 code2，理论上也会触发 updater：</p>
<blockquote>
<p>updating…
{dum: 2} “before”
{dum: 2} “after”</p>
</blockquote>
<p>实际结果非我们所料，因为还没实现…</p>
<p>接下来看下要实现 delete proxy 需要哪些步骤 >>>>>></p>
<ol>
<li>
<p>声明  delete proxy handler : <code class="language-text">deleteProperty</code></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// delete proxy</span>
<span class="token keyword">function</span> <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> hadKey <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
 <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
 <span class="token comment">// 操作先执行下去</span>
 <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token comment">// 如果执行成功且自身存在该属性，排除原型链操作</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 直接触发 updaters</span>
   <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'delete'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> result <span class="token comment">// 不能丢，必须反馈删除结果 boolean</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>加入到<code class="language-text">mutableHandlers</code> </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
 <span class="token keyword">get</span><span class="token punctuation">,</span>
 <span class="token keyword">set</span><span class="token punctuation">,</span>
 deleteProperty
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<p>只要经过上面简单的两步就实现了 <code class="language-text">delete</code> 操作代理，但执行结果却报错了(明明和源码一样啊，悲催〒▽〒!!!)</p>
<p><img src="http://qiniu.ii6g.com/1590046965.png?imageMogr2/thumbnail/!100p"></p>
<p>从输出可以看到， delete 操作确实触发了 updater，最后 <code class="language-text">dum: undefined</code> 也证明了这点。</p>
<p>至于报错…，(⊙o⊙)…，(⊙o⊙)…，少了个 <code class="language-text">return result</code> 将删除操作结果返回。</p>
<h2>has</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'has'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>更新 mutableHandlers:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  deleteProperty<span class="token punctuation">,</span>
  has
<span class="token punctuation">}</span></code></pre></div>
<p>测试：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">let</span> dum<span class="token punctuation">,</span> has
<span class="token keyword">const</span> <span class="token function-variable function">updater</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updating...'</span><span class="token punctuation">)</span>
  dum <span class="token operator">=</span> <span class="token string">'bar'</span> <span class="token keyword">in</span> n
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span>updater<span class="token punctuation">)</span>

<span class="token keyword">const</span> dep <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> fn <span class="token keyword">of</span> dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn<span class="token punctuation">.</span>raw<span class="token punctuation">,</span> fn<span class="token punctuation">.</span>raw <span class="token operator">===</span> updater<span class="token punctuation">,</span> <span class="token string">'deps'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dum <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
n<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dum <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<ol>
<li><code class="language-text">&#39;bar&#39; in n</code> 收集依赖 <code class="language-text">updater</code></li>
<li><code class="language-text">n.bar = 3</code> 触发 <code class="language-text">ownKeys</code> 收集到的 <code class="language-text">updater</code></li>
</ol>
<blockquote>
<p>updating…
() => {
console.log(‘updating…’)
dum = ‘bar’ in n
} true “deps”
{dum: true} “before”
updating…
{dum: true} “after”</p>
</blockquote>
<h2>ownKeys</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'iterate'</span><span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>更新 mutableHandlers:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  deleteProperty<span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  ownKeys
<span class="token punctuation">}</span></code></pre></div>
<p>注意 <code class="language-text">ownKeys</code> 的实现里使用到 了一个 Symbol: ITERATE<em>KEY，开始一直不明白 <code class="language-text">trigger</code> 里为啥会用到这个去 `depsMap.get(ITERRATE</em>KEY)<code class="language-text">，这里应该明白是怎么回事了，就是针对对象的迭代器操作的时候，使用到</code>ownKeys<code class="language-text">，需要对该操作收集依赖，那么就需要有个唯一的 key 去设置</code>targetMap, depsMap<code class="language-text">，这里的</code>ITERATE_KEY` 就是这个作用，用它来收集(track)对象迭代操作的所有依赖，然后通过 trigger 里面查找这个符号值去取所有 updaters。</p>
<p>测试：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token keyword">let</span> dum<span class="token punctuation">,</span> has
<span class="token keyword">const</span> <span class="token function-variable function">updater</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updating...'</span><span class="token punctuation">)</span>
  dum <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 触发依赖收集</span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span>updater<span class="token punctuation">)</span>

<span class="token keyword">const</span> dep <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> it <span class="token keyword">of</span> dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>raw<span class="token punctuation">,</span> it<span class="token punctuation">.</span>raw <span class="token operator">===</span> updater<span class="token punctuation">,</span> <span class="token string">'deps'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dum<span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
n<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// 触发 updaters</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dum<span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<blockquote>
<p>updating…
{foo: 1, bar: 2} “own keys”
() => {
console.log(‘updating…’)
dum = Object.keys(n)
} true “deps”
(2) [“foo”, “bar”] “before”
(2) [“foo”, “bar”] “after”</p>
</blockquote>
<p>但是发现并没有触发 updaters。</p>
<p>trigger 里面加打印结果：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 非数组的删除或添加操作</span>
<span class="token keyword">const</span> isAddOrDelete <span class="token operator">=</span>
      type <span class="token operator">===</span> <span class="token string">'add'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'delete'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> key <span class="token punctuation">}</span><span class="token punctuation">,</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span>
<span class="token comment">// 对象的属性的新增和删除，或者 Map 类型的 set 操作</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isAddOrDelete <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'set'</span> <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">add</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'length'</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>输出 <code class="language-text">{type: &quot;set&quot;, key: &quot;foo&quot;} false</code> 说明确实有触发 <code class="language-text">trigger</code>，但是条件：</p>
<p><code class="language-text">if (isAddOrDelete || (type === &#39;set&#39; &amp;&amp; target instanceof Map))</code></p>
<p>阻止了它进入 <code class="language-text">add</code> 收集 <code class="language-text">ITERATE_KEY</code> 对应的依赖，因为 target 不是 Map 类型。</p>
<p><strong>TODO 为啥会这样？？？？？？？</strong></p>
<h2>jest 测试</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">☁  vue-next-code-read [master] ⚡  jest
PASS  packages/__tests__/reactive/reactive.spec.js
FAIL  packages/__tests__/reactive/effect.spec.js
● reactivity/effect › should observe iteration

expect(received).toBe(expected) // Object.is equality

Expected: &quot;Hello World!&quot;
Received: &quot;Hello&quot;

161 |     expect(dummy).toBe(&#39;Hello&#39;)
162 |     list.push(&#39;World!&#39;)

  &gt; 163 |     expect(dummy).toBe(&#39;Hello World!&#39;)
  &gt;  |                   ^
  &gt; 164 |     list.shift()
  &gt; 165 |     expect(dummy).toBe(&#39;World!&#39;)
  &gt; 166 |   })

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:163:19)

● reactivity/effect › should observe implicit array length changes

  expect(received).toBe(expected) // Object.is equality

  Expected: &quot;Hello World!&quot;
  Received: &quot;Hello&quot;

    173 |     expect(dummy).toBe(&#39;Hello&#39;)
    174 |     list[1] = &#39;World!&#39;

  &gt; 175 |     expect(dummy).toBe(&#39;Hello World!&#39;)
  &gt;  |                   ^
  &gt; 176 |     list[3] = &#39;Hello!&#39;
  &gt; 177 |     expect(dummy).toBe(&#39;Hello World!  Hello!&#39;)
  &gt; 178 |   })

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:175:19)

● reactivity/effect › should observe enumeration

  expect(received).toBe(expected) // Object.is equality

  Expected: 7
  Received: 3

    203 |     expect(dummy).toBe(3)
    204 |     numbers.num2 = 4

  &gt; 205 |     expect(dummy).toBe(7)
  &gt;  |                   ^
  &gt; 206 |     delete numbers.num1
  &gt; 207 |     expect(dummy).toBe(4)
  &gt; 208 |   })

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:205:19)

● reactivity/effect › should not observe well-known symbol keyed properties

  expect(received).toBe(expected) // Object.is equality

  Expected: undefined
  Received: true

    234 |     array[key] = true
    235 |     expect(array[key]).toBe(true)

  &gt; 236 |     expect(dummy).toBe(undefined)
  &gt;  |                   ^
  &gt; 237 |   })
  &gt; 238 |
  &gt; 239 |   it(&#39;should observe function valued properties&#39;, () =&gt; {

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:236:19)

● reactivity/effect › should observe json methods

  expect(received).toBe(expected) // Object.is equality

  Expected: 1
  Received: undefined

    523 |     })
    524 |     obj.a = 1

  &gt; 525 |     expect(dummy.a).toBe(1)
  &gt;  |                     ^
  &gt; 526 |   })
  &gt; 527 |
  &gt; 528 |   it(&#39;should observe class method invocations&#39;, () =&gt; {

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:525:21)

● reactivity/effect › scheduler

  expect(jest.fn()).toHaveBeenCalledTimes(expected)

  Expected number of calls: 1
  Received number of calls: 0

    573 |     // should be called on first trigger
    574 |     obj.foo++

  &gt; 575 |     expect(scheduler).toHaveBeenCalledTimes(1)
  &gt;  |                       ^
  &gt; 576 |     // should not run yet
  &gt; 577 |     expect(dummy).toBe(1)
  &gt; 578 |     // manually run

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:575:23)

● reactivity/effect › events: onTrack

  expect(jest.fn()).toHaveBeenCalledTimes(expected)

  Expected number of calls: 3
  Received number of calls: 0

    598 |     )
    599 |     expect(dummy).toEqual([&#39;foo&#39;, &#39;bar&#39;])

  &gt; 600 |     expect(onTrack).toHaveBeenCalledTimes(3)
  &gt;  |                     ^
  &gt; 601 |     expect(events).toEqual([
  &gt; 602 |       {
  &gt; 603 |         effect: runner,

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:600:21)

● reactivity/effect › events: onTrigger

  expect(jest.fn()).toHaveBeenCalledTimes(expected)

  Expected number of calls: 1
  Received number of calls: 0

    637 |     obj.foo++
    638 |     expect(dummy).toBe(2)

  &gt; 639 |     expect(onTrigger).toHaveBeenCalledTimes(1)
  &gt;  |                       ^
  &gt; 640 |     expect(events[0]).toEqual({
  &gt; 641 |       effect: runner,
  &gt; 642 |       target: toRaw(obj),

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:639:23)

● reactivity/effect › stop

  TypeError: (0 , _reactive2.stop) is not a function

    667 |     obj.prop = 2
    668 |     expect(dummy).toBe(2)

  &gt; 669 |     stop(runner)
  &gt;  |     ^
  &gt; 670 |     obj.prop = 3
  &gt; 671 |     expect(dummy).toBe(2)
  &gt; 672 |

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:669:5)

● reactivity/effect › stop with scheduler

  expect(received).toBe(expected) // Object.is equality

  Expected: 1
  Received: 2

    689 |     )
    690 |     obj.prop = 2

  &gt; 691 |     expect(dummy).toBe(1)
  &gt;  |                   ^
  &gt; 692 |     expect(queue.length).toBe(1)
  &gt; 693 |     stop(runner)
  &gt; 694 |

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:691:19)

● reactivity/effect › events: onStop

  TypeError: (0 , _reactive2.stop) is not a function

    704 |     })
    705 |

  &gt; 706 |     stop(runner)
  &gt;  |     ^
  &gt; 707 |     expect(onStop).toHaveBeenCalled()
  &gt; 708 |   })
  &gt; 709 |

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:706:5)

● reactivity/effect › stop: a stopped effect is nested in a normal effect

  TypeError: (0 , _reactive2.stop) is not a function

    714 |       dummy = obj.prop
    715 |     })

  &gt; 716 |     stop(runner)
  &gt;  |     ^
  &gt; 717 |     obj.prop = 2
  &gt; 718 |     expect(dummy).toBe(1)
  &gt; 719 |

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:716:5)

● reactivity/effect › should trigger all effects when array length is set 0

  expect(received).toBe(expected) // Object.is equality

  Expected: 3
  Received: 1

    773 |
    774 |     observed.unshift(3)

  &gt; 775 |     expect(dummy).toBe(3)
  &gt;  |                   ^
  &gt; 776 |     expect(record).toBe(3)
  &gt; 777 |
  &gt; 778 |     observed.length = 0

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:775:19)

Test Suites: 1 failed, 1 passed, 2 total
Tests:       13 failed, 49 passed, 62 total
Snapshots:   0 total
Time:        2.917 s, estimated 3 s
Ran all test suites.</code></pre></div>
<p>全是失败啊！！！</p>
<p>还是老老实实的一个个来解决吧…</p>
<ol>
<li>
<p><font color="red">● reactivity/effect › should observe iteration</font></p>
<p>数组操作失败，push 的时候没有触发 updater。</p>
<p>示例：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updating....'</span><span class="token punctuation">)</span>
 dummy <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetMap<span class="token punctuation">,</span> <span class="token string">'dep'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token comment">/* list.push('World!') */</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果(直接索引赋值是生效的，那么为啥 push 没用？？？)：</p>
<blockquote>
<p>updating…
test.html:20 WeakMap {Array(1) => Map(3)} “dep”
test.html:21 Hello 1
test.html:17 updating…
test.html:24 hello 2</p>
</blockquote>
<p>在 <code class="language-text">list.push(&#39;World!&#39;)</code> 处打个断点：</p>
<p>先触发的是<code class="language-text">list</code> 的 get push :</p>
<p><img src="http://qiniu.ii6g.com/1590068611.png?imageMogr2/thumbnail/!100p"></p>
<p>然后再是触发的 length get</p>
<p><img src="http://qiniu.ii6g.com/1590068464.png?imageMogr2/thumbnail/!100p"></p>
<p>触发 key: 1 的 updater，但最后没有任何依赖被发现？？？</p>
<p><img src="http://qiniu.ii6g.com/1590068984.png?imageMogr2/thumbnail/!100p"></p>
<p><img src="http://qiniu.ii6g.com/1590069039.png?imageMogr2/thumbnail/!100p"></p>
<p>看最后的图发现问题，首先，数组就一个元素，长度为1，最大索引为0，在 push 之后，长度为2，最大索引为1，也就是说这个新的索引即新的 key，属于新增属性操作，应该要走到 trigger:add ，但是实际走了 trigger:set 里面去了。</p>
<p>问题就在 <code class="language-text">if(!target.hasOwnProperty(key))</code> 这一行，它不应该取 <code class="language-text">Reflect.set(...)</code> 之后的 target 因为这是更新之后的，肯定有 key: 1了。</p>
<p>修改： </p>
<p>在 <code class="language-text">Reflect.set(...)</code> 之前先 <code class="language-text">hadKey = target.hasOwnProperty(key)</code> 然后使用缓存的 <code class="language-text">hadKey</code> 进行判断 <code class="language-text">if(!hadKey) {...}</code>。</p>
<p>修改之后测试通过：</p>
<blockquote>
<p>☁  vue-next-code-read [master] ⚡  jest
PASS  packages/<strong>tests</strong>/reactive/reactive.spec.js
PASS  packages/<strong>tests</strong>/reactive/effect.spec.js</p>
<p>Test Suites: 2 passed, 2 total
Tests:       26 passed, 26 total
Snapshots:   0 total
Time:        7.645 s
Ran all test suites.</p>
</blockquote>
</li>
<li>
<p><font color="red">● reactivity/effect › should not observe well-known symbol keyed properties</font></p>
<p>js 内置的符号属性，不能被 observe，这是因为 <code class="language-text">createGetter</code> 里面还没完成 <code class="language-text">Symbol</code> 类型的检测，下面加上就OK了。</p>
<p>需要增加以下内容：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 1. 符号类型检测</span>
<span class="token keyword">const</span> <span class="token function-variable function">isSymbol</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'symbol'</span>

<span class="token comment">// 2. Symbol 上的所有符号属性</span>
<span class="token keyword">const</span> builtInSymbols <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>
 Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>Symbol<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isSymbol<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// 3. createGetter中增加判断</span>
<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>
 
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'__proto__'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> res
 <span class="token punctuation">}</span>  
 
 <span class="token comment">// ....</span>
<span class="token punctuation">}</span></code></pre></div>
<p>重测 jest 通过。</p>
</li>
<li>
<p><font color="red">● reactivity/effect › scheduler</font>
真怀疑当时自己是故意的，尽是些地级错误（捂脸，🤦‍♀️，(<em>/ω＼</em>)）！！！</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 修改前：</span>
<span class="token comment">// if (effect.options &amp;&amp; effect.options.shecduler) {</span>
<span class="token comment">// 修改后：</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre></div>
</li>
<li><font color="red">● reactivity/effect › events: onTrack</font></li>
<li>
<p><font color="red">● reactivity/effect › events: onTrigger</font></p>
<p>两个是在 <strong>DEV</strong> 模式下才会执行的，没有完成，现在给加上去吧。</p>
<p>Track 里面，在 if dep.has 最后面增加统计事件 onTrack：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     activeEffect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       effect<span class="token operator">:</span> activeEffect<span class="token punctuation">,</span>
       target<span class="token punctuation">,</span>
       type<span class="token punctuation">,</span>
       key
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Trigger 里面，在执行 updaters 的开头增加 onTrigger 事件：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>

 <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> hasOpt <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>effect<span class="token punctuation">.</span>options
   <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> hasOpt <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       effect<span class="token punctuation">,</span>
       target<span class="token punctuation">,</span>
       key<span class="token punctuation">,</span>
       type<span class="token punctuation">,</span>
       newValue<span class="token punctuation">,</span>
       oldValue<span class="token punctuation">,</span>
       oldTarget
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// ...</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>加完，jest 通过。</p>
</li>
<li>
<p><font color="red">● stop</font>
增加 stop 函数，停止 effect 行为，主要通过 effect.active，清理 effect.deps 来控制，阻止触发 deps。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">cleanup</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<p>到此 <code class="language-text">effect.spec.ts</code> 中除了 <code class="language-text">ref</code> 有关的测试用例全部测试通过，</p>
<p><img src="http://qiniu.ii6g.com/1590139513.png?imageMogr2/thumbnail/!100p"></p>
<p>下面来逐个分析 >>> go go go…</p>
<h2>测试用例结果分析</h2>
<p>通过运行 <code class="language-text">jest --verbose</code> 将所有用例测试结果列出：</p>
<ul>
<li>
<p><font color="green">✓ should run the passed function once (wrapped by a effect) (4 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should run the passed function once (wrapped by a effect)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fnSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span>fnSpy<span class="token punctuation">)</span> <span class="token comment">// effect() 实现里面，如果没有传 options.lazy 就会立即执行一次</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fnSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 因此这里 fnSpy 会被调用一次</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should observe basic properties (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe basic properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dummy
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// updater: dummy = counter.num</span>
  <span class="token comment">// 被立即调用， dummy = 0</span>
  <span class="token comment">// 由于 counter.num 触发 trigger:get ，收集dep: 'num'->Set(1): updater</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span> 

  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
  counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span> <span class="token comment">// 赋值，trigger: set 触发 updater，赋值 dummy</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should observe multiple properties</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe multiple properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dummy
  <span class="token comment">// obj ={num1: 0, num2: 0}</span>
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num1<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> num2<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// updater: ...</span>
  <span class="token comment">// updater 被立即调用，counter 的 num1, num2 被访问，分别触发他们的 trigger:get</span>
  <span class="token comment">// 收集依赖，三次访问，三次收集同一个 updater</span>
  <span class="token comment">// 由于 targetMap -> depsMap -> dep: new Set() 是个集合类型</span>
  <span class="token comment">// 因此虽然是三次访问，但收集的都是 updater，因此每个 dep 里面保存的是同一个 updater</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num1 <span class="token operator">+</span> counter<span class="token punctuation">.</span>num1 <span class="token operator">+</span> counter<span class="token punctuation">.</span>num2<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 首次调用 updater 时候赋值了 0 + 0 + 0 = 0</span>
	<span class="token comment">// 这里先后赋值了 num1, num2，触发了两次 updater</span>
	<span class="token comment">// first: 0 + 0 + 7</span>
	<span class="token comment">// second: 7 + 7 + 7 = 21</span>
	<span class="token comment">// 测试如下面的示例代码</span>
  counter<span class="token punctuation">.</span>num1 <span class="token operator">=</span> counter<span class="token punctuation">.</span>num2 <span class="token operator">=</span> <span class="token number">7</span> 
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>  </code></pre></div>
<p>测试代码：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> dummy<span class="token punctuation">,</span>
  n <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num1<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> num2<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>n<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num1 <span class="token operator">+</span> counter<span class="token punctuation">.</span>num1 <span class="token operator">+</span> counter<span class="token punctuation">.</span>num2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy<span class="token punctuation">,</span> n <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
counter<span class="token punctuation">.</span>num1 <span class="token operator">=</span> counter<span class="token punctuation">.</span>num2 <span class="token operator">=</span> <span class="token number">7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy<span class="token punctuation">,</span> n <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre></div>
<p>结果图示：</p>
<p><img src="http://qiniu.ii6g.com/1590139770.png?imageMogr2/thumbnail/!100p"></p>
<ol>
<li>depsMap 有两个 map，分别是 num1, num2，</li>
<li>trigger: set 触发了两次，且 num2 先触发 num1 紧随其后，因为赋值操作是从右到左的顺序进行。    </li>
</ol>
</li>
<li>
<p><font color="green">✓ should handle multiple effects (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should handle multiple effects'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">let</span> dummy1<span class="token punctuation">,</span> dummy2
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy1 <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 收集 updater1，执行一次，dummy1  = 0</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy2 <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 收集 updater2, 执行一次，dummy2 = 0</span>

<span class="token function">expect</span><span class="token punctuation">(</span>dummy1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// true </span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token comment">// trigger:set 取出 targetMap-depsMap-num:dep:Set(2) 即 updater1, updater2</span>
<span class="token comment">// 执行 updaters 之后，重新复制dummy1, dummy2 = 1</span>
counter<span class="token punctuation">.</span>num<span class="token operator">++</span> 
<span class="token function">expect</span><span class="token punctuation">(</span>dummy1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green"> ✓ should observe nested properties (1 ms) </font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe nested properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">let</span> dummy
<span class="token comment">// 嵌套的 reactive 是在 createReativeObject 里面完成的</span>
<span class="token comment">// 在最后 return 结果的时候检测了是否是 isObject ，如果是进一步检测</span>
<span class="token comment">// isReadonly 与否，非只读返回 reactive(res) 对结果递归调用一次</span>
<span class="token comment">// 前提是没有设置shallow 标志，该标识表明只对目前的对象只做浅reactive</span>
<span class="token comment">// 即只做对象的一级响应式，里面嵌套的对象原样返回。</span>
<span class="token comment">// 这里调用的是 reactive 显然是递归 reactive 的。</span>
<span class="token comment">// obj = { nested: {num: 0 }}</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nested<span class="token operator">:</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 这里会触发两次 getter，一次是 counter.nested，一次是 nested.num</span>
<span class="token comment">// targetMap{ obj -> map, nested -> map } 存放了两个对象的映射</span>
<span class="token comment">// obj:map -> 'nested':Set(1), nested:map -> 'num':Set(1)</span>
<span class="token comment">// Set(1) 都是下面的 updater</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
counter<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">// 只会触发 'num':Set(1)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>转测试代码结果：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> dummy
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nested<span class="token operator">:</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
counter<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1590118132.png?imageMogr2/thumbnail/!100p"></p>
<p>​	</p>
<ol>
<li>Loc1 : 访问 counter.nested 收集的 <code class="language-text">{counter:{nested:{num:0}}} -&gt; Map{&#39;nested&#39; -&gt; Set(1)}</code> 依赖。</li>
<li>Loc2: 访问 nested.num 收集的 {num:7}->Map{‘num’->Set(1)} 依赖。</li>
<li>Loc2: 注意看这里，当给 counter.nested.num = 7 赋值的时候只会触发 ‘num’ -> Set(1)。</li>
</ol>
</li>
<li>
<p><font color="green"> ✓ should observe delete operations (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe delete operations'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">let</span> dummy
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prop<span class="token operator">:</span> <span class="token string">'value'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> obj<span class="token punctuation">.</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 收集依赖 updater</span>

<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token comment">// 对象属性的删除操作，只会触发 trigger 里面的 if (key !== void 0) 收集依赖进 effects: []</span>
<span class="token keyword">delete</span> obj<span class="token punctuation">.</span>prop <span class="token comment">// 触发 updater 重新复制 dummy: undefined</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li><font color="green"> ✓ should observe has operations (1 ms)</font></li>
<li>
<p><font color="green">✓ should observe properties on the prototype chain (9 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'should observe properties on the prototype chain'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dummy
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> parentCounter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> parentCounter<span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 收集 updater</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
	<span class="token comment">// 这里删除操作触发 deleteProperty proxy handler</span>
	<span class="token comment">// trigger: delete -> run deps -> 触发 updater</span>
	<span class="token comment">// 由于 updater 里面访问了 counter.num ，而 counter 自身的 num 在这时候已经被删除了</span>
	<span class="token comment">// 注意：deletePropery 里面是先执行了 Reflect.deleteProperty(...) </span>
	<span class="token comment">// 然后再触发的 trigger:delete的，因此在 updater 执行的时候 counter.num 已经不存在</span>
	<span class="token comment">// 但是根据对象属性的访问原理，会去检查原型链上父级对象的，最后会找到 parentCounter.num</span>
	<span class="token comment">// 然后取出它的值：num: 2 赋值给 dummy，所以下面 dummy toBe(2) 为 true</span>
  <span class="token keyword">delete</span> counter<span class="token punctuation">.</span>num
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token comment">// 这里改变 parent num 时候也会触发 updater</span>
	<span class="token comment">// 是因为上面的 delete 操作导致去检查了原型链，访问了 parentCounter.num ，这个时候</span>
	<span class="token comment">// 也相当于触发了  parentCounter.num 的 get ，收集了 updater</span>
  parentCounter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">4</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
	<span class="token comment">// 这里重新复制，触发 counter.num 的 set(createSetter)，</span>
	<span class="token comment">// 检测到自身没有该属性(在Reflect.set()之前)</span>
	<span class="token comment">// 然后触发 trigger:add 增加属性的操作</span>
	<span class="token comment">// 在 trigger 里面，触发之前收集到的 updater</span>
  <span class="token comment">// (注意：counter.num 的 dep 这个时候并没有被移除的)</span>
  counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li><font color="green">✓ should observe has operations on the prototype chain</font></li>
<li>
<p><font color="green">✓ should observe inherited property accessors (2 ms)</font></p>
<p>访问器属性也是一样的道理。</p>
</li>
<li><font color="green">✓ should observe function call chains (1 ms)</font></li>
<li><font color="green">✓ should observe iteration (1 ms)</font></li>
<li><font color="green">✓ should observe implicit array length changes</font></li>
<li><font color="green">✓ should observe sparse array mutations (1 ms)</font></li>
<li><font color="green">✓ should observe enumeration (2 ms)</font></li>
<li><font color="green">✓ should observe symbol keyed properties (2 ms)</font></li>
<li>
<p><font color="green">✓ should not observe well-known symbol keyed properties (2 ms)</font></p>
<p>已知的符号属性，在 <code class="language-text">createReactiveObject</code> 里面就被过滤掉了</p>
<p><code class="language-text">if (isSymbol(res) &amp;&amp; builtInSymbols.has(res) || res === &#39;__proto__&#39;)</code>。</p>
</li>
<li><font color="green">✓ should observe function valued properties (1 ms)</font></li>
<li><font color="green">✓ should observe chained getters relying on this (1 ms)</font></li>
<li><font color="green">✓ should observe methods relying on this (1 ms)</font></li>
<li>
<p><font color="green">✓ should not observe set operations without a value change (1 ms)</font></p>
<p>值没发生变化的时候不会重复触发 udpaters，<code class="language-text">createSetter</code> 里面就已经有了判断：</p>
<p><code class="language-text">if (value !== oldValue &amp;&amp; (value === value || oldValue === oldValue))</code></p>
<p>值没变不会 trigger: set，后面的是为了过滤掉 <code class="language-text">NaN</code> 的情况。</p>
</li>
<li>
<p><font color="green">✓ should not observe raw mutations (1 ms)</font></p>
<p><code class="language-text">toRaw</code> 就是将 <code class="language-text">observed</code> 转成原始的那个对象，就不再是响应式的了，当然不会有啥作用。</p>
</li>
<li>
<p><font color="green">✓ should not be triggered by raw mutations</font></p>
<p>同上。</p>
</li>
<li>
<p><font color="green">✓ should not be triggered by inherited raw setters (1 ms)</font></p>
<p>同上。</p>
</li>
<li>
<p><span id="test-case-rloops"><font color="green">✓ should avoid implicit infinite recursive loops with itself (1 ms)</font></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">counterSpy</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
n<span class="token operator">++</span>
counter<span class="token punctuation">.</span>num<span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span>counterSpy<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span></code></pre></div>
<p>运行结果：</p>
<blockquote>
<p>// 这里是 updater 里面的 counter.num++ 触发的get</p>
<p>{num: 0} {type: “get”, key: “num”, shouldTrack: true, activeEffect: ƒ} “track”</p>
<p>// 因为 counter.num++ 触发的 set</p>
<p>Map(1) {“num” => Set(1)} {type: “set”, key: “num”, newValue: 1, oldValue: 0} “trigger”
Proxy {num: 1} 1 “1” // log</p>
<p>// 赋值操作引发的 trigger:set</p>
<p>Map(1) {“num” => Set(1)} {type: “set”, key: “num”, newValue: 4, oldValue: 1} “trigger”</p>
<p>// set 触发了updater -> trigger:get </p>
<p>{num: 4} {type: “get”, key: “num”, shouldTrack: true, activeEffect: ƒ} “track”</p>
<p>// counter.num++ -> trigger:set</p>
<p>Map(1) {“num” => Set(1)} {type: “set”, key: “num”, newValue: 5, oldValue: 4} “trigger”
Proxy {num: 5} 2 “2”</p>
</blockquote>
<p>好像没发现哪里拦截了，但是通过下面的例子，确实又会死循环：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> dummy

<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token punctuation">{</span>
num<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> ob
<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ob.num = ob.num + 1</span>
dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span>num<span class="token operator">++</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> ob<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

ob<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">2</span></code></pre></div>
<p>node 运行之后：</p>
<blockquote>
<p>/Users/simon/github/vuejs/vue-next-code-read/test/test.js:10
dummy = ob.num++
^</p>
<p>RangeError: Maximum call stack size exceeded</p>
</blockquote>
<p>所以肯定还是有哪里做了处理，防止死循环。</p>
<p>经过一通 <code class="language-text">console.log</code> 之后发现关键点就在 <code class="language-text">trigger</code> 的 <code class="language-text">add</code> 函数里面，它在查找依赖添加到将要执行的 <code class="language-text">effects</code> 集合中的时候有两个前提条件：</p>
<ol>
<li><code class="language-text">!shouldTrack</code></li>
<li><code class="language-text">effect !== activeEffect</code></li>
</ol>
<p><img src="http://qiniu.ii6g.com/1590131447.png?imageMogr2/thumbnail/!100p"></p>
<p>图中输出的主要关键点在<font color="red" size="5">红色</font> 部分，这里检测到正在 <code class="language-text">add</code> 的 <code class="language-text">effect</code> 与当前激活状态的 <code class="language-text">activeEffect</code> 是同一个所以结束触发 <code class="language-text">trigger:set</code>，但是为什么 <code class="language-text">shouldTrack = true</code> 且 <code class="language-text">effect === activeEffect</code>呢？？？</p>
<p>那么就要回头去看 <code class="language-text">effect()</code> 的具体实现了，重点在 <code class="language-text">try...finally</code>。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token function">enableTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span>
activeEffect <span class="token operator">=</span> _effect <span class="token comment">// 这里的 _effect 就是在 trigger 里用来与 activeEffect 比较的</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>_effect <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'effect 1'</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token comment">// trigger set 检测 shouldTrack 和 activeEffect</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 而 shouldTrck 和 activeEffect 重置工作在这里，因此阻止了 fn 里面 ++ 操作引起的死循环</span>
<span class="token comment">// 因为 trigger -> add 需要检测 if (!shouldTrack || effect !== activeEffect)</span>
<span class="token comment">// 才会将找到的 dep:updater 加入到 run 要执行的 effects: [] 中去</span>
<span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>_effect <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'effect 2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这段代码含义如下：</p>
<ol>
<li>当执行 <code class="language-text">effect(updater)</code> 时，执行上面的一段代码。</li>
<li><code class="language-text">enableTracking()</code>  只要知道它是将 <code class="language-text">shouldTrack = true</code> 了。</li>
<li>接下来缓存，赋值 effect</li>
<li>重点来了，执行 updater，这里执行的 updater里面是 <code class="language-text">counter.num++</code> 会依次触发 <code class="language-text">get</code> -> <code class="language-text">set</code></li>
</ol>
<p> Get 就是收集依赖，同一个 updater 只会有一个 (<code class="language-text">Set(1)</code>)。</p>
<p> Set 这里会触发 trigger:set 那么这里会检测 shouldTrack 和 activeEffect，但是这个时候两者的值并没有重置，也就是说告诉 trigger， <code class="language-text">effect(updater)</code> 我还没执行完呢，你不能重复 trigger:set，但是我什么时候才能继续 trigger呢？？？这就是下面第5条该做的事情了。</p>
<ol start="5">
<li>finally 在 udpater 首次执行完成之后恢复shouldTrack 和activeEffect的值，从而继续完成 <code class="language-text">effect(updater)</code> 的任务直到 <code class="language-text">finally</code> 的代码执行完毕。</li>
</ol>
<p>即这个问题的关键点在于 4和5，正是这里的逻辑防止了 updater 里面导致 set 死循环。</p>
</li>
<li>
<p><font color="green">✓ should allow explicitly recursive raw function loops (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should allow explicitly recursive raw function loops'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> numSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    counter<span class="token punctuation">.</span>num<span class="token operator">++</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter<span class="token punctuation">.</span>num <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">numSpy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span>numSpy<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>numSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>有了前面一个测试用例的分析，这里的原理就一目了然了。</p>
<p>首先 <code class="language-text">counter.num++</code> 还是会因为 <code class="language-text">effect(updater)</code> 没有完全结束而中断，只会执行一次 +1 操作。</p>
<p>紧跟着的 <code class="language-text">if</code> 相当于在 <code class="language-text">try { return fn(...args) } }</code> 返回结果之前又调用了下自己，也就是说 num+1 会执行知道 <code class="language-text">num = 10</code> ，所以最后结果是 <code class="language-text">num=10</code>, updater 被调用了 10，才进入了 <code class="language-text">effect -&gt; finally</code> 结束当前的 <code class="language-text">effect()</code>。</p>
</li>
<li>
<p><font color="green">✓ should avoid infinite loops with other effects (1 ms)</font></p>
<p>原理如上上。</p>
</li>
<li>
<p><font color="green">✓ should return a new reactive version of the function (1 ms)</font></p>
<p>因为 <code class="language-text">effect(fn)</code> 最终都会被封装成 <code class="language-text">ReactiveEffect</code> 类型的对象，所以肯定不相等了。</p>
</li>
<li><font color="green">✓ should discover new branches while running automatically (1 ms)</font></li>
<li>
<p><font color="green">✓ should discover new branches when running manually (1 ms)</font></p>
<p>这两个原理都一样，在于 <code class="language-text">?:</code> 执行的时候根据条件的真假是否有触发 <code class="language-text">get</code>。</p>
</li>
<li><font color="green">✓ should not be triggered by mutating a property, which is used in an inactive branch (1 ms)</font></li>
<li>
<p><font color="green">✓ should not double wrap if the passed function is a effect (1 ms)</font></p>
<p><code class="language-text">function effect(fn)</code> 的第一句就是为了防止这种情况发生，检测是不是 <code class="language-text">_isEffect</code> ，是的话会将 <code class="language-text">fn = fn.raw</code> 提取出来。 </p>
</li>
<li><font color="green">✓ should not run multiple times for a single mutation (1 ms)</font></li>
<li>
<p><font color="green">✓ should allow nested effects (4 ms)</font></p>
<p>不管嵌套不嵌套只要 <code class="language-text">effect</code> 完整执行完成，就能顺利的进行下一个 <code class="language-text">effect()</code>。</p>
</li>
<li>
<p><span id="test-case-json"> <font color="green">✓ should observe json methods</font></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> dummy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
dummy <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetMap<span class="token punctuation">,</span> dummy<span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
<span class="token comment">/* obj.a = 1 */</span>
<span class="token comment">/* console.log(targetMap, dummy, 'after') */</span></code></pre></div>
<p>注释最后两行，看输出</p>
<p><img src="http://qiniu.ii6g.com/1590134578.png?imageMogr2/thumbnail/!100p"></p>
<p>注意这里的一个迭代器为 key 的 dep，也就是 <code class="language-text">JSON.stringify(obj)</code> 的时候说明有对 obj 进行遍历(迭代器操作，触发了 <code class="language-text">ownKeys</code> proxy handler)。</p>
<p>去看下 <a href="https://tc39.es/ecma262/">https://tc39.es/ecma262/</a> <code class="language-text">JSON.stringify</code> 实现原理：</p>
<blockquote>
<p>最后一步： Return ? <a href="https://tc39.es/ecma262/#sec-serializejsonproperty">SerializeJSONProperty</a>(state, the empty String, wrapper). 进入到 SerializeJSONProperty</p>
<p>Step2: 检测到是对象会去取它 的 <code class="language-text">toJson</code> 值，这也就是为什么 最后收集到的依赖 depsMap 里面会有一个 key 为 <code class="language-text">toJSON</code> 的项了：</p>
<p><a href="https://tc39.es/ecma262/#sec-ecmascript-data-types-and-values">Type</a>(value) is Object or BigInt, then</p>
<ol>
<li>Let toJSON be ? <a href="https://tc39.es/ecma262/#sec-getv">GetV</a>(value, “toJSON”).</li>
</ol>
<p>然后检测到是对象会进入：SerializeJSONObject ( state, value )</p>
<ol>
<li>let partial be a new empty <a href="https://tc39.es/ecma262/#sec-list-and-record-specification-type">List</a>.</li>
<li>For each elemen P of K , do </li>
</ol>
<p>  // 这里会有一个迭代器操作，遍历对象属性，触发 ITERATE_KEY 依赖收集</p>
<ol>
<li>Let strP be ? <a href="https://tc39.es/ecma262/#sec-serializejsonproperty">SerializeJSONProperty</a>(state, P, value).</li>
</ol>
</blockquote>
<p>结果就是说 <code class="language-text">JSON.stringify</code> 会有对 obj 有迭代器操作，触发了 ownkeys proxy handler 调用 <code class="language-text">track:ITERATE_KEY</code> 触发收集依赖。</p>
</li>
<li><font color="green">✓ should observe class method invocations (1 ms)</font></li>
<li><font color="green">✓ lazy (5 ms)</font></li>
<li><font color="green">✓ scheduler (1 ms)</font></li>
<li><font color="green">✓ events: onTrack (1 ms)</font></li>
<li><font color="green">✓ events: onTrigger (3 ms)</font></li>
<li><font color="green">✓ stop (1 ms)</font></li>
<li>
<p><font color="green">✓ stop with scheduler (2 ms)</font></p>
<p>来看下 stop 结合 scheduler 调度器是如何使用的。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'stop with scheduler'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dummy
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prop<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// updater</span>
      dummy <span class="token operator">=</span> obj<span class="token punctuation">.</span>prop <span class="token comment">// 这里会立即执行一次收集依赖</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      
      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 这里设置触发 trigger:set，但是因为有 scheduler 的存在，所以没有立即调用 effect</span>
  <span class="token comment">// 而是执行了 scheduler 将 effect 推入了队列 queue</span>
  obj<span class="token punctuation">.</span>prop <span class="token operator">=</span> <span class="token number">2</span> 
  <span class="token comment">// 所以这里还是 1</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
  <span class="token comment">// 因为上面的赋值触发 scheduler 缘故</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
  <span class="token comment">// 清理依赖，targetMap->depsMap->dep 里面的所有依赖清理掉</span>
  <span class="token comment">// 且 effect.active = false</span>
  <span class="token function">stop</span><span class="token punctuation">(</span>runner<span class="token punctuation">)</span> 

  <span class="token comment">// a scheduled effect should not execute anymore after stopped</span>
  <span class="token comment">// 这里执行的其实是 updater -> ReactiveEffect 化之后的 effect</span>
  <span class="token comment">// 但是在 stop 之后 effect.active 已经是 FALSE 了</span>
  <span class="token comment">// 所以会直接检测到 effect.options.scheduler 存在，返回 undefined </span>
  <span class="token comment">// 真正 try 里面的 执行 fn:updater 实际没有到。所以这里相当于什么都没干</span>
  queue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 所以这里值也就不会有任何变化了</span>
  <span class="token comment">// 如果要这里 updater 被调用只要去掉 stop 那句即可，active = true 进入正常</span>
  <span class="token comment">// 的 effect{try...finaylly} 执行流程触发 updater</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li><font color="green">✓ events: onStop (1 ms)</font></li>
<li><font color="green">✓ stop: a stopped effect is nested in a normal effect (1 ms)</font></li>
<li><font color="green">✓ markRaw (1 ms)</font></li>
<li><font color="green">✓ should not be trigger when the value and the old value both are NaN (1 ms)</font></li>
<li><font color="green">✓ should trigger all effects when array length is set 0 (1 ms)</font></li>
</ul>
<p><span id="code2">阶段代码链接：<a href="https://github.com/gcclll/vue-next-code-read/blob/master/bakups/reactive_with_effect_spec_passed.js">reactive<em>with</em>effect<em>spec</em>passed_js</a>  代码</span></p>
<h1>小结 2</h1>
<p>又是一个周一了，周末又荒废中度过…，回顾下之前的内容(顺序按照当时实现前后顺序排列)：</p>
<h2><strong><font color="purple">reactive - createReactiveObject</font></strong></h2>
<ol>
<li>参数： <code class="language-text">[target, toProxy, toRaw, baseHandlers, collectionHandlers]；</code></li>
<li><code class="language-text">new Proxy(target, handlers)</code>；</li>
<li>根据类型选择 <code class="language-text">handlers</code> ，集合类型(Map, Set)用collection，其他对象类型用 base；</li>
<li>缓存 <em>proxy-target</em> 结果(toProxy: target -> observed, toRaw: observed -> target)；</li>
<li>过滤条件(已经 proxy 或 toProxy 中已经存在的不用重复 new )；</li>
<li>非对象判断，能 proxy 的必须是引用类型；</li>
<li>过滤掉 5 中非法情况(_isVue, _isVNode, rawValues, isFrozen, 非 observable 五种情况)。</li>
</ol>
<h2><strong><font color="purple">createGetter</font></strong></h2>
<p>取值，递归 reactive，调用 track 收集依赖，数组检测(includes, indexOf, lastIndex 特殊处理)，等等。</p>
<ol>
<li>参数： <code class="language-text">[isReadonly, shallow]</code>；</li>
<li><code class="language-text">Reflect.get()</code> 先取值</li>
<li>判断结果是不是引用类型，如果是调用 reactive 将结果转响应式(嵌套的对象)</li>
<li>检测是不是只读，如果是就返回只读版本(其实差别就是在 handlers)</li>
<li>shallow = true 情况，只 reactive 对象一级(嵌套不处理)</li>
<li>非只读情况调用  <code class="language-text">track()</code> 收集依赖</li>
<li>检测 key 是不是数组的三个索引方法(includes, indexOf, lastIndexOf)，单独处理(<code class="language-text">arrayInstrumentations</code>)</li>
</ol>
<h2><strong><font color="purple">createSetter</font></strong></h2>
<p>设置，调用 trigger 触发 deps(<code class="language-text">targetMap -&gt; depsMap -&gt; dep</code>)，返回 <code class="language-text">Reflect.set()</code> 结果。</p>
<ol>
<li>参数：<code class="language-text">[shallow]</code></li>
<li><code class="language-text">oldValue = target[key]</code></li>
<li>事先 <code class="language-text">hasOwnProperty</code> 检测，缓存结果(添加属性的时候需要)</li>
<li>调用 <code class="language-text">Reflect.set(...)</code> 设置下去</li>
<li>调用 <code class="language-text">trigger(target, type, key, newValue, oldValue, oldTarget)</code> 触发 deps</li>
<li>
<p>增加条件判断，不是什么情况都可以调用 trigger的</p>
<p>a) target - receiver 必须是对应关系</p>
<p>b) hasOwn 检测结果失败则为 <code class="language-text">add</code> 操作，否则为 <code class="language-text">set</code> 操作，且 set 操作必须是在值发生改变的情况(排除 <code class="language-text">NaN</code>)</p>
</li>
</ol>
<h2><strong><font color="purple">track</font></strong></h2>
<p> createGetter 里面调用，用来收集依赖的，依赖都存储在 <code class="language-text">targetMap</code> 里面，分为两级，</p>
<p>第一级是 Map{target -> Map} 类型</p>
<p>第二级也是 Map{key -> Set(deps)}</p>
<ol>
<li>参数：<code class="language-text">[target, type, key]</code></li>
<li>从 targetMap 中取 depsMap 该 target 对象对应的所有依赖仓库，没有就初始化 <code class="language-text">new Map()</code></li>
<li>从 depsMap 取对应 key 的所有依赖仓库 dep，没有就初始化 <code class="language-text">new Set()</code></li>
<li>检测依赖是否存在(activeEffect)，确保不会重复添加</li>
<li><code class="language-text">dep.add(activeEffect) -&gt; activeEffect.deps.push(dep)</code></li>
<li>增加判断，如果当前 <code class="language-text">activeEffect</code> 未具备收集条件(<strong>shouldTrack: true, activeEffect不为空</strong>)，就退出依赖收集。</li>
</ol>
<h2><strong><font color="purple">trigger</font></strong></h2>
<p>createSetter 里调用来，触发依赖调用的，主要包含两个内部函数(add, run)：</p>
<p>Add: 将于当前要 update 的 deps 收集到一个内部变量 <code class="language-text">effects: Set()</code> 里。</p>
<p>Run: 使用 run去执行 effects 里面的 dep </p>
<ol>
<li>参数： <code class="language-text">[target, type, key, newValue, oldValue, oldTarget]</code></li>
<li>检测 targetMap -> target 没有依赖直接退出</li>
<li>实现 add，添加条件：<code class="language-text">shouldTrack = false, effect !== activeEffect</code> 这两个条件能防止栈溢出的问题(比如在 effect(fn) 的 fn 里面做 <code class="language-text">ob.prop++</code> 操作，<a href="#test-case-rloops">之前有分析</a>。)</li>
<li>
<p>使用 add 收集 deps，三种情况</p>
<p>a) 如果 type: clear 将所有 depsMap 添加进去</p>
<p>b) 如果 key: length 且 target 是数组，说明是数组的增加和删除操作，将 depsMap 中 key 为 ‘length’ 或者 key > newValue 情况的 dep 添加</p>
<p>c) 其他为对象情况处理(Map类型或Object操作)</p>
</li>
<li>最后去执行 run，flush 掉所有 deps(effects, computedEffects)。</li>
</ol>
<h2><strong><font color="purple">effect</font></strong></h2>
<p>构造 dep 类型 ReactiveEffect，其中包含 <code class="language-text">[_isEffect, active, raw, deps, options, id]</code>类型的对象。</p>
<ol>
<li>参数：<code class="language-text">[fn, options]</code></li>
<li>检测 fn._isEffect 如果本身已经是个 ReactiveEffect，取出 fn = fn.raw，重新封装</li>
<li>定义 _effect 函数，所以 vue3 里面每个 dep 都是一个函数类型，上面追加了若干参数</li>
<li>_effect 函数的实现重点是 effectStack 和 try…finally，try 里面 enable effect 执行 fn，finally 里面 disable effect。所以这里结合 trigger 里面的 shouldTrack 和 activeEffect 判断来协同防止栈溢出问题。</li>
<li>_effect 上追加 ReactiveEffect 必备的参数。</li>
<li>执行一次 <code class="language-text">_effect()</code> (前提是没有设置 options.lazy 属性为 true)</li>
</ol>
<h2><strong><font color="purple">ownKeys, has, delete</font></strong></h2>
<p>这三个的实现非常简单</p>
<ol>
<li>ownKeys 调用 track 收集依赖</li>
<li>has 调用 track 收集依赖</li>
<li>delete 调用 trigger 触发 delete 操作</li>
<li>最后都要返回对应的 Reflect… 操作结果</li>
</ol>
<h2>其他</h2>
<p>到此，第一阶段的工作基本已经完成了，我们也得到了一个基本可以跑起来，作用起来的 reactive 。</p>
<p>接下的内容主要有以下几点：</p>
<ol>
<li>集合类型的 <strong>collectionHandlers</strong> 实现，之前都是实现了 <em>baseHandlers</em>，既然 vue3 中独立成两个文件了，肯定有不小的差别，但是有了之前的基础，相信理解 <strong>collectionHandlers</strong> 不会那么困难。</li>
<li>ref 的实现，这块目前进度几乎为0️⃣，有待研究。</li>
<li>最后就是其他几个测试用例文件的测试了。</li>
</ol>
<p>漫漫源码路其修远兮，吾将前后左右以贯之，加油파이팅🤜🤛！！！</p>
<p>书大坐阵，稳<del></del>~~</p>
<p><img src="http://qiniu.ii6g.com/1.png?imageMogr2/thumbnail/!100p"></p>
<h1>更新(2020-05-25 10:54:40)</h1>
<p>前两天更新了下 vue 仓库源码，发现有不小的改动，这里提前把这些改动合并到之前的阅读上去，以防止后面越走越远，导致越难合并。</p>
<blockquote>
<p>5a3b44ca master origin/master chore: fix typo in comment (#1217)
2b2beb91 build(deps-dev): bump @types/puppeteer from 2.1.0 to 2.1.1
8e945c97 build(deps-dev): bump @microsoft/api-extractor from 7.8.1 to 7.8.2
91c4e9b8 build(deps-dev): bump rollup from 2.10.4 to 2.10.5
96a9d5c6 build(deps-dev): bump rollup from 2.10.2 to 2.10.4
42e48b83 build(deps-dev): bump @types/jest from 25.2.2 to 25.2.3
32b3f78a v3.0.0-beta.14 release: v3.0.0-beta.14</p>
</blockquote>
<p>本节约定：</p>
<ol>
<li>先列出变更对比代码</li>
<li>未变更的篇幅较多的代码将省略，如注释：// … 省略</li>
</ol>
<h2>reactive.ts</h2>
<h3><font color="red"><strong>首先新增了两个类型：</strong></font></h3>
<ol>
<li>
<p>ReactiveFlags 枚举对象，用来记录对象特征的，比如：是否只读等等</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlags <span class="token punctuation">{</span>
 skip <span class="token operator">=</span> <span class="token string">'__v_skip'</span><span class="token punctuation">,</span>
 isReactive <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
 isReadonly <span class="token operator">=</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span>
 raw <span class="token operator">=</span> <span class="token string">'__v_raw'</span><span class="token punctuation">,</span>
 reactive <span class="token operator">=</span> <span class="token string">'__v_reactive'</span><span class="token punctuation">,</span>
 <span class="token keyword">readonly</span> <span class="token operator">=</span> <span class="token string">'__v_readonly'</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p>Target 接口类型</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 会发现这个和上面的 ReactiveFlags 是相对应的，上面的 enum 代表的是 key 值字符串</span>
<span class="token comment">// 这里声明了一个 Target 类型，里面包含的就是上面所有 key 字符串对应值为 boolean 的一个对象</span>
<span class="token comment">// 都是些标识，标识这对象的各种特性</span>
<span class="token keyword">interface</span> <span class="token class-name">Target</span> <span class="token punctuation">{</span>
 __v_skip<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
 __v_isReactive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
 __v_isReadonly<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
 __v_raw<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span>
 __v_reactive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span>
 __v_readonly<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<h3><font color="red"><strong>canObserve 实现变化</strong></font></h3>
<p><strong>更新后</strong></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 就是把三种非法类型(_isVue, _isVNode, rawValues)进行合并了，使用一个__v_skip 来检测</span>
<span class="token comment">// 所以关键我们要关注的将是这个 __v_skip 是在哪里给初始化的值(预想应该是在 createGetter 里面)</span>
<span class="token keyword">const</span> canObserve <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> Target<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token builtin">boolean</span></span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>__v_skip <span class="token operator">&amp;&amp;</span>
    <span class="token function">isObservableType</span><span class="token punctuation">(</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">isFrozen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>更新前</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">canObserve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVNode <span class="token operator">&amp;&amp;</span>
    <span class="token function">isObservableType</span><span class="token punctuation">(</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>rawValues<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">isFrozen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3><font color="red">reactive(target)</font></h3>
<p><strong>更新后</strong></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// if trying to observe a readonly proxy, return the readonly version.</span>
  <span class="token comment">// 变化1 ： 使用了 __v_isReadonly 代替了 readonlyToRaw: WeakMap</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> Target<span class="token punctuation">)</span><span class="token punctuation">.</span>__v_isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// 变化2：这里现在只需要四个参数了，将 toProxy 和 toRaw 合并了？？？</span>
  <span class="token comment">// 只能后面再说了</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>更新前</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// reactivity start</span>
<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonlyToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    rawToReactive<span class="token punctuation">,</span>
    reactiveToRaw<span class="token punctuation">,</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3><font color="red">createReactiveObject(target, isReadonly, baseHandlers, collectionHandlers)</font></h3>
<p>去掉了 toProxy 和 toRaw，改成了 isReadonly，所以针对这个函数的更新，需要探究去掉这两者之后是如何实现该功能的，或者没有该功能了？？？</p>
<p><strong>更新后：</strong></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 变化1：参数变少了</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token operator">:</span> Target<span class="token punctuation">,</span>
  isReadonly<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  baseHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span>
  collectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value cannot be made reactive: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// target is already a Proxy, return it.</span>
  <span class="token comment">// exception: calling readonly() on a reactive object</span>
  <span class="token comment">// 变化2：直接通过两个 __v_raw 和 __v_isReactive 过滤</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>__v_raw <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>isReadonly <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">.</span>__v_isReactive<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
    
  <span class="token comment">// 变化3：直接返回对应的 target 版本</span>
  <span class="token comment">// target already has corresponding Proxy</span>
  <span class="token comment">// 这里应该是直接返回了 target 上的只读和reactive 版本</span>
  <span class="token comment">// 所以这里就必然存在一个行为，将只读和 reactive 版本赋值到 __v_readonly，__v_reactive</span>
  <span class="token comment">// 两个属性上去，继续>>></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> isReadonly <span class="token operator">?</span> ReactiveFlags<span class="token punctuation">.</span><span class="token keyword">readonly</span> <span class="token operator">:</span> ReactiveFlags<span class="token punctuation">.</span>reactive<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> target<span class="token punctuation">.</span>__v_readonly <span class="token operator">:</span> target<span class="token punctuation">.</span>__v_reactive
  <span class="token punctuation">}</span>
  <span class="token comment">// only a whitelist of value types can be observed.</span>
  <span class="token comment">// 这里就不说了，变动存在于 canObserve 函数内部</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canObserve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">)</span> <span class="token operator">?</span> collectionHandlers <span class="token operator">:</span> baseHandlers
  <span class="token punctuation">)</span>
  
  <span class="token comment">// 变化4：使用了 def 函数，估计缓存target两个版本，就是在这里实现的</span>
  <span class="token comment">// 本次更新重点应该就是这个 def 了，离真相越来越近了......</span>
  <span class="token function">def</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    isReadonly <span class="token operator">?</span> ReactiveFlags<span class="token punctuation">.</span><span class="token keyword">readonly</span> <span class="token operator">:</span> ReactiveFlags<span class="token punctuation">.</span>reactive<span class="token punctuation">,</span>
    observed
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span></code></pre></div>
<p><strong>更新前：</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 变化1：参数变少了</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token punctuation">,</span>
  toProxy<span class="token punctuation">,</span>
  toRaw<span class="token punctuation">,</span>
  baseHandlers<span class="token punctuation">,</span>
  collectionHandlers</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target <span class="token operator">||</span> <span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>

  <span class="token comment">// 变化2</span>
  <span class="token keyword">let</span> observed <span class="token operator">=</span> toProxy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>observed <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> observed
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>toRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span> <span class="token comment">// 变化2 end</span>
    
 	<span class="token comment">// 变化3：... 新增</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canObserve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span> 

  <span class="token keyword">const</span> handlers <span class="token operator">=</span> collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span>
    <span class="token operator">?</span> collectionHandlers
    <span class="token operator">:</span> baseHandlers
  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
  
  <span class="token comment">// 变化4：使用 def 代替</span>
  toProxy<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
  toRaw<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span></code></pre></div>
<p>下面就不继续更了，都是些小函数围绕 def, Target, ReactiveFlags 的更新。</p>
<h2>baseHandlers.ts</h2>
<h3><font color="red">createGetter(isReadonly = false, shallow = false) </font></h3>
<p><strong>更新后(只有一个变化，标识性属性的读取处理)：</strong></p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> receiver<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 变化1：新增对标识性的属性读取，vue 给增加的一些属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span>isReactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token comment">// ... 为了节省篇幅，未变化的就省略吧，后续的也如此</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>更新前：</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 变化1：新增</span>
    <span class="token comment">/*
    	...
    */</span>
    <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
     <span class="token comment">// ... 为了节省篇幅，未变化的就省略吧，后续的也如此</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>effect.ts</h2>
<p>变量及类型声明变更：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> Dep <span class="token operator">=</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">></span> <span class="token comment">// 新增 Dep 类型</span>
<span class="token keyword">type</span> KeyToDepMap <span class="token operator">=</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">></span> <span class="token comment">// 新增对象的 key -> Dep</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h2>jest</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">☁  vue-next-code-read [master] jest
FAIL  packages/__tests__/reactive/reactive.spec.js (5.447 s)
● reactivity/reactive › markRaw

expect(received).toBe(expected) // Object.is equality

Expected: false
Received: true

106 |     })
107 |     expect(isReactive(obj.foo)).toBe(true)

  &gt; 108 |     expect(isReactive(obj.bar)).toBe(false)
  &gt;  |                                 ^
  &gt; 109 |   })
  &gt; 110 |
  &gt; 111 |   test(&#39;should not observe frozen objects&#39;, () =&gt; {

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/reactive.spec.js:108:33)

FAIL  packages/__tests__/reactive/effect.spec.js (5.589 s)
● reactivity/effect › markRaw

  expect(received).toBe(expected) // Object.is equality

  Expected: 0
  Received: 1

    744 |     expect(dummy).toBe(0)
    745 |     obj.foo.prop++

  &gt; 746 |     expect(dummy).toBe(0)
  &gt;  |                   ^
  &gt; 747 |     obj.foo = { prop: 1 }
  &gt; 748 |     expect(dummy).toBe(1)
  &gt; 749 |   })

    at Object.&lt;anonymous&gt; (packages/__tests__/reactive/effect.spec.js:746:19)

Test Suites: 2 failed, 2 total
Tests:       2 failed, 59 passed, 61 total
Snapshots:   0 total
Time:        9.857 s
Ran all test suites.</code></pre></div>
<p>这两个原因其实都是因为 canObserve 还没更新过来，修改如下：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">canObserve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>__v_skip <span class="token operator">&amp;&amp;</span>
    <span class="token function">isObservableType</span><span class="token punctuation">(</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">isFrozen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>重新 jest 通过：</p>
<blockquote>
<p>☁  vue-next-code-read [master] ⚡  jest
PASS  packages/<strong>tests</strong>/reactive/reactive.spec.js (5.311 s)
PASS  packages/<strong>tests</strong>/reactive/effect.spec.js (5.429 s)</p>
<p>Test Suites: 2 passed, 2 total
Tests:       61 passed, 61 total
Snapshots:   0 total
Time:        9.612 s
Ran all test suites.
☁  vue-next-code-read [master] ⚡</p>
</blockquote>
<p><span id="file-0521"><a href="https://github.com/gcclll/vue-next-code-read/blob/master/bakups/reactive_with_update_0521.js">Reactive.js</a></span></p>
<h2></h2>
<h1>collectionHandlers.ts</h1>
<p>也该开始集合类型支持了，这部分的修改主要集中在这个文件里面，因为之前 reactive.ts, effect.ts 里面都已经把集合类型代码合并进去了(其实除了 trigger 里面有部分的 map 相关区分之后，绝大部分都是一样的)。</p>
<p>这里可能得做个事情，如果还想坚持使用一个 js 文件来完成功能，那只能考虑使用作用域对象来处理了，即将 baseHandlers 和 collectionHandlers 分别用单独一个对象来承载，因为里面的函数名都是同一个，不然就只能拆分成多个文件了。</p>
<p>思考中 ☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡☡…</p>
<p>还是拆分吧，和 vue 源码结构保持一致，增加 reactive 目录来承载。</p>
<p>分离之后的目录备份 <a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_files_v">bakups/reactive<em>files</em>v</a></p>
<p>下面进入正题 >>>>>>>></p>
<p>新建 collectionHandlers.js 用来定义集合类型有关的 proxy handlers。</p>
<p>把 reactive.js 里面的 </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// TODO</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mutableCollectionHandlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyCollectionHandlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowCollectionHandlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></div>
<p>移到 <em>collectionHandler.js</em> 里，这节接下来所有的工作都是为了构建这三个 handlers。</p>
<p>将按 get -> set -> size -> add -> deleteEntry -> has -> clear 顺序来一步步实现。</p>
<h2>准备工作</h2>
<p>有了 baseHandlers.ts 实现的基础，就没必要再那么详细的步骤去实现了，这里将所有准备工作做足，主要就是一些基础变量的声明，在理解它的基础上先声明好，而不是用的时候再去声明。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// reactive 化</span>
<span class="token keyword">const</span> toReactive <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=></span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value

<span class="token comment">// readonly reactive</span>
<span class="token keyword">const</span> toReadonly <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=></span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value

<span class="token comment">// shallow reactive</span>
<span class="token keyword">const</span> toShallow <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=></span> value
<span class="token comment">// 取原型原子操作 Reflect</span>
<span class="token keyword">const</span> getProto <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">CollectionTypes</span><span class="token operator">></span><span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token builtin">any</span></span> <span class="token operator">=></span>
  Reflect<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>

<span class="token comment">// 三个 handlers 对应的 instrumentations</span>
<span class="token keyword">const</span> mutableInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">></span> <span class="token operator">=</span>  <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> shallowInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> readonlyInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>

<span class="token comment">// 集合类型几个迭代方法和迭代器</span>
<span class="token keyword">const</span> iteratorMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'keys'</span><span class="token punctuation">,</span> <span class="token string">'values'</span><span class="token punctuation">,</span> <span class="token string">'entries'</span><span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span>

<span class="token comment">// 三个 handlers 只需要一个 get ????????????</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mutableCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token operator">:</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> shallowCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token operator">:</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token operator">:</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>createInstrumentationGetter</h2>
<p>由于三个 handlers 都是由这个生成的，所以我们不得不以这个函数作为切入点。</p>
<p>在这之前必须的完成准备工作，把需要的变量都实现准备好。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// proxy handlers 对象</span>
<span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> shallowInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> readonlyInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly<span class="token punctuation">,</span> shallow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 决定使用哪种类型的 instru...</span>
  <span class="token keyword">const</span> instrumentations <span class="token operator">=</span> shallow
    <span class="token operator">?</span> shallowInstrumentations
    <span class="token operator">:</span> isReadonly
    <span class="token operator">?</span> readonlyInstrumentations
    <span class="token operator">:</span> mutableInstrumentations

  <span class="token comment">// Reflect.get 类型的 proxy handler</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ReactiveFlags<span class="token punctuation">.</span>isReactive<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly
      <span class="token keyword">case</span> ReactiveFlags<span class="token punctuation">.</span>isReadonly<span class="token operator">:</span>
        <span class="token keyword">return</span> isReadonly
      <span class="token keyword">case</span> ReactiveFlags<span class="token punctuation">.</span>raw<span class="token operator">:</span>
        <span class="token keyword">return</span> target
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 难道集合类型的 proxy handler 统统走的都是 proxy get ???</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    <span class="token function">hasOwn</span><span class="token punctuation">(</span>instrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> target <span class="token operator">?</span> instrumentations <span class="token operator">:</span> target<span class="token punctuation">,</span>
    key<span class="token punctuation">,</span>
    receiver
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这里对于集合类型只提供一个 get proxy handler 和之前碰到过的报错 <a href="#error-map">VM1029:1 Uncaught TypeError: Method Map.prototype.get called on incompatible receiver [object Object]</a> 问题是一样的，网上说的是丢失了作用域，看报错的提示也确实是这个原因。</p>
<p>根源在于你使用 observed->Map 的时候，需要通过 <code class="language-text">observed.get()</code> 去调用，但 observed 是个 Proxy 类型，在 proxy handler 里面 Reflect 需要调用的又是 Map 类型上面的 get 方法(因为它是 target 的原子操作啊)，因此就出现了 Proxy -> 调用 Map.prototype.get 导致失败报错 。</p>
<p>要解决这个问题，最简单是改变 Reflect.get 的调用作用，如：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key <span class="token punctuation">}</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token string">'111 get proxy'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>既然现在知道了 map 的操作都需要通过 get 来进行进一步”代理”，<code class="language-text">createInstrumentationGetter</code> 也实现了，这个也很简单，就是根据特性判断采用那一个 instrumentations，然后返回 <code class="language-text">Reflect.get</code> 结果，中间加上了 ReactiveFlags 的一些判断而已。</p>
<p>三个 handlers ：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> mutableCollectionHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token operator">:</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyCollectionHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token operator">:</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowCollectionHandlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token operator">:</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>get(target, key, wrap)</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> rawKey <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> rawKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> has<span class="token punctuation">,</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>测试：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'is reactive'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>or <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">,</span> <span class="token string">'or is map'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ob <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">,</span> <span class="token string">'ob is map'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'============================='</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<p><img src="http://qiniu.ii6g.com/1590398397.png?imageMogr2/thumbnail/!100p"></p>
<p>注意看 createInstrumentationGetter 返回的箭头函数里返回的值：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token function">hasOwn</span><span class="token punctuation">(</span>instrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> target
  <span class="token operator">?</span> instrumentations
  <span class="token operator">:</span> target<span class="token punctuation">,</span>
  key<span class="token punctuation">,</span>
  receiver
<span class="token punctuation">)</span>

<span class="token comment">// 上面的假设是 mutableInstrumentations，那么上面的代码就相当于</span>
<span class="token comment">// 假设调用的是 observed.get(key, ...)，那么第二个参数 key = 'get'</span>
<span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* mutableInstrumentations 里面的 get 方法*/</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> receiver<span class="token punctuation">)</span></code></pre></div>
<p>经过上面的转换之后就比较有意思了，不管你通过 observed 调用什么方法，最终都会被转成 Reflect.get 取值操作，而取值的关键在于两点：</p>
<ol>
<li>被取值的对象这里就是我们真正定义的 proxy handler 对象，里面包含了指定特性需要的函数</li>
<li>key 为 observed 调用的那个方法名称，必须取值 observed.get 那么 key 就是 ‘get’，observed.set ，那么 key 就是 ‘set’</li>
</ol>
<p>最终 observed.get ---> 其实就是 <code class="language-text">mutableInstrumentations.get</code> 。</p>
<h3><font color="red">TODO</font> 疑问？？</h3>
<ol>
<li>
<p>Get 里的 两次 toRaw 是啥意思？？？</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 这里为啥要取两次 toRaw，然后可能会触发两次 track???</span>
 target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
 <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> rawKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><span id="question-this">在实现 get 的时候 vue 源码里是这样的： <code class="language-text">get(this: MapTypes, ...)</code> 但实际这种语法在 js 中肯定是不支持的</span></p>
<p>然后自己就改写了下：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// proxy handlers 对象</span>
<span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
 <span class="token keyword">get</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReactive<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token keyword">set</span>
<span class="token punctuation">}</span></code></pre></div>
<p>结果发现不太对：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'effect'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
<span class="token comment">/* ob.set('key', 'value') */</span>
<span class="token comment">/* console.log({ dummy }, '2') */</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<p><img src="http://qiniu.ii6g.com/1590402707.png?imageMogr2/thumbnail/!100p"></p>
<p>这里收集的依赖的 key 竟然是 <code class="language-text">undefined</code>，也就是说传入给 <code class="language-text">get(target, key, wrap)</code> 的 key 丢失了。</p>
<p>虽然知道原因：就是上面的 mutableInstrumentations 的 get 多了一个参数啊，这貌似哪里不太对，无奈去看了下 <code class="language-text">vue.global.js</code> 打包之后的代码，才发现端倪。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 打包之后的 get</span>
<span class="token keyword">const</span> readonlyInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
 <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请看这里，打包之后第一个 this 没有了</span>
   <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token function">$1</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReadonly<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打包之前的 get，ts语法</span>
<span class="token keyword">const</span> mutableInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
 <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReactive<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>由于 js 是不支持用 this 做函数参数的，所以只能从 TypeScript 去方向着手了…，然后，然后就有了结果：</p>
<p>ts 中的 <a href="https://www.typescriptlang.org/docs/handbook/functions.html">this 作为函数第一个参数的语法</a>说明</p>
<p><img src="http://qiniu.ii6g.com/1590403211.png?imageMogr2/thumbnail/!100p"></p>
<p>被圈圈的两个单词是关键，它就是个假的参数，作用也就是让函数能声明它被调用的那个对象是什么类型，因此也就明白为何打包之前和打包之后代码的差异了。</p>
<p>所以该问题解决方法就是去掉第一个参数，只有一个参数 key ，如：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
 <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReactive<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token keyword">set</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
</ol>
<h2>set(this, key, value)</h2>
<p>弄清楚 TypeScript 的 this argument 之后，解决了 get 也就解决了 set 问题了。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token comment">// 取调用 set 的那个对象，取出它原型上的 has, get, set，</span>
  <span class="token comment">// 也就是 target: Map </span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> has<span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token keyword">set</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

  <span class="token keyword">let</span> hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 是不是有可能也是个 observed ???</span>
    <span class="token comment">// Map 的 key 不仅限于普通类型，可以是任意类型</span>
    key <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token comment">// 那么重新取一次值</span>
    hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 取旧值</span>
  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token comment">// 把值设置到 observed 之前的对象上，可参考下面的结果图</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  
  <span class="token comment">// 下面就是跟 basehandler 一样的增加或设置操作了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 记得返回设置结果</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>测试：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<p><img src="http://qiniu.ii6g.com/1590405427.png?imageMogr2/thumbnail/!100p"></p>
<p>有了 get 和 set 实现打基础下面的实现就🌾渠成了，但革命还未成功，依旧需要努力谨慎，🐩🐩🐩…</p>
<h2>size(target)</h2>
<p>Map 的 size 属性是一个原型是上的属性： <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map/size">Map.prototype.size</a>， 至于为什么要用ITERATE_KEY 那就需要看下</p>
<p><a href="https://tc39.es/ecma262/#sec-get-map.prototype.size">这里了</a></p>
<p>实现的时候是需要对 Map 进行迭代的(<code class="language-text">for [key, value] of map</code>)，因此会触发 iterate 行为来收集依赖。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'iterate'</span><span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>
  <span class="token comment">// size 是在 Map 原型上的一个属性</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>更新 mutableInstrumentations:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// proxy handlers 对象</span>
<span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReactive<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>add(value)</h2>
<p>限于 Set 类型使用，但是为啥不加个判断呢？？？</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token comment">// Set.prototype ....</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// Set.prototype.has</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// Set.prototype.add</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>测试</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<blockquote>
<p>{dummy: false} “before”
{dummy: true} “after”</p>
</blockquote>
<h2>deleteEntry(key)</h2>
<p>Map/Set.prototype.delete 的 proxy handler</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">deleteEntry</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> has<span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token keyword">delete</span><span class="token operator">:</span> del <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">get</span> <span class="token operator">?</span> <span class="token keyword">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">del</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'delete'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>测试</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 增加，触发 fn -> updater</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
ob<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 清空，trigger: clear</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'cleared'</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// trigger: add</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
ob<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token comment">// trigger: delete</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'deleted'</span><span class="token punctuation">)</span> <span class="token comment">// false</span></code></pre></div>
<p>结果</p>
<blockquote>
<p>{dummy: false} “before”
{dummy: true} “after”
{dummy: false} “cleared”
{dummy: true} “add”
{dummy: false} “deleted”</p>
</blockquote>
<h2>has(key)</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> rawKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'has'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'has'</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>

  <span class="token keyword">const</span> has <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>has
  <span class="token keyword">return</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>	</code></pre></div>
<p>测试：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy<span class="token punctuation">,</span> has
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span>size
  has <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy<span class="token punctuation">,</span> has <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 改变了 size</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy<span class="token punctuation">,</span> has <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果：</p>
<blockquote>
<p>{dummy: 0, has: false} “before”
{dummy: 1, has: true} “after”</p>
</blockquote>
<h2>clear()</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> hadItems <span class="token operator">=</span> target<span class="token punctuation">.</span>size <span class="token operator">!==</span> <span class="token number">0</span>
  <span class="token keyword">const</span> oldTarget <span class="token operator">=</span> __DEV__
    <span class="token operator">?</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span>
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">undefined</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hadItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'clear'</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> oldTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>测试</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'cleared'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果</p>
<blockquote>
<p>{dummy: false} “before”
{dummy: true} “after”
{dummy: false} “cleared”</p>
</blockquote>
<h2>forEach(isReadonly, shallow)</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> thisArg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span>

    <span class="token keyword">const</span> wrap <span class="token operator">=</span> isReadonly <span class="token operator">?</span> toReadonly <span class="token operator">:</span> shallow <span class="token operator">?</span> toShallow <span class="token operator">:</span> toReactive

    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'iterate'</span><span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>

    <span class="token comment">// 封装的目的：</span>
    <span class="token comment">// 1. 确保在 thisArg 作用域下调用</span>
    <span class="token comment">// 2. 确保传递给 callback 的值都是 creative 的</span>
    <span class="token keyword">function</span> <span class="token function">wrappedCallback</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> wrappedCallback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre></div>
<p>测试</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  ob<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    dummy<span class="token operator">++</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code></pre></div>
<p>未实现之前结果</p>
<blockquote>
<p>{dummy: 0} 0
{dummy: 0} 1
{dummy: 0} 2
{dummy: 0} 3</p>
</blockquote>
<p>实现之后结果</p>
<blockquote>
<p>{dummy: 0} 0
{dummy: 1} 1
{dummy: 3} 2
{dummy: 6} 3</p>
</blockquote>
<h2>三个小矮人(handlers, createIterableMethod)</h2>
<p>只读操作的 handlers ：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 只读函数，会改变对象的操作均不响应</span>
<span class="token keyword">function</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">on key "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" </span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> operation </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> type <span class="token operator">===</span> <span class="token string">'delete'</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>三个小主人公：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// proxy handlers 对象</span>
<span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReactive<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  add<span class="token punctuation">,</span>
  clear<span class="token punctuation">,</span>
  <span class="token keyword">delete</span><span class="token operator">:</span> deleteEntry<span class="token punctuation">,</span>
  forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> shallowInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toShallow<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  add<span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  <span class="token keyword">delete</span><span class="token operator">:</span> deleteEntry<span class="token punctuation">,</span>
  clear<span class="token punctuation">,</span>
  forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> readonlyInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> toReadonly<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  add<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">delete</span><span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span><span class="token string">'delete'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  clear<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span><span class="token string">'clear'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>针对迭代器操作，创建迭代器代理 handler:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createIterableMethod</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> isReadonly<span class="token punctuation">,</span> shallow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> isMap <span class="token operator">=</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span>
    <span class="token comment">// 检测是不是 Set 或 Map，Map迭代的时候返回的是for [key, value] of map</span>
    <span class="token comment">// Set 迭代的时候返回的时候是 for value of set</span>
    <span class="token comment">// Object.entries()</span>
    <span class="token keyword">const</span> isPair <span class="token operator">=</span> method <span class="token operator">===</span> <span class="token string">'entries'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> Symbol<span class="token punctuation">.</span>iterator <span class="token operator">&amp;&amp;</span> isMap<span class="token punctuation">)</span>
    <span class="token comment">// Object.keys()</span>
    <span class="token keyword">const</span> isKeyOnley <span class="token operator">=</span> method <span class="token operator">===</span> <span class="token string">'keys'</span> <span class="token operator">&amp;&amp;</span> isMap
    <span class="token comment">// 取出原生的 迭代器</span>
    <span class="token keyword">const</span> innerIterator <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token comment">// 嵌套 reactive</span>
    <span class="token keyword">const</span> wrap <span class="token operator">=</span> isReadonly <span class="token operator">?</span> toReadonly <span class="token operator">:</span> shallow <span class="token operator">?</span> toShallow <span class="token operator">:</span> toReactive
    <span class="token comment">// 触发迭代器 收集依赖</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'iterate'</span><span class="token punctuation">,</span> isKeyOnley <span class="token operator">?</span> <span class="token constant">MAP_KEY_ITERATE_KEY</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token comment">// 封装一层，迭代器的两个必备条件：1. next()，2. Symbol.iterator 必须实现</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 原本的迭代器</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> innerIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> done
          <span class="token operator">?</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token punctuation">{</span>
          		<span class="token comment">// 处理 entries 或 keys, values，对嵌套的对象进行 reactiv</span>
              value<span class="token operator">:</span> isPair <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
              done
            <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 可迭代对象实现基础</span>
      <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>测试</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> or <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> keys<span class="token punctuation">,</span> values<span class="token punctuation">,</span> entries
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  keys <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  values <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  entries <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> values<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entries<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> values<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entries<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code></pre></div>
<p>结果</p>
<p><img src="http://qiniu.ii6g.com/1590456092.png?imageMogr2/thumbnail/!100p"></p>
<h2>jest</h2>
<p>结果：</p>
<blockquote>
<p>☁  vue-next-code-read [master] ⚡  jest
PASS  packages/<strong>tests</strong>/reactive/reactive.spec.js
PASS  packages/<strong>tests</strong>/reactive/effect.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/WeakSet.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/Map.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/WeakMap.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/Set.spec.js</p>
<p>Test Suites: 6 passed, 6 total
Tests:       132 passed, 132 total
Snapshots:   0 total
Time:        5.278 s
Ran all test suites.</p>
</blockquote>
<p>分析</p>
<ul>
<li>
<p><font color="green">✓ instanceof (3 ms)</font></p>
<p><img src="http://qiniu.ii6g.com/1590458265.png?imageMogr2/thumbnail/!100p"></p>
<p>注意 Proxy 之后的 observed 的 <strong>proto</strong> 值是 Map ，所以对 observed 使用 instanceof Map(查找原型链) 结果肯定是 true。</p>
</li>
<li>
<p><font color="green">✓ should observe mutations (2 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe mutations'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">let</span> dummy
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里触发的是 map 对象的 'get' proxy handler</span>
  <span class="token comment">// key = 'get', 最后通过 Reflect.get(instrumentations{...}, 'get', receiver)</span>
  <span class="token comment">// 即最后调用 'get' 方法的是 instrumentations 这些对象</span>
  <span class="token comment">// 如： mutableInstrmentations 的 get(key) { return get(this, key, toReactive) }</span>
  <span class="token comment">// 然后 get(key) 的 key = 'key'，传递给 `get(this, ...)`</span>
  <span class="token comment">// 然后在 get(this, ...) 里面通过 call->proto 去调用原型上的方法，解决作用域丢失的问题</span>
  dummy <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token comment">// 调用的是 instrumentations 的 set => set(this, ...)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span> <span class="token comment">// map{'key' => 'value'}, trigger: add</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value2'</span><span class="token punctuation">)</span> <span class="token comment">// trigger: set</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'value2'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token comment">// trigger: delete</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should observe mutations with observed value as key (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> dummy
<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
dummy <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 用 observe 对象作为 key 和 value</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// true，都是引用类型，非值传递</span>
map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li><font color="green">✓ should observe size mutations (1 ms)</font></li>
<li><font color="green"> ✓ should observe for of iteration (2 ms)</font></li>
<li><font color="green">  ✓ should observe forEach iteration (1 ms)</font></li>
<li><font color="green"> ✓ should observe keys iteration (3 ms)</font></li>
<li><font color="green"> ✓ should observe values iteration (3 ms)</font></li>
<li><font color="green"> ✓ should observe entries iteration (5 ms)</font></li>
<li><font color="green"> ✓ should be triggered by clearing (3 ms)</font></li>
<li><font color="green"> ✓ should not observe custom property mutations (6 ms)</font></li>
<li><font color="green"> ✓ should not observe non value changing mutations (4 ms)</font></li>
<li><font color="green"> ✓ should not observe raw data (1 ms)</font></li>
<li><font color="green"> ✓ should not pollute original Map with Proxies (7 ms)</font></li>
<li><font color="green">✓ should return observable versions of contained values (1 ms)</font></li>
<li><font color="green">✓ should observed nested data (2 ms)</font></li>
<li><font color="green">✓ should observe nested values in iterations (forEach) (1 ms)</font></li>
<li><font color="green">✓ should observe nested values in iterations (values) (1 ms)</font></li>
<li><font color="green">✓ should observe nested values in iterations (entries) (2 ms)</font></li>
<li><font color="green">✓ should observe nested values in iterations (for…of) (2 ms)</font></li>
<li><font color="green">✓ should not be trigger when the value and the old value both are NaN (1 ms)</font></li>
<li><font color="green">✓ should work with reactive keys in raw map (1 ms)</font></li>
<li><font color="green">✓ should track set of reactive keys in raw map</font></li>
<li><font color="green">✓ should track deletion of reactive keys in raw map (1 ms)</font></li>
<li><font color="green">✓ should warn when both raw and reactive versions of the same object is used as key</font></li>
<li><font color="green">✓ should not trigger key iteration when setting existing keys (4 ms)</font></li>
</ul>
<h2>小结</h2>
<p>这节工作也基本完成了，所有 collection 相关的四个测试用例都测试通过，说明代码<strong>照抄</strong>(🤦‍♂️)的结果也正常。那现在也应该基本了解对于集合类型的 proxy 处理，vue 是怎么个实现的。</p>
<p>首先，proxy 是没有提供和集合类型有关的原子操作代理的，所以直接使用 new Proxy(map) 是没法实现我们想要的功能的，同时也会出现方法应用不当的报错(丢失方法的作用域了，把 Map.prototype.method 的方法应用到了 Proxy 类型)。</p>
<p>为了解决这个问题，vue 里面 collection 有关的操作全部都是通过 get proxy 代理来实现，下面是几个关键点和疑问点：</p>
<ol>
<li>所有接口全部使用 get proxy 通道转发，调用 <code class="language-text">Reflect.get(instrumentations, key, receiver)</code></li>
<li>在所有的实际 proxy handler里面(如：set, get, delete, …)，解决作用域问题，取target 上的原型方法</li>
<li>并且所有的原型上的方法(如：has, get, set)都通过 <code class="language-text">has.call(target)</code> 解决调用域的问题</li>
<li>
<p>Key 和 rawKey 的问题(get 中)，直接看测试代码分析🥵<span id="question-raw-key"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> key1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> key11 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span>
<span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> n1<span class="token punctuation">,</span> n2
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 n1 <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span>
 n2 <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key11<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key1<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> n1<span class="token punctuation">,</span> n2 <span class="token punctuation">}</span><span class="token punctuation">,</span> ob<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key11<span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> n1<span class="token punctuation">,</span> n2 <span class="token punctuation">}</span><span class="token punctuation">,</span> ob<span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果</p>
<p><img src="http://qiniu.ii6g.com/1590472850.png?imageMogr2/thumbnail/!100p"></p>
<p>Get 源码：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// key -> 'key11'</span>
<span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
 <span class="token comment">// 这里会对 key 有个 toRaw 操作，就是针对 key 是 proxy 的可能</span>
 <span class="token comment">// 最后 key11 传进来实际 rawKey = key1，并且触发 track 的时候</span>
 <span class="token comment">// rawKey 是必定会触发的，这保证了 key 非 proxy 时的能正常收集依赖</span>
 <span class="token comment">// 而 key !== rawKey -> trigger: get-key 就是针对 proxy key11 的情况也会</span>
 <span class="token comment">// 触发 track:get 收集依赖，因为 proxy key11 肯定是不会等于 key1 的。</span>
 <span class="token comment">// 所以 key1, key11 在 map.get(key1) 或 map.get(key11) 的时候都能正常收集到依赖</span>
 <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> rawKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>
 <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后在 set 的时候：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>

 <span class="token comment">// 这一段操作就是为了确保，key1 和 proxy key11 都能正确取到依赖</span>
 <span class="token comment">// 所以说 get 里面的 rawKey 和 key 的操作和这里的 toRaw 操作是相对应的</span>
 <span class="token comment">// 如果没有 get 里的 rawKey-key 操作，这里如果传入 proxy key11 就不会有依赖触发</span>
 <span class="token comment">// 因为 get 里面根本不会触发 track:get</span>
 <span class="token comment">// 如果 set 这里不加这一段处理，就算 get-track:get 了，这里也会找不到 proxy key11 导致</span>
 <span class="token comment">// 会触发非正常的 trigger:add 操作。</span>
 <span class="token keyword">let</span> hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   key <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
   hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// TODO</span>
 <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
</li>
<li>
<p><span id="question-key1-key11">为什么 key1 和 toReactive(key1) 后的 key11 前后 set 会改变 key1 对应的值？？？</span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> key1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> key2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key1<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
<span class="token comment">// 这里 key1 被转成了 Proxy，在 createIterableMethod 里面做的</span>
<span class="token comment">// 返回 iterable 的 next() 里面的行为，会把所有 value 都变成 wrap(value)</span>
<span class="token comment">// reactive 的，下面的 key11 其实就是 key1 经过 reactive 之后的 proxy</span>
<span class="token keyword">const</span> key11 <span class="token operator">=</span> ob<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value

<span class="token comment">// 验证 key11 与 key1 关系的猜测：</span>
<span class="token comment">// console.log(key11, key1, toRaw(key11) === key1) // code1</span>

<span class="token comment">// 验证 key11 与 key1 关系的猜测：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>key11<span class="token punctuation">)</span> <span class="token operator">===</span> key1<span class="token punctuation">,</span> ob<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>

<span class="token comment">// 然后我们将 key11 作为 key 设置给 ob</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key11<span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>key11<span class="token punctuation">)</span> <span class="token operator">===</span> key1<span class="token punctuation">,</span> ob<span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">)</span></code></pre></div>
<p>直接看结果图：</p>
<p><img src="http://qiniu.ii6g.com/1590465056.png?imageMogr2/thumbnail/!100p"></p>
<p>把 code1 注释掉，加上下面的代码，看下结果:</p>
<p><img src="http://qiniu.ii6g.com/1590465566.png?imageMogr2/thumbnail/!100p"></p>
<p>修正：“命名” -> “明明”。</p>
<p>也就是说我们通过设置 key1 的 proxy 版本 key11 却能让 key1 的值发生变化。那得分析分析这是为什么了？？？原因其实很简单，请看 <code class="language-text">set(key, value)</code> 源码：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// key -> key11, value -> '11'</span>
<span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// ...</span>
 
 <span class="token comment">// 首先是检测有没有 key11，咦，发现没有诶，</span>
 <span class="token comment">// 那有没可能它是个 proxy ???</span>
 <span class="token keyword">let</span> hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 好吧，那就还原下吧，取出 proxy 之前的那个 target</span>
   key <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
   <span class="token comment">// 返现 key11 你不就是 key1 转过来的吗？？？</span>
   <span class="token comment">// key1 我有啊 ，所以这里的 hadKey 就成了 true</span>
   <span class="token comment">// key 就成了 key1</span>
   hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// TODO</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// 因此下面其实就是通过 proxy:key11 的原版 key1 去触发 trigger: set</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>更直观点的测试：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> key1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> key11 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span>
<span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key1<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
<span class="token comment">// 验证 key11 与 key1 关系的猜测：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>key11<span class="token punctuation">)</span> <span class="token operator">===</span> key1<span class="token punctuation">,</span> ob<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
<span class="token comment">// 然后我们将 key11 作为 key 设置给 ob</span>
ob<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key11<span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>key11<span class="token punctuation">)</span> <span class="token operator">===</span> key1<span class="token punctuation">,</span> ob<span class="token punctuation">,</span> <span class="token string">'11'</span><span class="token punctuation">)</span></code></pre></div>
</li>
</ol>
<h1>ref.ts</h1>
<p>前面已经完成了 reactive 模块大部分且最基本的功能了，这节将完成剩余两大块computed 和 ref 其中的 ref.ts，</p>
<p>来揭露其真实的面目。</p>
<p>Ref 类型定义(<a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-7.html#unique-symbol">unique symbol 类型定义</a>)：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">declare</span> <span class="token keyword">const</span> RefSymbol<span class="token operator">:</span> unique <span class="token builtin">symbol</span>

<span class="token comment">// Ref 类型主要有两个属性，一个 值为 true 的唯一的符号属性</span>
<span class="token comment">// 一个是 value 值</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>RefSymbol<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span>
  value<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>内容列表</h2>
<table>
<thead>
<tr>
<th>变量/函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="language-text">convert(val)</code></td>
<td>将对象转成 reactive</td>
</tr>
<tr>
<td><code class="language-text">isRef(r)</code></td>
<td>判断是不是 Ref 类型，依据是 r._<em>v</em>isRef 标识的值</td>
</tr>
<tr>
<td><code class="language-text">ref(value)</code></td>
<td>创建 Ref 类型，调用 <code class="language-text">createRef(value)</code></td>
</tr>
<tr>
<td><code class="language-text">shallowRef(value)</code></td>
<td>创建 Ref 类型，调用 <code class="language-text">createRef(value, true)</code></td>
</tr>
<tr>
<td><code class="language-text">createRef(rawValue, shallow)</code></td>
<td>创建 Ref 类型</td>
</tr>
<tr>
<td><code class="language-text">triggerRef(ref: Ref)</code></td>
<td>trigger Ref 的 value 值变更 deps</td>
</tr>
<tr>
<td><code class="language-text">unref(ref)</code></td>
<td>取消 Ref，即返回 ref.value 原始值</td>
</tr>
<tr>
<td><code class="language-text">customRef(factory)</code></td>
<td>由创建者去定义 get, set 应该做哪些事情</td>
</tr>
<tr>
<td><code class="language-text">toRefs(object)</code></td>
<td>将对象的所有 key 的值转成 Ref</td>
</tr>
<tr>
<td><code class="language-text">toRef(object, key)</code></td>
<td>被 toRefs 调用</td>
</tr>
</tbody>
</table>
<p>完整的 ref.js(除了类型定义，不到100行，🐂👃)</p>
<h2>源码</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> isObject<span class="token punctuation">,</span> hasChanged <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> isProxy<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> collectionTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> track<span class="token punctuation">,</span> trigger<span class="token punctuation">,</span> __DEV__ <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect.js'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">convert</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// get track, set trigger</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span><span class="token parameter">rawValue<span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rawValue
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> value <span class="token operator">=</span> shallow <span class="token operator">?</span> rawValue <span class="token operator">:</span> <span class="token function">convert</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span>

  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">{</span>
    __v_isRef<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">,</span> rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rawValue <span class="token operator">=</span> newVal
        value <span class="token operator">=</span> shallow <span class="token operator">?</span> newVal <span class="token operator">:</span> <span class="token function">convert</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> __DEV__ <span class="token operator">?</span> <span class="token punctuation">{</span> newValue<span class="token operator">:</span> newVal <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> r
<span class="token punctuation">}</span>

<span class="token comment">// 手动触发 ref: set</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerRef</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> __DEV__ <span class="token operator">?</span> <span class="token punctuation">{</span> newValue<span class="token operator">:</span> ref<span class="token punctuation">.</span>value <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> r <span class="token operator">?</span> r<span class="token punctuation">.</span>__v_isRef <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">unref</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token operator">?</span> ref<span class="token punctuation">.</span>value <span class="token operator">:</span> ref
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">customRef</span><span class="token punctuation">(</span><span class="token parameter">factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token keyword">set</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">track</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">trigger</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">{</span>
    __v_isRef<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toRefs</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toRef</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    __v_isRef<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> object<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      object<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>给之前的代码加上 ref 功能：</p>
<ol>
<li>baseHandlers.js</li>
</ol>
<h2>测试</h2>
<h3>ref(value)</h3>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 将 100 变成 reactive 的 r -> { __v_isRef: true, get value() {}, set value() {} }</span>
<span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> r<span class="token punctuation">.</span>value
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'deps'</span><span class="token punctuation">)</span></code></pre></div>
<p>输出：</p>
<p><img src="http://qiniu.ii6g.com/1590477277.png?imageMogr2/thumbnail/!100p"></p>
<p>effect 里面使用到了 r.value 触发 get value() 访问器，里面使用 <code class="language-text">track(r, &#39;get&#39;, &#39;value&#39;, void 0)</code> 收集依赖，所以从  <code class="language-text">targetMap.get(r)</code> 可以取到 ‘value’ => Set(1) 这个 Dep。</p>
<p>更新 ref 值：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> r<span class="token punctuation">.</span>value
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">200</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span></code></pre></div>
<p>结果:</p>
<blockquote>
<p>{dummy: 100} “1”
{dummy: 200} “2”</p>
</blockquote>
<p>所以说，Ref 的存在就是让普通类型的值也能 reactive。</p>
<p><strong>应用到对象上</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nested<span class="token operator">:</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> r<span class="token punctuation">.</span>value<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>value<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">100</span></code></pre></div>
<p>结果：</p>
<blockquote>
<p>{_<em>v</em>isRef: true}
Map(1) {“value” => Set(1)}
{dummy: 0} “1”
{dummy: 100} “2”</p>
</blockquote>
<h3>shallowRef(value)</h3>
<p><strong>shallowRef</strong>  就是针对对象类型使用 Ref 的时候是否需要对对象里面的嵌套对象进行 reactive 化。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nested<span class="token operator">:</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  dummy <span class="token operator">=</span> r<span class="token punctuation">.</span>value<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dummy <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>value<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">100</span></code></pre></div>
<p>结果：</p>
<p><img src="http://qiniu.ii6g.com/1590477847.png?imageMogr2/thumbnail/!100p"></p>
<p>对象最终会被整个成为 value，因为是用的 shallowRef，所以改变 r.value.nested.num 的值是不会触发 dummy 更新的。</p>
<p>其他用法直接看下面的测试用例解析吧！！！</p>
<h2>jest</h2>
<p>结果:</p>
<blockquote>
<p>☁  vue-next-code-read [master] ⚡  jest
PASS  packages/<strong>tests</strong>/reactive/reactive.spec.js
PASS  packages/<strong>tests</strong>/reactive/ref.spec.js
PASS  packages/<strong>tests</strong>/reactive/effect.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/WeakSet.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/Set.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/Map.spec.js
PASS  packages/<strong>tests</strong>/reactive/collection/WeakMap.spec.js</p>
<p>Test Suites: 7 passed, 7 total
Tests:       149 passed, 149 total
Snapshots:   0 total
Time:        5.94 s
Ran all test suites.
☁  vue-next-code-read [master] ⚡</p>
</blockquote>
<ul>
<li>
<p><font color="green">✓ should hold a value (8 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should hold a value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// a -> { get value() {}, set value(val) {}, __v_isRef: true }</span>
<span class="token function">expect</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 在构造 set value(val) { trigger(r, 'set', 'value', void 0) }</span>
<span class="token function">expect</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should be reactive (2 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should be reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// { get value(), set value(), __v_isRef: true }</span>
<span class="token keyword">let</span> dummy
<span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  calls<span class="token operator">++</span> <span class="token comment">// 1</span>
  dummy <span class="token operator">=</span> a<span class="token punctuation">.</span>value <span class="token comment">// 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true，effect会立即执行一次</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true，同上</span>
a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 赋值触发 set value -> trigger: set</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 因为赋值 trigger: set 触发 updater</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// same value should not trigger</span>
a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 值没变，被 hasChanged() 阻拦，不 trigger</span>
<span class="token comment">// if (hasChanged(toRaw(newVal), rawValue)) {</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should make nested properties reactive (2 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should make nested properties reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// a.value 触发一次 ref track</span>
  <span class="token comment">// a.value.count 触发一次普通的 reactive track</span>
  <span class="token comment">// 所以这里会有两次 track</span>
  dummy <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>count
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 这里依旧会触发两次 get</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>测试：<img src="http://qiniu.ii6g.com/1590483209.png?imageMogr2/thumbnail/!100p"></p>
</li>
<li>
<p><font color="green">✓ should work without initial value (1 ms)</font></p>
<p>createRef(undefined) 并不影响它的使用，只会初始值是 undefined。</p>
</li>
<li>
<p><font color="green">✓ should work like a normal property when nested in a reactive object (2 ms)</font><span id="reactive-nest-ref"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work like a normal property when nested in a reactive object'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 这里 ref 类型的a 被作为对象成员传递给 reactive 之后，会被转成正常的值</span>
<span class="token comment">// 因为 baseHandlers.js 里面的 createGetter 的时候，有检测 isRef 是不是 Ref 类型 ?</span>
<span class="token comment">// 如果是且非数组的话会直接返回 res.value ，其实就是被普通化了(unref)之后将结果返回</span>
<span class="token comment">// 也就是说它只影响在 get 的时候返回的值，实际上在嵌套的对象里面 a 还是 Ref: a 类型的那个 a</span>
<span class="token comment">/*
	if (isRef(res)) {
    if (targetIsArray) {
      !isReadonly &amp;&amp; track(target, 'get', key)
      return res
    }
    return res.value
  }
*/</span>
<span class="token comment">// 所有后面可以直接 obj.a++ 操作</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  a<span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token punctuation">{</span>
    c<span class="token operator">:</span> a
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> dummy1
<span class="token keyword">let</span> dummy2

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个时候的 a 和 c 虽然一开始都是 a，但是由于传递给 </span>
  <span class="token comment">// reactive 之后被还原成最原始的值 1 了，所以这里 dummy1,2 都是 1</span>
  <span class="token comment">// 而非表面上的 Ref(1)</span>
  dummy1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>a 
  dummy2 <span class="token operator">=</span> obj<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">assertDummiesEqualTo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">[</span>dummy1<span class="token punctuation">,</span> dummy2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dummy</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 有了上面的结论下面结果就很明显了，也很好理解了</span>
<span class="token function">assertDummiesEqualTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true，被还原的 Ref(1)</span>
a<span class="token punctuation">.</span>value<span class="token operator">++</span> <span class="token comment">// ++ 之后改变的是 Ref:a，引用类型</span>
<span class="token comment">// 但是这里为什么是 2 呢？？？</span>
<span class="token comment">// 原因其实就是上面 reactive 的时候 只是在 trigger:get 的时候返回的是 ref.value</span>
<span class="token comment">// 实际上并没有改变 Ref:a 自身，只是影响了 get 的返回值而已</span>
<span class="token function">assertDummiesEqualTo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
<span class="token comment">// 但是这里 obj.a++ &lt;=> obj.a = obj.a + 1</span>
obj<span class="token punctuation">.</span>a<span class="token operator">++</span>
<span class="token function">assertDummiesEqualTo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c<span class="token operator">++</span>
<span class="token function">assertDummiesEqualTo</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>看下最后 obj 变成啥了？</p>
<p><img src="http://qiniu.ii6g.com/1590485724.png?imageMogr2/thumbnail/!100p"></p>
<p><span id="question-ref-++">最后可以看到 Ref:a 在 obj 里面尽管执行了 obj.a++ 和 obj.b.c++ 依旧还是 Ref: a？？？？</span></p>
</li>
<li>
<p><font color="green">✓ should unwrap nested ref in types (1 ms)</font></p>
<p>在 createRef 第一行就加了检测是不是 Ref 如果是就直接返回了。</p>
</li>
<li>
<p><font color="green">✓ should unwrap nested values in types (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should unwrap nested values in types'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    b<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 这里虽然是 Ref</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 发生嵌套了</span>

  <span class="token comment">// 但是在访问的时候，还记得之前那个测试用例碰到的问题吗？</span>
  <span class="token comment">// createGetter 里面返回 Ref 会直接 返回 ref.value</span>
  <span class="token comment">// 所以这里访问 c.value.b 其实相当于 c.value.b.value </span>
  <span class="token comment">// 所以 + 1 的结果肯定是 number 类型</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>value<span class="token punctuation">.</span>b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should NOT unwrap ref types nested inside arrays</font></p>
<p>这个用例和上一个是一样的原理，有个不同的地方是，target 是数组，createGetter 不是返回 res.value 了，而是直接返回 res，因为是数组类型且取的是整个数组对象。</p>
<p>而后面通过 <code class="language-text">arr[i]</code> 取值就和上一个用例一样了，一样会检测到数组元素如果是 Ref 照样会返回 res.value，所以在数组中使用 Ref(val) 做数组成员，然后 ref 数组是没有问题的。</p>
</li>
<li>
<p><font color="green">✓ should keep tuple types (6 ms)</font></p>
<p>不管你是什么类型元素，数组类型首先是整个数组访问直接返回 ref，然后如果是数组元素会检测是不是引用类型，如果是就 reactive ，不是直接返回结果。</p>
</li>
<li><font color="green">✓ should keep symbols (4 ms)</font></li>
<li><font color="green">✓ unref</font></li>
<li>
<p><font color="green">✓ shallowRef (2 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'shallowRef'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> sref <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// shallow，那么里面的 {a:1} 对象是不会被 reactive 的</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>sref<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">// 所以这里就是 False</span>

<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里依然会立即执行一次，且只会触发一次 track:get，因为有 sref.value 取值操作</span>
  <span class="token comment">// 但是由于 {a: 1} 并不是 Reactive ，所以对 a 的取值是不会触发 track:get 的</span>
  dummy <span class="token operator">=</span> sref<span class="token punctuation">.</span>value<span class="token punctuation">.</span>a
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

sref<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token comment">// 这里重新赋值整个 value</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>sref<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 虽然改变了 value 但的值依旧是普通对象</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 因为改变了 value，而 sref 还是 ref 类型，会触发 set value </span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ shallowRef force trigger (1 ms)</font></p>
<p>手动调用 triggerRef 触发 <code class="language-text">trigger(r, &#39;set&#39;, &#39;value&#39;, void 0)</code> 执行以来 deps</p>
</li>
<li><font color="green">✓ isRef (1 ms)</font></li>
<li><font color="green">✓ toRef (2 ms)</font></li>
<li><font color="green">✓ toRefs (1 ms)</font></li>
<li>
<p><font color="green">✓ customRef</font>
自定义 Ref 功能最主要的就是将控制权交给使用者，比如何时 track dep，何时 trigger dep 操作。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'customRef'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">let</span> _trigger

  <span class="token keyword">const</span> custom <span class="token operator">=</span> <span class="token function">customRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">track<span class="token punctuation">,</span> trigger</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 根据实际情况调用来收集依赖</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> newValue
      _trigger <span class="token operator">=</span> trigger <span class="token comment">// 可缓存 trigger 不一定要立即触发 deps</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>custom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// customRef 依旧返回的是 Ref</span>

  <span class="token keyword">let</span> dummy
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    dummy <span class="token operator">=</span> custom<span class="token punctuation">.</span>value
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

  custom<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token comment">// should not trigger yet</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token function">_trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
</ul>
<p><a href="https://github.com/gcclll/vue-next-code-read/tree/master/bakups/reactive_ref">ref 版 reactive.js</a></p>
<h1>computed.ts</h1>
<p>最后一个了，两周的坚持总算快结束了。</p>
<p>这块的实现就更简单了，就一个 computed() 函数，结合 effect() + ref 来实现。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getterOrOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> getter<span class="token punctuation">,</span> setter

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getterOrOptions <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> getterOrOptions
    setter <span class="token operator">=</span> __DEV__ <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'计算属性只读。'</span><span class="token punctuation">)</span> <span class="token operator">:</span> noop
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>get
    setter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>set
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 脏位检查，为 true 表示值有变化，重新取值</span>
  <span class="token keyword">let</span> value
  <span class="token keyword">let</span> computed 

  <span class="token comment">// runner 不会立即执行，直到计算属性取值在 get value 中手动调用</span>
  <span class="token comment">// 来触发所有有关的依赖，重新计算得到最新的值 value</span>
  <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    computed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 然后这里提供调度器，不直接</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  computed <span class="token operator">=</span> <span class="token punctuation">{</span>
    __v_isRef<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    effect<span class="token operator">:</span> runner<span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取值时，检测 dirty ，如果脏了(有变)，就重新 runner 取值，运行所有 deps，得到最新的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        value <span class="token operator">=</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dirty <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 重新计算后的重置 </span>
      <span class="token punctuation">}</span>
      <span class="token function">track</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span> <span class="token comment">// 收集依赖</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setter</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> computed
<span class="token punctuation">}</span></code></pre></div>
<h2>测试一：依赖收集</h2>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
cValue<span class="token punctuation">.</span>value
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  cValue<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">===</span> cValue<span class="token punctuation">.</span>effect<span class="token punctuation">,</span>
  value
<span class="token punctuation">)</span>  <span class="token comment">// true Proxy {__v_reactive: Proxy}</span></code></pre></div>
<p>当 cValue.value 执行对 Ref 进行取值(get value())触发，执行</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">computed <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  effect<span class="token operator">:</span> runner<span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检测到 dirty = true</span>
      <span class="token comment">// 执行 effect -> 执行 getter: () => value.foo</span>
      <span class="token comment">// 计算新值 undefined 赋值给 value</span>
      value <span class="token operator">=</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
      dirty <span class="token operator">=</span> <span class="token boolean">false</span> 
    <span class="token punctuation">}</span>
    <span class="token function">track</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span> <span class="token comment">// 触发</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">cValue.value</code> 首先这一句会触发两个 <code class="language-text">track</code></p>
<blockquote>
<p>{shouldTrack: true, type: “get”, key: “foo”, target: {…}, activeEffect: ƒ}
{shouldTrack: true, activeEffect: undefined, type: “get”, key: “value”, target: {…}}</p>
</blockquote>
<ol>
<li><code class="language-text">get value()</code> 里面执行了 runner() -> value.foo 取了一次 foo ，所以 <em>type: get, key: foo</em></li>
<li><code class="language-text">get value()</code> 里手动执行了一次 <code class="language-text">track(computed, &#39;get&#39;, &#39;value&#39;)</code>，但是由于 activeEffect 是 undefined 所以不会继续往下执行</li>
</ol>
<p>因此，虽然调用了两次 track ，但只有 value.foo 的 track 会去往下收集 <code class="language-text">effect:runner</code> 这个依赖。所以：</p>
<p><code class="language-text">cValue.effect.deps[0].values().next().value === cValue.effect // --&gt; true</code> </p>
<p>随后， <code class="language-text">value.foo = 1</code> 会触发上面收集到的依赖，执行一次 runner() 取 value.foo 的最新值： 1。</p>
<p><img src="http://qiniu.ii6g.com/1590548272.png?imageMogr2/thumbnail/!100p"></p>
<p>注意图中圈起来的，其实我想知道在调用 value.foo = 1 之后 cValue.value 的值会不会发生改变，按照代码逻辑是不会改变的，也就还是 undefined。但是直接点击 <code class="language-text">...</code> 浏览器会相当于触发一次 <code class="language-text">getter</code> 操作，最后结果会是 1，但是这不是我们想要的，不能让它触发。</p>
<p>那么就得想办法在它触发之前将老的值输出出来才行，结合代码只有在 <code class="language-text">get value()</code> 一开始加上打印才行，如下：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">computed <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为点击省略号会触发 getter ，会进入到这里</span>
    <span class="token comment">// 所以只需要提前将值打印出来就知道在 value.foo 设置下去之后</span>
    <span class="token comment">// cValue.value 其实是没有发生任何改变的，依旧还是 undefined</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'before runner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      dirty <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token function">track</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p><img src="http://qiniu.ii6g.com/1590548546.png?imageMogr2/thumbnail/!100p"></p>
<p>然后修改下输出： </p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token comment">// undefined，触发 runner() 执行 () => value.foo</span>
<span class="token comment">// 在这里并不会立即触发 runner() 调用 () => value.foo 更新 cValue.value 的值</span>
<span class="token comment">// 所以在这里设置之后到最后的 log 之前 cValue.value 依旧是 undefined</span>
<span class="token comment">// 但是这里会有个动作和 computed 有关，那就是计算属性里面的 scheduler() </span>
<span class="token comment">// 里面会检测 dirty = false(因为上面 get value 过，所以是 false)，</span>
<span class="token comment">// 触发 trigger(computed, 'set', 'value')，这里会触发所有和 computed-value 有关的依赖</span>
<span class="token comment">// 还有个重要的就是将 dirty = true，这样，后面当访问计算属性的时候才会触发 runner() 更新值</span>
value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span> 
<span class="token comment">// 然后访问一次 cValue.value 触发其 get value() 检测到 dirty 是 true</span>
<span class="token comment">// 然后触发 runner() 调用 () => value.foo 更新 value 的值</span>
<span class="token comment">// 所以下面的输出值就是 value.foo 的值</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token comment">// 1</span></code></pre></div>
<h2>jest</h2>
<ul>
<li>
<p><font color="green">✓ should return updated value (5 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return updated value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 提供的是函数，所以只有 getter，且不会立即执行(计算属性有设置：lazy: true)</span>
<span class="token comment">// 返回一个 Ref 类型值</span>
<span class="token comment">// 依赖属性：value.foo</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token comment">// 取值收集 value 的依赖，此时 dirty = true，执行 runner() 得到 undefined</span>
<span class="token function">expect</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token comment">// 赋值触发 value.foo 的 trigger: set，然后检测到该 effect 有提供 scheduler</span>
<span class="token comment">// 因此调用 cValue.options.scheduer </span>
<span class="token comment">// 此时的 dirty = false(get value 的时候置为 false 的)，</span>
<span class="token comment">// 触发 cValue 的 trigger: set -> value 调用 set value()</span>
value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">expect</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should compute lazily (3 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should compute lazily'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> getter <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span>

<span class="token comment">// lazy</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 计算属性默认是 lazy 的所以不会立即执行</span>

<span class="token function">expect</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token comment">// get value() -> runner() -> 触发一次 getter</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token comment">// should not compute again</span>
cValue<span class="token punctuation">.</span>value <span class="token comment">// 因为上面取过一次值了所有 dirty = false ，不会重复 runner()</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">// should not compute until needed</span>
<span class="token comment">// 不会立即重新计算，此时 cValue.value 值依旧是 undefined，上面有分析过了</span>
<span class="token comment">// 由于 foo 有收集到 computed.effect 这个依赖，一次赋值的时候会触发它执行</span>
<span class="token comment">// 而 computed.effect.options.scheduler 又存在，因此会执行 scheduler</span>
<span class="token comment">// 里面重置 dirty = true，标识值由变化</span>
value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span> 
<span class="token comment">// 因为不会触发 get value() 就不会 runner()，也就不会重新 getter()</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 

<span class="token comment">// now it should compute</span>
<span class="token comment">// 发生取值操作，会触发 get value() 此时 dirty = true(value.foo = 1的时候触发的 scheduler)</span>
<span class="token comment">// 因此这里取值的时候会发现值变化了，所以需要重新 runner() 取新值，然后又置 dirty = false</span>
<span class="token function">expect</span><span class="token punctuation">(</span>cValue<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 上面取值，runn() -> getter()</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment">// should not compute again</span>
cValue<span class="token punctuation">.</span>value <span class="token comment">// 一样的道理，dirty = false 了，所以不会重新 runner()</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</li>
<li>
<p><font color="green">✓ should trigger effect (1 ms)</font></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token keyword">let</span> dummy
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token comment">// 这个会立即执行一次，触发 get value() 执行 runner() -> getter()</span>
<span class="token comment">// 但是 value.foo 是没有指定 所以是 undefined</span>
dummy <span class="token operator">=</span> cValue<span class="token punctuation">.</span>value 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token comment">// 这里设置为什么会触发 effect(fn) 里面的 fn 呢？？？</span>
<span class="token comment">// 1. computed(updater1) 执行完之后，effect:runner() 并未立即执行</span>
<span class="token comment">//   所以 shouldTrack = true 和 activeEffect = undefined 并没有任何改变</span>
<span class="token comment">// 2. effect(fn) 执行完会立即执行 fn，里面访问了 cValue.value 触发 get value()</span>
<span class="token comment">//   执行 effect:runner() -> getter(): () => value.foo 此时 value.foo 取值触发其收集依赖</span>
<span class="token comment">//   此时的 activeEffect 其实还是 fn，因为 fn 没有执行完就不会重置(try...finally)</span>
<span class="token comment">// 3. 所以下面执行 value.foo = 1 的时候是会触发 fn 执行的，因为在 2 中已经将它收集到了</span>
<span class="token comment">// 4. 执行 fn 导致 cValue.value 取值，触发 get value() 执行 runner() -> getter() 取最新的</span>
<span class="token comment">//    值 1，因此 dummy 的值就是 1 了。</span>
value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre></div>
<p>所以上这个用例的关键点在于<strong><font color="red">理解 value.foo 是如何收集到 effect(fn) 里面的fn</font></strong>，因为 fn 里面并没有直接访问 value.foo ，而是访问的 cValue.value。</p>
</li>
<li>
<p><font color="green">✓ should work when chained (1 ms)</font><span id="test-case-computed-chained"></span></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work when chained'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> c1 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
<span class="token keyword">const</span> c2 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> c1<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 1. c2:runner() -> c2:getter() -> c1.value -> c1:runner() -> c1.getter() -> 0 + 1 = 1</span>
<span class="token comment">// 且此时 value.foo 收集到了 c1.effect</span>
<span class="token comment">// 且 c1.value 在触发 get value() 时候收集到了 c2.effect</span>
<span class="token function">expect</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token comment">// 2. 因为上面触发了 c1:runner() 所以 c1.value = 0</span>
<span class="token function">expect</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// 3. 因为在 step1 value.foo 收集到了 c1:effect，所以这里改变 value.foo</span>
<span class="token comment">//   会触发 c1:effect，执行 runner()，将 c1:dirty 置为 true</span>
value<span class="token punctuation">.</span>foo<span class="token operator">++</span>
<span class="token comment">// 4. c2.value -> c2: get value() -> c2 runner() -> c1.value: get value()</span>
<span class="token comment">//    -> c1 runner() -> value.foo = 1 + 1 = 2</span>
<span class="token function">expect</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// 5. c1.value 此时就算不访问 c1.value 触发 get value() 这里 c1.value 也是 1</span>
<span class="token function">expect</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>为了方便区分，这里给 <code class="language-text">computed(getterOrOptions, id)</code> 加个 id 参数，方便跟踪当前是按个 computed .</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 从结果直接分析原因，将下面的输出行用 Pn 标记</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> c1 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token string">'c1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> c2 <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> c1<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'c2'</span><span class="token punctuation">)</span>
<span class="token comment">// 首先上面三行不会触发任何输出</span>
<span class="token comment">// 1. log1 会触发 P1,P2,P3，原因：</span>
<span class="token comment">//    c2.value -> c2:get value()输出P1, dirty = true -> </span>
<span class="token comment">//          runner() + track + dirty = false -></span>
<span class="token comment">//    执行 c2:getter(), c1.value + 1 -> 访问 c1.value </span>
<span class="token comment">//    c1.value -> c1:get value()输出P2, dirty = true -> </span>
<span class="token comment">//          runner() + track + dirty = false -></span>
<span class="token comment">//    执行 c1:getter(), c1.value = value.foo = 0</span>
<span class="token comment">//    然后往回推： c1.value -> c1.value + 1 = 1 -> c2.value -> 输出 P3，c2.value 值为 1</span>
<span class="token comment">// 2. 第一步结束之后的状态：</span>
<span class="token comment">//    value.foo, deps[c1.effect]，value.foo = 1</span>
<span class="token comment">//    因为都触发了 get value() 所以各自收集到了自身的 effect </span>
<span class="token comment">//    c1, deps[c1.effect], c1.value = 0, dirty = false，等待 scheduler 调用置为 true</span>
<span class="token comment">//    c2, deps[c2.effect], c2.value = 1, dirty = false，等待 scheduler 调用置为 true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'c2.value 1'</span><span class="token punctuation">)</span> <span class="token comment">// log1, 1</span>
<span class="token comment">// 3. log2 会触发 P4, P5，原因：</span>
<span class="token comment">//    只是 c1.value 取值，会触发 get value()，因此有了 P4 输出</span>
<span class="token comment">//    但因为此时的 dirty = false 不会重复执行 runner()，所以值依旧是 0，最后输出 P5</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'c1.value 1'</span><span class="token punctuation">)</span> <span class="token comment">// log2, 0</span>

<span class="token comment">// 增加下面三个输出，让依赖收集结果更清晰</span>
<span class="token keyword">const</span> dep <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 这里收集到的是 c1.effect，因为 c1.value ->get value() 执行了 runner() 触发</span>
<span class="token comment">// value.foo 将 c1.effect 收进 deps</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> dep<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">===</span> c1<span class="token punctuation">.</span>effect<span class="token punctuation">)</span> <span class="token comment">// , true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
c1<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">,</span>
c1<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">===</span> c1<span class="token punctuation">.</span>effect<span class="token punctuation">,</span> <span class="token comment">// true</span>
<span class="token string">'c1 deps'</span>
<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
c2<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">,</span>
c2<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">===</span> c2<span class="token punctuation">.</span>effect<span class="token punctuation">,</span> <span class="token comment">// true</span>
<span class="token string">'c2 deps'</span>
<span class="token punctuation">)</span>

<span class="token comment">// 这里++，会触发 c1.effect，因为 c1:dirty = false，所以调用 c1.options.scheduler，</span>
<span class="token comment">// c1.dirty = true，trigger-c1:set-value</span>
<span class="token comment">// 记住一点：computed 属性没有取值就不会触发 runner()，所以这句执行之后</span>
<span class="token comment">// c1.value 依旧是 0，c2.value 依旧是 1</span>
<span class="token comment">// 通过之前的方式可测试出结果，如下图中结果</span>
value<span class="token punctuation">.</span>foo<span class="token operator">++</span>

<span class="token comment">// 4. log3 会输出 P9, P10, P11</span>
<span class="token comment">// c2.value 取值，触发 c2:runner() 重新计算值，c1.value + 1，触发</span>
<span class="token comment">// c1.value 取值，触发 c1:runner() 重新计算值，得到 c1.value = value.foo(++之后的值为1) = 1</span>
<span class="token comment">// 然后：c2.value = c1.value + 1 = 1 + 1 = 2</span>
<span class="token comment">// 所以这里会输出2，请看下面的，P9,P10,P11，其实这句之后 c1.value 已经是 1了</span>
<span class="token comment">// 因为这里触发了 c1.value 取值</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'c2.value 2'</span><span class="token punctuation">)</span> <span class="token comment">// log3, 2</span>
<span class="token comment">// 5. log4会输出 P12,P13，其实这里无论用不用 c1.value 它的值都已经是 1 了</span>
<span class="token comment">//    所以这里纯粹只是取值，不会重复 runner()，因为 step 4-log3 触发过 get value() diry = false</span>
<span class="token comment">//    了。</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'c1.value 2'</span><span class="token punctuation">)</span> <span class="token comment">// log4, 1</span></code></pre></div>
<p>输出：</p>
<blockquote>
<p>P1: {id: “c2”, value: undefined} “before runner”
P2: {id: “c1”, value: undefined} “before runner”
P3: 1 “c2.value 1”
P4: {id: “c1”, value: 0} “before runner”
P5: 0 “c1.value 1”</p>
<p>P6: Map(1) {“foo” => Set(1)} true
P7: [Set(1)] true “c1 deps”
P8: [Set(1)] true “c2 deps”</p>
<p>// 新增 Log3 之后的输出</p>
<p>P9: {id: “c2”, value: 1} “before runner”
P10: {id: “c1”, value: 0} “before runner”
P11: 2 “c2.value 2”</p>
<p>// 新增 log4 之后的输出</p>
<p>P12: {id: “c1”, value: 1} “before runner”
P13: 1 “c1.value 2”</p>
</blockquote>
<p>点击省略号输出：</p>
<p><img src="http://qiniu.ii6g.com/1590560419.png?imageMogr2/thumbnail/!100p"></p>
</li>
<li>
<p><font color="green">✓ should trigger effect when chained (3 ms)</font></p>
<p><a href="#test-case-computed-chained">请看上一个用例的分析---->></a></p>
</li>
<li>
<p><font color="green">✓ should trigger effect when chained (mixed invocations) (3 ms)</font></p>
<p><a href="#test-case-computed-chained">请看上上一个用例的分析---->></a></p>
</li>
<li>
<p><font color="green">✓ should no longer update when stopped (2 ms)</font></p>
<p>同上。但是有一点需要知道，stop() 主要干两件事：</p>
<ol>
<li>cleanup(effect) -> deps = [] 清空依赖</li>
<li>effect.active = false</li>
</ol>
<p>那么问题就很清晰了，stop 之后 active 为 false，在执行 effect() 的时候一开始就是检测是不是激活状态，如果不是会返回 undefined(有 scheduler清空)或者 fn(…args) 执行结果。不会继续往下执行 try…finally。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> options<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>所以说这里 stop 之后再赋值，调用 effect.scheduler() 相当于什么都没干。</p>
</li>
<li><font color="green">✓ should support setter (2 ms)</font></li>
<li>
<p><font color="green">✓ should trigger effect w/ setter</font></p>
<p>plusOne.value = 0<code class="language-text">会触发 setter 调用 options.set:</code>n.value = val - 1`。</p>
<p>那么 n.value 变了 就会触发 effect(fn) 里面的 dep:fn 更新 dummy 值。</p>
</li>
<li><font color="green">✓ should warn if trying to set a readonly computed</font></li>
</ul>
<h1>总结</h1>
<p><font size="20" color="red">Over</font><font size="3">💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥💥.</font></p>
<p>终于结束了，经过两周的坚持，终于将 vue3.0 reactivity 模块源码“抄完”了。</p>
<p>此时此刻，貌似没什么话要写的了…，唯有</p>
<p><font color="magenta" size="6">路漫漫其修远兮，吾将上下而求索！！！</font></p>
<p>两周以来，每天脑子空闲了里面都是 vue3.0 reactivity 代码，甚至睡觉都在做梦敲这块的代码，做梦都在思考所经历的代码流程和细节。</p>
<p>总的下来，只有感叹自己能力不足，越学习越觉得自己垃圾！！！</p>
<p>路还很长，不能放弃，回来这几年总感觉心有力而余不足，更是感叹大学没好好学好基础，更体会到书到用时方恨少方恨少，(⊙o⊙)…，有点扯远了！！！</p>
<hr>
<p>还是老老实实的来复盘⑧ （开始 -> 🔚）：</p>
<h2>**第一阶段：reactive() **</h2>
<p><code class="language-text">reactive(target) -&gt; createObjectReactive(target, isReadonly, baseHandlers, collectionHandlers)</code></p>
<p>创建 reactive 对象，之前的 toProxy, toRaw 改成了 ReactiveFlags 标记方式存储到 target 和 observed 对象上了，而不是单独的声明两个模块遍历来专门存储 target -> observed 和 observed -> target 的关系。</p>
<p><strong>baseHandlers</strong>: 基本对象类型的 proxy handler，原生的 Reflect 基本都提供了对应的能力。</p>
<p><strong>collectionHandlers</strong>：集合类型(Map, Set, WeakMap, WeakSet) 对象的 proxy handlers，由于原生 Reflect 并没有支持它们的原子操作，所以只能通过对象的 proxy get ，来获取所调用的方法名去对应的 instrumentations 里面查找与之相关的 handler 来模拟集合类型的所有操作。</p>
<p>可进行 reactive 的的条件</p>
<ol>
<li>_isVue: false 表示 Vue 实例类型</li>
<li>_VNode: false 虚拟节点类型</li>
<li>!rawValues 中的类型或值</li>
<li>可 observable 类型(除Map, Set, WeakMap, WeakSet, Object, Array意外的类型)</li>
<li>非 Object.isFrozen 类型</li>
</ol>
<p>经过更新之后前面三种都合并到了 ReactiveFlags._<em>v</em>skip 里面了(结合 markRaw(value) 将不能被观察的值置为 _<em>v</em>skip: true)。</p>
<p>最后变成了三种检测：</p>
<ol>
<li>_<em>v</em>skip = false</li>
<li>observable 类型</li>
<li>非 frozen 对象</li>
</ol>
<p>取消 toProxy, toRaw 之后使用 target.<strong>v_readonly 和 target.</strong>v<em>reactive 来保存 observed,  target.__v</em>raw 来保存 proxy 之前的对象。</p>
<p>所以一旦检测到 _<em>v</em>readonly 和 _<em>v</em>reactive 值存在就直接返回这个缓存的 proxy。</p>
<h2>第二阶段：baseHandlers</h2>
<p><strong>createGetter -> 创建 proxy get</strong>：</p>
<p>返回的时候检测 isReadonly 决定使用 readonly() 还是 reactive() 做深层的 reactive。</p>
<p>如果指定了 shallow = true 参数，那么只会针对对象的第一层做 reactive。</p>
<p>如果是数组的三个索引操作，直接进入 arrayInstrumentations 处理，调用封装之后的 includes, indexOf, lastIndexOf。</p>
<p>如果是 Ref 类型直接返回 res.value，如果又是数组，手动 track 一次数组元素的 ‘get’ 操作，直接返回该数组 res。</p>
<p><strong>createSetter -> 创建 proxy set</strong>：</p>
<p>如果是 Ref 类型要将值设置到 oldValue.value 上，而不是直接将值通过 Reflect.set() 设置下去。</p>
<p>然后根据 oldValue 和 newValue 进行比较，排除 NaN 的可能之后，如果有发生变化就调用 trigger，如果 target 上没有的 key 就是 <code class="language-text">trigger: add</code>，否则 <code class="language-text">trigger:set</code>。</p>
<p><strong>deleteProperty -> 创建 proxy delete</strong>：</p>
<p>trigger delete。</p>
<p><strong>has -> 创建 proxy has</strong>：</p>
<p>track has 收集依赖。</p>
<p><strong>ownKeys -> 创建 proxy ownKeys</strong> ：</p>
<p>track ITERATE_KEY 迭代器收集依赖。</p>
<h2>第三阶段：effect() 构建 Dep</h2>
<p>effect(fn, options) 是将 fn 构造成 Dep 类型，所以，其实Vue里面所有的依赖都是一个 effect 函数，函数上挂了若干个属性(<code class="language-text">_isEffect, active, id, deps, options, raw</code>)。</p>
<p>这里的重点在于 reactiveEffect 函数的实现里面有个 try…finally 它结合 shouldTrack 和 activeEffect 保证了在 Dep 里面执行 <code class="language-text">value.n++</code> 不会出现死循环，因为 trigger 里面的 add 操作会检测这两个值，如果 <code class="language-text">activeEffect !== effect</code>(当前的这个 Dep) 或者 <code class="language-text">shouldTrack = false</code> 才会收集要执行的依赖。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// enable effect</span>
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// 这个就是 effect(() => {}) 传入的函数</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
	<span class="token comment">// 结束当前 effect 构建</span>
	<span class="token comment">// shouldTrack = false</span>
	<span class="token comment">// activeEffect = undefined</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>第四阶段：collectionHandlers</h2>
<p>这里就有意思了…</p>
<p>因为没有集合类型的直接 proxy 对应的 Reflect，因此只能采取另类的方式来解决这个问题。</p>
<p>不管什么情况下，obj.fn 都属于属性值的访问，也就是说当使用 obj.fn() 的时候，无论如何都会出发 obj 对 fn 属性的 <code class="language-text">get</code> 操作。</p>
<p>所以对于 collectionHandlers 里面就只有一个 get。</p>
<p>然后通过 obj.fn -> 出发 get, key 为 fn -> <code class="language-text">Reflect.get(instrumentations, &#39;fn&#39;, ...)</code>，然后通过 fn 即函数名称去 instrumentations 里面找到对应的函数(比如：set, get, add, has, 等等…)。</p>
<p>最后根据调用 <code class="language-text">obj.fn(...args)</code> 时传递的参数转接到 instrumentations 里面对应的函数参数上。</p>
<p>这部分的重点在于 instrumentations 里面函数的调用时作用域问题的解决：</p>
<ol>
<li>从 target.prototype 原型上取出对应的方法(如：has, get, set, add)</li>
<li>然后通过 <code class="language-text">has.call(target)</code> 然后将调用域指回给 target(Map, Set…)</li>
</ol>
<p>不然会出现 Map.prototype.has 在 Proxy 类型上调用而找不到函数的问题。</p>
<p>另一个需要关注的是 key, rawKey 的问题，这里的意义在于：</p>
<p>​	<font color="blue"><em>如果 key-> proxyKey ，如果同时用 key 和 proxyKey 取 get 值的时候会发现最终 proxyKey 会被转成 key再取值。这里应该是为了避免 proxyKey 和 key 会同时被添加如 Map 或 Set 问题</em>。</font></p>
<h2>第四阶段：Ref</h2>
<p>Ref 类型，主要提供了将原始类型值转成 reactive 的能力。</p>
<p>它通过将值封装成 ： <code class="language-text">{__v_isRef: true, get value(){}, set value() {} }</code> 对象来完成 reactive 功能。</p>
<p>这里重点是几个函数：</p>
<ol>
<li><code class="language-text">ref(value)</code> 将值转成 Ref 类型</li>
<li><code class="language-text">createRef(value, shallow)</code> 被 ref 或 shallowRef 调用来创建 Ref</li>
<li><code class="language-text">triggerRef(ref)</code> 触发 Ref 上的 deps</li>
<li><code class="language-text">customRef(factory)</code> 提供外部自定义 Ref 能力</li>
<li><code class="language-text">toRef(object)</code> 将对象转成 Ref 类型</li>
</ol>
<p>Ref 类型关键：</p>
<ol>
<li>get value() -> track 收集依赖</li>
<li>set value(val) -> trigger 依赖</li>
</ol>
<h2>第五阶段：computed(getterOrOptions)</h2>
<p>computed 实现原理：</p>
<ol>
<li>Ref 类型</li>
<li>dirty 脏检查位</li>
</ol>
<p>所以计算属性就是个 Ref 类型结果对象，包含(<code class="language-text">__v_isRef, get value(), set value()</code>)，有两种使用方式</p>
<ol>
<li>getterOrOptions 是函数那么就只会有 getter</li>
<li>getterOrOptions 是对象可以提供自定义的 setter 和 getter</li>
</ol>
<p>每个 computed 都有一个名为 runner 的 effect，用来处理计算属性所依赖的值的变更所需要作出的行为。</p>
<p>一个计算属性使用流程大概是这样的：</p>
<ol>
<li>取值触发 get value() </li>
<li>检查 dirty，如果为 true，表示值由边则调用 runner() 重新计算新值</li>
<li>
<p>如果依赖的值发生变更，也会触发 runner()</p>
<p><em>因为 runner 是个 effect，在 fn 里面使用其他值(比如：<code class="language-text">obj.foo</code>)会触发这些值来收集这个 effect:runner 所以这些值改变会触发 runner。</em></p>
</li>
<li>
<p>即 obj.foo++ 改变，调用 trigger:set，trigger的时候检测到 runner 有schudler 所有调用它</p>
<p><em>此时 runner: dirty 如果是 false 情况下就会触发 trigger(computed, ‘set’, ‘value’)，重点是会将脏位标识置为 dirty = true，那么下次取值的时候就会知道值发生改变了，就会触发 runner() 重新计算值。</em></p>
</li>
<li>经过第四部之后， computed.value 并没有真正的更新，必须它被实际访问的时候才会去触发 runner() 重新计算值。</li>
</ol>
<p><strong>所以说计算属性并不是在依赖值更新之后就会立即发生变化，必须在依赖值变更之后被访问了之后触发 get value() 才会重新计算值。</strong></p>
<hr>
<p>严格来说应该不是按照这五个阶段来完成的，其实最耗时间的是在第一和第二阶段，尤其是第二阶段。</p>
<p>第二阶段耗时间的地方有两个</p>
<ol>
<li>createGetter -> track</li>
<li>createSetter -> trigger</li>
</ol>
<p>主要时间花在这两个上了，所以如果还可以拆分阶段肯定是这里。</p></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQCBQP/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABvg6XkPHXEs2DkVP/xAAaEAEAAwEBAQAAAAAAAAAAAAABAgMRABAx/9oACAEBAAEFApSzpFgSXZVm2odKtei6/fP/xAAYEQACAwAAAAAAAAAAAAAAAAAAARAhMf/aAAgBAwEBPwFIoex//8QAGREAAQUAAAAAAAAAAAAAAAAAAAEQESEx/9oACAECAQE/AZLExv/EAB0QAAICAQUAAAAAAAAAAAAAAAARAQIxECEiQYH/2gAIAQEABj8CtWMjcoyNz4KOjjKLG+n/xAAaEAEBAQADAQAAAAAAAAAAAAABEQAhQaEx/9oACAEBAAE/IW7iSnm9A2+tWXe7wi0Ep0zoxTkTvNVocRckd//aAAwDAQACAAMAAAAQ2zeB/8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQITH/2gAIAQMBAT8QBY65Z//EABgRAQADAQAAAAAAAAAAAAAAAAEAEBEx/9oACAECAQE/EFhBz23/xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMUHRUWGB/9oACAEBAAE/EFbOWbJntGjC1APfMsaX5TqNxAwkxrNWQph0XsR3ApUAN9vksJzcTUQaviCgGCf/2Q==" alt="Kyle Mathews" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg 1x,
/static/94e5e34de11ed954bada7ca31a5613c0/aba1d/profile-pic.jpg 1.5x,
/static/94e5e34de11ed954bada7ca31a5613c0/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg 1x,
/static/94e5e34de11ed954bada7ca31a5613c0/aba1d/profile-pic.jpg 1.5x,
/static/94e5e34de11ed954bada7ca31a5613c0/b315d/profile-pic.jpg 2x" src="/static/94e5e34de11ed954bada7ca31a5613c0/99438/profile-pic.jpg" alt="Kyle Mathews" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Kyle Mathews</strong> <!-- -->who lives and works in San Francisco building useful things.<!-- --> <a href="https://twitter.com/kylemathews">You should follow him on Twitter</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2020-06-16-es6++/">← <!-- -->ES6++</a></li><li><a rel="next" href="/2020-06-16-algo-leetcode/">Algorithm on leetcode 1(算法学习 leetcode)<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020-06-16-vue-3.0-reactivity/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-da2011b4223c5d7c3864.js"],"component---src-pages-404-js":["/component---src-pages-404-js-dfa684939fdc086afe1b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-e9a9ff0bc6d35a12e2fb.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-df3c457ebc2bf0738933.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-89ff2d606443a75a09e8.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-89ff2d606443a75a09e8.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-6260575670be770f4a25.js" async=""></script><script src="/commons-db8b23eb39139ace1919.js" async=""></script><script src="/app-da2011b4223c5d7c3864.js" async=""></script><script src="/styles-2d4804b503525347efbe.js" async=""></script><script src="/framework-d54fcf3f0204b459cf2d.js" async=""></script><script src="/webpack-runtime-69d8816745da999b9479.js" async=""></script></body></html>